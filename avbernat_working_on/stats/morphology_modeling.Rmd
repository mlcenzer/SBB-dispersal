---
title: "Modeling Morphology"
author: "Anastasia Bernat"
date: "6/24/2020"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
setwd("~/Desktop/Rstats-winter2020/")

# For Modeling
library(lme4)

# For Data Summaries and Manipulation
library(dplyr)
library(mosaic)

# For Plotting
library(ggplotify)
library(gridExtra) # "grid" graphics

knitr::opts_chunk$set(echo = TRUE)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(panel.grid.major = ggplot2::element_line(colour = "grey75"))
```

## Winter 2020 Flight Trials: Morphology Modeling {.tabset}

Flight Trials Winter 2020 Dataset was conducted from 2/17/2020 - 3/10/2020. Soapberry bugs were flight tested twice for multiple hours in the flight mill and observed from 8 AM to (5-8 PM) each day.

### All Data

#### Reading the data

```{r}
rm(list=ls())
output_col = FALSE # Recommend changing this to TRUE if working in Base R or RStudio, and FALSE if generating an html
source("src/clean_flight_data.R") # Script that loads and cleans up the data
source("src/regression_output.R") # A script that cleans up regression outputs and prints in color or black and white
source("src/center_flight_data.R")

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]
```

#### Testing Models and Covariates

**Experimental Set-Up Effects**

```{r echo=FALSE}
###### No effect of chamber
tidy_regression(lmer(thorax_c~chamber + (1|trial_type), data=data_tested), is_color=output_col) 

####### No effect of test date
tidy_regression(lmer(thorax_c~days_from_start_c+ (1|trial_type), data=data_tested), is_color=output_col)

####### No effect of test time
tidy_regression(lmer(thorax_c~min_from_IncStart_c + (1|trial_type), data=data_tested), is_color=output_col) 
```

#### Comparing Models

**host, sex, sym_dist**

```{r, warning=FALSE}
data<-data.frame(R=data_tested$thorax_c, 
                 A=data_tested$host_c, 
                 B=data_tested$sex_c, 
                 C=data_tested$sym_dist, 
                 X=data_tested$trial_type, Y=data_tested$chamber)

source("src/AICprobabilities.R")
source("src/generic models-gaussian glmer 2-RF + 3-FF.R") 
AICs <- sort(summary$AIC)
models_init <- sort(P, decreasing=TRUE, index.return=TRUE)
top <- length(models_init$x[which(models_init$x>0.05)])

AICs <- AICs[1:top]
models <- lapply(models_init$ix[1:top],1,FUN=as.integer)
probs <- models_init$x[1:top]
rbind(AICs, models, probs) 
```

- m7 <- R ~ A + B + C + (1 | X)
- m25 <- R ~ A + B + C + (1 | Y)
- m43 <- R ~ A + B + C + (1 | X) + (1 | Y)

```{r}
anova(m7, m43, test="Chisq") # Adding (1|Y) does not improve fit
```

```{r}
best.fit <- lmer(thorax_c ~ host_c + sex_c + sym_dist + (1|trial_type), data=data_tested)
tidy_regression(best.fit, is_color=output_col)
```

* negative effect of host plant where if from GRT then smaller thorax length
* strong positive effect of sex where if Female then larger thorax length
* positive effect of sym_dist where if farther from Homestead, then longer thorax length

```{r, warning=FALSE}
### pick things back up today
data<-data.frame(R=data_tested$thorax_c, 
                 A=data_tested$host_c, 
                 B=data_tested$sex_c, 
                 C=data_tested$sym_dist, 
                 D=data_tested$body_c,
                 X=data_tested$trial_type, Y=data_tested$chamber)

source("src/AICprobabilities.R")
source("src/generic models-gaussian glmer 2-RF + 3-FF.R") 
AICs <- sort(summary$AIC)
models_init <- sort(P, decreasing=TRUE, index.return=TRUE)
top <- length(models_init$x[which(models_init$x>0.05)])

AICs <- AICs[1:top]
models <- lapply(models_init$ix[1:top],1,FUN=as.integer)
probs <- models_init$x[1:top]
rbind(AICs, models, probs) 
```


### All Data Plots

```{r}
par(mfrow=c(2,3))
plot(thorax_c ~ host_c, data=data_tested, main="data_tested")
plot(thorax_c ~ sym_dist, data=data_tested, main="data_tested")
plot(thorax_c ~ sex_c, data=data_tested, main="data_tested")

plot(thorax_c ~ host_c, data=data_all, main="data_all")
plot(thorax_c ~ sym_dist, data=data_all, main="data_all")
plot(thorax_c ~ sex_c, data=data_all, main="data_all")
```

```{r}
gf_point(thorax_c ~ sym_dist, col=~host_c, alpha=~sex_c, data=data_tested)
gf_point(thorax_c ~ sym_dist, col=~host_c, alpha=~sex_c, data=data_all)
```

### Female Data

```{r}
rm(list=ls())
output_col = FALSE # Recommend changing this to TRUE if working in Base R or RStudio, and FALSE if generating an html
source("src/clean_flight_data.R") # Script that loads and cleans up the data
source("src/regression_output.R") # A script that cleans up regression outputs and prints in color or black and white
source("src/center_flight_data.R")

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]

data_fem <- data_tested[data_tested$sex=="F",]
```

#### Testing Models and Covariates

**Experimental Set-Up Effects**

```{r echo=FALSE}
###### No effect of chamber
tidy_regression(lmer(thorax_c~chamber + (1|trial_type), data=data_fem), is_color=output_col) 

####### No effect of test date
tidy_regression(lmer(thorax_c~days_from_start_c+ (1|trial_type), data=data_fem), is_color=output_col)

####### No effect of test time
tidy_regression(lmer(thorax_c~min_from_IncStart_c + (1|trial_type), data=data_fem), is_color=output_col) 
```

#### Comparing Models

**host, sym_dist**

```{r, warning=FALSE}
data<-data.frame(R=data_fem$thorax_c, 
                 A=data_fem$host_c, 
                 B=data_fem$sym_dist, 
                 X=data_fem$ID, Y=data_fem$trial_type)

source("src/AICprobabilities.R")
source("src/generic models-gaussian glmer 2-RF + 2-FF.R") 
AICs <- sort(summary$AIC)
models_init <- sort(P, decreasing=TRUE, index.return=TRUE)
top <- length(models_init$x[which(models_init$x>0.05)])

AICs <- AICs[1:top]
models <- lapply(models_init$ix[1:top],1,FUN=as.integer)
probs <- models_init$x[1:top]
rbind(AICs, models, probs) 
```

m12 <- B + (1 | X) + (1 | Y)

```{r}
best.fit.fem <- lmer(thorax_c ~ sym_dist + (1|ID) + (1|trial_type), data=data_fem)
tidy_regression(best.fit.fem, is_color=output_col)
```

* no effect of sym_dist 

**host, sym_dist, body_c**

```{r, warning=FALSE}
data<-data.frame(R=data_fem$thorax_c, 
                 A=data_fem$host_c, 
                 B=data_fem$sym_dist,
                 C=data_fem$body_c,
                 X=data_fem$trial_type)

source("src/AICprobabilities.R")
source("src/generic models-gaussian glmer 1-RF + 3-FF.R") 
AICs <- sort(summary$AIC)
models_init <- sort(P, decreasing=TRUE, index.return=TRUE)
top <- length(models_init$x[which(models_init$x>0.05)])

AICs <- AICs[1:top]
models <- lapply(models_init$ix[1:top],1,FUN=as.integer)
probs <- models_init$x[1:top]
rbind(AICs, models, probs) 
```

m5 <- A + C + (1 | X)
m3 <- R ~ C + (1 | X)

```{r}
anova(m3, m5, test="Chisq") # Adding A does improve fit
```

```{r}
best.fit.fem <- lmer(thorax_c ~ host_c + body_c + (1 | trial_type), data=data_fem)
tidy_regression(best.fit.fem, is_color=output_col)
```

* negative effect of host where if form GRT then the shorter the thorax 
* strong positive effect of body where the longer the body the longer the thorax 

**host, sym_dist, body, beak**

```{r, warning=FALSE}
data<-data.frame(R=data_fem$thorax_c, 
                 A=data_fem$host_c, 
                 B=data_fem$sym_dist,
                 C=data_fem$body_c,
                 D=data_fem$beak_c,
                 X=data_fem$trial_type)

source("src/AICprobabilities.R")
source("src/generic models-gaussian glmer 1-RF + 4-FF.R") 
AICs <- sort(summary$AIC)
models_init <- sort(P, decreasing=TRUE, index.return=TRUE)
top <- length(models_init$x[which(models_init$x>0.05)])

AICs <- AICs[1:top]
models <- lapply(models_init$ix[1:top],1,FUN=as.integer)
probs <- models_init$x[1:top]
rbind(AICs, models, probs) 
```

m10 <-  C + D + (1 | X)
m21 <-  C * D + (1 | X)
m6 <- A + C + (1 | X)

```{r}
anova(m10, m21, test="Chisq") # Adding A*C does improve fit
```

```{r}
best.fit.fem <- lmer(thorax_c ~ beak_c *body_c + (1 | trial_type), data=data_fem)
tidy_regression(best.fit.fem, is_color=output_col)
```
* no effect of beak length
* positive effect of body length, where the longer the bug, the wider the thorax
* postive effect of beak*body, where the longer the bug and beak, the wider the thorax

### Female Plots

```{r}
plot(thorax ~ host_c, data=data_fem)
plot(thorax ~ sym_dist, data=data_fem)
gf_point(thorax_c ~ sym_dist, col=~host_c, data=data_fem)
```


### Male Data 

```{r}
rm(list=ls())
output_col = FALSE # Recommend changing this to TRUE if working in Base R or RStudio, and FALSE if generating an html
source("src/clean_flight_data.R") # Script that loads and cleans up the data
source("src/regression_output.R") # A script that cleans up regression outputs and prints in color or black and white
source("src/center_flight_data.R")

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]

data_male <- data_tested[data_tested$sex=="M",]
```

#### Testing Models and Covariates

**Experimental Set-Up Effects**

```{r echo=FALSE}
###### No effect of chamber
tidy_regression(lmer(thorax_c~chamber + (1|trial_type), data=data_male), is_color=output_col) 

####### No effect of test date
tidy_regression(lmer(thorax_c~days_from_start_c+ (1|trial_type), data=data_male), is_color=output_col)

####### No effect of test time
tidy_regression(lmer(thorax_c~min_from_IncStart_c + (1|trial_type), data=data_male), is_color=output_col) 
```

#### Comparing Models

**host, sym_dist**

```{r, warning=FALSE}
data<-data.frame(R=data_male$thorax_c, 
                 A=data_male$host_c, 
                 B=data_male$sym_dist, 
                 X=data_male$chamber, Y=data_male$trial_type)

source("src/AICprobabilities.R")
source("src/generic models-gaussian glmer 2-RF + 2-FF.R") 
AICs <- sort(summary$AIC)
models_init <- sort(P, decreasing=TRUE, index.return=TRUE)
top <- length(models_init$x[which(models_init$x>0.05)])

AICs <- AICs[1:top]
models <- lapply(models_init$ix[1:top],1,FUN=as.integer)
probs <- models_init$x[1:top]
rbind(AICs, models, probs) 
```

m3 <- R ~ A + B + (1 | X)
m8 <- R ~ A + B + (1 | Y)
m13 <- R ~ A + B + (1 | X) + (1 | Y)

```{r}
anova(m3, m13, test="Chisq") # adding (1|Y) does not improve fit
anova(m3, m8, test="Chisq") # replacing X with Y does improve fit
anova(m8, m13, test="Chisq") # Adding (1|X) does not improve fit
```

```{r}
best.fit.male <- lmer(thorax_c ~ host_c + sym_dist + (1|trial_type), data=data_male)
tidy_regression(best.fit.male, is_color=output_col)
```

* negative effect of host where if form GRT, the narrower the thorax
* positve effect of sym_dist where the farther from Homestead, the wider the thorax

**host, sym_dist, body_c**

```{r, warning=FALSE}
data<-data.frame(R=data_male$thorax_c, 
                 A=data_male$host_c, 
                 B=data_male$sym_dist,
                 C=data_male$body_c,
                 X=data_male$trial_type)

source("src/AICprobabilities.R")
source("src/generic models-gaussian glmer 1-RF + 3-FF.R") 
AICs <- sort(summary$AIC)
models_init <- sort(P, decreasing=TRUE, index.return=TRUE)
top <- length(models_init$x[which(models_init$x>0.05)])

AICs <- AICs[1:top]
models <- lapply(models_init$ix[1:top],1,FUN=as.integer)
probs <- models_init$x[1:top]
rbind(AICs, models, probs) 
```

m3 <- R ~ C + (1 | X)

```{r}
best.fit.male <- lmer(thorax_c ~ body_c + (1|trial_type), data=data_male)
tidy_regression(best.fit.male, is_color=output_col)
```

* positive effect of body size wher the longer the body the wider the thorax

**host, sym_dist, body, beak**

```{r, warning=FALSE}
data<-data.frame(R=data_male$thorax_c, 
                 A=data_male$host_c, 
                 B=data_male$sym_dist,
                 C=data_male$body_c,
                 D=data_male$beak_c,
                 X=data_male$trial_type)

source("src/AICprobabilities.R")
source("src/generic models-gaussian glmer 1-RF + 4-FF.R") 
AICs <- sort(summary$AIC)
models_init <- sort(P, decreasing=TRUE, index.return=TRUE)
top <- length(models_init$x[which(models_init$x>0.05)])

AICs <- AICs[1:top]
models <- lapply(models_init$ix[1:top],1,FUN=as.integer)
probs <- models_init$x[1:top]
rbind(AICs, models, probs) 
```

m45 <- R ~ A * C + A * D + (1 | X)
m59 <- R ~ A * C + A * D + B + (1 | X)
m3 <- R ~ C + (1 | X)
m10 <- R ~ C + D + (1 | X)

```{r}
anova(m3, m10, test="Chisq") # Adding B does improve fit
anova(m45, m59, test="Chisq") # Adding B does improve fit
```

```{r}
best.fit.male <- lmer(thorax_c ~ host_c * body_c + host_c * beak_c + sym_dist  + (1|trial_type), data=data_male)
tidy_regression(best.fit.male, is_color=output_col)
```


* maringal positive effect of host where if from GRT then wider thorax
* positve effect of body where the longer the body the wider the thorax
* positive effect of beak where the logner the beak, the wider the thorax
* positive effect of sym_dist where the farther from Homestead, the wider the beak

* negative effect of host*body where if from GRT and longer body, then smaller thorax
* positive efefct of host*beak where if from GRT and longer beak, then larger thorax

### Female Plots

```{r}
plot(thorax ~ host_c, data=data_male)
plot(thorax ~ sym_dist, data=data_male)
gf_point(thorax_c ~ sym_dist, col=~host_c, data=data_male)
```



