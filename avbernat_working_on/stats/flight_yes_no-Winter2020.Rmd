---
title: 'Binomial Modeling: flight_yes_no'
author: "Anastasia Bernat"
date: "3/30/2020 - 6/14/2020"
output:
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
rm(list=ls())
setwd("~/Desktop/Rstats-winter2020/")

library(lme4)
library(dplyr)
library(ggplotify)
library(gridExtra)
library(ggformula)
library(tidyselect)
library(zoo)

knitr::opts_chunk$set(echo = TRUE)
```

## Winter 2020 Flight Trials: Binomial Flight Modeling {.tabset}

Flight Trials Winter 2020 Dataset was conducted from 2/17/2020 - 3/10/2020. Soapberry bugs were flight tested twice for multiple hours in the flight mill and observed from 8 AM to (5-8 PM) each day. Used multivariate (glm) and mixed effect modeling (glmer) to analyze the flight results.

### All Trials

[Cleaning Data](#data_clean)

[Testing glmer() and Covariates](#testing)

<a id="data_clean"></a>

**Cleaning the Data**

```{r}
rm(list=ls())
output_col = FALSE # Recommend changing this to TRUE if working in Base R or RStudio, and FALSE if generating an html
source("src/clean_flight_data.R") # Script that loads and cleans up the data
source("src/regression_output.R") # A script that cleans up regression outputs and prints in color or black and white
source("src/center_flight_data.R")
source("get_warnings.R")

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]
```

```{r}
# columns of strings (e.g. "T1, T2")
# d2 <- data_tested %>%
#     group_by(ID) %>%
#     summarise_all(funs(toString(na.omit(.))))

# columns of tuples (e.g. list(T1, T2))
d <- data_tested %>%
   group_by(ID, sex,population, site, host_plant, latitude, longitude, total_eggs, 
            beak, thorax, wing, body, w_morph, morph_notes, tested,
            host_c, sex_c, w_morph_c, lat_c, sym_dist, sym_dist_s, total_eggs_c, 
            beak_c, thorax_c, thorax_s, body_c, wing_c, wing2body, wing2body_c, wing2body_s) %>%
   summarise_all(funs(list(na.omit(.))))

d$num_flew <- 0
d$num_notflew <- 0
d$average_mass <- 0

for(row in 1:length(d$flew_b)){
  
  n_flew <- sum(d$flew_b[[row]] == 1) # total number of times did fly among trails
  d$num_flew[[row]] <- n_flew 
  
  n_notflew <- sum(d$flew_b[[row]] == 0) # total number of times did not fly among trails
  d$num_notflew[[row]] <- n_flew
  
  avg_mass <- mean(d$mass[[row]])
  d$average_mass[[row]] <- avg_mass

}

d <- select(d, -filename, -channel_letter, -set_number)

d
```

<a id="testing"></a>

**Note**

Modeling the dataset as it was before led to lots of converging issues that couldn't be easily resolved. Now we are using a modified dataset, d, to model the data.

**Testing Models and Covariates**

```{r}
# test mixed effect model
model <- lmer(num_flew~sex_c*host_c + (1|population), data=d)
tidy_regression(model, is_color=output_col)
getME(model, "lower")
```

**Experimental, Biological, and Morphological Effects**

```{r, echo=FALSE}
####### Can't test chamber, test date, or test time any more

####### (Strong) Effect of average mass
tidy_regression(glm(num_flew~average_mass, data=d), is_color=output_col)

####### Effect of number of eggs laid
tidy_regression(glm(num_flew~total_eggs, data=d), is_color=output_col)

####### Can't test eggs_b b/c it's date specific

####### Effect of beak length
tidy_regression(glm(num_flew~beak_c, data=d), is_color=output_col)

####### Effect of thorax length
tidy_regression(glm(num_flew~thorax_c, data=d), is_color=output_col)

####### Effect of body length
tidy_regression(glm(num_flew~body_c, data=d), is_color=output_col)

####### No effect of wing length
tidy_regression(glm(num_flew~wing_c, data=d), is_color=output_col)

####### Effect of wing morph - don't include it
#tidy_regression(glm(num_flew~w_morph_c, data=d), is_color=output_col)

```

#### Without Mass

```{r message=FALSE}
R = d$num_flew
A = d$host_c
B = d$sex_c
C = d$sym_dist
D = d$average_mass 
X = d$population

data<-data.frame(R, A, B, C, D, X)

source("src/compare_models.R")
errors <- withWarnings(model_comparisonsAIC("src/generic models-gaussian glmer 1-RF + 3-FF.R"))
length(errors$warnings)
```

```{r}
anova(m2, m4, test="Chisq") # Adding A marginally improves fit
anova(m2, m6, test="Chisq") # Adding C does not improve fit
anova(m4, m8, test="Chisq") # Adding A*B improves fit...
```

```{r}
nomass_model <- lmer(num_flew ~ sex_c + (1|population), data=d)
tidy_regression(nomass_model, is_color=output_col)
```

* strong negative effect of sex where if F then less number of times will fly

#### With Mass 

```{r message=FALSE}
source("src/compare_models.R")
errors <- withWarnings(model_comparisonsAIC("src/generic models-gaussian glmer 1-RF + 4-FF.R"))
length(errors$warnings) 
```

```{r}
anova(m26, m50, test="Chisq") # Adding B*D does not improve fit
```

```{r}
mass_model <- lmer(num_flew ~ host_c * average_mass + sex_c + (1|population), data=d)
tidy_regression(mass_model, is_color=output_col)
```

* if from GRT then less times will fly. 
* no effect of average mass
* if F then less times will fly
* (marginal) if from GRT and heavier then more times will fly

#### Morphology 

```{r}
d <- d %>%
  filter(!is.na(body))
d$thorax_c <- d$thorax - mean(d$thorax)
d$wing_c <- d$wing - mean(d$wing)
d$body_c <- d$body - mean(d$body)

R = d$num_flew
A = d$thorax_c
B = d$body_c
C = d$wing_c 
X = d$population

data<-data.frame(R, A, B, C, X)

source("src/compare_models.R")
errors <- withWarnings(model_comparisonsAIC("src/generic models-gaussian glmer 1-RF + 3-FF.R"))
length(errors$warnings)
```

```{r}
anova(m5, m7, test="Chisq") # Adding C improves fit
anova(m7, m12, test="Chisq") # Adding A*C marginally improves fit
anova(m7, m13, test="Chisq") # Addding B*C improves fit
```

```{r}
morph_model <- lmer(num_flew ~ body_c * wing_c + thorax_c + (1 | population), data=d)
tidy_regression(morph_model, is_color=output_col)
```
* no effect of body
* strong positive effect of wing where the longer the wing, the more times the bug flies
* strong negative effect of thorax where the wider the thorax, the less times the bug flies
* marginal negative effect of of body*wing where the longer the body and wing, the less times the bug flies

```{r}
R = d$num_flew
A = d$thorax_c
B = d$wing2body_c
X = d$population

data<-data.frame(R, A, B, X)

source("src/compare_models.R")
errors <- withWarnings(model_comparisonsAIC("src/generic models-gaussian glmer 1-RF + 2-FF.R"))
length(errors$warnings)
```

```{r}
morph_model <- lmer(num_flew ~ wing2body_c * thorax_c + (1 | population), data=d)
tidy_regression(morph_model, is_color=output_col)
```

* strong positive effect of wing2body where the greater the ratio the more times a bug flies
* negative effect of thorax where the the wider the thorax the less times a bug flies
* no negative effect of wing2body*thorax 


Q? Testing out models that combine most of the independent variables:

```{r}
R = d$num_flew
A = d$thorax_c
B = d$wing2body_c
C = d$average_mass
X = d$population

data<-data.frame(R, A, B, C, X)

source("src/compare_models.R")
errors <- withWarnings(model_comparisonsAIC("src/generic models-gaussian glmer 1-RF + 3-FF.R"))
length(errors$warnings)
```


```{r}
R = d$num_flew
A = d$thorax_c
B = d$wing2body_c
C = d$sex_c
X = d$population

data<-data.frame(R, A, B, C, X)

source("src/compare_models.R")
errors <- withWarnings(model_comparisonsAIC("src/generic models-gaussian glmer 1-RF + 3-FF.R"))
length(errors$warnings)
```



### All Trials - Old Method

**Testing Models and Covariates**

```{r}
# test mixed effect model
model <- glmer(flew_b~sex_c*host_c + (1|ID) + (1|trial_type), data=data_tested, family=binomial)
summary(model)
getME(model, "lower")
```

**Experimental Set-Up Effects**

```{r, echo=FALSE}
####### No effect of chamber
tidy_regression(glm(flew_b~chamber, data=data_tested, family=binomial), is_color=output_col)

####### Effect of test date (but no effect of test date when you split between T1 and T2)
tidy_regression(glm(flew_b~days_from_start_c, data=data_tested, family=binomial), is_color=output_col)

####### No effect of test time
tidy_regression(glm(flew_b~min_from_IncStart_c, data=data_tested, family=binomial), is_color=output_col)
```

**Biological Effects**

```{r, echo=FALSE}
####### (Strong) Effect of mass
tidy_regression(glm(flew_b~mass_c, data=data_tested, family=binomial), is_color=output_col)

####### Effect of number of eggs laid
tidy_regression(glm(flew_b~total_eggs, data=data_tested, family=binomial), is_color=output_col)

####### Effect of whether eggs were laid or not
tidy_regression(glm(flew_b~eggs_b, data=data_tested, family=binomial), is_color=output_col)
```

**Morphology Effects**

```{r, echo=FALSE}
####### Effect of beak length
tidy_regression(glm(flew_b~beak_c, data=data_tested, family=binomial), is_color=output_col)

####### Effect of thorax length
tidy_regression(glm(flew_b~thorax_c, data=data_tested, family=binomial), is_color=output_col)

####### Effect of body length
tidy_regression(glm(flew_b~body_c, data=data_tested, family=binomial), is_color=output_col)

####### No effect of wing length
tidy_regression(glm(flew_b~wing_c, data=data_tested, family=binomial), is_color=output_col)

####### No effect of wing morph (check how annotated the wing morph) - don't include it
#tidy_regression_bw(glm(flew_b~w_morph_c, data=data_all, family=binomial))
```

**Summary:** Effect of days_from_start, mass, eggs, beak length, thorax length, and body length.

#### Without Mass (Test)

```{r}
# Remove any missing masses
data_tested <- data_tested %>%
  filter(!is.na(mass))
data_tested <- center_data(data_tested)

R = data_tested$flew_b
A = data_tested$host_c
B = data_tested$sex_c
C = data_tested$sym_dist
D = data_tested$mass_c 
X = data_tested$ID
Y = data_tested$trial_type

data<-data.frame(R, A, B, C, D, X, Y)

source("src/compare_models.R")
errors <- withWarnings(model_comparisonsAIC("src/generic models-binomial glmer 2 RF + 3-FF.R"))
length(errors$warnings) # 10 models did not converge
```

```{r}
anova(m42, m46, test="Chisq") # Adding A*B improves fit
```

```{r}
all_model<-glmer(flew_b~sex_c*host_c + (1|ID) + (1|trial_type), family=binomial, data=data_tested)
tidy_regression(all_model, is_color=output_col)
```

* strong negative effect of sex where if F then less likely to fly
* no effect of host
* marginal positive effect of sex*host where if F and form GRT then more likely to fly

#### With Mass (Test)

```{r}
# source("src/compare_models.R")
# model_comparisonsAIC("src/generic models-binomial glmer 2-RF + 4-FF.R")
# too many models failed to even keep running
```

#### Morphology 

```{r}
data_tested <- data_tested %>%
  filter(!is.na(body))
data_tested <- center_data(data_tested)

R = data_tested$flew_b
A = data_tested$thorax_c
B = data_tested$body_c
C = data_tested$wing_c 
X = data_tested$ID
Y = data_tested$trial_type

data<-data.frame(R, A, B, C, X, Y)

source("src/compare_models.R")
errors <- withWarnings(model_comparisonsAIC("src/generic models-binomial glmer 2 RF + 3-FF.R"))
cat("Number of models that failed to converge:", length(errors$warnings)) # 13 models did not converge
```

```{r}
anova(m51, m53, test="Chisq") # Adding A*B improves fit
```

```{r}
morph_model<-glmer(flew_b~ thorax_c * body_c + body_c * wing_c + (1|ID), family=binomial, data=data_tested) # model failed to converge when both trial_type and ID
tidy_regression(morph_model, is_color=output_col) 
```

```{r}
R = data_tested$flew_b
A = data_tested$thorax_c
B = data_tested$wing2body_c
X = data_tested$ID
Y = data_tested$trial_type

data<-data.frame(R, A, B, C, X, Y)

source("src/compare_models.R")
errors <- withWarnings(model_comparisonsAIC("src/generic models-binomial glmer 2-RF + 2-FF.R"))
cat("Number of models that failed to converge:", length(errors$warnings)) 
```

```{r}
anova(m13, m14, test="Chisq") # Adding A*B marginally improves fit
```

```{r}
morph_model<-glmer(flew_b~ thorax_c * wing2body_c + (1|trial_type) + (1|ID), family=binomial, data=data_tested)
tidy_regression(morph_model, is_color=output_col) # coefficients are huge...
```


### Trial 1

[Cleaning Data](#clean_data)

[Testing Covariates](#exp_effects)

[Testing glmer() with pop and chamber](#glmertesting1)

[Without Mass Modeling](#without_mass)

[With Mass Modeling](#with_mass)

[Morphology Modeling](#morph1)

<a id="clean_data"></a>

**Cleaning the Data**

```{r}
rm(list=ls())
output_col = FALSE 
source("src/clean_flight_data.R") 
source("src/regression_output.R") 
source("src/center_flight_data.R")
source("get_warnings.R")

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]

data_T1 <-data_tested[data_tested$trial_type=="T1",]
data_T1 <- center_data(data_T1)
```

<a id="exp_effects"></a>

**Experimental Set-Up Effects**

```{r echo=FALSE}
####### No effect of chamber
tidy_regression(glm(flew_b~chamber, data=data_T1, family=binomial), is_color=output_col)

####### No effect of test date
tidy_regression(glm(flew_b~days_from_start_c, data=data_T1, family=binomial), is_color=output_col)

####### No effect of test time
tidy_regression(glm(flew_b~min_from_IncStart, data=data_T1, family=binomial), is_color=output_col)
```

**Biological Effects**

```{r, echo=FALSE}
####### (Strong) Effect of mass
tidy_regression(glm(flew_b~mass_c, data=data_T1, family=binomial), is_color=output_col)
```

**Morphology Effects**

```{r, echo=FALSE}
####### Effect of beak length
tidy_regression(glm(flew_b~beak_c, data=data_T1, family=binomial), is_color=output_col)

####### Effect of thorax length
tidy_regression(glm(flew_b~thorax_c, data=data_T1, family=binomial), is_color=output_col)

####### No effect of body length
tidy_regression(glm(flew_b~body_c, data=data_T1, family=binomial), is_color=output_col)

####### No effect of wing length
tidy_regression(glm(flew_b~wing_c, data=data_T1, family=binomial), is_color=output_col)
```

<a id="glmertesting1"></a>

**Glmer() Testing Notes**

(1|chamber) as a random effect does not need to be included in the Trial 1 glmer() analyses because in all cases the variance is essentially 0. What pops up if you do try glmer on the best fit model? A singular fit error is raised: “When you obtain a singular fit, this is often indicating that the model is overfitted – that is, the random effects structure is too complex to be supported by the data, which naturally leads to the advice to remove the most complex part of the random effects structure (usually random slopes). The benefit of this approach is that it leads to a more parsimonious (conservative) model that is not over-fitted.” Source: https://stats.stackexchange.com/questions/378939/dealing-with-singular-fit-in-mixed-models

However, (1|population) and (1|days_from_start_c) does matter when doing the morphology analyses in Trial 1, and will not throw an error because the variance is large enough to change the fit of a model.

<a id="without_mass"></a>

#### Without Mass

```{r}
# Remove any missing masses
data_T1 <- data_T1 %>%
  filter(!is.na(mass))
data_T1 <- center_data(data_T1)

R = data_T1$flew_b
A = data_T1$host_c
B = data_T1$sex_c
C = data_T1$sym_dist
D = data_T1$mass_c 

data<-data.frame(R, A, B, C, D)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 3-FF.R")
```

```{r}
anova(m8, m11, test="Chisq") ## Adding C does not improve fit
anova(m11, m15, test="Chisq") ## Adding B*C interaction does not improve fit
anova(m11, m14, test="Chisq") ## Adding A*C interaction does not improve fit 
```

```{r}
model_T1<-glm(flew_b~sex_c*host_c, family=binomial, data=data_T1)
tidy_regression(model_T1, is_color=output_col)
```
* strong negative effect of sex, where if you are female you are less likely to fly.
* no longer an effect of host or distance from sympatric zone. (last season there was)
* strong positive effect of sex and host where if female and from GRT, then less likely to fly.

**Before adding mass, we can see that:**

* Being female strongly reduces your chances of flying
* Being from K. elegans reduces the negative effects of being female on flight
* No direct effect of host plant

```{r}
model_T1_cov<-glm(flew_b~host_c*sex_c + mass_c, family=binomial, data=data_T1)
tidy_regression(model_T1_cov, is_color=output_col)
```

* strong negative effect of mass that subsumes the sex effect
* no direct effect of host plant
* no direct effect of sex
* host*sex interaction shows a strong positive effect, such that if from GRT and are female then more likely to be dispersive

<a id="with_mass"></a>

#### With Mass

```{r}
source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 4-FF.R")
```

```{r}
anova(m51, m63, test="Chisq") # Adding B does not improve fit
```

```{r}
model_T1_m <- glm(flew_b~host_c*mass_c + sex_c, family=binomial, data=data_T1)
tidy_regression(model_T1_m, is_color=output_col)
```

What this basically looks like is if you have sex* host, you don't need mass*host, and vice-versa, but you need one.

* no longer a strong negative effect of being far from the sympatric zone 
* no effect of host plant
* strong negative effect of mass and has a large coefficient, where the heavier the bug is the much less likely the bug will fly
* host*sex interaction shows a strong positive effect, such that if from GRT and are female then more likely to be dispersive
* marginal effect of sex, where if you are female you are less likely to fly

```{r}
model_T1_m <- glm(flew_b~host_c*mass_c + sym_dist*mass_c, family=binomial, data=data_T1)
tidy_regression(model_T1_m, is_color=output_col)
```

<a id="morph1"></a>

#### Morphology 

```{r}
data_T1 <-data_tested[data_tested$trial_type=="T1",]
data_T1 <- data_T1 %>%
  filter(!is.na(body))
data_T1 <- center_data(data_T1)

R = data_T1$flew_b
A = data_T1$thorax_c
B = data_T1$body_c
C = data_T1$wing_c 

data<-data.frame(R, A, B, C)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 3-FF.R")
```

```{r}
anova(m13, m18, test="Chisq") # Adding A*B does not improve fit
anova(m7, m13, test="Chisq") # Adding B*C marginally improves fit
```


```{r}
morph_model <- glm(flew_b ~ body_c * wing_c + thorax_c, family = binomial, data = data_T1)
tidy_regression(morph_model, is_color=output_col)
```

* maringal negative effect of body wher ethe larger the body the less likely to fly
* strong positive effect of wing length where the longer the wing, the more likely to fly
* storng negative effect of thorax where the larger the thorasxs, the less likely to fly

* no effect of body*wing (we know body and wing are closely related so they could be canceling each other out (b/c body is a proxi for mass))

```{r}
morph_modelglmer <- glmer(formula = flew_b ~  body_c * wing_c + thorax_c + (1| population), family = binomial, data = data_T1) 
tidy_regression(morph_modelglmer, is_color=output_col) # did change the coefficients slightly, but not a better fit
```

### Trial 2

[Cleaning Data](#clean)

[Testing Covariates](#experimental_effects)

[Testing glmer() with pop and chamber](#glmertesting2)

[Without Mass Modeling](#wo_mass)

[With Mass Modeling](#w_mass)

[Morphology Modeling](#morph2)

<a id="clean"></a>

**Cleaning the Data**

```{r}
rm(list=ls())
output_col = FALSE 
source("src/clean_flight_data.R") 
source("src/regression_output.R") 
source("src/center_flight_data.R")
source("get_warnings.R")

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]

data_T2 <-data_tested[data_tested$trial_type=="T2",]
data_T2 <- center_data(data_T2)
```

<a id="experimental_effects"></a>

**Experimental Set-Up Effects**

```{r echo=FALSE}
####### No effect of chamber
tidy_regression(glm(flew_b~chamber, data=data_T2, family=binomial), is_color=output_col)

####### No effect of test date
tidy_regression(glm(flew_b~days_from_start_c, data=data_T2, family=binomial), is_color=output_col)

####### No effect of test time
tidy_regression(glm(flew_b~min_from_IncStart, data=data_T2, family=binomial), is_color=output_col)
```

**Biological Effects**

```{r, echo=FALSE}
####### (Strong) Effect of mass
tidy_regression(glm(flew_b~mass_c, data=data_T2, family=binomial), is_color=output_col)
```

**Morphology Effects**

```{r, echo=FALSE}
####### Effect of beak length
tidy_regression(glm(flew_b~beak_c, data=data_T2, family=binomial), is_color=output_col)

####### Effect of thorax length
tidy_regression(glm(flew_b~thorax_c, data=data_T2, family=binomial), is_color=output_col)

####### Effect of body length
tidy_regression(glm(flew_b~body_c, data=data_T2, family=binomial), is_color=output_col)

####### No effect of wing length
tidy_regression(glm(flew_b~wing_c, data=data_T2, family=binomial), is_color=output_col)
```

<a id="wo_mass"></a>

<a id="glmertesting2"></a>

**Glmer() Testing Notes**

(1|population) + (1|chamber) as random effects do not need to be included in the Trial 2 glmer() mass and no mass analyses because in all cases the variance is essentially 0. What pops up if you do try glmer on the best fit model? A singular fit error is raised. Refer to the reasoning in Trial 1.

However, no error is thrown when included in the morphology analyses.

#### Without Mass

```{r}
R = data_T2$flew_b
A = data_T2$host_c
B = data_T2$sex_c
C = data_T2$sym_dist
D = data_T2$mass_c # as a covariate 

data<-data.frame(R, A, B, C, D)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 3-FF.R")
```

```{r}
anova(m2, m4, test="Chisq") # Adding A does not improve fit
anova(m2, m6, test="Chisq") # Adding C does not improve fit
anova(m4, m7, test="Chisq") # Adding C does not improve fit
anova(m6, m7, test="Chisq") # Adding A does not improve fit
anova(m4, m8, test="Chisq") # Adding an A*B interaction term does not improve fit
anova(m6, m10, test="Chisq") # Adding a B*C interaction term does not improve fit
```

```{r}
model_T2 <-glm(flew_b~sex_c, family=binomial, data=data_T2)
tidy_regression(model_T2, is_color=output_col)
```

* sex is the only significant and strong effect, so that if you are female you are much less likely to disperse/fly

<a id="w_mass"></a>

#### With Mass

```{r}
source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 4-FF.R")
```

```{r}
anova(m4, m7, test="Chisq") # Adding A does not improve fit
anova(m7, m12, test="Chisq") # Adding B does not improve fit
anova(m4, m9, test="Chisq") # Adding B does not improve fit
```

```{r}
model_T2_mass <-glm(flew_b~mass_c, family=binomial, data=data_T2)
tidy_regression(model_T2_mass, is_color=output_col)
```

* mass is the only significant and extremely strong effect, so that if you are heavy you are much less likely to disperse/fly

Mass is really dominating everything, so let's split by sex after looking at Trial 2.

<a id="morph2"></a>

#### Morphology 

```{r}
# Remove any missing masses and morphology measurements
data_T2 <- data_T2 %>%
  filter(!is.na(mass))  %>%
  filter(!is.na(body))

data_T2 <- center_data(data_T2)

R = data_T2$flew_b
A = data_T2$thorax_c
B = data_T2$body_c
C = data_T2$wing_c 

data<-data.frame(R, A, B, C)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 3-FF.R")
```

```{r}
morph_model_T2 <- glm(flew_b ~ thorax_c * wing_c + body_c * wing_c, family = binomial, data = data_T2)
tidy_regression(morph_model_T2, is_color=output_col)
```

* negative marginal effect of thorax, where the wider the thorax, the then bug less likely to fly
* positive effect of wing length, where if wing longer then bug more likely to fly
* negative effect of body, where the longer the body the less likely the bug is to fly

* positive effect of thorax:wing where the wider the thorax and wing the more likely the bug is to fly *(this encapsulates overall flight power in a way b/c thorax muscles and wing length)*
* negative effect of wing and body where the longer the wing and body the less likely the bug is to fly *(this encapsulates mass limitations)*

```{r}
morph_model_T2glmer <- glmer(flew_b ~ thorax_c * wing_c + body_c * wing_c + (1|chamber), family = binomial, data = data_T2) # (1|days_from_start_c) and (1|population)variance = 0, chamber did not have variance at 0
tidy_regression(morph_model_T2glmer, is_color=output_col) # changed coefficients slightly, but did not improve the fit of the model.
```

### Females

[Cleaning Data](#cleanup_data)

[Testing Covariates](#expset-up_effects)

[Without Mass Modeling](#without.mass)

[With Mass Modeling](#with.mass)

* [glmer() A=host, B=mass, C=wing, X=ID](#glmer)

[Eggs Modeling](#eggs)

* [glmer() A=host, B=wing_c, C=mass, D=eggs_b, X=ID](#glmer_eggs)

[Morphology Modeling](#morph_fem)

* [glmer() A=thorax, B=body, C=wing X=trial_type](#glmer_morph)

<a id="cleanup_data"></a>

**Cleaning the Data**

```{r}
rm(list=ls())
output_col = FALSE 
source("src/clean_flight_data.R") 
source("src/regression_output.R") 
source("src/center_flight_data.R")
source("get_warnings.R")

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]

data_fem <- data_tested[data_tested$sex=="F",]
data_fem <- center_data(data_fem)
```

<a id="expset-up_effects"></a>

**Experimental Set-Up Effects**

```{r echo=FALSE}
####### Marginal effect of chamber B-4 (ah this again!)
tidy_regression(glm(flew_b~chamber, data=data_fem, family=binomial), is_color=output_col)

####### No effect of test date
tidy_regression(glm(flew_b~days_from_start, data=data_fem, family=binomial), is_color=output_col)

####### No effect of test time
tidy_regression(glm(flew_b~min_from_IncStart, data=data_fem, family=binomial), is_color=output_col)
```

**Biological Effects**

```{r echo=FALSE}
####### (Strong) Effect of mass  
tidy_regression(glm(flew_b~mass_c, data=data_fem, family=binomial), is_color=output_col)

####### Effect of number of eggs laid
tidy_regression(glm(flew_b~total_eggs_c, data=data_fem, family=binomial), is_color=output_col) 

####### Effect of whether eggs were laid or not
tidy_regression(glm(flew_b~eggs_b, data=data_fem, family=binomial), is_color=output_col) 
```

**Morphology Effects**

```{r echo=FALSE}
####### Effect of beak length
tidy_regression(glm(flew_b~beak_c, data=data_fem, family=binomial), is_color=output_col)  

####### No effect of thorax length
tidy_regression(glm(flew_b~thorax_c, data=data_fem, family=binomial), is_color=output_col) 

####### Effect of body length
tidy_regression(glm(flew_b~body_c, data=data_fem, family=binomial), is_color=output_col) 

####### Effect of wing length
tidy_regression(glm(flew_b~wing_c, data=data_fem, family=binomial), is_color=output_col) 
```

<a id="without.mass"></a>

#### Without Mass

```{r}
R = data_fem$flew_b
A = data_fem$host_c
B = data_fem$wing_c # before had sym_dist but now leave out because did not have significant effects or interactions within the total model dataset.
C = data_fem$mass_c

data<-data.frame(R, A, B, C)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 2-FF.R")
```

```{r}
anova(m0, m1, test="Chisq") # Adding A does not improve fit
anova(m0, m2, test="Chisq") # Adding B does improve fit
anova(m1, m3, test="Chisq") # Adding B does improve improve fit
anova(m2, m3, test="Chisq") # Adding A does not improve fit
```

```{r echo=FALSE}
model_fem <-glm(flew_b~wing_c, family=binomial, data=data_fem)
tidy_regression(model_fem, is_color=output_col) 
```

* positive effect of wing length where the longer the wing then female more likely to fly.

<a id="with.mass"></a>

#### With Mass

```{r}
data_fem <- data_tested[data_tested$sex=="F",]
data_fem <- data_fem %>%
  filter(!is.na(mass))
data_fem <- center_data(data_fem)

R = data_fem$flew_b
A = data_fem$host_c
B = data_fem$wing_c # used to be sym_dis
C = data_fem$mass_c

data<-data.frame(R, A, B, C)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 3-FF.R")
```

```{r}
anova(m3, m6, test="Chisq") # Adding B does improve fit
anova(m3, m5, test="Chisq") # Adding A does not improve fit
anova(m6, m7, test="Chisq") # Adding A does not improve fit
anova(m6, m10, test="Chisq") # Adding B*C does not improve fit
```

```{r echo=FALSE}
model_fem_mass <-glm(flew_b~wing_c + mass_c, family=binomial, data=data_fem)
tidy_regression(model_fem_mass, is_color=output_col) 
```

* large negative effect of mass, where the heavier the bug is the less likely the bus will fly/disperse.
* positve effect of wing morph where the longer the wing then more likely to disperse.

<a id="glmer"></a>

#### Chamber B-4 was significant: Consider for females: A=host, B=mass, C=wing, X=ID

```{r}
R = data_fem$flew_b
A = data_fem$host_c
B = data_fem$mass_c
C = data_fem$wing_c # replaced sym_dist
X = data_fem$ID  # variance is zero if use trial_type | 3 models fail to converge if use ID

data<-data.frame(R, A, B, C, X)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glmer 1 RF + 3-FF.R") # here
```

```{r}
# top model if use ID:
model_fem_ME <-glmer(flew_b~host_c * mass_c + host_c * wing_c + (1 | ID), family=binomial, data=data_fem)
tidy_regression(model_fem_ME, is_color=output_col) 

# top model if use trial_type:
model_fem_ME <-glmer(flew_b~mass_c + wing_c + (1|trial_type), family=binomial, data=data_fem)
# if you replace trial_type with ID then you'll see the coefficients are way too huge and at different scales. Why?
tidy_regression(model_fem_ME, is_color=output_col) 
```

<a id="eggs"></a>

#### Eggs

```{r}
R = data_fem$flew_b
A = data_fem$host_c
B = data_fem$wing_c
C = data_fem$mass_c
D = data_fem$eggs_b
  
data<-data.frame(R, A, B, C, D)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 4-FF.R")
```

```{r}
fem_model<-glm(flew_b~wing_c + mass_c + eggs_b, family=binomial, data=data_fem)
tidy_regression(fem_model, is_color=output_col)
```

* Strong negative effect if laid eggs that day
* strong negative effect of mass
* positive effect of wing length

```{r}
ffem_model<-glmer(flew_b~wing_c + mass_c + eggs_b + (1|ID), family=binomial, data=data_fem) 
tidy_regression(ffem_model, is_color=output_col) # model fits better
```

still a strong negative effect if laid eggs that day but mass and wing length are no longer significant...

<a id="glmer_eggs"></a>

#### glmer() A=host, B=wing_c, C=mass, D=eggs_b, X=ID

```{r}
R = data_fem$flew_b
A = data_fem$host_c
B = data_fem$wing_c
C = data_fem$mass_c
D = data_fem$eggs_b
X = data_fem$ID
  
data<-data.frame(R, A, B, C, D, X)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-gaussian glmer 1-RF + 4-FF.R") # only 1 model failed to converge
```

But m53 fails to converge...

```{r}
anova(m21, m33, test="Chisq") # Adding B improves fits
```

```{r}
ffem_model<-glmer(flew_b~mass_c *eggs_b + wing_c + (1|ID), family=binomial, data=data_fem) 
tidy_regression(ffem_model, is_color=output_col) # model fits better
```

coefficients are extremely out of scale.
* negative effect of mass
* negative effect of eggs
*positive effect of wing
* positivie effect mass*eggs?? doesn't really make sense.


<a id="morph_fem"></a>

#### Morphology

```{r}
R = data_fem$flew_b
A = data_fem$thorax_c
B = data_fem$body_c
C = data_fem$wing_c 

data<-data.frame(R, A, B, C)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 3-FF.R")
```

```{r}
anova(m13, m16, test="Chisq") # Adding A*C improves fit
```

```{r}
morph_fem_model <- glm(flew_b ~ thorax_c * wing_c + body_c * wing_c, data=data_fem)
tidy_regression(morph_fem_model, is_color=output_col)
```
* no significant effects 

```{r}
morph_fem_modelglmer <- glmer(flew_b ~ thorax_c * wing_c + body_c * wing_c + (1|trial_type) + (1|chamber), data=data_fem, family=binomial) # variance of population and days_from_start_c = 0
morph_fem_modelglmer2 <- glmer(flew_b ~ thorax_c * wing_c + body_c * wing_c + (1|ID), data=data_fem, family=binomial)

tidy_regression(morph_fem_modelglmer, is_color=output_col) # better fitted model; coefficients changed a lot, and more significant
tidy_regression(morph_fem_modelglmer2, is_color=output_col) #even better fitted model; effects no longer significant and coefficients changed. 
# why so drastically different between the two?
```

**Trying wing2body**

```{r}
R = data_fem$flew_b
A = data_fem$thorax_c
B = data_fem$wing2body_c

data<-data.frame(R, A, B)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 2-FF.R")
```

```{r}
anova(m0, m2, test="Chisq") # Adding B marginally improves fit
anova(m2, m3, test="Chisq") # Adding A does not improve fit
```

```{r}
morph_fmodel <- glm(flew_b ~ wing2body_c, data=data_fem, family=binomial) # variance of population and days_from_start_c = 0
tidy_regression(morph_fmodel, is_color=output_col)
```

* strong marginal positive effect of wing2body where the larger the ration (the more wing than body), the more likely the female bug disperses

Worth running a glmer() script.

<a id="glmer_morph"></a>

#### Consider for females morph: A=thorax, B=body, C=wing X=trial_type

```{r}
R = data_fem$flew_b
A = data_fem$thorax_c
B = data_fem$body_c
C = data_fem$wing_c
X = data_fem$trial_type # rescale variables warning when replace trial type with ID as the sole RF
#Y = data_fem$ID # you would think it's the same as ID, but not
# you get a different set of top models if you use trial_type or ID

data<-data.frame(R, A, B, C, X)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glmer 1 RF + 3-FF.R")
```

```{r}
anova(m38, m40, test="Chisq") # adding B does not improve fit
anova(m38, m41, test="Chisq") # Adding C does not improve fit
anova(m38, m42, test="Chisq") # Adding A does not improve fit

anova(m13, m16, test="Chisq") # Adding A*C improves fit
```

```{r}
# when use ID and trial type as RFs get the null model as the top model
best.fem.morph <- glmer(flew_b ~  1 + (1|trial_type) + (1|ID), data=data_fem, family=binomial) 
tidy_regression(best.fem.morph, is_color=output_col) 
# when use only trial type as RF:
best.fem.morph <- glmer(flew_b ~  thorax_c * wing_c + body_c * wing_c + (1|trial_type), data=data_fem, family=binomial) 
tidy_regression(best.fem.morph, is_color=output_col) 
```

**Trying wing2body**

```{r}
R = data_fem$flew_b
A = data_fem$thorax_c
B = data_fem$wing2body_c
X = data_fem$trial_type # rescale variables warning when replace trial type with ID as the sole RF
Y = data_fem$ID # you would think it's the same as ID, but not
# you get a different set of top models if you use trial_type or ID

data<-data.frame(R, A, B, X, Y)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glmer 2-RF + 2-FF.R")
```

```{r}
anova(m0, m2, test="Chisq") # Adding A marginally imprvoes fit
anova(m2, m3, test="Chisq") # Adding B does not improve fit

anova(m10, m11, test="Chisq") # Adding A does not improve fit
anova(m10, m12, test="Chisq") # Adding B does not improve fit
```

```{r}
# best fit model if only use trial type as RF:
best.fem.morph <- glmer(flew_b ~  wing2body_c + (1|trial_type), data=data_fem, family=binomial) 
tidy_regression(best.fem.morph, is_color=output_col) 
# best fit model is the null if use both trial type and ID as RFs: 
best.fem.morph <- glmer(flew_b ~  1 + (1|trial_type) + (1|ID), data=data_fem, family=binomial) 
tidy_regression(best.fem.morph, is_color=output_col) 
```


### Males

[Cleaning Data](#cleanup_d)

[Testing Covariates](#expsetup_effects)

[Without Mass Modeling + Days From Start](#no.mass)

[With Mass Modeling + Days From Start](#mass)

[Morphology Modeling](#male_morph)

* [glmer() A=thorax, B=body, C=wing, D=days_from_start, X=ID, Y=trial_type](#morph_glmer)

* [glmer() A=wing2body, B=thorax, C=days_from_start, X=ID, Y=trial_type](#morph_glmer3)

<a id="cleanup_d"></a>

**Cleaning Data**

```{r}
rm(list=ls())
output_col = FALSE 
source("src/clean_flight_data.R") 
source("src/regression_output.R") 
source("src/center_flight_data.R")
source("get_warnings.R")

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]

data_male <- data_tested[data_tested$sex=="M",]
data_male <- center_data(data_male)
```

<a id="expsetup_effects"></a>

**Experimental Set-Up Effects**

```{r echo=FALSE}
####### No effect of chamber
tidy_regression(glm(flew_b~chamber, data=data_male, family=binomial), is_color=output_col)

####### Effect of test date (as seen in the data_all)
tidy_regression(glm(flew_b~days_from_start_c, data=data_male, family=binomial), is_color=output_col)

####### No effect of test time (but close p = 0.09443)
tidy_regression(glm(flew_b~min_from_IncStart, data=data_male, family=binomial), is_color=output_col)

# seems like males are very time sensitive
```

**Biological Effects**

```{r echo=FALSE}
####### (Strong) Effect of mass 
tidy_regression(glm(flew_b~mass_c, data=data_male, family=binomial), is_color=output_col) 
```

**Morphology Effects**

```{r echo=FALSE}
####### No effect of beak length
tidy_regression(glm(flew_b~beak_c, data=data_male, family=binomial), is_color=output_col)

####### No effect of thorax length
tidy_regression(glm(flew_b~thorax_c, data=data_male, family=binomial), is_color=output_col) 

####### Marginal effect of body length
tidy_regression(glm(flew_b~body_c, data=data_male, family=binomial), is_color=output_col) 

####### Effect of wing length
tidy_regression(glm(flew_b~wing_c, data=data_male, family=binomial), is_color=output_col) 
```

<a id="no.mass"></a>

#### Without Mass + Days From Start

```{r}
# Remove any missing masses
data_male <- data_male %>%
  filter(!is.na(mass))
data_male <- center_data(data_male)

R = data_male$flew_b
A = data_male$host_c
B = data_male$days_from_start_c
C = data_male$mass_c 

data<-data.frame(R, A, B, C)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 2-FF.R")
```

```{r}
anova(m3, m4, test="Chisq") # Adding A*B does not improve fit
```

```{r echo=FALSE}
model_male<-glm(flew_b~host_c + days_from_start_c, family=binomial, data=data_male)
tidy_regression(model_male, is_color=output_col)
```

* Negative effect if from GRT
* Negative effect of days from start where the farther out the day from the start of the experiment (e.g. maybe a proxi for age), the less likely the male bug is to fly

```{r}
## Consider covariates
model_male_final <-glmer(flew_b~host_c + days_from_start_c + (1|population) + (1|trial_type), family=binomial, data=data_male) 
tidy_regression(model_male_final, is_color=output_col)
## Changed the effect slightly, did not improve the model, and made host not significant...
```

<a id="mass"></a>

#### With Mass + Days From Start

```{r}
source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 3-FF.R")
```

```{r}
anova(m7, m11, test="Chisq") # Adding A*B does not improve fit
```

```{r echo=FALSE}
model_male_mass <-glm(flew_b~host_c + mass_c + days_from_start_c, family=binomial, data=data_male)
tidy_regression(model_male_mass, is_color=output_col)
```

* Strong negative effect if from GRT
* Strong negative effect of mass, that if weigh more then less likely to disperse
* negative effect of days from start where the farther out the day from the start of the experiment (e.g. maybe a proxi for age), the less likely the male bug is to fly

```{r}
## Consider covariates
model_male_mass_final <-glmer(flew_b~host_c + mass_c + days_from_start_c + (1|population) + (1|trial_type), family=binomial, data=data_male) # no error, but singular fit error 

tidy_regression(model_male_mass_final, is_color=output_col)
## Changed the effects slightly and in turn made host not significant but not a better fitting model.
```

<a id="male_morph"></a>

#### Morphology

```{r}
data_male <- data_tested[data_tested$sex=="M",]
data_male <- data_male %>%
  filter(!is.na(mass)) %>%
  filter(!is.na(body))
data_male <- center_data(data_male)

R = data_male$flew_b
A = data_male$thorax_c
B = data_male$body_c
C = data_male$wing_c 

data<-data.frame(R, A, B, C)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glm 3-FF.R")
```

```{r}
anova(m10, m13, test="Chisq") # Adding A*C marginally improves fit
```

```{r}
male_morph<-glm(flew_b~body_c* wing_c + thorax_c, family=binomial, data=data_male) 
tidy_regression(male_morph, is_color=output_col) 
```

* no effect of body length
* marginal negative effect of thorax length, where if longer thorax then less likely to fly
* marginal positive effect of wing length, where if longer wing then more likely to fly

* negative effect of body*wing where if longer body and wing then less likely to fly

```{r}
male_morph.glmer <- glmer(flew_b ~ body_c* wing_c + thorax_c + (1|ID) + (1|trial_type), family=binomial, data=data_male) 
tidy_regression(male_morph.glmer, is_color=output_col) # model improves fit and it converges!
```
* no effect of body length
* no effect of wing length
* marginal negative effect of thorax length, where if longer thorax then less likely to fly

* negative effect of body*wing where if longer body and wing then less likely to fly

<a id="morph_glmer"></a>

#### glmer() A=thorax, B=body, C=wing, D=days_from_start, X=ID, Y=trial_type

```{r message=FALSE}
R = data_male$flew_b
A = data_male$thorax_c 
B = data_male$body_c
C = data_male$wing_c 
D = data_male$days_from_start_c 
X = data_male$ID # only one model failed to converge when ID as RF
Y = data_male$trial_type # 9 modles failed to converge when both RFs

data<-data.frame(R, A, B, C, D, X, Y)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glmer 2-RF + 4-FF-noD-interactions.R")
```

```{r}
anova(m24, m27, test="Chisq") # Adding A marginally improves fit
anova(m22, m26, test="Chisq") # ADding B does not improve fit
```

```{r}
male_morph.glmer <- glmer(flew_b ~ thorax_c * wing_c + days_from_start_c + (1 | ID) , family=binomial, data=data_male) 
tidy_regression(male_morph.glmer, is_color=output_col) 
```

<a id="morph_glmer3"></a>

#### glmer() A=wing2body, B=thorax, C=days_from_start, X=ID, Y=trial_type

```{r}
# left off here
R = data_male$flew_b
A = data_male$wing2body_c 
B = data_male$thorax_c
C = data_male$days_from_start_c 
X = data_male$ID 
Y = data_male$trial_type 

data<-data.frame(R, A, B, C, X, Y)

source("src/compare_models.R")
model_comparisonsAIC("src/generic models-binomial glmer 2 RF + 3-FF-noCinteractions.R")
```

```{r}
anova(m5, m7, test="Chisq") # Adding B does not improve fit
anova(m5, m24, test="Chisq") # Adding Y does not improve fit
```

```{r}
male_morph.glmer <- glmer(flew_b ~ wing2body_c + days_from_start_c + (1 | ID), family=binomial, data=data_male) 
tidy_regression(male_morph.glmer, is_color=output_col) 
```

* strong positive effect of wing2body, where if you have more wing to body, then more likely to fly
* negative effect of days from start, where farther out in days from the start day, the less likely you are to fly.
