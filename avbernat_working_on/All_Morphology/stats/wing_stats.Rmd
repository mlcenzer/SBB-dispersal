---
title: "All Morphology: Wing Statistics"
date: "2/18/2021"
output:
  html_document:
    toc: True
    theme: united
---

```{r setup, include=FALSE}
rm(list=ls())
library(lme4)
library(zoo)
library(rethinking)

library(lubridate)

library(dplyr)
library(ggplotify)
library(gridExtra)
library(ggformula)
library(tidyselect)

dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/All_Morphology/stats/"
setwd(dir)

knitr::opts_chunk$set(echo = TRUE)
```

Base statistics of all morphology for wing morph and wing2body ratio (in long-winged bugs).

Conclusion from the wing_timeseries.Rmd: Found no significant temporal dependencies. Determined that most time series were nonstationary and all ts were an AR(0) process [white noise with moving average]. Concluded that the time values were independent of each other.

## Sourcing Scripts and Cleaning the Data

```{r}
source_path = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/Rsrc/"

script_names = c("compare_models.R",
                 "regression_output.R", 
                 "clean_morph_data2.R", # two functions: read_morph_data and remove_torn_wings
                 "AICprobabilities.R")

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}

source("~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/RSsrc/spatial_dependencies.R") # space
```

```{r}
data_list <- read_morph_data("data/allmorphology04.30.21-coors.csv")
raw_data = data_list[[1]]
data_long = data_list[[2]]
```

## Checking for Outliers 

```{r}
dotplot = function(var, data) {
  plot(data[,var], seq(1:nrow(data)),
       col=data$color, ylab="Order of the data from text file", xlab=paste0("Value of ", var))
}
```

```{r}
# remove NA dates
d = data_long %>%
  filter(!is.na(wing2body))

range(d$wing2body) 
```

```{r}
MyVar <- c("wing2body", "wing2thorax", "body", "wing", "beak", "thorax", "lat", "long") 
d$color = "black"
d$color[d$year == "2019" & d$month =="May"] = "red"

par(mfrow=c(3,3))
for (v in MyVar) {
  dotplot(v, d)
}

# remove outliers?
d2 = d %>% 
  filter(!beak<4.5) %>%
  filter(!wing2body <0.62) # 

par(mfrow=c(3,3))
for (v in MyVar) {
  dotplot(v, d2)
}
```

Wing overmeasured? Body measured too small? Probably the body measured off? wing seems off.

## Wing Morph

### Infer missing wing morph values

```{r}
raw_data_missing = raw_data %>%
  filter(w_morph=="" | is.na(w_morph)) # had 30 that are hard to identify as either S or L based on the wing2thorax thresholds.
raw_data_missing # need to determine the morph of these bugs manually. In the long term...need to do this manually because the boundaries of what is defined as a morph can change over time.
```

```{r}
par(mfrow=c(3,1))
hist(raw_data$wing[raw_data$w_morph=="L"]/raw_data$thorax[raw_data$w_morph=="L"],
     main="Histogram of wing length/thorax length for long winged SBB",
     xlab="wing length/thorax length",
      breaks=seq(0.5, 3.8, by=0.05))
hist(raw_data_missing$wing/raw_data_missing$thorax, 
      main="Histogram of wing length/thorax length for SBB w/o recorded wing morph",
      xlab="wing length/thorax length",
      breaks=seq(0.5, 3.8, by=0.05))
hist(raw_data$wing[raw_data$w_morph=="S"]/raw_data$thorax[raw_data$w_morph=="S"],
      main="Histogram of wing length/thorax length for short winged SBB",
      xlab="wing length/thorax length",
      breaks=seq(0.5,3.8,by=0.05))
```

### Plotting Data Points Across Time and Group

Grouping the data for group counts.

```{r}
raw_data %>% group_by(sex, 
                  datetime) %>% 
  summarize(count = n())
```

Checking over bug numbers per season.

```{r}
#raw_data[raw_data$year =="2020",]  #476 survived shipment, so I"m guessing that about 103 bugs did not survive shipment but were still measured for morphology?
#raw_data[raw_data$year =="2019" & raw_data$month=="October",] #similar here. 372 bugs measured but 207 survived. So that means that 165 bugs did not survive and were still measured for morph. 
```

Plotting the histograms.

```{r}
data = raw_data
data$population[data$population=="Ft.Myers"]<-"Ft. Myers"
data$population[data$population=="Key_Largo"]<-"Key Largo"
data$population[data$population=="Lake_Placid"]<-"Lake Placid"
data$population[data$population=="Lake_Wales"]<-"Lake Wales"
data$population[data$population=="North_Key_Largo"]<-"North Key Largo"
data$population[data$population=="Plantation_Key"]<-"Plantation Key"

data$pophost[data$pophost=="C.corindum"]<-"C. corindum"
data$pophost[data$pophost=="K.elegans"]<-"K. elegans"

data = data[order(-data$lat),] 
#lat_order = unique(data$population) # should work but lat and long not right so need to do it manually:
lat_order = c("Gainesville", "Leesburg", "Lake Wales", "Lake Placid", "Ft. Myers",  "Homestead",  "North Key Largo", "Key Largo", "Plantation Key")
data$population = as.factor(data$population)
data$population = factor(data$population,levels=lat_order)
```

```{r echo=FALSE, fig.width=3.5, fig.height=2.3}
# order the histogram by latitude and change some colors 

#hist(data$year, main="Numbers Collected", xlab="Year")

colors = c("#787a87", "#E69F00", "#56B4E9",
           "royalblue", "grey", "gold", 
           "#409973", "#9bc969", "ivory2") # the keys

p = ggplot(data=subset(data, !is.na(datetime)), aes(x=datetime, fill=population)) + 
    geom_bar(position='stack', color="black", width=0.7) +
    theme_bw()
p1 = p + labs(title=" ", fill="Population",
         x="Field Collection Month", y = "Number of Bugs Collected")+
   scale_fill_manual(values=colors) +
   theme_classic() +theme(
     axis.text.y = element_text(size=11),
     axis.text.x=element_text(size=11, angle = 45, hjust = 1.1),
        axis.title=element_text(size=17,face="bold"))  +
theme(axis.title.x = element_text(vjust = -3)) +
theme(axis.title.y = element_text(vjust = 4)) +
  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))

p = ggplot(data=subset(data, !is.na(datetime)), aes(x=datetime, fill=pophost)) + 
    geom_bar(position='stack', color="black", width=0.7) +
    theme_bw()
p2 = p + labs(title=" ", fill="Host Plant",
         x="Field Collection Month", y = "Number of Bugs Collected")+
   scale_fill_manual(values=c("#56B4E9", "chartreuse4")) +
   theme_classic() + theme(
        axis.text.y = element_text(size=11),
        axis.text.x=element_text(size=11, angle = 45, hjust = 1.1), # 9
        axis.title=element_text(size=17,face="bold"))  +
theme(axis.title.x = element_text(vjust = -3)) +
theme(axis.title.y = element_text(vjust = 4)) +
  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))

p = ggplot(data=subset(data, !is.na(datetime)), aes(x=datetime, fill=sex)) + 
    geom_bar(position='stack', color="black", width=0.7) +
    theme_bw()
p3 = p + labs(title=" ", fill="Sex",
         x="Field Collection Month", y = "Number of Bugs Collected")+
   scale_fill_manual(values=c("salmon1", "darkslategray3")) +
   theme_classic() +theme(     
        axis.text.y = element_text(size=11),
        axis.text.x=element_text(size=11, angle = 45, hjust = 1.1), # 9
        axis.title=element_text(size=17,face="bold"))  +
theme(axis.title.x = element_text(vjust = -3)) +
theme(axis.title.y = element_text(vjust = 4)) +
  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))

p1
p2
p3
```

I have not removed the bugs with torn wings yet. 

### Binomial Regressions

What determines wing morph using all the data? Does sex? host plant? month of the year?

#### Testing time covariates

```{r}
m = glm(wing_morph_binom ~ months_since_start, data=raw_data, family="binomial")
tidy_regression(m, is_color=FALSE)
m = glm(wing_morph_binom ~ month_of_year, data=raw_data, family="binomial")
tidy_regression(m, is_color=FALSE)
```

```{r}
data<-data.frame(R=raw_data$wing_morph_binom, 
                 A=raw_data$sex_binom, 
                 B=raw_data$pophost_binom, 
                 C=(raw_data$month_of_year),
                 D=raw_data$months_since_start)

model_script = paste0(source_path,"generic models-binomial glm 3-FF.R")
model_comparisonsAIC(model_script)
```

```{r  results = "hold"}
anova(m13, m15, test="Chisq") # Adding A*B does not improve fit
anova(m7, m13, test="Chisq") # Adding B*C marginally improves fit
anova(m5, m7, test="Chisq")
anova(m6, m7, test="Chisq")
anova(m4, m7, test="Chisq")
```

```{r}
m = glm(wing_morph_binom ~ sex_binom + pophost_binom + month_of_year, data=raw_data, family="binomial")
```

```{r}
tidy_regression(m, is_color=FALSE) # m7
```

Top model is m7
* Males are more likely to be long-winged.
* K.elegans more likely to be long-winged.
* (+) effect later in the season such that long wing morphs become increasingly likely later in the year. 

```{r}
temp = raw_data %>% 
  filter(!is.na(wing_morph_binom))

check_spatial_dependencies(m, temp, temp$long, temp$lat, zone = 16, cutoff=10000, is_glm=TRUE)
```

A **variogram** is used to display the variability between data points as a function of distance. Here, from distances 0 to 4000 m, the variability between points starts high and then decreases (the points become more similar) until it levels out because at some point the distance between data points will be great enough that the points are no longer considered to be related to each other. The variability will flatten out into a "sill".

No spatial dependencies for wing morph.

#### Best fit: Modeling all important covariates

```{r}
model_script = paste0(source_path,"generic models-gaussian glm 4-FF.R")
model_comparisonsAIC(model_script)
```

```{r results="hold"}
anova(m98, m110, test="Chisq") # adding B*D does not improve fit
anova(m84, m98, test="Chisq") # adding A*B improves fit

anova(m63, m84, test="Chisq") # Adding C*D improves fit
anova(m51, m63, test="Chisq") # Adding B improves fit
```

```{r}
m = glm(wing_morph_binom ~ sex_binom * pophost_binom + sex_binom * months_since_start + pophost_binom * month_of_year + month_of_year * months_since_start, data=raw_data, family="binomial") # m98 top model
tidy_regression(m, is_color=FALSE)
```

* Males are more likely to be long-winged.
* K.elegans more likely to be long-winged.
* (+) effect of getting later in the season (month_of_year), such that long wing morphs become increasingly likely later in the year. 
* (+) effect of months_since_start, such that long wing morphs become increasingly likely across the decade.

* (+) effect of sex*host where if F and from K.elegans then more likely to be long-winged

* (+) effect of sex*months_since_start where if female and later in the decade then more likely to be long-winged
* (-) effect of pophost*month_of_year where if from C.corindum and later in the season, then more likely long wing morphs will be present

* weak (-) effect of month_of_year*months_since_start where the later in the year and later in the decade, the more likely short wing morphs will be present.

```{r}
# m = glm(wing_morph_binom ~ sex_binom*months_since_start + month_of_year*months_since_start + pophost_binom*month_of_year, data=raw_data, family="binomial") # m84 was the top model
```

```{r}
temp = raw_data %>%
  filter(!is.na(wing_morph_binom)) # filter out NA's that glm did automatically

check_spatial_dependencies(m, temp, temp$long, temp$lat, zone = 16, cutoff=10000, is_glm=TRUE)
```

Model validation looks fine. Nothing to worry about.


#### Let's see what impacts the long-wing morph variance:

```{r}
SE = function(x){sd(x)/sqrt(length(x))}
wmorph_summaryt<-aggregate(wing_morph_binom~sex_binom*pophost_binom*month_of_year*months_since_start, data=raw_data, FUN=mean)
wmorph_summaryt$sd<-aggregate(wing_morph_binom~sex_binom*pophost_binom*month_of_year*months_since_start, data=raw_data,
                          FUN=sd)$wing_morph_binom
wmorph_summaryt$se<-aggregate(wing_morph_binom~sex_binom*pophost_binom*month_of_year*months_since_start, data=raw_data,
                          FUN=SE)$wing_morph_binom
```

```{r}
data = wmorph_summaryt
data<-data.frame(R=data$sd, 
                 A=data$sex_binom, 
                 B=data$pophost_binom, 
                 C=(data$month_of_year),
                 D=data$months_since_start)

model_script = paste0(source_path,"generic models-gaussian glm 3-FF.R")
model_comparisonsAIC(model_script)
```

```{r}
anova(m2, m6, test="Chisq") # Adding C does not improve fit
anova(m2, m4, test="Chisq") # Adding B does not improve fit
anova(m0, m2, test="Chisq")
```

```{r}
m = glm(sd ~ pophost_binom, data=wmorph_summaryt, family="gaussian")
tidy_regression(m, is_color=FALSE) # -1 = C.corindum
```

only a (-) effect of pophost, where if from K.elegans then have less variation vs. if from C.cordinum have more variation.

```{r}
plot(m$fitted.values, m$residuals)
```

## Wing2Body

### Removing Torn Wings

```{r}
data_long = remove_torn_wings(data_long)
```

### Winter 2020 vs. other dates 

```{r}
data_long$compare_dates <- -1
data_long$compare_dates[data_long$months_since_start==81] <- 1

compare_dates_model <- glm(wing2body~compare_dates + pophost_binom*sex_binom, data=data_long)

tidy_regression(compare_dates_model, is_color=FALSE)
```

Yes, bugs from this collection date have detectably smaller wing2body ratios on average than other collection dates, even when controlling for sex and host plant.

```{r echo=FALSE}
# fig.width=3, fig.height=2.7,
par(mar = c(5, 5, 2, 0)) 
par(bty = 'n')
boxplot(wing2body~compare_dates,
        data=data_long, ylim=c(0.6,0.85),
        xlab = "collection date",
        ylab= "wing2body",
        col=c(col.alpha( "red" , alpha = 0.5), 
              col.alpha( "blue" , alpha = 0.5)),
        border="gray30",
        names=c("2013-2020", "Winter 2020"), pch=1,
        cex=1.56, cex.lab=1.8, cex.axis=1.56
)
means <- tapply(data_long$wing2body,data_long$compare_dates, mean, na.rm=TRUE)
points(means,pch=18, cex=2, col="white")
#title("(a)", adj = 0.05, line = 0, cex.main=1.8)
```

### Binomial Regressions

What effects wing2body ratio? sex? host plant? month of the year? months since start?

```{r}
data_long$wing2body_c = (data_long$wing2body-mean(data_long$wing2body, na.rm=TRUE))
data_long$month_of_year_c = (data_long$month_of_year-mean(data_long$month_of_year, na.rm=TRUE))
data_long$months_since_start_c = (data_long$months_since_start-mean(data_long$months_since_start, na.rm=TRUE))
```

```{r}
data<-data.frame(R=data_long$wing2body_c, # centered
                 A=data_long$sex_binom, # sex
                 B=data_long$pophost_binom, # host
                 C=data_long$month_of_year_c, 
                 D=data_long$months_since_start_c) 

model_script = paste0(source_path,"generic models-gaussian glm 3-FF.R")
model_comparisonsAIC(model_script)
```

```{r results="hold"}
anova(m15, m17, test="Chisq") # Adding A*C does not improve fit
anova(m11, m15, test="Chisq") # Adding B*C does not improve fit
anova(m11, m14, test="Chisq") # Adding A*C does not improve fit
anova(m8, m11, test="Chisq") # Adding C does improve fit
```

```{r}
m = glm(wing2body_c ~ sex_binom*pophost_binom + month_of_year_c, data=data_long, family=gaussian) 
tidy_regression(m, is_color=FALSE) # m11
```

* Males have larger wing2body ratios.
* K.elegans bugs have larger wing2body ratios.
* Females on K.elegans have longer wings than C.corindum females.
* wing2body ratios are increasing moderately towards the end of the year 

```{r}
temp = data_long %>% 
  filter(!is.na(wing2body_c))
```

```{r}
check_spatial_dependencies(m, temp, temp$long, temp$lat, zone = 16, cutoff=20000, is_glm=TRUE)
```
There might be some spatial dependencies for long wing freq because seeing clusters of red and clusters of black.

Also the variogram shows distances 0 to 10,000 m where the variability between points starts high and then decreases (the points become more similar) until it levels out because at some point the distance between data points will be great enough that the points are no longer considered to be related to each other. The variability will flatten out into a "sill".

Strange that it's decreases over distance. But if you do 20,000 m then see it begins to increase again.

```{r}
model_script = paste0(source_path,"generic models-gaussian glm 4-FF.R")
model_comparisonsAIC(model_script)
```

```{r}
anova(m22, m42, test="Chisq") # adding B*C does not improve fit
anova(m16, m22, test="Chisq") # adding C does improve fit # same top model as before
```

Same best fit model (no months_since_start effect). But can plot the positive effect of month of year on wing2body ratio. It looks cyclical by pophost and more linear by sex: 
                 
```{r}
wing2body_summary<-aggregate(wing2body~pophost*month_of_year, data=data_long, FUN=mean)
plot(wing2body~month_of_year, data=wing2body_summary, pch=19, col=c(1,2)[as.factor(pophost)])

wing2body_summary<-aggregate(wing2body~sex_binom*month_of_year, data=data_long, FUN=mean) # black is M; Red is F
plot(wing2body~month_of_year, data=wing2body_summary, pch=19, col=c(1,2)[as.factor(sex_binom)]) # black is C. ; Red is K.
```
These plots are plotted cleanly in the wing_plots.Rmd script.

#### Let's plot histograms and analyze the variance. Then model the variance.

```{r}
SE = function(x){sd(x)/sqrt(length(x))}
w2b_summaryt<-aggregate(wing2body~sex_binom*pophost_binom*month_of_year*months_since_start, data=data_long, FUN=mean)
w2b_summaryt$sd<-aggregate(wing2body~sex_binom*pophost_binom*month_of_year*months_since_start, data=data_long,
                          FUN=sd)$wing2body
w2b_summaryt$se<-aggregate(wing2body~sex_binom*pophost_binom*month_of_year*months_since_start, data=data_long,
                          FUN=SE)$wing2body
```

```{r}
data = w2b_summaryt
data<-data.frame(R=data$sd, 
                 A=data$sex_binom, 
                 B=data$pophost_binom, 
                 C=(data$month_of_year),
                 D=data$months_since_start)

model_script = paste0(source_path,"generic models-gaussian glm 3-FF.R")
model_comparisonsAIC(model_script)
```

```{r}
anova(m2, m6, test="Chisq")
anova(m0, m2, test="Chisq")
```


```{r}
m = glm(sd ~ pophost_binom, data=w2b_summaryt, family=gaussian) 
tidy_regression(m, is_color=FALSE)
```

Nothing seems to effect the w2b variance.

Plot the histograms between the sexes and conduct var tests.

```{r}
time_var_tests = function(d, print_test=FALSE) {
  
  months = sort(unique(d$month_of_year))
  month_labs <- c("Feb", "Apr", "May", "Aug", "Sept", "Oct", "Dec")

  table = matrix(nrow=length(months), ncol=9)
  i = 0
  for (m in months) {
    i = i + 1
    data = d[d$month_of_year==m, ]
  
    VAR = var.test(wing2body ~ sex, data = data) # F test to compare the variances of two samples from normal pops
    TTEST= t.test(wing2body ~ sex, data=data) # t.test to find significant difference between the means of two groups
    AOV = aov(wing2body ~ sex, data=data) # used to analyze the differences among means. 
    
    p = TukeyHSD(AOV)$sex[,"p adj"]
    diff = TukeyHSD(AOV)$sex[,"diff"]
    
    if (print_test) {
      print(month_labs[i])
      print("t.test")
      print(TTEST)
      print("anova")
      print(summary(AOV))
      print(TukeyHSD(AOV))
      cat("-------------------------------------------------")
    }
    
    # plot histograms
    h = data %>%
    ggplot( aes(x=wing2body, fill=sex)) +
      geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
      scale_fill_manual(values=c("#69b3a2", "#404080")) +
      labs(fill="")  + labs(title=month_labs[i])
    print(h)
    
    # populate matrix
    table[i,1] = month_labs[i]
    table[i,2] = "M-F"
    table[i,3] = round(diff,4)
    table[i,4] = round(p,5)
    table[i,5] = "M=-1 | F=1"
    table[i,6] = round(TTEST$statistic,4)
    table[i,7] = round(TTEST$p.value,5)
    table[i,8] = round(VAR$statistic,2)
    table[i,9] = round(VAR$p.value, 3)
  }
  colnames(table) = c("month","sex", "Tukey-diff", "p-val", "sex", "ttest", "p-val", "F-test", "p-val")
  return(table)
} 
```

```{r}
summary_table = time_var_tests(data_long)
summary_table
```

```{r}
y = summary_table[,"F-test"]
xlab = summary_table[, "month"]
x = sort(unique(d$month_of_year))

plot(x,y, ylab="F-test value", xlab="Month of Year", xaxt = "n", main="wing-to-body ~ sex")
axis(1, at=seq(min(x),max(x),2), labels=xlab[-5])
abline(h=1, col=2) # non-linear relationship where at the beginning of the year the variance between sexes is similar but then in spring it deviates a lot. In the summer the variance is similar and then towards the winter the variance deviates.
```

```{r}
time_var_tests = function(d, print_test=FALSE) {
  
  months = sort(unique(d$month_of_year))
  month_labs <- c("Feb", "Apr", "May", "Aug", "Sept", "Oct", "Dec")

  table = matrix(nrow=length(months), ncol=9)
  i = 0
  for (m in months) {
    i = i + 1
    data = d[d$month_of_year==m, ]
  
    VAR = var.test(wing2body ~ pophost, data = data) # F test to compare the variances of two samples from normal pops
    TTEST= t.test(wing2body ~ pophost, data=data) # t.test to find significant difference between the means of two groups
    AOV = aov(wing2body ~ pophost, data=data) # used to analyze the differences among means. 
    
    p = TukeyHSD(AOV)$pophost[,"p adj"]
    diff = TukeyHSD(AOV)$pophost[,"diff"]
    
    if (print_test) {
      print(month_labs[i])
      print("t.test")
      print(TTEST)
      print("anova")
      print(summary(AOV))
      print(TukeyHSD(AOV))
      cat("-------------------------------------------------")
    }
    
    # plot histograms
    h = data %>%
    ggplot( aes(x=wing2body, fill=pophost)) +
      geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
      scale_fill_manual(values=c("#69b3a2", "#404080")) +
      labs(fill="")  + labs(title=month_labs[i])
    print(h)
    
    # populate matrix
    table[i,1] = month_labs[i]
    table[i,2] = "GRT-BV"
    table[i,3] = round(diff,4)
    table[i,4] = round(p,5)
    table[i,5] = "GRT=1 | BV=-1"
    table[i,6] = round(TTEST$statistic,4)
    table[i,7] = round(TTEST$p.value,5)
    table[i,8] = round(VAR$statistic,2)
    table[i,9] = round(VAR$p.value, 3)
  }
  colnames(table) = c("month","sex", "Tukey-diff", "p-val", "sex", "ttest", "p-val", "F-test", "p-val")
  
  return(table)
} 
```

```{r}
summary_table = time_var_tests(data_long)
summary_table
```

```{r}
y = summary_table[,"F-test"]
xlab = summary_table[, "month"]
x = sort(unique(d$month_of_year))

plot(x,y, ylab="F-test value", xlab="Month of Year", xaxt = "n", main="wing-to-body ~ pophost")
axis(1, at=seq(min(x),max(x),2), labels=xlab[-5])
abline(h=1, col=2) # non-linear relationship where at the beginning of the year the variance between hostplants is similar but then in spring it deviates a lot. In the summer and winter the variance is similar. (GRT/BV var = F-test value where in Sept and Feb only months where GRT is higher and the rest is BV)
```





