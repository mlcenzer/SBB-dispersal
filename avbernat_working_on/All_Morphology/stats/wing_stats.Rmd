---
title: "All Morphology: Wing Statistics"
date: "2/18/2021"
output:
  html_document:
    toc: True
    theme: united
---

```{r setup, include=FALSE}
rm(list=ls())
library(lme4)
library(zoo)
library(rethinking)

library(lubridate)

library(dplyr)
library(ggplotify)
library(gridExtra)
library(ggformula)
library(tidyselect)

dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/All_Morphology/stats/"
setwd(dir)

knitr::opts_chunk$set(echo = TRUE)
```

Base statistics of all morphology for wing morph and wing2body ratio (in long-winged bugs).

## Sourcing Scripts and Cleaning the Data

```{r}
source_path = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/Rsrc/"

script_names = c("compare_models.R",
                 "regression_output.R", 
                 "clean_morph_data2.R", # two functions: read_morph_data and remove_torn_wings
                 "AICprobabilities.R")

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}

spatial_path = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/RSsrc/spatial_dependencies.R"
source(spatial_path)
```

```{r}
data_list <- read_morph_data("data/allmorphology04.26.21-coors2.csv")
raw_data = data_list[[1]]
data_long = data_list[[2]]
###remind yourself how the months are laid out
#cbind(data_long$month_of_year, data_long$month)
```

## Wing Morph

### Infer missing wing morph values

```{r}
raw_data_missing = raw_data %>%
  filter(w_morph=="" | is.na(w_morph)) # had 28 that are hard to identify as either S or L based on the wing2thorax thresholds.
raw_data_missing # need to determine the morph of these bugs manually. In the long term...need to do this manually because the boundaries of what is defined as a morph can change over time.
```

```{r}
par(mfrow=c(3,1))
hist(raw_data$wing[raw_data$w_morph=="L"]/raw_data$thorax[raw_data$w_morph=="L"],
     main="Histogram of wing length/thorax length for long winged SBB",
     xlab="wing length/thorax length",
      breaks=seq(0.5, 3.8, by=0.05))
hist(raw_data_missing$wing/raw_data_missing$thorax, 
      main="Histogram of wing length/thorax length for SBB w/o recorded wing morph",
      xlab="wing length/thorax length",
      breaks=seq(0.5, 3.8, by=0.05))
hist(raw_data$wing[raw_data$w_morph=="S"]/raw_data$thorax[raw_data$w_morph=="S"],
      main="Histogram of wing length/thorax length for short winged SBB",
      xlab="wing length/thorax length",
      breaks=seq(0.5,3.8,by=0.05))
```

### Plotting Data Points Across Time and Group

Grouping the data for group counts.

```{r}
raw_data %>% group_by(sex, 
                  datetime) %>% 
  summarize(count = n())
```

Checking over bug numbers per season.

```{r}
raw_data[raw_data$year =="2020",]  #476 survived shipment, so I"m guessing that about 103 bugs did not survive shipment but were still measured for morphology?
raw_data[raw_data$year =="2019" & raw_data$month=="October",] #similar here. 372 bugs measured but 207 survived. So that means that 165 bugs did not survive and were still measured for morph. 
```

Plotting the histograms.
```{r}
data = raw_data
data$population[data$population=="Ft.Myers"]<-"Ft. Myers"
data$population[data$population=="Key_Largo"]<-"Key Largo"
data$population[data$population=="Lake_Placid"]<-"Lake Placid"
data$population[data$population=="Lake_Wales"]<-"Lake Wales"
data$population[data$population=="North_Key_Largo"]<-"North Key Largo"
data$population[data$population=="Plantation_Key"]<-"Plantation Key"

data$pophost[data$pophost=="C.corindum"]<-"C. corindum"
data$pophost[data$pophost=="K.elegans"]<-"K. elegans"

data = data[order(-data$lat),] 
#lat_order = unique(data$population) # should work but lat and long not right so need to do it manually:
lat_order = c("Gainesville", "Leesburg", "Lake Wales", "Lake Placid", "Ft. Myers",  "Homestead",  "North Key Largo", "Key Largo", "Plantation Key")
data$population = as.factor(data$population)
data$population = factor(data$population,levels=lat_order)
```



```{r echo=FALSE, fig.width=3.5, fig.height=2.3}
# order the histogram by latitude and change some colors 

#hist(data$year, main="Numbers Collected", xlab="Year")

colors = c("#787a87", "#E69F00", "#56B4E9",
           "royalblue", "grey", "gold", 
           "#409973", "#9bc969", "ivory2") # the keys

p = ggplot(data=subset(data, !is.na(datetime)), aes(x=datetime, fill=population)) + 
    geom_bar(position='stack', color="black", width=0.7) +
    theme_bw()
p1 = p + labs(title=" ", fill="Population",
         x="Field Collection Month", y = "Number of Bugs Collected")+
   scale_fill_manual(values=colors) +
   theme_classic() +theme(
     axis.text.y = element_text(size=11),
     axis.text.x=element_text(size=11, angle = 45, hjust = 1.1),
        axis.title=element_text(size=17,face="bold"))  +
theme(axis.title.x = element_text(vjust = -3)) +
theme(axis.title.y = element_text(vjust = 4)) +
  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))

p = ggplot(data=subset(data, !is.na(datetime)), aes(x=datetime, fill=pophost)) + 
    geom_bar(position='stack', color="black", width=0.7) +
    theme_bw()
p2 = p + labs(title=" ", fill="Host Plant",
         x="Field Collection Month", y = "Number of Bugs Collected")+
   scale_fill_manual(values=c("#56B4E9", "chartreuse4")) +
   theme_classic() + theme(
        axis.text.y = element_text(size=11),
        axis.text.x=element_text(size=11, angle = 45, hjust = 1.1), # 9
        axis.title=element_text(size=17,face="bold"))  +
theme(axis.title.x = element_text(vjust = -3)) +
theme(axis.title.y = element_text(vjust = 4)) +
  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))

p = ggplot(data=subset(data, !is.na(datetime)), aes(x=datetime, fill=sex)) + 
    geom_bar(position='stack', color="black", width=0.7) +
    theme_bw()
p3 = p + labs(title=" ", fill="Sex",
         x="Field Collection Month", y = "Number of Bugs Collected")+
   scale_fill_manual(values=c("salmon1", "darkslategray3")) +
   theme_classic() +theme(     
        axis.text.y = element_text(size=11),
        axis.text.x=element_text(size=11, angle = 45, hjust = 1.1), # 9
        axis.title=element_text(size=17,face="bold"))  +
theme(axis.title.x = element_text(vjust = -3)) +
theme(axis.title.y = element_text(vjust = 4)) +
  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))

p1
p2
p3
```

I have not removed the bugs with torn wings yet. 

### Binomial Regressions

What determines wing morph using all the data? Does sex? host plant? month of the year?

```{r}
data<-data.frame(R=raw_data$wing_morph_binom, 
                 A=raw_data$sex_binom, 
                 B=raw_data$pophost_binom, 
                 C=(raw_data$month_of_year),
                 D=raw_data$months_since_start)

model_script = paste0(source_path,"generic models-binomial glm 3-FF.R")
model_comparisonsAIC(model_script)
```

```{r}
anova(m13, m15, test="Chisq") # Adding A*B does not improve fit
anova(m7, m13, test="Chisq") # Adding B*C marginally improves fit
anova(m5, m7, test="Chisq")
anova(m6, m7, test="Chisq")
anova(m4, m7, test="Chisq")
```

```{r}
m = glm(wing_morph_binom ~ sex_binom + pophost_binom + months_since_start, data=raw_data, family="binomial")
```

```{r}
tidy_regression(m, is_color=FALSE) # m7
```

Top model is m7
* Males are more likely to be long-winged.
* K.elegans more likely to be long-winged.
* No more an effect of months_since_start effect. Before had a (+) effect of getting later in the season (month_of_year), such that long wing morphs become increasingly likely later in the year. 

```{r}
temp = raw_data %>% 
  filter(!is.na(wing_morph_binom))
```

```{r}
check_spatial_dependencies(m, temp, temp$long, temp$lat, zone = 16, cutoff=10000)
```
No spatial dependencies for wing morph.

```{r}
model_script = paste0(source_path,"generic models-binomial glm 4-FF.R")
model_comparisonsAIC(model_script)
```

```{r}
anova(m98, m110, test="Chisq") # adding B*D does not improve fit
anova(m84, m98, test="Chisq") # adding A*B marginally improves fit

anova(m63, m84, test="Chisq") # Adding C*D improves fit
anova(m51, m63, test="Chisq") # Adding B improves fit
```

```{r}
m = glm(wing_morph_binom ~ sex_binom*months_since_start + month_of_year*months_since_start + pophost_binom*month_of_year, data=raw_data, family="binomial") # m84 top model
```

```{r}
tidy_regression(m, is_color=FALSE)
```

* Males are more likely to be long-winged.
* K.elegans more likely to be long-winged.
* (+) effect of getting later in the season (month_of_year), such that long wing morphs become increasingly likely later in the year. 
* (+) effect of months_since_start, such that long wing morphs become increasingly likely across the decade.
* (+) effect of sex*months_since_start where if female and later in the decade then more likely to be long-winged
* weak (-) effect of month_of_year and months_since_start where the later in the year and later in the decade, the more likely short wing morphs will be present.
* (-) effect of month of year and pophost where if from C.corindum and later in the season, then more likely long wing morphs will be present

### Model Validation 

```{r}
temp = raw_data %>%
  filter(!is.na(wing_morph_binom)) # filter out NA's that glm did automatically
```


```{r}
check_spatial_dependencies(m, temp, temp$long, temp$lat, zone = 16, cutoff=10000)
```

Don't see any spatial dependencies. 


## Wing2Body

### Removing Torn Wings

```{r}
data_long = remove_torn_wings(data_long)
```

### Winter 2020 vs. other dates 

```{r}
data_long$compare_dates <- -1
data_long$compare_dates[data_long$months_since_start==81] <- 1

compare_dates_model <- glm(wing2body~compare_dates + pophost_binom*sex_binom, data=data_long)

tidy_regression(compare_dates_model, is_color=FALSE)
```
Yes, bugs from this collection date have detectably smaller wing2body ratios on average than other collection dates, even when controlling for sex and host plant.

```{r echo=FALSE}
# fig.width=3, fig.height=2.7,
par(mar = c(5, 5, 2, 0)) 
par(bty = 'n')
boxplot(wing2body~compare_dates,
        data=data_long, ylim=c(0.6,0.85),
        xlab = "collection date",
        ylab= "wing2body",
        col=c(col.alpha( "red" , alpha = 0.5), 
              col.alpha( "blue" , alpha = 0.5)),
        border="gray30",
        names=c("2013-2020", "Winter 2020"), pch=1,
        cex=1.56, cex.lab=1.8, cex.axis=1.56
)
means <- tapply(data_long$wing2body,data_long$compare_dates, mean, na.rm=TRUE)
points(means,pch=18, cex=2, col="white")
#title("(a)", adj = 0.05, line = 0, cex.main=1.8)
```

### Binomial Regressions

What effects wing2body ratio? sex? host plant? month of the year? months since start?

```{r}
data_long$wing2body_c = (data_long$wing2body-mean(data_long$wing2body, na.rm=TRUE))
data_long$month_of_year_c = (data_long$month_of_year-mean(data_long$month_of_year, na.rm=TRUE))
data_long$months_since_start_c = (data_long$months_since_start-mean(data_long$months_since_start, na.rm=TRUE))
```

```{r}
data<-data.frame(R=data_long$wing2body_c, # centered
                 A=data_long$sex_binom, # sex
                 B=data_long$pophost_binom, # host
                 C=data_long$month_of_year_c, 
                 D=data_long$months_since_start_c) 

model_script = paste0(source_path,"generic models-gaussian glm 3-FF.R")
model_comparisonsAIC(model_script)
```

```{r}
anova(m15, m17, test="Chisq") # Adding A*C does not improve fit
anova(m11, m15, test="Chisq") # Adding B*C does not improve fit
anova(m8, m11, test="Chisq") # Adding C does improve fit
```

```{r}
m = glm(wing2body_c ~ sex_binom*pophost_binom + month_of_year_c, data=data_long, family=gaussian) 
tidy_regression(m, is_color=FALSE) # m11
```

* Males have larger wing2body ratios.
* K.elegans bugs have larger wing2body ratios.
* Females on K.elegans have longer wings than C.corindum females.
* wing2body ratios are increasing moderately towards the present 

```{r}
temp = data_long %>% 
  filter(!is.na(wing2body_c))
```

```{r}
check_spatial_dependencies(m, temp, temp$long, temp$lat, zone = 16, cutoff=10000)
```

There might be some spatial dependencies for long wing freq because seeing clusters of red and clusters of black.

```{r}
model_script = paste0(source_path,"generic models-gaussian glm 4-FF.R")
model_comparisonsAIC(model_script)
```

```{r}
anova(m22, m42, test="Chisq") # adding B*C does not improve fit
anova(m16, m22, test="Chisq") # adding C does improve fit # same top model as before
```

No months_since_start effect. But can plot the positive effect of month of year on wing2body ratio. It looks cyclical by pophost and more linear by sex: 

```{r}
wing2body_summary<-aggregate(wing2body~pophost*month_of_year, data=data_long, FUN=mean)
plot(wing2body~month_of_year, data=wing2body_summary, pch=19, col=c(1,2)[as.factor(pophost)])

wing2body_summary<-aggregate(wing2body~sex_binom*month_of_year, data=data_long, FUN=mean) # black is M; Red is F
plot(wing2body~month_of_year, data=wing2body_summary, pch=19, col=c(1,2)[as.factor(sex_binom)]) # black is C. ; Red is K.
```

```{r}
wing2body_summary<-aggregate(wing2body~sex_binom*pophost*month_of_year, data=data_long, FUN=mean)
plot(wing2body~month_of_year, data=wing2body_summary, pch=c(19,21)[as.factor(sex_binom)], col=c(2,3)[as.factor(pophost)]) 
# female open cirlces, males closed circles
# green K. elegans and red C. corindum
```

These plots are plotted cleanly in the wing_plots.Rmd script.

