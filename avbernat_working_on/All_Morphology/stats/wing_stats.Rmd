---
title: "All Morphology: Wing Statistics"
date: "2/18/2021"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
library(lme4)
library(zoo)
library(rethinking)

library(dplyr)
library(ggplotify)
library(gridExtra)
library(ggformula)
library(tidyselect)

dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/All_Morphology/stats/"
setwd(dir)

knitr::opts_chunk$set(echo = TRUE)
```

Base statistics of all morphology for wing morph and wing2body ratio (in long-winged bugs).

## Cleaning Data and Sourcing Scripts

```{r}
source_path = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/Rsrc/"

script_names = c("compare_models.R","regression_output.R", "clean_morph_data.R",
                 "AICprobabilities.R")

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}
```

### Read the data

```{r}
data_list <- read_morph_data("data/allmorphology9.21.20.csv")
raw_data = data_list[[1]]
data_long = data_list[[2]]
###remind yourself how the months are laid out
#cbind(data_long$month_of_year, data_long$month)
```

## Wing Morph

### Infer missing wing morph values

```{r}
raw_data_missing<-raw_data[raw_data$w_morph=="",]
```

```{r}
par(mfrow=c(3,1))

hist(raw_data$wing[raw_data$w_morph=="L"]/raw_data$thorax[raw_data$w_morph=="L"],
     main="Histogram of wing length/thorax length for long winged SBB",
     xlab="wing length/thorax length",
     breaks=seq(0.5,3.8,by=0.05))
hist(raw_data_missing$wing/raw_data_missing$thorax, 
      main="Histogram of wing length/thorax length for SBB w/o recorded wing morph",
      xlab="wing length/thorax length",
      breaks=seq(0.5, 3.8, by=0.05))
hist(raw_data$wing[raw_data$w_morph=="S"]/raw_data$thorax[raw_data$w_morph=="S"],
      main="Histogram of wing length/thorax length for short winged SBB",
      xlab="wing length/thorax length",
      breaks=seq(0.5,3.8,by=0.05))
```

### Plotting Data Points Across Time

```{r}
# Datetime
raw_data$date <- paste(raw_data$month, raw_data$year, sep="/")
raw_data$datetime <- as.yearmon(raw_data$date, "%B/%Y")
raw_data$datetime <- as.factor(raw_data$datetime)
n_missing_dates = nrow(raw_data[is.na(raw_data$datetime),])
cat("number of missing dates:", n_missing_dates)
```

```{r}
# merge May 2015 with April 2015 because very few bugs were collected in May 2015.
raw_data$date[raw_data$date == "May/2015"] = "April/2015"

raw_data$datetime <- as.yearmon(raw_data$date, "%B/%Y")
raw_data$datetime <- as.factor(raw_data$datetime)
raw_data
```

```{r}
raw_data %>% group_by(sex, 
                  datetime) %>% 
  summarize(count = n())
```


```{r echo=FALSE fig.width=4, fig.height=6}

#hist(raw_data$year, main="Numbers Collected", xlab="Year")

colors = c("#999999", "#E69F00", "#56B4E9",
           "ivory2", "gold", "royalblue4", "coral1", 
           "orange4", "palegreen4")

p = ggplot(data=subset(raw_data, !is.na(datetime)), aes(x=datetime, fill=population)) + 
    geom_bar(position='stack', color="black", width=0.7) +
    theme_bw()
p1 = p + labs(title=" ", fill="Population",
         x="Field Collection Month", y = "Number of Bugs Collected")+
   scale_fill_manual(values=colors) +
   theme_classic() +theme(
     axis.text.y = element_text(size=11),
     axis.text.x=element_text(size=11, angle = 45, hjust = 1.1),
        axis.title=element_text(size=17,face="bold"))  +
theme(axis.title.x = element_text(vjust = -3)) +
theme(axis.title.y = element_text(vjust = 4)) +
  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))

p = ggplot(data=subset(raw_data, !is.na(datetime)), aes(x=datetime, fill=pophost)) + 
    geom_bar(position='stack', color="black", width=0.7) +
    theme_bw()
p2 = p + labs(title=" ", fill="Host Plant",
         x="Field Collection Month", y = "Number of Bugs Collected")+
   scale_fill_manual(values=c("#56B4E9", "chartreuse4")) +
   theme_classic() + theme(
        axis.text.y = element_text(size=11),
        axis.text.x=element_text(size=11, angle = 45, hjust = 1.1), # 9
        axis.title=element_text(size=17,face="bold"))  +
theme(axis.title.x = element_text(vjust = -3)) +
theme(axis.title.y = element_text(vjust = 4)) +
  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))

p = ggplot(data=subset(raw_data, !is.na(datetime)), aes(x=datetime, fill=sex)) + 
    geom_bar(position='stack', color="black", width=0.7) +
    theme_bw()
p3 = p + labs(title=" ", fill="Sex",
         x="Field Collection Month", y = "Number of Bugs Collected")+
   scale_fill_manual(values=c("salmon1", "darkslategray3")) +
   theme_classic() +theme(     
        axis.text.y = element_text(size=11),
        axis.text.x=element_text(size=11, angle = 45, hjust = 1.1), # 9
        axis.title=element_text(size=17,face="bold"))  +
theme(axis.title.x = element_text(vjust = -3)) +
theme(axis.title.y = element_text(vjust = 4)) +
  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))

p1
p2
p3
```

### Binomial Regression: wing morph

```{r}
raw_data$wing2thorax <- raw_data$wing/raw_data$thorax

raw_data$w_morph[raw_data$w_morph=="" & raw_data$wing2thorax<=2.2]<-"S"
raw_data$w_morph[raw_data$w_morph=="" & raw_data$wing2thorax>=2.35]<-"L"

raw_data$w_morph_binom <- NA
raw_data$wing_morph_binom[raw_data$w_morph=="S"]<-0
raw_data$wing_morph_binom[raw_data$w_morph=="L"]<-1
raw_data$sex_binom <- -1
raw_data$sex_binom[raw_data$sex=="F"] <- 1
raw_data$pophost_binom <- -1
raw_data$pophost_binom[raw_data$pophost=="K.elegans"] <- 1

raw_data$month_of_year <- (raw_data$months_since_start+7)%%12+1
```

What determines wing morph using all the data? Does sex? host plant? month of the year?

```{r}
data<-data.frame(R=raw_data$wing_morph_binom, 
                 A=raw_data$sex_binom, 
                 B=raw_data$pophost_binom, 
                 C=(raw_data$month_of_year))

model_script = paste0(source_path,"generic models-binomial glm 3-FF.R")
model_comparisonsAIC(model_script)
```
* Males are more likely to be long-winged.
* K.elegans more likely to be long-winged.
* No effect of months_since_start.
* (-) effect of getting later in the season (month_of_year), such that short wing morphs become increasingly likely later in the year. 

```{r}
#summary(glm(wing_morph_binom ~ months_since_start, data=raw_data, family="binomial"))
tidy_regression(m7, is_color=FALSE)
#summary(m7)
```

## Wing2Body

### Cleaning data

```{r}
data_long<-raw_data[raw_data$w_morph=="L",]

###remove individuals with torn wings first.
data_long$drop <- FALSE

for(row in 1:nrow(data_long)){
	if(length(unlist(strsplit(strsplit(paste("test ", data_long$notes[row], " test", sep=""), "torn")[[1]], "wing")))>2){
		 #browser()	
		 data_long$drop[row] <- TRUE
		 }
}

data_long <- data_long[data_long$drop==FALSE,]

data_long$wing2body <- data_long$wing/as.numeric(data_long$body)
```


### Winter 2020 vs. other dates 

```{r}
data_long$compare_dates <- -1
data_long$compare_dates[data_long$months_since_start==81] <- 1

compare_dates_model <- glm(wing2body~compare_dates + pophost_binom*sex_binom, data=data_long)

tidy_regression(compare_dates_model, is_color=FALSE)
```
Yes, bugs from this collection date have detectably smaller wing2body ratios on average than other collection dates, even when controlling for sex and host plant.

```{r echo=FALSE}
# fig.width=3, fig.height=2.7,
par(mar = c(5, 5, 2, 0)) 
par(bty = 'n')
boxplot(wing2body~compare_dates,
        data=data_long, ylim=c(0.6,0.85),
        xlab = "collection date",
        ylab= "wing2body",
        col=c(col.alpha( "red" , alpha = 0.4 ), 
              col.alpha( "orange" , alpha = 0.4)),
        border="gray30",
        names=c("2013-2020", "Winter 2020"), pch=1,
        cex=1.56, cex.lab=1.8, cex.axis=1.56
)
means <- tapply(data_long$wing2body,data_long$compare_dates, mean, na.rm=TRUE)
points(means,pch=18, cex=2, col="white")
#title("(a)", adj = 0.05, line = 0, cex.main=1.8)
```

What effects wing2body ratio? sex? host plant? month of the year? months since start?

```{r}
data<-data.frame(R=(data_long$wing2body-mean(data_long$wing2body, na.rm=TRUE)), # centered
                 A=data_long$sex_binom, # sex
                 B=data_long$pophost_binom, # host
                 C=(data_long$month_of_year-mean(data_long$month_of_year, na.rm=TRUE)), 
                 D=(data_long$months_since_start-mean(data_long$months_since_start, na.rm=TRUE))) 

model_script = paste0(source_path,"generic models-gaussian glm 3-FF.R")
model_comparisonsAIC(model_script)
```

```{r}
anova(m15, m17, test="Chisq") # Adding A*C does not improve fit
anova(m11, m15, test="Chisq") # Adding B*C does improve fit
```
data<-data.frame(R=(data_long$wing2body-mean(data_long$wing2body, na.rm=TRUE)), # centered
                 A=data_long$sex_binom, # sex
                 B=data_long$pophost_binom, # host
                 C=(data_long$month_of_year-mean(data_long$month_of_year, na.rm=TRUE)), 
                 D=(data_long$months_since_start-mean(data_long$months_since_start, na.rm=TRUE))) 

```{r}
tidy_regression(m15, is_color=FALSE)
#summary(m15)
```

* Males have larger wing2body ratios.
* Females on K.elegans have longer wings than C.corindum females.
* K.elegans bugs have larger wing2body ratios.
* wing2body ratios are decreasing moderately towards the present 

* Possibly but **not** seen visually: There is a negative effect of month of year on wing length if you are from K.elegans.

```{r}
wing2body_summary<-aggregate(wing2body~pophost*month_of_year, data=data_long, FUN=mean)

plot(wing2body~month_of_year, data=wing2body_summary, pch=19, col=c(1,2)[as.factor(pophost)])
```

## Winter 2020

```{r}
rm(list=ls())
source_path = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/Rsrc/"

script_names = c("center_flight_data.R", # Needs to load first
                 "clean_flight_data.R",  # Script that loads and cleans up the data
                 "regression_output.R",
                 "clean_morph_data.R")  # Cleans up regression outputs, prints in color or B&W

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
  }
```

```{r}
##read in and clean up data
data_winter_full <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_winter_all <- data_winter_full[[1]]
data_winter_tested <- data_winter_full[[2]]

###for these analyses, morphology only
data_winter <- data_winter_tested[,c('beak','thorax', 'wing', 'body', 'w_morph', 'morph_notes')]

##load full dataset & pare to long-winged bugs only
data_list <- read_morph_data("data/allmorphology9.21.20.csv")
raw_data = data_list[[1]]
data_long = data_list[[2]]
```

```{r}
data_all_dates<-raw_data[raw_data$w_morph=="L",c('beak','thorax', 'wing', 'body', 'w_morph', 'notes')]
```

