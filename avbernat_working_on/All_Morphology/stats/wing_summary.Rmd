---
title: "Modeling Wing Morphology Summary File"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
rm(list=ls())

# set working directory
dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/"
#dir <- "~/Documents/GitHub/SBB-dispersal/avbernat_working_on/"
setwd(dir)
knitr::opts_knit$set(root.dir = dir)

knitr::opts_chunk$set(echo = TRUE)
```

# Data Cleaning And Exploration

## Read Libraries

```{r message=FALSE}
library(lme4) # fit regressions 
library(dplyr) # data manipulation 
library(ggformula) # ggplot plotting
library(cowplot) # ggplot helper functions to arrange multi-panel figures
library(binom) # binomial confidence intervals
```

## Read Source Files

```{r message=FALSE}
source_path = paste0(dir,"/Rsrc/")

script_names = c("compare_models.R", # 1 function: model_comparisonsAIC()
                 "clean_morph_data3.R", # 2 functions: read_morph_data(), remove_torn_wings()
                 "AICprobabilities.R") # 1 function: AICprobs()

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}

source(paste0(dir, "/RTsrc/vartests.R"))
```

## Read the Data

```{r}
data_list <- read_morph_data(paste0(dir,"All_Morphology/stats/data/allmorphology05.18.21.csv"))
raw_data = data_list[[1]]
data_long = data_list[[2]] # long-wing bugs only

data_long = remove_torn_wings(data_long)
```

## Histograms of Wing Morph Data 

&nbsp;

```{r fig.height=5.7, fig.width=6.6, echo=FALSE}
raw_data_missing = raw_data %>% 
  filter(w_morph=="" | is.na(w_morph)) 

par(mfrow=c(3,1))
hist(raw_data$wing[raw_data$w_morph=="L"]/raw_data$thorax[raw_data$w_morph=="L"],
     main="Histogram of wing length/thorax length for long winged SBB",
     xlab="wing length/thorax length",
     breaks=seq(0.5, 3.8, by=0.05))
hist(raw_data_missing$wing/raw_data_missing$thorax, 
     main="Histogram of wing length/thorax length for SBB w/o recorded wing morph",
     xlab="wing length/thorax length",
     breaks=seq(0.5, 3.8, by=0.05))
hist(raw_data$wing[raw_data$w_morph=="S"]/raw_data$thorax[raw_data$w_morph=="S"],
     main="Histogram of wing length/thorax length for short winged SBB",
     xlab="wing length/thorax length",
     breaks=seq(0.5,3.8,by=0.05))
```

Notice that there are 30 bugs that are hard to identify as either S or L. 

\newpage

## Barplots 

Bugs were collected on different years and months. These barplots show the bugs collected per **population**, **host plant**, and **sex** across the years and months.

```{r echo=FALSE}
# repeating plot features
customPlot = list(geom_bar(position='stack', color="black", width=0.7),
                  theme_classic(),
                  theme(axis.text.y = element_text(size=11),
                        axis.text.x=element_text(size=11, angle = 45, hjust = 1.1),
                        axis.title=element_text(size=17,face="bold")),
                  theme(axis.title.x = element_text(vjust = -3)),
                  theme(axis.title.y = element_text(vjust = 4)),
                  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm"))
                  )
```

### Plot 1: Collection numbers grouped by Population and Datetime

```{r message=FALSE, fig.height=4.1, fig.width=7.2, echo=FALSE}
pop_colors = c("#787a87", "#E69F00", "#56B4E9", "royalblue", 
               "grey", "gold", "#409973", "#9bc969", "ivory2") 

p1 = ggplot(data=subset(raw_data, !is.na(datetime)), aes(x=datetime, fill=population)) + 
  labs(title=" ", fill="Population", 
       x="Field Collection Month", y = "Number of Bugs Collected") +
  scale_fill_manual(values=pop_colors) + customPlot

groups = raw_data %>% 
  group_by(sex, datetime) %>% 
  summarize(count = n())

numF = paste0("F(", as.character(unlist(groups[1:10,3])), ")")
numM = paste0("M(", as.character(unlist(groups[11:20,3])), ")")
text = paste0(numF, "\n", numM)
p1 = p1 + annotate(geom="text", x=1, y=400, label=text[1],
              color="black", size=3) +
  annotate(geom="text", x=2, y=470, label=text[2],
           color="black", size=3) +
  annotate(geom="text", x=3, y=270, label=text[3],
           color="black", size=3) +
  annotate(geom="text", x=4, y=220, label=text[4],
           color="black", size=3) +
  annotate(geom="text", x=5, y=320, label=text[5],
           color="black", size=3) +
  annotate(geom="text", x=6, y=500, label=text[6],
           color="black", size=3) +
  annotate(geom="text", x=7, y=240, label=text[7],
           color="black", size=3) +
  annotate(geom="text", x=8, y=730, label=paste0("\n", text[8]),
           color="black", size=3) +
  annotate(geom="text", x=9, y=440, label=text[9],
           color="black", size=3) +
  annotate(geom="text", x=10, y=650, label=text[10],
           color="black", size=3)
p1
```

### Plot 2: Collection numbers grouped by Host Plant and Datetime

```{r fig.height=4.1, fig.width=7.2, echo=FALSE}
p2 = ggplot(data=subset(raw_data, !is.na(datetime)), aes(x=datetime, fill=pophost)) + 
  labs(title=" ", fill="Host Plant",
              x="Field Collection Month", y = "Number of Bugs Collected") +
  scale_fill_manual(values=c("#56B4E9", "chartreuse4")) + customPlot
p2
```

### Plot 3: Collection numbers grouped by Sex and Datetime

```{r fig.height=4.1, fig.width=7.2, echo=FALSE}
p3 = ggplot(data=subset(raw_data, !is.na(datetime)), aes(x=datetime, fill=sex)) + 
  labs(title=" ", fill="Sex",
              x="Field Collection Month", y = "Number of Bugs Collected") +
  scale_fill_manual(values=c("salmon1", "darkslategray3")) + customPlot
p3
```

&nbsp;

# Regression Modeling

## Long-Wing Morph Frequency

How does sex, host plant, month, and/or year effect whether a soapberry bug is long-winged (wing_morph_binom=1) or short-winged (wing_morph_binom=0)? 

```{r}
data<-data.frame(R=raw_data$wing_morph_binom, 
                 A=raw_data$sex_binom, 
                 B=raw_data$pophost_binom, 
                 C=(raw_data$month_of_year),
                 D=raw_data$months_since_start)

model_script = paste0(source_path,"generic models-binomial glm 4-FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r results = "hold"}
anova(m98, m110, test="Chisq") # adding B*D does not improve fit
anova(m84, m98, test="Chisq") # adding A*B improves fit
anova(m63, m84, test="Chisq") # Adding C*D improves fit
anova(m51, m63, test="Chisq") # Adding B improves fit
```

\newpage

## Best Fit

```{r}
M1 = glm(wing_morph_binom ~ sex_binom * pophost_binom + sex_binom * months_since_start +
           pophost_binom * month_of_year + month_of_year * months_since_start, 
         data=raw_data, family="binomial") 
summary(M1)
```

## Modeling Variance

In addition to modeling how sex, host plant, month, or year effects whether a soapberry bug is long-winged or short-winged, we modeled how those same factors affected the variance of wing morph.

```{r}
SE = function(x){sd(x)/sqrt(length(x))}
```

```{r}
wmorph_table<-aggregate(wing_morph_binom~sex_binom*pophost_binom*month_of_year*months_since_start, 
                           data=raw_data, FUN=mean)
wmorph_table$sd<-aggregate(wing_morph_binom~sex_binom*pophost_binom*month_of_year*months_since_start, 
                              data=raw_data,FUN=sd)$wing_morph_binom
wmorph_table$se<-aggregate(wing_morph_binom~sex_binom*pophost_binom*month_of_year*months_since_start, 
                              data=raw_data,FUN=SE)$wing_morph_binom
wmorph_table$n<-aggregate(wing_morph_binom~sex_binom*pophost_binom*month_of_year*months_since_start, 
                              data=raw_data,FUN=length)$wing_morph_binom
```

```{r}
data = wmorph_table
data<-data.frame(R=data$sd, 
                 A=data$sex_binom, 
                 B=data$pophost_binom, 
                 C=(data$month_of_year),
                 D=data$months_since_start)

model_script = paste0(source_path,"generic models-gaussian glm 4-FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r results = "hold"}
anova(m2, m5, test="Chisq") # Adding A does not improve fit
anova(m2, m8, test="Chisq") # Adding C does not improve fit
anova(m2, m9, test="Chisq") # Adding D does not improve fit
anova(m0, m2, test="Chisq") # Adding B improves fit
```

## Best Fit

```{r}
M2 = glm(sd ~ pophost_binom, data=wmorph_table, family="gaussian")
summary(M2) 
```

&nbsp;

## Wing-to-body Ratio 

How does sex, host plant, month, and/or year effect the wing-to-body ratio of long-winged soapberry bugs?

```{r}
data<-data.frame(R=data_long$wing2body_c, # centered
                 A=data_long$sex_binom,
                 B=data_long$pophost_binom,
                 C=data_long$month_of_year_c, # centered
                 D=data_long$months_since_start_c) # centered

model_script = paste0(source_path,"generic models-gaussian glm 4-FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r results = "hold"}
anova(m88, m58, test="Chisq") # Adding A*D marginally improves fit
anova(m76, m58, test="Chisq") # Adding C*D does not improve fit
anova(m88, m99, test="Chisq") # adding C*D does not improve fit
anova(m34, m58, test="Chisq") # Adding B*D improves fit
```

&nbsp;

## Best Fit

```{r}
M3 = glm(wing2body_c ~ sex_binom*pophost_binom + pophost_binom*months_since_start_c 
         + month_of_year_c, data=data_long, family=gaussian) 
summary(M3) 
```

&nbsp;

## Modeling Variance 

In addition to modeling how sex, host plant, month, or year effects the wing-to-body ratio of a soapberry bug, we modeled how those same factors affected the variance of wing-to-body ratio.

```{r}
w2b_table<-aggregate(wing2body~sex_binom*pophost_binom*month_of_year*months_since_start, 
                     data=data_long, FUN=mean)
w2b_table$sd<-aggregate(wing2body~sex_binom*pophost_binom*month_of_year*months_since_start, 
                           data=data_long, FUN=sd)$wing2body
w2b_table$se<-aggregate(wing2body~sex_binom*pophost_binom*month_of_year*months_since_start, 
                           data=data_long, FUN=SE)$wing2body
```

```{r}
data = w2b_table
data<-data.frame(R=data$sd, 
                 A=data$sex_binom, 
                 B=data$pophost_binom, 
                 C=(data$month_of_year),
                 D=data$months_since_start)

model_script = paste0(source_path,"generic models-gaussian glm 4-FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r results = "hold"}
anova(m8, m19, test="Chisq") # Adding B*C does not improve fit
anova(m2, m8, test="Chisq") # Adding C does not improve fit
anova(m0, m2, test="Chisq") # Adding B improves fit
```

## Best Fit

```{r}
M4 = glm(sd ~ pophost_binom, data=w2b_table, family=gaussian) 
summary(M4)
```

&nbsp;

# LOESS & Linear Regression Plots

```{r echo=FALSE}
# repeating plotting features
customPlot = list( theme_classic(),
                   theme(axis.text=element_text(size=13),
                         axis.title=element_text(size=16), 
                         plot.title=element_text(size=20),),
                   theme(legend.position = c(0.2, 0.9)),
                   theme(legend.title = element_text(size=14, face="italic"),
                         legend.text = element_text(size = 13, face="italic"))
)

xlab_years = na.omit(sort(unique(data_long$dates))[-2])
xlab_yrs = sort(unique(raw_data$dates))

xlab_allmonths = na.omit(sort(unique(data_long$month_of_year)))
xlab_months = xlab_allmonths[c(-2,-5)]
month_labs <- c("Feb", "May", "Aug", "Oct", "Dec")

hp_col_pts = c("turquoise3", "springgreen4")
hp_col_shade = c("turquoise3", "green")
hp_col_lines = c("skyblue2", "darkgreen")
sex_col_pts = c("brown3", "black")
sex_col_shade = c("brown1", "sienna4")
sex_col_lines = c("brown3", "black")
```

## Wing Morph Frequency

### Group significant elements 

```{r}
# function to calculate 95% confidence interval (CI). 
CI_95 <- function(x){qnorm(0.975)*sd(x)/sqrt(length(x))}
CI_95_binom_upper <- function(y) {binom.confint(x=sum(y, na.rm=TRUE), n=length(y[!is.na(y)]), 
                                                conf.level=0.95, methods='exact')$upper}
CI_95_binom_lower <- function(y) {binom.confint(x=sum(y, na.rm=TRUE), n=length(y[!is.na(y)]), 
                                                conf.level=0.95, methods='exact')$lower}
```

```{r}
# aggregate the full data and calculate standard error (SE), upper and lower CI, and sample size (n)
w_morph_summary<-aggregate(wing_morph_binom~sex*pophost*month_of_year*months_since_start
                           , data=raw_data, FUN=mean)
w_morph_summary$se<-aggregate(wing_morph_binom~sex*pophost*month_of_year*months_since_start
                              , data=raw_data, FUN=SE)$wing_morph_binom
w_morph_summary$upper<-aggregate(wing_morph_binom~sex*pophost*month_of_year*months_since_start
                              , data=raw_data, FUN=CI_95_binom_upper)$wing_morph_binom
w_morph_summary$lower<-aggregate(wing_morph_binom~sex*pophost*month_of_year*months_since_start
                              , data=raw_data, FUN=CI_95_binom_lower)$wing_morph_binom
w_morph_summary$n<-aggregate(wing_morph_binom~sex*pophost*month_of_year*months_since_start
                              , data=raw_data, FUN=length)$wing_morph_binom

jitter = runif(n=nrow(w_morph_summary), min=-0.1, max=0.1) # jitter points slightly
w_morph_summary$dates <- w_morph_summary$month_of_year + jitter

dd = w_morph_summary
```

### Check for LOESS Residuals 

```{r}
plot_lowess_residuals = function(lfit, x, y) {
  lfun <- approxfun(lfit)
  fitted <- lfun(x)
  resid <- y-fitted
  plot(fitted,resid)
  abline(h=0,col=8)
}
```

```{r fig.height=3.3}
l1 = lowess(dd$dates, dd$wing_morph_binom, f=0.4) # f = alpha, the smoother span

par(mfrow=c(1,2))
plot(dd$dates, dd$wing_morph_binom)
lines(l1, type = "l")
plot_lowess_residuals(l1, dd$dates, dd$wing_morph_binom)
```

### Figure: Panels A, B, C, D (long-wing morph freq with month) & E (long-wing morph freq with year)

```{r echo=FALSE}
# relevel factors for cleaner plotting
dd$pophost = factor(dd$pophost, levels = c("K. elegans", "C. corindum") )
dd$`Host Plant` = dd$pophost

dd$sex[dd$sex=="F"]<-"Females"
dd$sex[dd$sex=="M"]<-"Males"
dd$sex = factor(dd$sex, levels = c("Males", "Females") )
dd$`Sex` = dd$sex 
```

Note: Single-variate models or simpler models substituted best fit slope calculations below in order to avoid multiple interaction terms found in the best fit model. This led to cleaner glm line plotting.

```{r}
# single-variate model of month predicting wing morph
fit = glm(wing_morph_binom ~ month_of_year, family="binomial", data=raw_data)
xmonth <- seq(2,12, 0.01)
wing_probs <- predict(fit, list(month_of_year=xmonth), type="response")

# extract pvalue from best fit regression model
fit_pvalue = round(summary(M1)$coeff[,"Pr(>|z|)"][5],5)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
### Panels A and B

##MLC: I am in favor of dropping p4 and p5, as they are redundant with p6 and p7.

### host plant
p4 = ggplot() + 
  ggtitle("A") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_line(aes(x=xmonth, y=wing_probs), linetype = "dashed") +
  geom_smooth(data=dd, method="loess", 
              mapping = aes(x = month_of_year, y = wing_morph_binom, 
                            colour=`Host Plant`, fill=`Host Plant`)) + 
  geom_point(data=dd, mapping = aes(x = month_of_year, y = wing_morph_binom, colour=`Host Plant`)) +
  customPlot + 
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) + 
  ylim(0.3,1.2) 

### sex
p5 = ggplot() + 
  ggtitle("B") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_line(aes(x=xmonth, y=wing_probs), linetype = "dashed") +
  geom_smooth(data=dd, method="loess", 
              mapping = aes(x = month_of_year, y = wing_morph_binom, colour=Sex, fill=Sex)) + 
  geom_point(data=dd, mapping = aes(x = month_of_year, y = wing_morph_binom, colour=Sex)) +
  customPlot +
  scale_color_manual(values=c("Females" = sex_col_pts[1], "Males" = sex_col_pts[2])) +
  scale_fill_manual(values = c("Females" = sex_col_shade[1], "Males" = sex_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) + 
  ylim(0.3,1.2) + 
  theme(axis.title.y = element_blank()) 

# extract alpha, smoothing parameter, from LOESS regression(s)
alpha = paste("alpha[loess]==", ggplot_build(p5)$data[[3]]$alpha[1])
degree="lambda[loess]==0"

p4 = p4 + 
  annotate(geom="text", x=7.4, y=1.0, label=alpha, parse=TRUE) +
  annotate(geom="text", x=7.4, y=1.04, label=degree, parse=TRUE) +
  annotate(geom="text", x=5, y=0.718, label=pvalue, parse=TRUE) + 
  theme(legend.position = c(0.23, 0.95)) + 
  labs(x = " ", y = " ")

p5 = p5 + 
  annotate(geom="text", x=7.4, y=1.1, label=alpha, parse=TRUE) +
  annotate(geom="text", x=7.4, y=1.15, label=degree, parse=TRUE) +
  annotate(geom="text", x=5.5, y=1, label=pvalue, parse=TRUE) + 
  theme(legend.position = c(0.23, 0.95)) + 
  labs(x = " ", y = " ")
```

```{r echo=FALSE}
# group data by sex 
dfF = dd[dd$sex=="Females",]
dfM = dd[dd$sex=="Males",]
```

```{r echo=FALSE, message=FALSE}
# multi-variate model with month, sex, and host plant predicting wing morph
fit2 = glm(wing_morph_binom ~ sex_binom * pophost_binom + 
          pophost_binom * month_of_year, family = "binomial", data = raw_data)
xmon <- seq(2,12, 0.01)
set.seed(194842)
bsex = sample(c(-1,1), replace=TRUE, size=length(xmon))
bhost = sample(c(-1,1), replace=TRUE, size=length(xmon))
wprobs <- predict(fit2, list(sex_binom = bsex,
                                pophost_binom = bhost,
                                month_of_year = xmon), type="response")

pred = cbind(xmon, bsex, bhost, wprobs)
pred = as.data.frame(pred)

predFK = pred[pred$bhost==1 & pred$bsex==1,]
predFC = pred[pred$bhost==-1 & pred$bsex==1,]

predMK = pred[pred$bhost==1 & pred$bsex==-1,]
predMC = pred[pred$bhost==-1 & pred$bsex==-1,]

# extract pvalue from best fit regression model
fit_pvalue = round(summary(M1)$coeff[,"Pr(>|z|)"][6],4)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)
```


```{r echo=FALSE, message=FALSE}
### Panels C and D
##MLC: Data column additions should be relocated
raw_data$'Host Plant'=raw_data$pophost

### females & host plant
p6 = ggplot() + 
  ggtitle("C") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_line(aes(x=predFK$xmon, y=predFK$wprobs), linetype = "dashed", color=hp_col_lines[2]) +
  geom_line(aes(x=predFC$xmon, y=predFC$wprobs), linetype = "dashed", color=hp_col_lines[1]) +
  ##plotting shading as a function of full data set, NAs removed
  #geom_smooth(data=dtF, method="loess", span=0.8,
  #            mapping = aes(x = month_of_year, y = wing_morph_binom, colour=`Host Plant`, fill=`Host Plant`)) + 
  geom_smooth(data=raw_data[raw_data$sex=="F" & !is.na(raw_data$wing_morph_binom),], method="loess", span=0.8,
              mapping = aes(x = month_of_year, y = wing_morph_binom, colour=`Host Plant`, fill=`Host Plant`)) +
###MLC: I was interetwed in trying to plot each population as a different shape, but the 'shape' parameter here is very picky about not using more than 6 shape types and I am not familiar enough with ggplot to do it manually
  ###MLC: added 'size=n' to weight points by the sample size at each date - I think this helps explain the shapes a little bit
  geom_point(data=dfF, mapping = aes(x = month_of_year, y = wing_morph_binom, colour=`Host Plant`, size=n)) +
  customPlot + 
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) +
  ylim(0,1.3)


### males & host plant
p7 = ggplot() + 
  ggtitle("D") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_line(aes(x=predMK$xmon, y=predMK$wprobs), linetype = "dashed", color=hp_col_lines[2]) +
  geom_line(aes(x=predMC$xmon, y=predMC$wprobs), linetype = "dashed", color=hp_col_lines[1]) +
  #geom_smooth(data=dfM, method="loess", span=0.8,
  #            mapping = aes(x = month_of_year, y = wing_morph_binom, colour=`Host Plant`, fill=`Host Plant`)) +
  ##plotting shading as a function of full data set, NAs removed
  geom_smooth(data=raw_data[raw_data$sex=="M" & !is.na(raw_data$wing_morph_binom),], method="loess", span=0.8,
              mapping = aes(x = month_of_year, y = wing_morph_binom, colour=`pophost`, fill=`pophost`)) +
  geom_point(data=dfM, mapping = aes(x = month_of_year, y = wing_morph_binom, colour=`Host Plant`, size=n)) +
  customPlot + 
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) +
  ylim(0,1.3)

# extract alpha, smoothing parameter from LOESS regression(s)
alpha = paste("alpha[loess]==", ggplot_build(p7)$data[[4]]$alpha[1])
degree="lambda[loess]==0"

p6 = p6 + 
  #annotate(geom="text", x=10.7, y=1.3, label="Females", size=6, fontface = 'italic') + 
  annotate(geom="text", x=3.5, y=1.05, label="Females", size=6, fontface = 'italic') + 
  annotate(geom="text", x=10, y=1.1, label=alpha, parse=TRUE) +
  annotate(geom="text", x=10, y=1.17, label=degree, parse=TRUE) +
  annotate(geom="text", x=10, y=0.45, label=pvalue, parse=TRUE) + 
  theme(legend.position = "none") + 
  labs(x = " ", y = " ") +
  coord_cartesian(ylim=c(0.30,1.055))

p7 = p7 + 
  #annotate(geom="text", x=11, y=1.3, label="Males", size=6, fontface = 'italic') + 
  annotate(geom="text", x=3, y=1.05, label="Males", size=6, fontface = 'italic') + 
  annotate(geom="text", x=10, y=1.1, label=alpha, parse=TRUE) +
  annotate(geom="text", x=10, y=1.17, label=degree,parse=TRUE) +
  annotate(geom="text", x=10, y=0.45, label=pvalue, parse=TRUE) +
  theme(legend.position = "none") + 
  theme(axis.title.y = element_blank()) + 
  labs(x = " ", y = " ") +
  coord_cartesian(ylim=c(0.30,1.055))
```

```{r echo=FALSE}
# group data by sex 
wm_table<-aggregate(wing_morph_binom~dates*sex, data=raw_data, FUN=mean)
wm_table$n<-aggregate(wing_morph_binom~dates*sex, data=raw_data, FUN=length)$wing_morph_binom
dd = wm_table

dd$sex[dd$sex=="F"]<-"Females"
dd$sex[dd$sex=="M"]<-"Males"
dd$sex = factor(dd$sex, levels = c("Males", "Females") )
dd$`Sex` = dd$sex 

dF = dd[dd$sex=="Females",]
dM = dd[dd$sex=="Males",]
```

```{r}
# multi-variate model with year, sex, and host plant predicting wing morph
fit3 = glm(wing_morph_binom ~ sex_binom * dates, family = "binomial", data = raw_data)
xyr <- seq(sort(unique(dd$dates))[1],sort(unique(dd$dates))[10], 1)
set.seed(194842)
bsex = sample(c(-1,1), replace=TRUE, size=length(xyr))
bhost = sample(c(-1,1), replace=TRUE, size=length(xyr))
wprobs <- predict(fit3, list(sex_binom = bsex,
                                pophost_binom = bhost,
                                dates = xyr), type="response")

pred = cbind(xyr, bsex, bhost, wprobs)
pred = as.data.frame(pred)
pred$xyr = as.Date.numeric(pred$xyr)

predF = pred[pred$bsex==1,]
predM = pred[pred$bsex==-1,]

# extract pvalue from best fit regression model
fit_pvalue = round(summary(M1)$coeff[,"Pr(>|z|)"][7],3)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
### Panel F
##MLC: Data column additions should be relocated
raw_data$Sex=NA
raw_data$Sex[raw_data$sex=="F"]<-"Females"
raw_data$Sex[raw_data$sex=="M"]<-"Males"


p9 = ggplot() + 
  ggtitle("F") + xlab("Year") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_yrs, color="gainsboro") + 
  geom_line(aes(x=predF$xyr, y=predF$wprobs), linetype = "dashed", color=sex_col_lines[1], lwd=0.5) +
  geom_line(aes(x=predM$xyr, y=predM$wprobs), linetype = "dashed", color=sex_col_lines[2], lwd=0.5) +
  #geom_smooth(data=dd, method="loess", span=0.8,
  #            mapping = aes(x = dates, y = wing_morph_binom, colour=`Sex`, fill=`Sex`)) + 
  geom_smooth(data=raw_data[!is.na(raw_data$wing_morph_binom),], method="loess", span=0.8,
              mapping = aes(x = dates, y = wing_morph_binom, colour=`Sex`, fill=`Sex`)) + 
  geom_point(data=dd, mapping = aes(x = dates, y = wing_morph_binom, colour=`Sex`, size=n)) +
  customPlot + 
  scale_color_manual(values=c("Females" = sex_col_pts[1], "Males" = sex_col_pts[2])) +
  scale_fill_manual(values = c("Females" = sex_col_shade[1], "Males" = sex_col_shade[2])) +
  ylim(0,1) + # lower ylim value must be <=0 or 0s in the data will be marked as 'non-finite'
  # coord_cartesian(ylim=c(0.55,1)) +
  coord_cartesian(ylim=c(0.30,1.055)) +
  theme(legend.position = "none") 

##MLC: need to scoot legends to reflect 0,1 ylim

p9 = p9 +
  annotate(geom="text", x=xlab_yrs[7], y=1.05, label=alpha, parse=TRUE, size=6) +
  annotate(geom="text", x=xlab_yrs[7], y=1.12, label=degree, parse=TRUE, size=6) +
  annotate(geom="text", x=xlab_yrs[4], y=0.59, label=pvalue, parse=TRUE, size=6)
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10}
#```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=13.5, fig.width=10}
paper_figure1 = ggdraw() +
  #draw_plot(p4, 0, .66, .5, .33) +
  #draw_plot(p5, 0.5, .66, .5, .33) +
  draw_plot(p6, 0, .5, .5, .5) +
  draw_plot(p7, 0.5, .5, .5, .5) +
  draw_plot(p9, 0, 0, 1, .5) + 
  draw_plot_label("Month", 0.47, 0.338, fontface="plain") +
  draw_plot_label("Long-Wing Morph Frequency", 0, 0.46, fontface="plain", angle=90)
paper_figure1
```

&nbsp;

## Wing-to-body Ratio

```{r}
w2b_summary<-aggregate(wing2body~sex*pophost*dates*month_of_year, data=data_long, FUN=mean)
w2b_summary$se<-aggregate(wing2body~sex*pophost*dates, data=data_long,
                          FUN=SE)$wing2body
w2b_summary$n<-aggregate(wing2body~sex*pophost*dates, data=data_long,
                          FUN=length)$wing2body

jitter = runif(n=nrow(w2b_summary), min=-0.1, max=0.1) # jitter slightly
w2b_summary$dates <- w2b_summary$dates + jitter
d = w2b_summary
```

## Check for LOESS Residuals 

```{r fig.height=3.3}
l1 = lowess(d$dates, d$wing2body, f=0.4)

par(mfrow=c(1,2))
plot(d$dates, d$wing2body)
lines(l1, type = "l")
plot_lowess_residuals(l1, d$dates, d$wing2body)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# relevel factors for cleaner plotting
d$pophost = factor(d$pophost, levels = c("K. elegans", "C. corindum") )
d$`Host Plant` = d$pophost

d$sex[d$sex=="F"]<-"Females"
d$sex[d$sex=="M"]<-"Males"
d$sex = factor(d$sex, levels = c("Males", "Females") )
d$`Sex` = d$sex 
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
### Panels A and B
###MLC: Should move column additions up
data_long$'Host Plant' <- factor(data_long$pophost, levels = c("K. elegans", "C. corindum") )
data_long$Sex[data_long$sex=="F"]<-"Females"
data_long$Sex[data_long$sex=="M"]<-"Males"
data_long$Sex = factor(data_long$Sex, levels = c("Males", "Females") )

### host plant
p10 = ggplot() + 
  ggtitle("A") + xlab("Month") + ylab(" ") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_smooth(data=data_long, method="glm", se=FALSE, linetype = "dashed", 
              mapping = aes(x = month_of_year, y = wing2body), colour="black", lwd=0.5) + 
  geom_smooth(data=data_long, method="loess", 
              mapping = aes(x = month_of_year, y = wing2body, colour=`Host Plant`, fill=`Host Plant`)) + 
  geom_point(data=d, mapping = aes(x = month_of_year, y = wing2body, colour=`Host Plant`, size=n)) + 
  ylim(0.65, 0.85) + # data outside this range will be dropped
  coord_cartesian(ylim=c(0.7,0.75)) + 
  customPlot +
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels=month_labs) + 
  theme(axis.title.x = element_blank())

### sex
p11 = ggplot() + 
  ggtitle("B") + xlab("Month") + ylab(" ") + 
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_smooth(data=data_long, method="glm", se=FALSE, linetype = "dashed",  
              mapping = aes(x = month_of_year, y = wing2body), colour="black", lwd=0.5) + 
  geom_smooth(data=data_long, method="loess",
              mapping = aes(x = month_of_year, y = wing2body, colour=Sex, fill=Sex)) + 
  geom_point(data=d, mapping = aes(x = month_of_year, y = wing2body, colour=Sex, size=n)) +
  ylim(0.65, 0.85) +
  coord_cartesian(ylim=c(0.7,0.75)) + 
  customPlot +
  scale_color_manual(values=c("Females" = sex_col_pts[1], "Males" = sex_col_pts[2])) +
  scale_fill_manual(values = c("Females" = sex_col_shade[1], "Males" = sex_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) + 
  theme(axis.title.x = element_blank())

# extract alpha, smoothing parameter from LOESS regression(s) and pvalue from linear model
alpha = paste("alpha[loess]==", ggplot_build(p10)$data[[3]]$alpha[1])
degree="lambda[loess]==0"
fit_pvalue = round(summary(M3)$coeff[,"Pr(>|t|)"][5],7)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)

p10 = p10 +
  annotate(geom="text", x=10, y=0.745, label=alpha, parse=TRUE) +
  annotate(geom="text", x=10, y=0.75, label=degree, parse=TRUE) +
  annotate(geom="text", x=5, y=0.718, label=pvalue, parse=TRUE)

p11 = p11 +
  annotate(geom="text", x=10, y=0.745, label=alpha, parse=TRUE) +
  annotate(geom="text", x=10, y=0.75, label=degree, parse=TRUE) +
  annotate(geom="text", x=5, y=0.718, label=pvalue, parse=TRUE)
```

```{r echo=FALSE}
# multi-variate model with year, sex, and host plant predicting wing morph
fit4 = glm(wing2body ~ pophost_binom * dates, data = data_long)
xyr <- seq(sort(unique(dd$dates))[1],sort(unique(dd$dates))[10], 1)
set.seed(194842)
bhost = sample(c(-1,1), replace=TRUE, size=length(xyr))
wprobs <- predict(fit4, list(pophost_binom = bhost,
                                dates = xyr), type="response")

pred = cbind(xyr, bhost, wprobs)
pred = as.data.frame(pred)
pred$xyr = as.Date.numeric(pred$xyr)

predK = pred[pred$bhost==1,]
predC = pred[pred$bhost==-1,]

# extract pvalue from best fit regression model
fit_pvalue = round(summary(M3)$coeff[,"Pr(>|t|)"][7],3)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
### Panel C

p12 = ggplot() + 
  ggtitle("C") + xlab("Year") + ylab(" ") +
  geom_vline(xintercept = xlab_years, color="gainsboro") + 
  geom_line(aes(x=predK$xyr, y=predK$wprobs), linetype = "dashed", color=hp_col_lines[2], lwd=0.5) +
  geom_line(aes(x=predC$xyr, y=predC$wprobs), linetype = "dashed", color=hp_col_lines[1], lwd=0.5) +
  geom_smooth(data=data_long, method="loess", span=0.8,
              mapping = aes(x = dates, y = wing2body, colour=`Host Plant`, fill=`Host Plant`)) + 
  geom_point(data=d, mapping = aes(x = dates, y = wing2body, colour=`Host Plant`, size=n)) +
  customPlot +
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  ylim(0.65, 0.85) +
  coord_cartesian(ylim=c(0.705,0.75)) + # AB: edit, not the same 
  theme(legend.position = "none")

#### loess and linear regressions
alpha = paste("alpha[loess]==", ggplot_build(p12)$data[[4]]$alpha[1])
degree="lambda[loess]==0"

p12 = p12 +
  annotate(geom="text", x=unique(d$dates)[17]-330, y=0.743, label=alpha, parse=TRUE, size=6) +
  annotate(geom="text", x=unique(d$dates)[17]-330, y=0.748, label=degree, parse=TRUE, size=6) +
  annotate(geom="text", x=unique(d$dates)[15], y=0.716, label=pvalue, parse=TRUE, size=6)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10}
paper_figure2 = ggdraw() +
  draw_plot(p10, 0, .5, .5, .5) +
  draw_plot(p11, .5, .5, .5, .5) +
  draw_plot(p12, 0, 0, 1, .5) +  
  draw_plot_label("Month", 0.47, 0.51, fontface="plain") +
  draw_plot_label("Wing-to-Body Ratio", 0, 0.35, fontface="plain", angle=90)
paper_figure2
```

