---
title: "All Morphology: Testing for Spatial Dependencies"
author: "Anastasia Bernat"
date: "4/23/2021"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/All_Morphology/stats/"
setwd(dir)

library(dplyr)
library(zoo)

library(vegan)
library(lattice)
library(MASS)
library(sp)
library(raster)
library(dismo)
library(splancs)
library(INLA)
library(reshape)
library(gstat)
library(ggplot2)
library(ggmap)
library(rworldmap)
library(rgdal)
library(fields)
library(rgeos)

library(sf)

knitr::opts_chunk$set(echo = TRUE)
```

# Barrier Model

## Sourcing Scripts and Cleaning the Data

```{r}
source_path = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/Rsrc/"

script_names = c("compare_models.R",
                 "regression_output.R",
                 "clean_morph_data2.R", # two functions: read_morph_data and remove_torn_wings
                 "AICprobabilities.R",
                 "HighstatLibV13.R")

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}

source("~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/RTsrc/ts_auxiliary_funs.R") # time
source("~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/RSsrc/spatial_dependencies.R") # space
```

```{r}
data_list <- read_morph_data("data/allmorphology04.28.21-coors.csv")
raw_data = data_list[[1]]
all_bugs = nrow(raw_data)
data_long = data_list[[2]] 

# Remove individuals with torn wings first
raw_data = remove_torn_wings(raw_data) # **don't need to remove torn wings for wing morph analysis
data_long = remove_torn_wings(data_long) # **don't need to remove torn wings for wing morph analysis
clean_bugs = nrow(raw_data)

cat("number of bugs with torn wings:", all_bugs - clean_bugs, "\n\n")
```

## Checking coordinates 

```{r}
coors = unique(data_long[,c("population", "lat","long")])
coors[order(-coors$lat),]
```
August	2017...is it Key Largo or is it North Key Largo? Or are the coordinates seem a little off?

K.elegans	Homestead	M	5.59	2.84	7.5	10.55	February	2020	81	winter	L	25.1755702	-80.36780089	non-diapausing	2.5.2020 - Either this is Homestead or North Key Largo.

Here is the block

K.elegans	Gainesville	M	5.51	3.08	8.28	11.13	February	2020	81	winter	L	29.6620224	-82.347313
K.elegans	Homestead	M	5.59	2.84	7.5	10.55	February	2020	81	winter	L	25.1755702	-80.36780089 ***
K.elegans	Homestead	F	7.47	3.82	9.66	13.31	February	2020	81	winter	L	25.491362	-80.485821

Data cleaning is not linear, it's incrementally non-linear. 

We need to start adding site to the allmorph datasheet

This one too...lat is a little too hight to make sense: 	Key_Largo	25.17563	-80.36775	(search for the lon and you'll find it in the dataset)

August 2017 is the year where there are some lat long typos

## Plotting 

```{r}
d2 = data_long %>%
  filter(!is.na(lat), !is.na(wing2body))
```

```{r}
spatial_data <- st_as_sf(d2,
                         coords = c("long", "lat"),
                         crs = 4326,
                         agr = "constant")

spatial_data <- st_transform(spatial_data, 2236)
plot(spatial_data) 
```

## Modeling 

Make a model and then create a variogram for it to check for spatial dependencies.

What effects wing2body?

```{r}
# And this is the Poisson GLMM

M1 <- inla(wing2body ~ sex_binom + pophost_binom + month_of_year + months_since_start, 
                    control.compute = list(dic = TRUE), 
                    family = "gaussian", 
                    data = d2)

M2 <- inla(wing2body ~ sex + pophost + month_of_year + months_since_start +
                            f(population, model = "iid"), 
                    control.compute = list(dic = TRUE),          
                    family = "gaussian", 
                    data = d2)
# Compare them
dic  <- c(M1$dic$dic, M2$dic$dic) # M2 better
dic
```

## Model Validation, Variograms, and Spatial Plots

A **variogram** is used to display the variability between data points as a function of distance. Here, from distances 0 to 4000 m, the variability between points starts high and then decreases (the points become more similar) until it levels out because at some point the distance between data points will be great enough that the points are no longer considered to be related to each other. The variability will flatten out into a "sill".

```{r}
temp = d2 
check_spatial_dependencies(M2, temp, temp$long, temp$lat, zone = 16, cutoff=10000, is_inla=TRUE)
```

## Model Ony the Keys and Homestead

```{r}
keys = c("North_Key_Largo", "Key_Largo", "Plantation_Key", "Homestead", "HomesteadBV", "HomesteadGRT")

d3 = d2 %>%
  filter(population == "North_Key_Largo" | population =="Key_Largo" | population == "Plantation_Key" | population == "Homestead" | population == "HomesteadBV" | population == "HomesteadGRT")
```

```{r}
spatial_data <- st_as_sf(d3,
                         coords = c("long", "lat"),
                         crs = 4326,
                         agr = "constant")

spatial_data <- st_transform(spatial_data, 2236)
plot(spatial_data)
```

```{r}
M1 <- inla(wing2body ~ sex_binom + pophost + month_of_year + months_since_start +
                    f(population, model = "iid"),  
                    control.compute = list(dic = TRUE), 
                    family = "gaussian", 
                    data = d3)
```

```{r}
temp = d3 
check_spatial_dependencies(M1, temp, temp$long, temp$lat, zone = 16, cutoff=10000, is_inla=TRUE)
```
## Model Only Keys

```{r}
d4 = d2 %>%
  filter(population == "North_Key_Largo" | population =="Key_Largo" | population == "Plantation_Key")
```

```{r}
spatial_data <- st_as_sf(d4,
                         coords = c("long", "lat"),
                         crs = 4326,
                         agr = "constant")

spatial_data <- st_transform(spatial_data, 2236)
plot(spatial_data)
```

```{r}
M1 <- inla(wing2body ~ sex_binom + month_of_year + months_since_start +
                    f(population, model = "iid"),  
                    control.compute = list(dic = TRUE), 
                    family = "gaussian", 
                    data = d4)
```

```{r}
temp = d4

check_spatial_dependencies(M1, temp, temp$long, temp$lat, zone = 16, cutoff=10000, is_inla=TRUE)
```

Probably best to take some means because the layering is obscuring what is happening per site, but can see clustering regardless.
