---
title: "All Morphology: Wing LOESS"
author: "Anastasia Bernat"
date: "4/8/2021"
output:
  html_document:
    theme: united
---

```{r setup, include=FALSE}
rm(list=ls())
library(ggformula)
library(splines)
library(gridExtra) #grid.arrange()
library(ggpmisc) #stat_fit_glance

knitr::opts_chunk$set(echo = TRUE)
```

# {.tabset}

AB: does it make sense to split it by each group by each graph? Probably not.

## Cleaning Data and Sourcing Scripts

```{r}
source_path = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/Rsrc/"

script_names = c("compare_models.R","regression_output.R", "clean_morph_data2.R", "AICprobabilities.R")

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}
```

### Read the data

```{r warning=FALSE}
data_list <- read_morph_data("data/allmorphology04.26.21-coors2.csv")
raw_data = data_list[[1]]
data_long = data_list[[2]]
```

## Wing2Body 

```{r}
SE = function(x){sd(x)/sqrt(length(x))}
w2b_summary<-aggregate(wing2body~sex*pophost*dates, data=data_long, FUN=mean)
w2b_summary$se<-aggregate(wing2body~sex*pophost*dates, data=data_long,
                          FUN=SE)$wing2body

#jitter slightly
jitter = runif(n=nrow(w2b_summary), min=-0.5, max=0.5)
w2b_summary$dates <- w2b_summary$dates + jitter
```

Loess Regression: (base R) http://r-statistics.co/Loess-Regression-With-R.html

```{r}
# define function that returns the SSE
calcSSE <- function(x){
  loessMod <- try(loess(wing2body ~ index, data=w2b_summary, span=x), silent=T)
  res <- try(loessMod$residuals, silent=T)
  if(class(res)!="try-error"){
    if((sum(res, na.rm=T) > 0)){
      sse <- sum(res^2)  
    }
  }else{
    sse <- 99999
  }
  return(sse)
}

# Run optim to find span that gives min SSE, starting at 0.5
#optim(par=c(0.25), calcSSE, method="SANN")
#optim(par=c(1), calcSSE, method="SANN")
```

```{r}
d = w2b_summary[w2b_summary$sex=="F" & w2b_summary$pophost=="C.corindum",]
d = w2b_summary[w2b_summary$sex=="M" & w2b_summary$pophost=="C.corindum",]
d = w2b_summary[w2b_summary$sex=="M",]
d = w2b_summary[w2b_summary$sex=="F",]
```

```{r}
d$index = 1:nrow(d)
loessMod20 <- loess(wing2body ~ index, data=d, span=0.20, degree=2) # 20% smoothing span
loessMod40 <- loess(wing2body ~ index, data=d, span=0.40, degree=2) # 40% smoothing span
loessMod60 <- loess(wing2body ~ index, data=d, span=0.60, degree=2) # 60% smoothing span
loessMod80 <- loess(wing2body ~ index, data=d, span=0.80, degree=2) # 80% smoothing span

smoothed20 <- predict(loessMod20) 
smoothed40 <- predict(loessMod40) 
smoothed60 <- predict(loessMod60)
smoothed80 <- predict(loessMod80) 
# Plot it
plot(d$wing2body, x=d$dates, type="p", main="Loess Smoothing and Prediction", xlab="months since start", ylab="wing:body")
#lines(smoothed20, x=d$dates, col="red")
#lines(smoothed40, x=d$dates, col="green")
lines(smoothed60, x=d$dates, col="blue")
#lines(smoothed80, x=d$dates, col="orange")
#?lowess
```

lmFC <- lm(wing2body ~ months_since_start, data=dfFC)
predFC <- data.frame(wing2body = predict(lmFC, dfFC), months_since_start=dfFC$months_since_start)

```{r}
df = w2b_summary
dfF = df[df$sex=="F",]
dfM = df[df$sex=="M",]

dfFC = df[df$sex=="F" & df$pophost =="C.corindum",]
dfFK = df[df$sex=="F" & df$pophost =="K.elegans",]

# general plotting features
xlab_dates = na.omit(sort(unique(data_long$dates))[-2])
host_colors_shade = c("turquoise3", "green")
host_colors_pts = c("turquoise3", "springgreen4")
```

```{r}
threshold = unique(df$dates)[15]
df$date_b = "2013-2015"
df$date_b[df$dates >= threshold] = "2016-2020"

df$date_b = as.factor(df$date_b)
```

```{r}
w2b_table<-aggregate(wing2body~dates, data=data_long, FUN=mean)
w2b_table$date_b = "2013-2015"
w2b_table$date_b[w2b_table$dates >= threshold] = "2016-2020"
w2b_table$date_b = as.factor(w2b_table$date_b)

last_4_years = w2b_table[w2b_table$date_b=="2016-2020",]
```

```{r fig.width=4.7, fig.height=2.15}
p0 = ggplot() + 
  ggtitle("C") + xlab("Year") + ylab("Wing-to-Body Ratio") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
   geom_smooth(data=w2b_table, method="lm", se=FALSE, linetype = "dashed",
              mapping = aes(x = dates, y = wing2body), colour="black", lwd=0.5) +
  geom_smooth(data=w2b_table, method="loess", 
              mapping = aes(x = dates, y = wing2body), colour="black") + 
  geom_point(data=w2b_table, mapping = aes(x = dates, y = wing2body)) +
  ylim(0.71, 0.75) +
  stat_smooth(data=last_4_years, mapping = aes(x = dates, y = wing2body), method = "lm", formula = y ~ x, se = FALSE,
               colour="blue") # linetype = "longdash",

p0 = p0 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=20)) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = "blue", labels=c("C. corindum", "K. elegans")) + 
  labs(fill = "Host Plant") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values="blue") + theme(legend.position = c(0.2, 0.88)) + theme(legend.title = element_blank())

alpha = paste("alpha[loess]==", ggplot_build(p0)$data[[2]]$alpha[1])
degree="lambda[loess]==0"
mlinear = glm(wing2body ~ dates, data=df, family=gaussian)
pvalue = paste0("italic(p)[glm]==",round(summary(mlinear)$coeff[[8]],2))


p0 = p0 + annotate(geom="text", x=unique(df$dates)[10], y=0.74, 
                   label=alpha, color="black", parse=TRUE, size=6) +
          annotate(geom="text", x=unique(df$dates)[10], y=0.748, 
                   label=degree, color="black",parse=TRUE, size=6) +
          annotate(geom="text", x=unique(df$dates)[15], y=0.718, 
                   label=pvalue, color="black", parse=TRUE, size=6)
# last 4 years
mlinear = glm(wing2body ~ dates, data=w2b_table[w2b_table$date_b=="2016-2020",], family=gaussian)
pvalue = paste0("italic(p)[glm]==",round(summary(mlinear)$coeff[[8]],2))

p0 = p0 + annotate(geom="text", x=unique(df$dates)[24], y=0.743, label=pvalue, color="blue", parse=TRUE, size=6)

p0
```

```{r fig.width=4.7, fig.height=2.3}
# create a LOESS plot
# females
p1 = ggplot() + 
  ggtitle("Females") + xlab("Year") + ylab("Wing-to-Body Ratio") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
  geom_smooth(data=dfF, method="loess", 
              mapping = aes(x = dates, y = wing2body, colour=pophost, fill=pophost)) + 
  geom_point(data=dfF, mapping = aes(x = dates, y = wing2body, colour=pophost)) +
  ylim(0.70, 0.76) 

p1 = p1 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=18, face="italic")) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = host_colors_shade, labels=c("C. corindum", "K. elegans")) + 
  labs(fill = "Host Plant") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=host_colors_pts) + theme(legend.position = c(0.2, 0.88)) + theme(legend.title = element_blank())

# males
p2 = ggplot() + 
  ggtitle("Males") + xlab("Year") + ylab(" ") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
  geom_smooth(data=dfM, method="loess", 
              mapping = aes(x = dates, y = wing2body, colour=pophost, fill=pophost)) + 
  geom_point(data=dfM, mapping = aes(x = dates, y = wing2body, colour=pophost)) + ylim(0.70, 0.76)

p2 = p2 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=18, face="italic")) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = host_colors_shade) + 
  labs(fill = "Host Plant") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=host_colors_pts) + theme(legend.position = "none")

grid.arrange(p1, p2, ncol=2)
```
Now do it by season because that's more interesting...



```{r}
w2b_summary<-aggregate(wing2body~sex*pophost*month_of_year, data=data_long, FUN=mean)
df = w2b_summary
dfF = df[df$sex=="F",]
dfM = df[df$sex=="M",]

xlab_dates = na.omit(sort(unique(data_long$month_of_year)))
xlab_months = xlab_dates[c(-2,-5)]
month_labs <- c("Feb", "May", "Aug", "Oct", "Dec")

sex_colors_shade = c("brown1", "sienna4")
sex_colors_pts = c("brown1", "grey27")
```

```{r fig.width=4.7, fig.height=2.15}
p5 = ggplot() + 
  ggtitle("A") + xlab("Month") + ylab("Wing-to-Body Ratio") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
  geom_smooth(data=w2b_summary, method="lm", se=FALSE, linetype = "dashed",
              mapping = aes(x = month_of_year, y = wing2body), colour="black", lwd=0.5) + 
  geom_smooth(data=w2b_summary, method="loess",
              mapping = aes(x = month_of_year, y = wing2body, colour=pophost, fill=pophost)) + 
  geom_point(data=w2b_summary, mapping = aes(x = month_of_year, y = wing2body, colour=pophost)) + ylim(0.71, 0.75)

p5 = p5 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=20)) + # plot.title=element_text(size=18, face="italic"
  guides(color = FALSE)  + 
  scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = host_colors_shade, labels=c("C. corindum", "K. elegans")) + 
  labs(fill = "Host Plant", face="italic") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=host_colors_pts) + theme(legend.position = c(0.2, 0.88))  +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) + 
  theme(legend.title = element_text(face = "italic"))

p6 = ggplot() + 
  ggtitle("B") + xlab("Month") + ylab(" ") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
  geom_smooth(data=w2b_summary, method="lm", se=FALSE, linetype = "dashed",
              mapping = aes(x = month_of_year, y = wing2body), colour="black", lwd=0.5) + 
  geom_smooth(data=w2b_summary, method="loess", 
              mapping = aes(x = month_of_year, y = wing2body, colour=sex, fill=sex)) + 
  geom_point(data=w2b_summary, mapping = aes(x = month_of_year, y = wing2body, colour=sex)) + ylim(0.71, 0.75)

p6 = p6 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=20)) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = sex_colors_shade, labels=c("Females", "Males")) + 
  labs(fill = "Sex") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=sex_colors_pts) + theme(legend.position = c(0.2, 0.9)) + #theme(legend.title = element_blank()) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) + 
  theme(legend.title = element_text(face = "italic"))

# extract the LOESS
alpha = paste("alpha[loess]==", ggplot_build(p5)$data[[2]]$alpha[1])
degree="lambda[loess]==0"

mlinear = glm(wing2body ~ month_of_year, data=df, family=gaussian)
round(summary(mlinear)$coeff[[8]],3) # significant for all (but only with K.elegans)
pvalue = paste0("italic(p)[glm]==",round(summary(mlinear)$coeff[[8]],3))

p5 = p5 + annotate(geom="text", x=10, y=0.744, label=alpha, color="black", parse=TRUE) +
          annotate(geom="text", x=10, y=0.747, label=degree, color="black", parse=TRUE) +
          annotate(geom="text", x=6.3, y=0.715, label=pvalue, color="black", parse=TRUE)

p6 = p6 + annotate(geom="text", x=10, y=0.744, label=alpha, color="black", parse=TRUE) +
          annotate(geom="text", x=10, y=0.747, label=degree, color="black",parse=TRUE) +
          annotate(geom="text", x=6.3, y=0.715, label=pvalue, color="black", parse=TRUE)

grid.arrange(p5, p6,ncol=2)

```



Loess: a nonparametric, graphical tool for depicting relationships between variables. http://www.jtrive.com/docs/Jacoby_LOESS.pdf

```{r}
# extract the LOESS
head(ggplot_build(p5)$data[[2]]) # alpha = 0.4 (smoothing parameter)
head(ggplot_build(p6)$data[[2]]) # alpha = 0.4 (smoothing parameter); lambda = degree of the local polynomial 
# degree is 0 (estimated below)
# Using a zero degree polynomial turns LOESS into a weighted moving average. 
# degrees: https://www.itl.nist.gov/div898/handbook/pmd/section1/pmd144.htm
```

Try ggdraw() http://www.sthda.com/english/wiki/wiki.php?id_contents=7930
Map separate lines: https://stats.idre.ucla.edu/r/faq/how-can-i-explore-different-smooths-in-ggplot2/


```{r fig.width=4.7, fig.height=2.3}
# create a LOESS plot
# females

p3 = ggplot() + 
  ggtitle("Females") + xlab("Month") + ylab("Wing-to-Body Ratio") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
  geom_smooth(data=dfF, method="lm", se=FALSE, linetype = "dashed",
              mapping = aes(x = month_of_year, y = wing2body, colour = pophost)) +
  geom_smooth(data=dfF, method="loess", 
              mapping = aes(x = month_of_year, y = wing2body, colour=pophost, fill=pophost)) + 
  geom_point(data=dfF, mapping = aes(x = month_of_year, y = wing2body, colour=pophost)) +
  ylim(0.70, 0.76)

p3 = p3 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=18, face="italic")) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = host_colors_shade, labels=c("C. corindum", "K. elegans")) + 
  labs(fill = "Host Plant") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=host_colors_pts) + theme(legend.position = c(0.2, 0.95)) + theme(legend.title = element_blank()) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs)

# males
p4 = ggplot() + 
  ggtitle("Males") + xlab("Month") + ylab(" ") +
  ylim(0.70, 0.76) +
  geom_vline(xintercept = xlab_dates, color="gainsboro") +
  geom_smooth(data=dfM, method="lm", se=FALSE, linetype = "dashed",
              mapping = aes(x = month_of_year, y = wing2body, colour = pophost)) +
  geom_smooth(data=dfM, method="loess", 
              mapping = aes(x = month_of_year, y = wing2body, colour=pophost, fill=pophost)) + 
  geom_point(data=dfM, mapping = aes(x = month_of_year, y = wing2body, colour=pophost)) 

p4 = p4 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=18, face="italic")) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = host_colors_shade) + 
  labs(fill = "Host Plant") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=host_colors_pts) + theme(legend.position = "none") +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) 

grid.arrange(p3, p4, ncol=2)
```

```{r}
# extract the LOESS
head(ggplot_build(p3)$data[[2]])
head(ggplot_build(p4)$data[[2]])

# these calculations give you similar tables. Here is an example:
mloess <- loess(wing2body ~ month_of_year, data=dfF, degree=0)
# Using a zero degree polynomial turns LOESS into a weighted moving average. 
xrange <- range(dfF$month_of_year)
xseq <- seq(from=xrange[1], to=xrange[2], length=80)
pred <- predict(mloess, newdata = data.frame(month_of_year = xseq), se=TRUE)
y = pred$fit
ci <- pred$se.fit * qt(0.95 / 2 + .5, pred$df)
ymin = y - ci
ymax = y + ci
loess.DF <- data.frame(x = xseq, y, ymin, ymax, se = pred$se.fit)
head(loess.DF)
summary(loess.DF)
summary(mloess)
```

```{r}
# compare models
mlinear = glm(wing2body ~ month_of_year, data=df, family=gaussian)
mlinearF = glm(wing2body ~ month_of_year, data=dfF, family=gaussian)
mlinearM = glm(wing2body ~ month_of_year, data=dfM, family=gaussian)

summary(mlinear)$coeff[[8]] # significant for all (but only with K.elegans)
summary(mlinearF)$coeff # not significant for females (or when split by host plant)
summary(mlinearM)$coeff # significant for males (for K.elegans, not for C.corindum)
```

scale_colour_discrete(name ="Host Plant", labels=c("C. corindum", "K. elegans")) +

## Wing Morph Freq

```{r}
#############wing morph plots

##Results to visualize: sex, host, months_since_start.

w_morph_summary<-aggregate(wing_morph_binom~sex*pophost*month_of_year, data=raw_data, FUN=mean)
w_morph_summary$se<-aggregate(wing_morph_binom~sex*pophost*month_of_year, data=raw_data, FUN=SE)$wing_morph_binom

#jitter slightly
jitter = runif(n=nrow(w_morph_summary), min=-0.5, max=0.5)
w_morph_summary$dates <- w_morph_summary$month_of_year + jitter

# create groups
df = w_morph_summary
dfF = df[df$sex=="F",]
dfM = df[df$sex=="M",]
dfFC = df[df$sex=="F" & df$pophost =="C.corindum",]
dfFK = df[df$sex=="F" & df$pophost =="K.elegans",]
```

lmFC <- lm(wing2body ~ months_since_start, data=dfFC)
predFC <- data.frame(wing2body = predict(lmFC, dfFC), months_since_start=dfFC$months_since_start)

```{r fig.width=4.7, fig.height=2.3}
p7 = ggplot() + 
  ggtitle("Females") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
  geom_smooth(data=dfF, method="lm", se=FALSE, linetype = "dashed",
              mapping = aes(x = month_of_year, y = wing_morph_binom, colour = pophost)) +
  geom_smooth(data=dfF, method="loess", 
              mapping = aes(x = month_of_year, y = wing_morph_binom, colour=pophost, fill=pophost)) + 
  geom_point(data=dfF, mapping = aes(x = month_of_year, y = wing_morph_binom, colour=pophost)) +
  ylim(-0.75,2.25)

p7 = p7 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=18, face="italic")) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = host_colors_shade, labels=c("C. corindum", "K. elegans")) + 
  labs(fill = "Host Plant") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=host_colors_pts) + theme(legend.position = c(0.2, 0.95)) + theme(legend.title = element_blank()) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs)

p8 = ggplot() + 
  ggtitle("Males") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
  geom_smooth(data=dfM, method="lm", se=FALSE, linetype = "dashed",
              mapping = aes(x = month_of_year, y = wing_morph_binom, colour = pophost)) +
  geom_smooth(data=dfM, method="loess", 
              mapping = aes(x = month_of_year, y = wing_morph_binom, colour=pophost, fill=pophost)) + 
  geom_point(data=dfM, mapping = aes(x = month_of_year, y = wing_morph_binom, colour=pophost)) +
  ylim(-0.75,2.25)

p8 = p8 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=18, face="italic")) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = host_colors_shade, labels=c("C. corindum", "K. elegans")) + 
  labs(fill = "Host Plant") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=host_colors_pts) + theme(legend.position = c(0.2, 0.95)) + theme(legend.title = element_blank()) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) 

grid.arrange(p7,p8, ncol=2)
```

```{r fig.width=4.7, fig.height=2.15}
p9 = ggplot() + 
  ggtitle("A") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
  geom_smooth(data=df, method="lm", se=FALSE, linetype = "dashed", lwd=0.5,
              mapping = aes(x = month_of_year, y = wing_morph_binom), colour="black") +
  geom_smooth(data=df, method="loess", 
              mapping = aes(x = month_of_year, y = wing_morph_binom, colour=pophost, fill=pophost)) + 
  geom_point(data=df, mapping = aes(x = month_of_year, y = wing_morph_binom, colour=pophost)) + ylim(0.3,1.2)

p9 = p9 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=20)) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = host_colors_shade, labels=c("C. corindum", "K. elegans")) + 
  labs(fill = "Host Plant") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=host_colors_pts) + theme(legend.position = c(0.23, 0.93)) + 
  scale_x_continuous(breaks=xlab_months, labels= month_labs)  + 
  theme(legend.title = element_text(face = "italic"))

p10 = ggplot() + 
  ggtitle("B") + xlab("Month") + ylab(" ") +
  geom_vline(xintercept = xlab_dates, color="gainsboro") + 
  geom_smooth(data=df, method="lm", se=FALSE, linetype = "dashed", lwd=0.5,
              mapping = aes(x = month_of_year, y = wing_morph_binom), colour="black") +
  geom_smooth(data=df, method="loess", 
              mapping = aes(x = month_of_year, y = wing_morph_binom, colour=sex, fill=sex)) + 
  geom_point(data=df, mapping = aes(x = month_of_year, y = wing_morph_binom, colour=sex)) + ylim(0.3,1.2)

p10 = p10 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=20)) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = sex_colors_shade, labels=c("Females", "Males")) + 
  labs(fill = "Sex") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values=sex_colors_pts) + theme(legend.position = c(0.23, 0.95)) + 
  scale_x_continuous(breaks=xlab_months, labels= month_labs)  + 
  theme(legend.title = element_text(face = "italic"))


# extract the LOESS
alpha = paste("alpha[loess]==", ggplot_build(p9)$data[[2]]$alpha[1])
degree="lambda[loess]==0"

mlinear = glm(wing_morph_binom ~ month_of_year, data=df, family=gaussian)
round(summary(mlinear)$coeff[[8]],3) # significant for all (but only with K.elegans)
pvalue = paste0("italic(p)[glm]==",round(summary(mlinear)$coeff[[8]],2))

p9 = p9 + annotate(geom="text", x=7.4, y=1.0, label=alpha, color="black", parse=TRUE) +
          annotate(geom="text", x=7.4, y=1.04, label=degree, color="black", parse=TRUE) +
          annotate(geom="text", x=5, y=0.718, label=pvalue, color="black", parse=TRUE)

p10 = p10 + annotate(geom="text", x=7.4, y=1.1, label=alpha, color="black", parse=TRUE) +
          annotate(geom="text", x=7.4, y=1.15, label=degree, color="black",parse=TRUE) +
          annotate(geom="text", x=5, y=1, label=pvalue, color="black", parse=TRUE)

grid.arrange(p9,p10, ncol=2)
```


```{r}
threshold = sort(unique(raw_data$dates))[5]
df$date_b = "2013-2015"
df$date_b[df$dates >= threshold] = "2016-2020"

df$date_b = as.factor(df$date_b)
```

```{r}
wm_table<-aggregate(wing_morph_binom~dates, data=raw_data, FUN=mean)
wm_table$date_b = "2013-2015"
wm_table$date_b[wm_table$dates >= threshold] = "2016-2020"
wm_table$date_b = as.factor(wm_table$date_b)

last_4_years = wm_table[wm_table$date_b=="2016-2020",]
first_3_years = wm_table[wm_table$date_b=="2013-2015",]

xlab_years = sort(unique(raw_data$dates))
```

```{r fig.width=4.7, fig.height=2.15}

p11 = ggplot() + 
  ggtitle("C") + xlab("Year") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_years, color="gainsboro") + 
   geom_smooth(data=wm_table, method="lm", se=FALSE, linetype = "dashed",
              mapping = aes(x = dates, y = wing_morph_binom), colour="black", lwd=0.5) +
  geom_smooth(data=wm_table, method="loess", 
              mapping = aes(x = dates, y = wing_morph_binom), colour="black") + 
  geom_point(data=wm_table, mapping = aes(x = dates, y = wing_morph_binom))
  #ylim(0.71, 0.75) +
 #+ stat_smooth(data=first_3_years, mapping = aes(x = dates, y = wing_morph_binom), method = "lm", formula = y ~ x, se = FALSE,
 #              colour="blue") # linetype = "longdash",

p11 = p11 + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=20)) + guides(color = FALSE)  + scale_linetype(guide = FALSE) +
  theme(legend.key = element_rect(fill = "white", color = NA), 
        legend.key.size = unit(0.5, "cm"),
        legend.key.width = unit(0.5,"cm")) + 
  scale_fill_manual(values = "blue", labels=c("C. corindum", "K. elegans")) + 
  labs(fill = "Host Plant") + theme(legend.title = element_text(size = 14),
                                    legend.text = element_text(size = 13, face="italic")) +
  scale_color_manual(values="blue") + theme(legend.position = c(0.2, 0.88)) + theme(legend.title = element_blank())

alpha = paste("alpha[loess]==", ggplot_build(p0)$data[[2]]$alpha[1])
degree="lambda[loess]==0"
mlinear = glm(wing_morph_binom ~ dates, data=df, family=gaussian)
pvalue = paste0("italic(p)[glm]==",round(summary(mlinear)$coeff[[8]],2))


p11 = p11 + annotate(geom="text", x=unique(raw_data$dates)[7], y=1, label=alpha, color="black", parse=TRUE, size=6) +
          annotate(geom="text", x=unique(raw_data$dates)[7], y=1.05, label=degree, color="black",parse=TRUE, size=6) +
          annotate(geom="text", x=unique(raw_data$dates)[6], y=0.55, label=pvalue, color="black", parse=TRUE, size=6)
# first 3 years
#mlinear = glm(wing_morph_binom ~ dates, data=first_3_years, family=gaussian)
#pvalue = paste0("italic(p)[glm]==",round(summary(mlinear)$coeff[[8]],2))

#p11 = p11 + annotate(geom="text", x=unique(raw_data$dates)[3], y=1, label=pvalue, color="blue", parse=TRUE, size=6)

p11
```

## Modeling Tests 

```{r}
plot_splines = function(x,y) {
  fit0 <- lm(y~1)
  fit1 <- lm(y~x)
  fit2 <- lm(y~bs(x,5))
  
  print(anova(fit1,fit2))
  print(anova(fit0,fit2))
  print(anova(fit0,fit1))
  
  plot(x,y, pch=16)
  abline(fit1, col='red')
  xx <- seq(min(x),max(x), length.out=250)
  yy <- predict(fit2, data.frame(x=xx))
  lines(xx,yy, col='blue')
}

```

```{r}
dfF = df[df$sex == "F" & df$pophost=="C.corindum",]

x = dfF$month_of_year
y = dfF$wing_morph_binom

plot_splines(x,y)


dfM = df[df$sex == "M" & df$pophost=="C.corindum",]

x = dfM$month_of_year
y = dfM$wing_morph_binom

plot_splines(x,y)

```


```{r}
w_morph_summary<-aggregate(wing_morph_binom~sex_binom*pophost_binom*months_since_start, data=raw_data, FUN=mean)

df = w_morph_summary
data<-data.frame(R=df$wing_morph_binom, 
                 A=df$sex_binom, 
                 B=df$pophost_binom, 
                 C=(df$months_since_start))

model_script = paste0(source_path,"generic models-gaussian glm 3-FF.R")
model_comparisonsAIC(model_script)
```
```{r}
anova(m0, m2, test="Chisq") # host plant is important
anova(m2, m4, test="Chisq") # sex not important 
anova(m2, m6, test="Chisq") # month not important and neither is year
```

```{r}
df<-aggregate(wing_morph_binom~sex_binom*pophost_binom*month_of_year, data=raw_data, FUN=mean)

data<-data.frame(R=df$wing_morph_binom, 
                 A=df$sex_binom, 
                 B=df$pophost_binom, 
                 C=(df$month_of_year))
A = data$A
B = data$B
C = data$C
R = data$R

fit0 <- glm(R~1, family="binomial")
fit1 <- glm(R~B, family="binomial")
fit2 <- glm(R~bs(C,5), family="binomial") # b-splin basis for polynomial splines
fit3 <- glm(R~B + bs(C,5), family="binomial")

anova(fit0,fit1, test="Chisq") 
anova(fit0,fit2, test="Chisq")
```


```{r}
x <- rnorm(1000)
y <- sin(x) + rnorm(1000, 0, 0.5)

fit1 <- lm(y~x)
fit0 <- lm(y~1)
fit2 <- lm(y~bs(x,5))

anova(fit1,fit2)
anova(fit0,fit2)

plot(x,y, pch='.')
abline(fit1, col='red')
xx <- seq(min(x),max(x), length.out=250)
yy <- predict(fit2, data.frame(x=xx))
lines(xx,yy, col='blue')
```

```{r}
ggplot() + 
  ggtitle("Host Plant") + xlab("Month") + ylab("Wing-to-Body Ratio") +                              # title and labels
  geom_vline(xintercept = xlab_dates, color="gainsboro") +                                          # add grey lines for the each collection date
  geom_smooth(data=w2b_summary, method="glm", se=FALSE, linetype = "dashed",                        # GLM regression and pvalue
              mapping = aes(x = month_of_year, y = wing2body), colour="black", lwd=0.5) + 
  annotate(geom="text", x=6.2, y=0.72, label=pvalue, color="black") + 
  geom_smooth(data=w2b_summary, method="loess",                                                     # LOESS regression
              mapping = aes(x = month_of_year, y = wing2body, colour=pophost, fill=pophost)) + 
  geom_point(data=w2b_summary, mapping = aes(x = month_of_year, y = wing2body, colour=pophost)) +   # data points and yaxis value range
  ylim(0.70, 0.76) +
  
  theme_classic() +

  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=16), 
        plot.title=element_text(size=18, face="italic")) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) +
  #scale_color_manual(values=host_colors_pts) +
  #scale_fill_manual(values = host_colors_shade, labels=c("C. corindum", "K. elegans")) +
  
  theme(legend.position = c(0.2, 0.9)) +
  theme(legend.title = element_blank(), #element_text(size = 14),
        legend.text = element_text(size = 13, face="italic"))



# + guides(fill = guide_legend(reverse = TRUE)) + theme_classic() +
#   scale_linetype(guide = FALSE) +
#   theme(legend.key = element_rect(fill = "white", color = NA), 
#         legend.key.size = unit(0.5, "cm"),
#         legend.key.width = unit(0.5,"cm")) + 
#   scale_fill_manual(values = host_colors_shade, labels=c("C. corindum", "K. elegans")) + 
#   labs(fill = " ") + theme(legend.title = element_text(size = 14),
#                                     legend.text = element_text(size = 13, face="italic")) +
#   scale_color_manual(values=host_colors_pts) 
```
