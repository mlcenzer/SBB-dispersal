---
title: "Modeling Flight Response Summary File"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
rm(list=ls())

# set working directory
dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/"
setwd(dir)

knitr::opts_chunk$set(echo = TRUE)
```

# Data Cleaning And Exploration

## Read Libraries

```{r message=FALSE, warning=FALSE}
library(lme4) # fit regressions 
library(rethinking) # Bayesian data analysis and plotting
library(popbio) # logistic regression plotting
library(binom) # binomial confidence intervals
```

## Read Source Files

```{r message=FALSE, warning=FALSE}
source_path = paste0(dir,"/Rsrc/")

script_names = c("center_flight_data.R", # 1 function: center_data()
                 "clean_flight_data.R", # 1 function: clean_flight_data()
                 "unique_flight_data.R", # 1 function: create_delta_data()
                 "compare_models.R", # 1 function: model_comparisonsAIC()
                 "AICprobabilities.R") # 1 function: AICprobs()

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}
```

## Read the Data

```{r message=FALSE, warning=FALSE}
data_path = paste0(dir,"/Dispersal/Winter_2020/stats/data/all_flight_data-Winter2020.csv")

data = read_flight_data(data_path)
data_all = data[[1]]
data_tested = data[[2]]
d = create_delta_data(data_tested, tested_more_than_once=FALSE)
```

## Repeating Plot Parameters & Functions

```{r}
# scale/magnifications
c1 = 1.3*2 # size of points
c2 = 1.2*2 # size of text
c3 = 2*2 # size of title 

# compute confidence interval
get_CI = function(x,y,m) {
  x.seq = seq(min(x) - sd(x), max(x) + sd(x), length.out=100)
  prd = data.frame(x=x.seq) # newdata
  err = predict(m, newdata = prd, se.fit = TRUE)
  prd$lci = err$fit - 1.96 * err$se.fit
  prd$fit = err$fit
  prd$uci = err$fit + 1.96 * err$se.fit
  mu_ci = t(matrix(c(prd$lci,prd$uci), ncol=2))
  return(list(mu_ci, prd))
}

# tailoring variables for plotting
d$mass_block=round(d$average_mass/0.005)*0.005
d$wing2body_block=round(d$wing2body, digits=2)
d$days_block=round(d$avg_days, digits=0)
```

# Across-Trial Flight Response

## Experimental Effects

```{r echo=FALSE, fig.height=2.7*3, fig.width=6*3}
# day tested: flight prob vs. days from start

par(mfrow=c(1,2), mar = c(4.3, 7, 3.5, 0)) 

# plot A (barplot)
counts = table(data_tested$flew_b, data_tested$trial_type)
counts = counts[1:2,2:3]
barplot(counts,
        xlab="Trial", col=c("#b57783","#820331"),
        ylab="Frequency",
        ylim=c(0,250), beside=TRUE,
        cex.lab=c2)
legend("topright",
       legend = c("no flew", "yes flew"),
       col=c("#b57783","#820331"),
       pch=15,
       cex = c2)
mtext("A", side=3, adj=0, line=0.5, cex=c3, font=1)
  
# plot B (for linear & logistic regression)
dt = aggregate(flew_b ~ days_from_start, data=data_tested, FUN=mean)
x=dt$days_from_start
y=dt$flew_b
m = glm(y ~ x, data=dt, family="gaussian")

shading = get_CI(x,y,m)
mu_ci=shading[[1]]
prd=shading[[2]]

plot(dt$flew_b~dt$days_from_start, 
     ylab="Flight Probability", xlab="Days From Start", 
     pch=19, col=1, 
     cex=c1, cex.lab=c2,
     ylim=c(0.4,1))
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval = paste0("p = ", round(summary(m)$coefficients[8],3), "*")
text(11, 0.45, pval, cex=c2)
mtext("B", side=3, adj=0, line=0.5, cex=c3, font=1)

#par(fig=c(.33,.48,0.68,1),new=TRUE)
par(fig=c(.70,1,0.5,0.99), new=TRUE, mar=c(1,1,1,1))
m = glm(flew_b ~ days_from_start, data=data_tested, family = "binomial" )
pvalue = paste0("p = ", round(summary(m)$coefficients[8],3), "*")

logi.hist.plot(data_tested$days_from_start, 
               data_tested$flew_b,boxp=FALSE,
               type="hist",col="indianred", ylabel="Flight Prob", xlabel="Days From Start")
text(7, 0.38, pvalue, cex=2)
```

```{r echo=FALSE, fig.height=2.7*2.7, fig.width=6*3}
# time tested: recording duration (HR) vs. trial start time (HR)

par(mfrow=c(1,2), mar = c(4.3, 7, 3.5, 0))

# plot C (all bugs)
x=data_tested$hr_start
y=data_tested$recording_duration/60/60
m = glm(y ~ x, data=data_tested, family="gaussian") # marginal effect

shading = get_CI(x,y,m)
mu_ci=shading[[1]]
prd=shading[[2]]

plot(data_tested$hr_start, data_tested$recording_duration/60/60,
     xlab="Trial Start Time (HR)", 
     ylab="Recording Duration (HR)",
     cex=c1, cex.lab=c2)
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval = paste0("p = ", round(summary(m)$coefficients[8],3))
text(15, 11, pval, cex=c2)
mtext("C", side=3, adj=0, line=0.5, cex=c3, font=1)


# plot D (filter out bugs that didn't fly)
dt=data_tested %>%
  filter(flew_b !=0)
x=dt$hr_start
y=dt$recording_duration/60/60
m = glm(y ~ x, data=dt, family="gaussian") # marginal effect

shading = get_CI(x,y,m)
mu_ci=shading[[1]]
prd=shading[[2]]

plot(dt$hr_start, dt$recording_duration/60/60,
     xlab="Trial Start Time (HR)", 
     ylab="Recording Duration (HR)",
     cex=c1, cex.lab=c2)
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval = paste0("p = ", round(summary(m)$coefficients[8],3), "*")
text(15, 11, pval, cex=c2)
mtext("D", side=3, adj=0, line=0.5, cex=c3, font=1)
```

**A & B.** There was a negative effect of day a bug was tested but only when the full dataset is considered (not the unique dataset).
**C & D.** There was a negative effect of the trial start time but only after removing bugs that didn't fly.

## Single-Variate Effects

```{r}
# aggregate data for plotting
data_temp = aggregate(flew_prob~sex, data=d, FUN=mean)
data_temp$trials = c(sum(d$num_flew[d$sex=="F"]+d$num_notflew[d$sex=="F"]),
                     sum(d$num_flew[d$sex=="M"]+d$num_notflew[d$sex=="M"]))

# calculate binomial confidence interval
data_temp$successes = c(sum(d$num_flew[d$sex=="F"]), 
                        sum(d$num_flew[d$sex=="M"]))
data_temp$CI = binom.confint(data_temp$successes, data_temp$trials, methods="exact")
```

```{r echo=FALSE, fig.height=2.7*2*2.7, fig.width=6*3}

par(mfrow=c(2,2), mar = c(4.3, 7, 3.5, 0))

# plot A (flight probability grouped by sex)

plot(data_temp$CI$mean~c(1,2), xaxt='n', 
     ylab="Flight probability", 
     xlab="Sex", ylim=c(0,1), 
     xlim=c(0.5,2.5), 
     cex=c1, cex.lab=c2, pch=19, col=c("red", "blue"))
lines(x=xy.coords(x=c(1,1), y=c(data_temp$CI$lower[1], data_temp$CI$upper[1])), lwd=3, col="red")
lines(x=xy.coords(x=c(2,2), y=c(data_temp$CI$lower[2], data_temp$CI$upper[2])), lwd=3, col="blue")
axis(side=1, at=c(1,2), labels=c("female", "male"))
mtext(text=c("N=120", "N=213"), at=c(1,2), side=1, line=-1.2, cex=c2)
mtext("A", side=3, adj=0, line=0.5, cex=c3, font=1)

# plot B (wing2body ratio vs. flew_prob grouped by sex)

data_temp=aggregate(flew_prob~sex*wing2body_block, data=d, FUN=mean)
data_temp$n=aggregate(flew_prob~sex*wing2body_block, data=d, FUN=length)$flew_prob

d1 = data_temp[data_temp$sex=="F",]
d2 = data_temp[data_temp$sex=="M",]

# females
x=d1[,"wing2body_block"]
y=d1[,"flew_prob"] 
m1 = lm(y ~ x, data=d1)
shading=get_CI(x,y,m1)
mu_ci1=shading[[1]]
prd1=shading[[2]]

# males
x=d2[,"wing2body_block"]
y=d2[,"flew_prob"] 
m2 = lm(y ~ x, data=d2)
shading=get_CI(x,y,m2)
mu_ci2=shading[[1]]
prd2=shading[[2]]

plot(data_temp$flew_prob~data_temp$wing2body_block, 
     ylab="Flight probability", xlab="wing-to-body ratio", 
     pch=19, col=c("red","blue")[as.factor(data_temp$sex)], 
     cex=c1, cex.lab=c2, ylim=c(0,1))
abline(m1, lty=2, col="indianred1")
abline(m2, lty=2, col="darkblue")
shade(mu_ci1, lim = prd1$x, col=col.alpha("indianred1"))
shade(mu_ci2, lim = prd2$x) #, col=col.alpha("darkblue"))
pval1 = paste0("p = ", round(summary(m1)$coefficients[8],2))
pval2 = paste0("p = ", round(summary(m2)$coefficients[8],5), "*")
text(0.72, 0.05, pval1, cex=c2, col="darkred")
text(0.67, 0.6, pval2, cex=c2) #, cex=c4, col="darkblue")
legend(0.64, 1, legend=c("male", "female"), pch=19, col=c("blue", "red"), y.intersp=1.5, pt.cex=2, cex=.8)
mtext("B", side=3, adj=0, line=0.5, cex=c3, font=1)

# plot C (mass vs. flew_prob grouped by sex)
data_temp=aggregate(flew_prob~sex*mass_block, data=d, FUN=mean)
data_temp$n=aggregate(flew_prob~sex*mass_block, data=d, FUN=length)$flew_prob

d1 = data_temp[data_temp$sex=="F",]
d2 = data_temp[data_temp$sex=="M",]

# females
x=d1[,"mass_block"]
y=d1[,"flew_prob"] 
m1 = lm(y ~ x, data=d1)
shading=get_CI(x,y,m1)
mu_ci1=shading[[1]]
prd1=shading[[2]]

# males
x=d2[,"mass_block"]
y=d2[,"flew_prob"] 
m2 = lm(y ~ x, data=d2)
shading=get_CI(x,y,m2)
mu_ci2=shading[[1]]
prd2=shading[[2]]

plot(data_temp$flew_prob~data_temp$mass_block, 
     ylab="Flight probability", 
     xlab="Mass (g)", 
     pch=19, 
     col=c("red","blue")[as.factor(data_temp$sex)], 
     cex=c1, cex.lab=c2,
     ylim=c(0,1), xlim=c(0.02, 0.18))
legend(0.14, 1, legend=c("male", "female"), pch=19, col=c("blue", "red"), y.intersp=1.5, pt.cex=2, cex=.8)
abline(m1, lty=2) #, col="indianred1")
abline(m2, lty=2, col="darkblue")
shade(mu_ci1, lim = prd1$x) #, col=col.alpha("indianred1"))
shade(mu_ci2, lim = prd2$x, col=col.alpha("darkblue"))
pval1 = paste0("p = ", round(summary(m1)$coefficients[8],3), "*")
pval2 = paste0("p = ", round(summary(m2)$coefficients[8],2))
text(0.11, 0.5, pval1, cex=c2) #, cex=c4, col="indianred1")
text(0.1, 0.9, pval2, cex=c2, col="darkblue")
mtext("C", side=3, adj=0, line=0.5, cex=c3, font=1)
```

# Between-Trial Flight Response (T1 vs. T2)

## Read Libraries

```{r warning=FALSE, message=FALSE}
library(dplyr) # data manipulation 
library(zoo) # data manipulation
library(nnet) # multinomial modeling 
library(kableExtra) # table formatting
library(plot.matrix) # enables heatmap plotting
```

## Read Source Files

```{r}
script_names = c( "get_warnings.R", # 1 function: withWarnings()
                  "multinom_functions.R") # 9 functions: calculate_P(),
                                          # calculate_P2(), calculate_P3(),
                                          # prediction_equations(),
                                          # prediction_equations2(),
                                          # get_significant_models(),
                                          # get_significant_modelsf(),
                                          # getting_odds()
                                          # getting_oddsf()

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}

```

## Read the Data

```{r}
d = create_delta_data(data_tested, tested_more_than_once=TRUE)
```

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("flew in both trials", "flew in T2 only", " flew in neither trials", "flew in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  kable_classic(html_font = "Cambria") %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

We wanted to model the probability of different delta flight response cases with sex, host plant, percent changes in mass, and percent changes in egg-laying response as predictors. Since the outcomes (or response variables) were no longer binomial, we used multicategorical logit models. See the Appendix for an explanation and examples of computing multicategorical logit models.

```{r echo=FALSE}
Event = c("gained mass from T1 to T2", "no mass change between trails", "lost mass from T1 to T2")
Sign = c("pos","0","neg")
key = cbind(Event, Sign)

kable(key) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  kable_classic(html_font = "Cambria") %>%
  add_header_above(c("Delta Mass Key" = 2 )) 
```

```{r echo=FALSE, warning=FALSE}
Host = c("Golden Rain Tree (GRT)", "Balloon Vine (BV)")
Encoding = c(1,-1)
key = cbind(Host, Encoding)

kable(key)  %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  kable_classic(html_font = "Cambria") %>%
  add_header_above(c("Host Plant Key" = 2 )) 
```

## Multinomial Modeling

### Baseline

```{r}
df = d %>%
  filter(!is.na(mass_diff), !is.na(flight_case)) 
  
df = df[with(df, order(mass_per)),]
n_trials = nrow(df)

df$flight_case = relevel(as.factor(df$flight_case), ref = "0")
```

### Null Model

```{r}
null = multinom(flight_case ~ 1, data = df) 
```

### Compare Models - predictors mass %, sex, host

```{r warning=FALSE}
data = data.frame(R = df$flight_case, 
         A = df$mass_per,
         B = df$sex_c,
         C = df$host_c)
model_script = paste0(source_path,"generic multinomial models- multinom 1RF + 3 FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r warning=FALSE, results = "hold"}
anova(m4, m7, test="Chisq") # Adding C (host plant) does not improve fit
anova(m4, m8, test="Chisq") # Adding A*B does not improve fit
```

### Best Fit

```{r warning=FALSE, results = "hold"}
M1 = multinom(flight_case ~ mass_per + sex_c, data = df)
model_table = calculate_P2(M1, "mass_per", "sex_c")
```

&nbsp;

```{r warning=FALSE}
prediction_equations2(model_table, var1=" Mass Percent Change", var2=" Sex ")
```

&nbsp;

```{r warning=FALSE, results = "hold", fig.width=11, fig.height=5}
# define a run_multinom_model function based on the best fit model
run_multinom_model = function(d) {
  m = multinom(flight_case ~ mass_per + sex_c, trace=FALSE, data = d) 
  model_table = calculate_P2(m, "mass_per", "sex_c", print_table=FALSE)
  return(model_table)
}

# determine which multinomial model equations are significant with a plot
par(mfrow=c(1,2))
MASS_ML = get_significant_models(15) # mass per
mtext("A. Mass", side=3, adj=0, line=0.5, cex=1.6, font=1)
SEX_ML = get_significant_models(16) # sex
mtext("B. Sex", side=3, adj=0, line=0.5, cex=1.6, font=1)
```

### Compare Models - predictors mass %, sex, wing2body

```{r warning=FALSE}
df = df[with(df, order(mass_per)),]
df$wing2body_c = df$wing2body - mean(df$wing2body) # normalize
```

```{r warning=FALSE}
data = data.frame(R = df$flight_case, 
         A = df$mass_per,
         B = df$sex_c,
         C = df$wing2body_c)
model_script = paste0(source_path,"generic multinomial models- multinom 1RF + 3 FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r warning=FALSE, results = "hold"}
anova(m7, m12, test="Chisq") # adding A*C does not improve fit
anova(m7, m13, test="Chisq") # Adding B*C does not improve fit
```

### Best Fit

```{r warning=FALSE, results = "hold"}
M2 = multinom(flight_case ~ mass_per + sex_c + wing2body_c, data = df)
model_table = calculate_P3(M2)
```

&nbsp;

```{r warning=FALSE, results = "hold", fig.width=10, fig.height=9}
# define a run_multinom_model function based on the best fit model
run_multinom_model = function(d) {
  m = multinom(flight_case ~ mass_per + sex_c + wing2body_c, trace=FALSE, data = d)
  model_table = calculate_P3(m, print_table=FALSE)
  return(model_table)
}

# determine which multinomial model equations are significant with a plot
par(mfrow=c(2,2))
MASS_PER_ML = get_significant_models(19) # mass%
mtext("A. Mass", side=3, adj=0, line=0.5, cex=1.3, font=1)
SEX_ML = get_significant_models(20) # sex
mtext("B. Sex", side=3, adj=0, line=0.5, cex=1.3, font=1)
WING2BODY_ML = get_significant_models(21) # wing2body
mtext("C. Wing2Body", side=3, adj=0, line=0.5, cex=1.3, font=1)
```


### Predicted Probabilities 

```{r warning=FALSE}
head(pp <- fitted(M1))
```

```{r warning=FALSE, echo=FALSE}
df$index = 1:nrow(df)
females = df %>%
  filter(sex=="F")
males = df %>%
  filter(sex=="M")
Frows = females$index
Mrows = males$index
```

```{r warning=FALSE, echo=FALSE, fig.width=3.2*1.7*2, fig.height=2.8*2}
plot3 = function(df, pp) {
  plot(df$mass_per[Frows], pp[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",
     type="l",
     ylab="Flight Case Probability", 
     xlab="Percent Mass Change From T1 to T2 (%)", lty=1, cex.axis=1.2, cex.lab=1.3)  
  points(df$mass_per[Mrows], pp[Mrows,1], col="red", type="l", cex=0.45, lty=2) 
  points(df$mass_per[Frows], pp[Frows,2], col="blue", type="l") 
  points(df$mass_per[Mrows], pp[Mrows,2], col="blue", type="l", cex=0.45, lty=2)
  points(df$mass_per[Frows], pp[Frows,3], col="darkgreen", cex=0.45, type="l", pch=16) 
  points(df$mass_per[Mrows], pp[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=2) 
  points(df$mass_per[Frows], pp[Frows,4], col="darkred", type="l") 
  points(df$mass_per[Mrows], pp[Mrows,4], col="darkred", type="l", cex=0.45, lty=2) 
  mtext("A", side=3, adj=0.01, line=0.5, cex=1.5, font=2)
  text(68,0.7, labels="Flew in T1 only", col="blue")
  text(-27,0.9, labels="Did Not Fly", col="red")
  text(13,0.37, labels="Flew Twice", col="darkred")
  legend(83, 1.0,
         legend = c("female","male"),
         lty=1:2,
         col="black",
         cex=1.1)  
}
pp3 <- fitted(M1)
df3 <- df 
plot3(df3,pp3)
```

```{r warning=FALSE}
head(pp <- fitted(M2)) # adding wing-to-body ratio
```

```{r warning=FALSE, echo=FALSE}
df$index = 1:nrow(df)
females = df %>%
  filter(sex=="F")
males = df %>%
  filter(sex=="M")
Frows = females$index
Mrows = males$index
```


```{r echo=FALSE, warning=FALSE}
plot4 = function(df, pp, PP, gradient=TRUE, circles=TRUE, stochasticity=TRUE, points=TRUE) {
  c1 = 0.65
  c2 = 1.2
  if (stochasticity) {
    plot(df$mass_per[Frows], pp[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",type="l", 
       ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3) 
    points(df$mass_per[Frows], pp[Frows,2], col="blue", type="l")
    points(df$mass_per[Frows], pp[Frows,4], col="darkorange1", type="l") #darkred
  }
  if (points){
    plot(df$mass_per[Frows], PP[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",type="l", 
       ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3) 
    points(df$mass_per[Frows], PP[Frows,2], col="blue", type="l")
    points(df$mass_per[Frows], PP[Frows,4], col="darkorange1", type="l") #darkred   
  }
  mtext(expression(italic("Females")), side=3, adj=0.05, line=-2, cex=1.5, font=2)
  mtext("B", side=3, adj=0.01, line=0.5, cex=1.5, font=2)
  text(64,0.7, labels="Flew in T1 only", col="blue", cex=c2)
  text(22,0.85, labels="Did Not Fly", col="red", cex=c2) 
  text(82,0.37, labels="Flew Twice", col="darkorange3", cex=c2) #maroon

  if (gradient) {
    rbPal <- colorRampPalette(c('black','red'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Frows], pp[Frows, 1], pch=20, col=df$w2b_col[Frows])
    
    rbPal <- colorRampPalette(c('black','royalblue1'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Frows], pp[Frows, 2], pch=20, col=df$w2b_col[Frows])
    
    rbPal <- colorRampPalette(c('black','orange')) # violetred1
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Frows], pp[Frows, 4], pch=20, col=df$w2b_col[Frows])
  }

 if (circles) {
  # Mark points in the graph with high wing2body ratio vs. points with low wing2body ratio.
  test <- df[with(df, order(wing2body)),] # ascending order

  small = test %>%
    filter(sex =="F", wing2body < 0.7184934)
  large = test %>%
    filter(sex == "F", wing2body > 0.7184934)
  srows = small$index
  lrows = large$index

  points(df$mass_per[lrows], pp[lrows,1], col="red", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,1], col="red", type="p", cex=c1)
  # those with smaller wing2body ratio were more likely to NOT fly
  points(df$mass_per[lrows], pp[lrows,2], col="blue", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,2], col="blue", type="p", cex=c1)
  points(df$mass_per[lrows], pp[lrows,4], col="darkred", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,4], col="darkred", type="p", cex=c1)
 }
  
}
pp6 = pp
df6 = df
```

```{r echo=FALSE, warning=FALSE}
plot5 = function(df, pp, PP, gradient=TRUE, circles=TRUE, stochasticity=TRUE, points=TRUE) {
  c1 = 0.65
  c2 = 1.2
  if (stochasticity) {
    plot(df$mass_per[Mrows], pp[Mrows,1], ylim=c(-0.00,0.8+0.05), xlim=c(-25,58), col="red",type="l", 
       ylab=" ", xlab="Percent Mass Change from T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3)
    points(df$mass_per[Mrows], pp[Mrows,2], col="blue", type="l", cex=0.45, lty=1)
    points(df$mass_per[Mrows], pp[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=1) 
    points(df$mass_per[Mrows], pp[Mrows,4], col="darkorange1", type="l", cex=0.45, lty=1) # darkred
  }
  if (points) {
    plot(df$mass_per[Mrows], PP[Mrows,1], ylim=c(-0.00,0.8), xlim=c(-25,58), col="red",type="l", 
       ylab=" ", xlab="Percent Mass Change from T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3)
    points(df$mass_per[Mrows], PP[Mrows,2], col="blue", type="l", cex=0.45, lty=1)
    points(df$mass_per[Mrows], PP[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=1) 
    points(df$mass_per[Mrows], PP[Mrows,4], col="darkorange1", type="l", cex=0.45, lty=1) # darkred
  }
  mtext(expression(italic("Males")), side=3, adj=0.05, line=-2, cex=1.5, font=2)
  mtext("C", side=3, adj=0.01, line=0.5, cex=1.5, font=2)
  text(22,0.35, labels="Flew in T1 only", col="blue", cex=c2)
  text(52,0.17, labels="Did Not Fly", col="red", cex=c2)
  text(-16, 0, labels="Flew in T2 only", col="darkgreen", cex=c2)
  text(-17,0.69, labels="Flew Twice", col="darkorange3", cex=c2) # 13,0.77, maroon, 13,0.77

  if (circles) {
    legend(39, .81+0.05, 
           pch=c(16,1), 
           title="Wing-to-body", 
           legend=c("> mean", "< mean"), 
           cex=1.1)
  }
  if (gradient) {
    text(50,0.84, labels="Wing-to-body", cex=c2)
  }
  
  if (gradient) {
    rbPal <- colorRampPalette(c('black','red'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 1], pch=20, col=df$w2b_col[Mrows])
    
    rbPal <- colorRampPalette(c('black','royalblue1'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 2], pch=20, col=df$w2b_col[Mrows])
    
    rbPal <- colorRampPalette(c('black','palegreen2'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 3], pch=20, col=df$w2b_col[Mrows])
    
    rbPal <- colorRampPalette(c('black','orange')) #violetred1
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 4], pch=20, col=df$w2b_col[Mrows])
  }

 if (circles) {
  # Mark points in the graph with high wing2body ratio vs. points with low wing2body ratio. 
  test <- df[with(df, order(wing2body)),] # ascending order
  
  small = test %>%
    filter(sex =="M", wing2body < 0.7184934)
  large = test %>%
    filter(sex == "M", wing2body > 0.7184934)
  srows = small$index
  lrows = large$index
  
  points(df$mass_per[lrows], pp[lrows,1], col="red", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,1], col="red", type="p", cex=c1)
  # those with smaller wing2body ratio were more likely to NOT fly
  points(df$mass_per[lrows], pp[lrows,2], col="blue", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,2], col="blue", type="p", cex=c1)
  points(df$mass_per[lrows], pp[lrows,3], col="darkgreen", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,3], col="darkgreen", type="p", cex=c1)
  points(df$mass_per[lrows], pp[lrows,4], col="darkred", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,4], col="darkred", type="p", cex=c1)
 }
}
```

```{r echo=FALSE, fig.width=0.7, fig.height=1, warning=FALSE}
# Function to plot color bar
color.bar <- function(lut, min, max=77, nticks=3, ticks=seq(min, max, len=nticks), title='') {
    scale = (length(lut)-1)/(max-min)
    
    final_ticks=seq(min/100, max/100, len=nticks)
    #final_ticks = c("0.63", "0.66", "0.70", "0.74", "0.77")
    final_ticks = c("0.63", "0.70", "0.77")
    
    #dev.new(width=1.75, height=5)
    plot(c(0,10), c(min,max), type='n', bty='n', xaxt='n', xlab='', yaxt='n', ylab='', main=title)
    axis(2, ticks, las=1, labels=final_ticks)
    for (i in 1:(length(lut)-1)) {
     y = (i-1)/scale + min
     rect(0,y,10,y+1/scale, col=lut[i], border=NA)
    }
}
```

```{r warning=FALSE, echo=FALSE}
# getting those small subset plots and scales in the top right hand corner.
plot_histograms = function() {
  x = 0.48
  v <- c(x-0.13,x, 0.85, 0.90)
  par( fig=v, new=TRUE, mar=c(0,0,0,0) )
  hist(df$wing2body[Frows], col="white", main="", cex.axis=0.9) 
  text(0.64,45, labels="w2b", cex=0.9)

  x = 0.88
  v <- c(x-0.13, x, 0.85, 0.90)
  par( fig=v, new=TRUE, mar=c(0,0,0,0) )
  hist(df$wing2body[Mrows], col="white", main="", cex.axis=0.9, xlim=c(0.64,0.78)) 
  text(0.66,40, labels="w2b", cex=0.9)
}
plot_color_scale = function() {
  x = 0.98
  v <- c(x-0.025, x, 0.75, 0.86)
  par( fig=v, new=TRUE, mar=c(0,0,0,0) )
  color.bar(colorRampPalette(c("black", "grey"))(1000), 63)
}
```


```{r echo=FALSE, warning=FALSE, fig.width=3.2*1.7*2, fig.height=2.8*2}
par(mfrow=c(1,2), tcl=-0.5) # length of tick marks set at default

par(mai=c(1,0.85,0.4,0)) # bottom, right, top, left
plot4(df6,pp6, pp3, gradient=TRUE, circles=FALSE, stochasticity=TRUE, points=FALSE)

par(mai=c(1,0.6,0.4,0.05))
plot5(df6,pp6, pp3, gradient=TRUE, circles=FALSE, stochasticity=TRUE, points=FALSE)

plot_histograms()
plot_color_scale()
```


## Multinomial Modeling (Females Only)

### Egg Case

```{r echo=FALSE, warning=FALSE}
# key = response in T2 - response in T1
Event = c("laid eggs in both trials", "laid eggs in T2 only", "laid eggs in neither trials", "laid eggs in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  kable_classic(html_font = "Cambria") %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

### Baseline

```{r warning=FALSE}
df <- d %>%
  filter(!is.na(egg_diff), !is.na(mass_diff), !is.na(flew_diff), sex_c == 1)

df <- df[with(df, order(mass_per)),]
n_tfemales = nrow(df)

df$flight_case <- relevel(as.factor(df$flight_case), ref = "0")
```

### Null model

```{r warning=FALSE}
df$flight_case = droplevels(df$flight_case) # no female bug only flew in T2
null <- multinom(flight_case ~ 1, data = df) 
```

### Comparing Models - predictors mass diff, egg diff, host

```{r warning=FALSE}
data <- data.frame(R = df$flight_case, 
         A = df$egg_case,
         B = df$mass_per,
         C = df$host_c)
model_script = paste0(source_path,"generic multinomial models- multinom 1RF + 3 FF.R")
model_comparisonsAIC(model_script)
```

```{r warning=FALSE, results='hold'}
anova(m4, m7, test="Chisq") # Adding C does not improve fit
anova(m7, m13, test="Chisq") # Adding  mass_diff*host does not improve fit
```

### Comparing Models - predictors mass diff, egg diff, wing2body

```{r warning=FALSE, echo=FALSE}
data <- data.frame(R = df$flight_case, 
         A = df$egg_case,
         B = df$mass_per,
         C = df$wing2body)
model_script = paste0(source_path,"generic multinomial models- multinom 1RF + 3 FF.R")
model_comparisonsAIC(model_script)
```

```{r results='hold', warning=FALSE}
anova(m4, m7, test="Chisq") # adding wing2body does not include fit
anova(m7, m13, test="Chisq") # Adding A*C does not improve fit
anova(m7, m12, test="Chisq") # Adding B*C does not improve fit
```

### Best Fit

```{r}
M3 <- multinom(flight_case ~ mass_per + egg_case, data = df) # same best fit
model_table = calculate_P2(M3, "mass_per", "egg_case")
```

&nbsp;

```{r warning=FALSE, results = "hold", fig.width=11, fig.height=5}
# define a run_multinom_model function based on the best fit model
run_multinom_model = function(d) {
  m <- multinom(flight_case ~ mass_per + egg_case, trace=FALSE, data = d) 
  model_table = calculate_P2(m, "mass_per", "egg_case", print_table=FALSE)
  return(model_table)
}

# determine which multinomial model equations are significant with a plot
par(mfrow=c(1,2)) 
ML_eqs = get_significant_modelsf(15) # mass_per 
mtext("A. Mass", side=3, adj=0, line=0.5, cex=1.6, font=1)
ML_eqs = get_significant_modelsf(16) # egg_case
mtext("B. Egg \nResponse", side=3, adj=0, line=0.3, cex=1.6, font=1)
```

### Barplot

```{r echo=FALSE, warning=FALSE}
par(mfrow=c(1,2))
data_fem = data_tested %>%
    filter(sex=="F")
bar2 = function() {
  counts <- table(data_fem$eggs_b, data_fem$trial_type) # data_tested$flew_b
  counts <- counts[1:2,2:3]
  barplot(counts, #main="Flight Distribution by Trial",
    xlab="Trial", col=c("lightblue","darkgoldenrod2"),
    legend = c("no eggs", "yes eggs"), ylim=c(0,110), beside=TRUE)
} 
bar2()
```

### Predicted Probabilities 

```{r warning=FALSE}
head(pp <- fitted(M3))
```

```{r echo=FALSE, warning=FALSE}
df$index = 1:nrow(df)

eggT1 = df %>%
  filter(egg_case==-1)
egg0 = df %>%
  filter(egg_case==0)
egg2 = df %>%
  filter(egg_case==2)
eggT2 = df %>%
  filter(egg_case==1)

eggT1_rows = eggT1$index
egg_0rows = egg0$index
egg_2rows = egg2$index
eggT2_rows = eggT2$index
```


```{r echo=FALSE, fig.width=3.2*1.7*2, fig.height=2.8*2}
plot6 = function(df, pp) {
  # only laid eggs in T1
  plot(df$mass_per[eggT1_rows], pp[eggT1_rows,1], ylim=c(0,1.05), xlim=c(-36,108), col="red", type="l", lty=1,main="Females Only", ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (g)")
  # xlim=c(-0.045,0.07)
  points(df$mass_per[eggT1_rows], pp[eggT1_rows,2], col="blue", type="l", lty=1, cex=0.45) 
  points(df$mass_per[eggT1_rows], pp[eggT1_rows,3], col="black", type="l", lty=1, cex=0.45) 
  # no egg change
  points(df$mass_per[egg_0rows], pp[egg_0rows,1], col="red", type="l", lty=2) # did not fly in either
  points(df$mass_per[egg_0rows], pp[egg_0rows,2], col="blue", type="l", lty=2) # flew in T1 only
  points(df$mass_per[egg_0rows], pp[egg_0rows,3], col="black", type="l", lty=2) # flew in both
  # eggs twice
  points(df$mass_per[egg_2rows], pp[egg_2rows,1], col="red", type="l", lty=4) # did not fly in either
  points(df$mass_per[egg_2rows], pp[egg_2rows,2], col="blue", type="l", lty=4) # flew in T1 only
  points(df$mass_per[egg_2rows], pp[egg_2rows,3], col="black", type="l", lty=4) # flew in both
  # only laid eggs in T2
  points(df$mass_per[eggT2_rows], pp[eggT2_rows,1], col="red", type="l", lty=3) # flew in neither
  points(df$mass_per[eggT2_rows], pp[eggT2_rows,2], col="blue", type="l", lty=3) # flew in T1 only
  points(df$mass_per[eggT2_rows], pp[eggT2_rows,3], col="black", type="l", lty=3) # flew in both
  
  # rect(-0.038,-1,0.064,2, NA, col = rgb(0.5,0,0.5,1/15), border="pink") # most likely to not fly unless gain more than about 0.025 g mass and then fly only in T1 (eggs were laid twice).
  # rect(-0.045,-1,0.038,2, NA, col = rgb(0.5,0.2,0.5,1/15), border="pink") # most likely to not fly (2nd widest mass change, and laid eggs in T2)
  # rect(-0.039,-1,0.008,2, NA, col = rgb(0.1,0.5,0.5,1/10), border="lightblue") # most likely to fly twice (lost mass and laid eggs only in T1)
  # rect(-0.005,-1,0.029,2, NA, col = rgb(0.4,0.5,0.5,1/4), border="lightblue") # most likely to fly twice always (smallest mass change and did not lay eggs)
  # 
  text(70,0.68, labels="Flew in T1 only", col="blue") # 0.059,0.54
  text(-20,0.95, labels="Did Not Fly", col="red") # -0.036,0.95
  text(-20,0.55, labels="Flew Twice", col="black") # -0.02,0.35
  legend(76, 1.07,
         legend = c("laid eggs in T1","no eggs laid", "eggs laid twice", "laid eggs in T2"),
         lty=1:4,
         col="black",
         cex=0.8)
}
pp5 = fitted(M3)
df5 = df
plot6(df5,pp5) 
```
```{r echo=FALSE}
#library(knitr) # table formatting
#library(dplyr) # data manipulation 
#library(ggformula) # ggplot plotting
#library(cowplot) # ggplot helper functions to arrange multi-panel figures
```




