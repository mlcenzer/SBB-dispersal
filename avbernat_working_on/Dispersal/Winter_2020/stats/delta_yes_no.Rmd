---
title: "Delta Flight Response"
author: "Anastasia Bernat"
date: "12/16/2020"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/Dispersal/Winter_2020/stats/"
setwd(dir) 

# tables
library(knitr)
library(kableExtra)

# plotting
library(rethinking) 
library(ggformula)
library(plot.matrix)
library(plotly)
library(tidyr)

# modeling and data manipulation
library(lme4)
library(nnet) # multinom package
library(dplyr)

knitr::opts_chunk$set(echo = TRUE)
```

## Multinomial Flight Modeling {.tabset}

Flight Trials Winter 2020 were conducted from 2/17/2020 - 3/10/2020. Soapberry bugs were flight tested twice (T1 vs. T2) for multiple hours in the flight mill and observed from 8 AM to (5-8 PM) each day. I used  multicategorical, nominal modeling (multinom) to analyze how sex and host plant as well as changes in mass and egg-laying changed a soapberry bug's flight response between trials. 

### Delta Flight Response (T1 vs. T2)

[Introduction](#intro)

[Clean the Data](#clean_data)

[Flight Case ~ Mass Diff ](#mass_difference)

[Flight Case ~ Mass Per ](#mass_percentage)

[Flight Case ~ Mass Diff or Mass Perc + Sex ](#adding_sex)

[Flight Case ~ Mass Diff or Mass Perc + Sex + Host Plant ](#host_plant)

[Flight Case ~ Mass Diff or Mass Perc + Sex + Wing2Body ](#wing2body)

Females Only

- [Flew Diff ~ Mass Diff + Egg Case ](#fem_only)
- [Flew Diff ~ Madd Diff + Egg Case + Wing2Body ](#fem_wings)

<a id="intro"></a>

#### Introduction

Graphs I generated below illustrate how changes in mass (more specifically % mass) or egg-laying led to changes in flight response. To generate these graphs, I ran multicategorical regressions to model the probability of different flight delta cases due to sex, host plant, and changes in mass or egg-laying. Changes in speed and distance as a result of changes in mass or egg-laying were not analyzed here but rather in a separate script.

To perform these analyses, a new variable will be created called "flight_case" which calculates the flight response differences between T1 and T2. Here is a formula and key describing each flight case event and encoding: 

**Formula** ***: flight case = response in*** $T_2$ ***- response in*** $T_1$

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("flew in both trials", "flew in T2 only", " flew in neither trials", "flew in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

Since the outcomes (or response variables) were no longer binomial, I used multicategorical logit models (refer to Chapter 6 of *An Introduction to Categorical Data Analysis, Second Edition* by Alan Agresti). Below I've written out notes on performing these analyses.

**What we are interested in is a multicategorical, nominal response variable.** When the response variable is nominal, there is no natural order among the response variable categories (unordered categories). When the response variable is multicategorical, its multicategory models assume that the counts in the categories of $Y$ have a *multinomial distribution*.

Let J = number of categories for $Y$.

$\pi_1,...\pi_J$ = the response probabilities where $\sum_j \pi_j = 1$.

With $n$ independent observations, the probability distribution for the number of outcomes of the J types is the multinomial. It specifies the probability for each possible way the $n$ observations can fall in the J categories. Multicategory logit models simultaneously use all pairs of categories by specifying the odds of outcome in one category instead of another. 

Logit models for nominal response variables pair each category with a baseline category. The choice of the baseline category is arbitrary. When the last category (J) is the baseline, the **baseline-category logits** are

<div align="center">$\log (\frac{\pi_j}{\pi_J}), j = 1, ..., J - 1$.</div> <br/>

Given that the response falls in category j or category J, this is the log odds that the response is j. **For J = 3**, for instance, the model uses $\log(\pi_1/\pi_3)$ and $\log(\pi_2/\pi_3)$. The baseline-category logit model with a predictor x is

<div align="center">$\log \frac{\pi_j}{\pi_J} = \alpha_J + \beta_j x, j = 1, ..., J - 1$</div> <br/>

The model has J - 1 equations, with separate parameters for each. **The effects vary according to the category paired with the baseline**. When J = 2, this model simplifies to a single equation for $\log(\pi_1/\pi_2) = logit(\pi_1)$, resulting in ordinary logistic regression for binary responses. 

So how do these pair of categories determine equations for all other pairs of categories? Here is an arbitrary pair of categories a and b that follows the general equation above,

<div align="center">$\log (\frac{\pi_a}{\pi_b}) = \log ( \frac{\pi_a/pi_J}{\pi_b/pi_J}) = \log (\frac{\pi_a}{\pi_J}) -  \log (\frac{\pi_b}{\pi_J})$

$= (\alpha_a + \beta_a x) - (\alpha_b + \beta_b x)$

$= (\alpha_a - \alpha_b) + (\beta_a - \beta_b) x$ </div> <br/>
So, the equation for categories a and b has the form $\alpha + \beta x$ with intercept parameter $\alpha = (\alpha_a - \alpha_b)$ and with slope parameter $\beta = (\beta_a - \beta_b)$.

Let's apply it to our data now:

<a id="clean_data"></a>

#### Cleaning the Data

```{r}
source_path = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/Rsrc/"

script_names = c("center_flight_data.R", # Re-centers data 
                 "clean_flight_data.R", # Loads and cleans data
                 "unique_flight_data.R",
                 "get_warnings.R", 
                 "compare_models.R",
                 "regression_output.R", # Cleans regression outputs; prints in color or B&W
                 "AICprobabilities.R")

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}

output_col = FALSE # Change to TRUE if working in Base R or RStudio; FALSE if generating an HTML

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]
d <- create_delta_data(data_tested)
```

```{r echo=FALSE}
# for machine learning | creates CSV files to be read into the python script
#test = d[,c(1:30,59,63:73)] # for machine learning
#short_test = d[,c(1:2,5,66:68,71:73)]
#write.csv(test, file="unique_data-Winter2020.csv")
#write.csv(short_test, file="unique_data-Winter2020.csv")
```

```{r}
colnames(d)[c(1:2,5,66:68,71:73)]
```

#### Age Effect 

Age also plays a role in this dataset, but age was unknown because the soapberry bugs were field collected.

```{r, echo=FALSE}
# fig.height=2.4, fig.width=2.7
```

```{r echo=FALSE}
bar = function() {
  counts <- table(data_tested$flew_b, data_tested$trial_type)
  counts <- counts[1:2,2:3]
  barplot(counts, #main="Flight Distribution by Trial",
  xlab="Trial", col=c("lightblue","darkgoldenrod2"),
  legend = c("no flew", "yes flew"), ylim=c(0,250), beside=TRUE)
}
bar()
```

#### Modeling

Below I used the **multinom function** from the **nnet package** to estimate a *multinomial logistic regression* model. There are other functions in other R packages capable of multinomial regression. I chose the multinom function because it does not require the data to be reshaped (as the mlogit package does) and to mirror the example code found in Hilbeâ€™s *Logistic Regression Models*.

First, I chose the baseline by specifying the level using relevel function. Then, I ran our model using multinom. The multinom package does not include p-value calculations for the regression coefficients, so I calculated *P* using **Wald tests (i.e. z-tests)**.

<a id="mass_difference"></a>

Finally, I considered **mass difference** as my predictor variable where a (+) sign means the bug gained mass between trials and a (-) sign means the bug lost mass between trials.

```{r echo=FALSE}
# key = change in mass
Event = c("gained mass from T1 to T2", "no mass change between trails", "lost mass from T1 to T2")
Sign = c("pos","0","neg")
key = cbind(Event, Sign)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Mass Key" = 2 )) 
```

**Baseline**

```{r}
df <- d %>%
  filter(!is.na(mass_diff), !is.na(flight_case)) 
  
df <- df[with(df, order(mass_diff)),]
n_trials = nrow(df)

df$flight_case <- relevel(as.factor(df$flight_case), ref = "0")
```

```{r echo=FALSE}
df$w2b_col <- 0
```

**Null model**

```{r}
null <- multinom(flight_case ~ 1, data = df) 
```

**Multinom model: flight_case ~ mass_diff**

```{r echo=FALSE}
calculate_P = function(model, print_table=TRUE) {
  # compute p-values using Wald tests (i.e. z-tests)
  s <- summary(model) 
  z <- s$coefficients/s$standard.errors 
  wald <- z^2
  p <- (1 - pnorm(abs(z), 0, 1)) * 2
  
  # summary table (similar to lm, glm, or lmer function)
  model_table <- cbind(s$coefficients, c(s$edf, s$edf, s$edf), s$standard.errors[,2], z[,2], wald[,2], p[,2])
  colnames(model_table) <- c("(Intercept)"," Estimate","DF", "Std. Err.", "z", "wald", "P > |z|")
  
  if (print_table) {
     cat("\n", "AIC: ", s$AIC, "\n")
    print(round(model_table,3))
  }
  return(model_table)
}
```

```{r}
model <- multinom(flight_case ~ mass_diff, data = df) 
model_table = calculate_P(model)
```

```{r}
anova(null, model, test="Chisq") # adding mass_diff improves fit 
```

**Which multinomial model equations are significant:**

```{r echo=FALSE}
run_multinom_model = function(d){
  m <- multinom(flight_case ~ mass_diff, trace=FALSE, data = d) 
  return(m)
}
get_significant_models = function(){
  baselines = -1:2
  pvalues = matrix(NA, nrow = 4, ncol = 4)
  r = 0
  for (i in baselines) {
    print(i)
    r = r + 1
    df$flight_case <- relevel(as.factor(df$flight_case), ref = as.character(i))
    m = run_multinom_model(df)
    model_table = calculate_P(m, print_table=FALSE)
    print(model_table)
    
    eqs = rownames(model_table)
    c = 0
    for (e in eqs){
      c = c + 1
      e = as.integer(e) + 2 
      pvalues[r,e] = model_table[c,7]
    } 
  }
  colnames(pvalues) = baselines
  rownames(pvalues) = baselines 

  #plot
  par(mar=c(5.1, 4.1, 3.1, 4.1))
  plot(pvalues, ylab="Baselines", xlab="Equation", main="p-values", 
     na.col="white", col=rev(grey.colors(7)), digits=4, 
     breaks=c(0.05,0.10, 0.5, 0.8, 1),
     text.cell=list(col="white", cex=1), max.col=170, border=NA, fmt.cell='%.2f', fmt.key='%.2f')
}
```

```{r}
get_significant_models()
```

```{r echo=FALSE}
# 2 vs. -1
odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=flew\\, in\\, T1\\, only)}$", " ")
effect = c("Intercept", "$\\delta$ Mass (g)")
pars = c("$\\alpha$", "$\\beta_1$")
estimate = round(c(1.1808369, -42.94895),2)
SE = c(" ", 13.95)
exp.b = c(" ",round(exp(-42.94895/50),2))
wald = c(" ",round(9.474699,2))
pvals = c(" ",round(2.083251e-03,2))
key1 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

# 2 vs. 0
odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=did\\, not\\, fly)}$", " ")
estimate = round(c(0.4195114, 25.328344),2)
SE = c(" ", 12.66)
exp.b = c(" ", 1.66)
wald = c(" ",round(0.1733724,2))
pvals = c(" ",round(4.545664e-02,2))
key2 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

key = rbind(key1,key2)
colnames(key) = c("Odds","Effect", "Parameter", "Estimate", "SE", "exp($\\frac{\\beta}{50}$)", "Wald", "p")

kable(key) %>%
  kable_styling(bootstrap_options = "hover", full_width = F)  %>%
  add_header_above(c("Estimated Parameters, Standard Errors, and Wald Test Statistics for All Main Effects Model" = 8 )) %>%
  column_spec(1, width="6cm")
```

**The multinomial (ML) prediction equations are:**

```{r echo=FALSE}
prediction_equations = function(tb) {
  # -1 / 1 | Flew in T1, not T2
  I = (tb[1,1] - tb[2,1])
  M = (tb[1,2] - tb[2,2])
  EQ1 = paste0("log(pi_-1 / pi_1) = ", round(I, 2), " + ", round(M,2), " Mass Change     Flew in T1, rather than T2" )
  
  # 2 / -1 | Flew in both, not T1
  I = (tb[3,1] - tb[1,1])
  M = (tb[3,2] - tb[1,2])
  EQ2 = paste0("log(pi_2 / pi_-1) = ", round(I, 2), " + ", round(M,2), " Mass Change     Flew in both, rather than T1" )
  
  # 2 / 1 | Flew in both, not T2
  I = (tb[3,1] - tb[2,1])
  M = (tb[3,2] - tb[2,2])
  EQ3 = paste0("log(pi_2 / pi_1) = ", round(I, 2), " + ", round(M,2),  " Mass Change     Flew in both, rather than T2")
  
  eqs = c(EQ1, EQ2, EQ3)
  return(eqs)
}
```

```{r}
prediction_equations(model_table) 
```

```{r echo=FALSE}
eq1 = "Flew in T1 only rather than T2 only = 1.36 + 62.51 Mass Change"
eq2 = "Flew in both rather than T1 only = 1.19 - 43.88 Mass Change"
eq3 = "Flew in both rather than T2 only = 2.55 + 18.63 Mass Change"

significance = c("not sig", "sig", "not sig")
t = cbind(n_trials, c(eq1, eq2, eq3), significance)
colnames(t) = c("N","Model", "P")

kable(t) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F) 
```

**Estimated Odds**

For bugs of mass_diff x + 1/50 (0.02) g, the estimated odds that the bug flew twice rather than only in T1 equals

```{r}
exp(-43.88/50)
```

times the estimated odds at mass_diff x (g). As gain mass, then less likely to fly again. 

```{r}
exp(coef(model)/50) # this compares to not flying, the baseline | 1/0 not significant
```

**Predicted probabilities** 

You can also use predicted probabilities to help you understand the model. **The multicategory logit model has an alternative expression in terms of the response probabilities**. This is

<div align="center">$\pi_j = \frac{e^{\alpha_j + \beta_j x}}{\sum_he^{\alpha_h + \beta_h x}}, j=1,...,J$</div> <br/>

The denominator is the same for each probability, and the numerators for various j sum to the denominator where $\sum_j \pi_j = 1$. The parameters ($\alpha$ and$\beta$) equal zero for whichever category is the baseline in the logit expressions. So these would be the equations for the model above:

<div align="center">$\hat{\pi_{-1}} = \frac{e^{-1.77 + 69.21 x}}{1 + e^{-1.77 + 69.21 x} + e^{-2.13 - 6.70 x} + e^{0.42 + 25.33 x}}, j=1,...,J$

$\hat{\pi_1} = \frac{e^{-2.13 - 6.70 x}}{1 + e^{-1.77 + 69.21 x} + e^{-2.13 - 6.70 x} + e^{0.42 + 25.33 x}}, j=1,...,J$

$\hat{\pi_2} = \frac{e^{0.42 + 25.33 x}}{1 + e^{-1.77 + 69.21 x} + e^{-2.13 - 6.70 x} + e^{0.42 + 25.33 x}}, j=1,...,J$

$\hat{\pi_0} = \frac{e^{0 + 0 x} = 1}{1 + e^{-1.77 + 69.21 x} + e^{-2.13 - 6.70 x} + e^{0.42 + 25.33 x}}, j=1,...,J$

x = mass_diff, which can give you the estimated probabilities.</div><br/>

You can calculate these predicted probabilities for each of our outcome levels using the fitted function. You can start by generating the predicted probabilities for the observations in our dataset and viewing the first few rows. Then, you can plot them.

```{r}
head(pp <- fitted(model))
```
```{r echo=FALSE}
plot1 = function(df, pp) {
   plot(df$mass_diff, pp[,1], ylim=c(0,1), col="red", type="l", ylab="Flight Case Probability", xlab="Changes in Mass From T1 to T2 (g)", pch=2, cex=0.45) # no flight_diff | 0 is triangle
  points(df$mass_diff, pp[,4], col="darkred", type="l", pch=3, cex=0.45)
  points(df$mass_diff, pp[,2], col="blue", type="l", cex=0.45) # flew in T1 but not T2
  points(df$mass_diff, pp[,3], col="darkgreen", type="l", cex=0.45) # flew in T2 but not T1
  text(-0.035,0.7, labels="Did Not Fly", col="red")
  text(0.007,0.6, labels="Flew Twice", col="darkred")
  text(0.05,0.85, labels="Flew in T1 only", col="blue")
  text(0.014,0.1, labels="Flew in T2 only", col="darkgreen")
  #abline(v=0.011, lty=2, col="black")
  abline(v=0.027, lty=2, col="black")
  abline(v=-0.0165, lty=2, col="black")
  abline(v=-0.022, lty=2, col="black")
  # legend(-0.015, 0.99,
  #        legend = c("0","1", "2"),
  #        pch = c(2,1, 3),
  #        title="Flight Count",
  #        col=c("red","black","darkred")) 
}
pp1 <- fitted(model)
df1 <- df # for summary purposes
plot1(df1,pp1)
```

<a id="mass_percentage"></a>

**Multinom model: flight case ~ mass_per**

**Re-order**

```{r}
df <- df[with(df, order(mass_per)),]
```

```{r}
model <- multinom(flight_case ~ mass_per, data = df) 
model_table = calculate_P(model)
```
Model comparing flying only in T2 to the baseline (not flying at all) **is not significant (P = 0.97)**. That is probably because so few bugs (only male) flew in T2 only.

**Significant ML equations**

```{r}
run_multinom_model = function(d) {
  m <- multinom(flight_case ~ mass_per, trace=FALSE, data = d) 
  return(m)
}
get_significant_models()
```

```{r echo=FALSE}
# 2 vs. -1
odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=flew\\, in\\, T1\\, only)}$", " ")
effect = c("Intercept", "$\\delta$ Mass %")
pars = c("$\\alpha$", "$\\beta_1$")
estimate = round(c(1.2530401, -0.02354676),2)
SE = c(" ", round(0.007814186,2))
exp.b = c(" ",round(exp(-0.02354676*20),2))
wald = c(" ",round(9.08019,2))
pvals = c(" ",round(2.583931e-03,2))
key1 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

# 2 vs. 0
odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=did\\, not\\, fly)}$", " ")
estimate = round(c(0.3436623, 0.0205503655),2)
SE =c(" ", round(0.008238958,2))
exp.b = c(" ",round(exp(0.0205503655*20),2))
wald = c(" ",round(6.221491411,2))
pvals = c(" ",round(1.262088e-02,2))
key2 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

# -1 vs. 1
odds = c("$\\frac{P(Yi=flew\\, in\\, T1\\, only)}{P(Yi=flew\\, in\\, T2\\, only)}$", " ")
estimate = round(c(1.217852, 0.0432625817),2)
SE =c(" ", round(0.02012413,2))
exp.b = c(" ",round(exp(0.0432625817*20),2))
wald = c(" ",round(4.621580358,2))
pvals = c(" ",round(0.03157214,2))
key3 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

key = rbind(key1, key2, key3)
colnames(key) = c("Odds","Effect", "Parameter", "Estimate", "SE", "exp($\\beta*20$)", "Wald", "p")

kable(key) %>%
  kable_styling(bootstrap_options = "hover", full_width = F)  %>%
  add_header_above(c("Estimated Parameters, Standard Errors, and Wald Test Statistics for All Main Effects Model" = 8 )) %>%
  column_spec(1, width="6cm")

# kable(key, "latex", booktabs = T) %>%
#   kable_styling(bootstrap_options = "hover", full_width = F)  %>%
#   add_header_above(c("Estimated Parameters, Standard Errors, and Wald Test Statistics for All Main Effects Model" = 8 )) %>%
#   column_spec(1, width="6cm") %>%
#   as_image()
```


**The multinomial (ML) prediction equations are:**

```{r}
gsub("Mass Change",  "Mass Percent Change", prediction_equations(model_table))
```

```{r echo=FALSE}
eq1 = "Flew in T1 only rather than T2 only = 1.22 + 0.04 Mass %"
eq2 = "Flew in both rather than T1 only = 1.25 - 0.02 Mass %"
eq3 = "Flew in both rather than T2 only = 2.48 + 0.02 Mass %"

significance = c("sig", "sig", "not sig")
t = cbind(n_trials, c(eq1, eq2, eq3), significance)
colnames(t) = c("N","Model", "P")

kable(t) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F) 
```

**Estimated Odds**

For bugs of mass_perc x + 20%*(0.04) the estimated odds that bug flew in T1 rather than T2 equals

```{r}
exp(0.04*20)
```

times the estimated odds at mass_perc x (%). So for every 20% increase in a bug's original mass, the bug is 2.23 times more likely to fly only in T1. That makes sense because the odds of flying in T2 only are very low to begin with.

For bugs of mass_perc x + 40%*(-0.02), the estimated odds that the bug flew twice instead of only in T1 equals

```{r}
exp(40*-0.02) # 2.5 times less likely to fly twice if gain mass
exp(-40*-0.02) # 2.5 times more likely to fly twice if loose mass
```

times the estimated odds at mass_perc x (%). Similar message - for every 40% increase in a bug's original mass, the bug was 2.23 times more likely to fly only in T1 rather than fly twice. Although, when a bug looses 40% of original mass then becomes more likely to fly twice then only once. 

```{r}
exp(coef(model)*20) # this compares to no fly, the baseline # gain large % mass
exp(coef(model)*5) # gain small % mass
exp(coef(model)*-5) # loose small % mass
exp(coef(model)*-20) # loose large % mass
# 1/0 not significant
```
1 vs. 0 is not significant as already stated. However, -1 vs. 0 shows that as gain more mass then become increasingly more likely to only fly once. If loose mass then most likely to not fly at all, and more likely to fly twice then fly only once.

```{r}
head(pp <- fitted(model))
```

```{r echo=FALSE}
plot2 = function(df, pp) {
    plot(df$mass_per, pp[,1], xlim=c(-40, 103), ylim=c(0,1), col="red", type="l", ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", pch=2, cex=0.45) # no flight_diff | 0 is triangle
  points(df$mass_per, pp[,4], col="darkred", type="l", pch=3, cex=0.45)
  points(df$mass_per, pp[,2], col="blue", type="l", cex=0.45) # flew in T1 but not T2
  points(df$mass_per, pp[,3], col="darkgreen", type="l", cex=0.45) # flew in T2 but not T1
  text(-36,0.65, labels="Did Not \nFly", col="red")
  text(20,0.6, labels="Flew Twice", col="darkred")
  text(85,0.85, labels="Flew in T1 only", col="blue")
  text(20,0.1, labels="Flew in T2 only", col="darkgreen")
  #abline(v=0.011, lty=2, col="black")
  abline(v=53, lty=2, col="black")
  abline(v=-16.5, lty=2, col="black")
  abline(v=-28, lty=2, col="black")
  # legend(-0.015, 0.99,
  #        legend = c("0","1", "2"),
  #        pch = c(2,1, 3),
  #        title="Flight Count",
  #        col=c("red","black","darkred"))
}

pp2 = fitted(model)
df2 <- df # for summary purposes
plot2(df2,pp2)
```

For more on multinomial plotting for when have more than 1 predictor variables see the following: https://stats.idre.ucla.edu/r/dae/multinomial-logistic-regression/

<a id="adding_sex"></a>

#### Now let's compare some models

**First: flight_case, mass_diff, and sex**

```{r}
df <- df[with(df, order(mass_diff)),]
```

```{r, warnings = FALSE}
data <- data.frame(R = df$flight_case, 
         A = df$mass_diff,
         B = df$sex_c)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 2 FF.R")
```

```{r}
anova(m3, m4, test="Chisq") # Adding A*B does not improve fit
```

```{r echo=FALSE}
calculate_P2 = function(model, var1, var2, print_table=TRUE) {
  # compute p-values using Wald tests (i.e. z-tests)
  s <- summary(model) 
  z <- s$coefficients/s$standard.errors 
  wald <- z^2
  p <- (1 - pnorm(abs(z), 0, 1)) * 2
  
  # summary table (similar to lm, glm, or lmer function)
  model_table <- cbind(s$coefficients, c(s$edf, s$edf, s$edf), s$standard.errors[,2:3], z[,2:3], wald[,2:3], p[,2:3])
  colnames(model_table) <- c("(Intercept)", var1, var2,"DF", 
                            "SE1", "SE2", "z1", "z2", 
                            "ML wald","sex wald","P1 > |z|", "P2 > |z|")
  if (print_table) {
    cat("\n", "AIC: ", s$AIC, "\n") 
    print(round(model_table,3))
  }
  return(model_table)
}
```

```{r}
delta_mass_model <- multinom(flight_case ~ mass_diff + sex_c, data = df)
model_table = calculate_P2(delta_mass_model, "mass_diff", "sex_c")
```

**Significant models**

```{r echo=FALSE}
run_multinom_model = function(d) {
  m <- multinom(flight_case ~ mass_diff + sex_c, trace=FALSE, data = d) 
  model_table = calculate_P2(m, "mass_diff", "sex_c", print_table=FALSE)
  return(model_table)
}
get_significant_models = function(val_num){
  baselines = -1:2
  pvalues = matrix(NA, nrow = 4, ncol = 4)
  r = 0
  model_list = list()
  for (i in baselines) {
    r = r + 1
    df$flight_case <- relevel(as.factor(df$flight_case), ref = as.character(i))
    model_table = run_multinom_model(df)
    model_list[[r]] = as.data.frame(model_table)
    
    eqs = rownames(model_table)
    c = 0
    for (e in eqs){
      c = c + 1
      e = as.integer(e) + 2 
      pvalues[r,e] = model_table[c,val_num]
    } 
  }
  colnames(pvalues) = baselines
  rownames(pvalues) = baselines 

  #plot
  par(mar=c(5.1, 4.1, 3.1, 4.1))
  plot(pvalues, ylab="Baselines", xlab="Equation", main="p-values", 
     na.col="white", col=rev(grey.colors(7)), digits=4, 
     breaks=c(0.05,0.10, 0.5, 0.8, 1),
     text.cell=list(col="white", cex=1), max.col=170, border=NA, fmt.cell='%.2f', fmt.key='%.2f')
  
  return(model_list)
}
```

```{r}
MASS_ML = get_significant_models(11) # mass_diff
MASS_ML
SEX_ML = get_significant_models(12) # sex
SEX_ML
```

```{r echo=FALSE}
prediction_equations2 = function(tb, var1, var2, third_eq = TRUE) {
  # -1 / 1 | Flew in T1, not T2
  I = (tb[1,1] - tb[2,1])
  M = (tb[1,2] - tb[2,2])
  S = (tb[1,3] - tb[2,3])
  EQ1 = paste0("log(pi_-1 / pi_1) = ", round(I, 2), " + ", round(M,2), var1, " + ", round(S, 2), var2, "     Flew in T1, rather than T2" )
  
  if (third_eq) {
    # 2 / -1 | Flew in both, not T1
    I = (tb[3,1] - tb[1,1])
    M = (tb[3,2] - tb[1,2])
    S = (tb[3,3] - tb[1,3])
    EQ2 = paste0("log(pi_2 / pi_-1) = ", round(I, 2), " + ", round(M,2), var1, " + ", round(S, 2), var2, "     Flew in both, rather than T1" )
  }

  if (third_eq) {
    # 2 / 1 | Flew in both, not T2
    I = (tb[3,1] - tb[2,1])
    M = (tb[3,2] - tb[2,2])
    S = (tb[3,3] - tb[2,3])
    EQ3 = paste0("log(pi_2 / pi_1) = ", round(I, 2), " + ", round(M,2),  var1, " + ", round(S, 2), var2, "     Flew in both, rather than T2")
  }
  
  eqs = EQ1
  
  if (third_eq) {
    eqs = c(EQ1, EQ2, EQ3)
  }
  
  print("Where F = 1")
  return(eqs)
}
```

```{r}
prediction_equations2(model_table, " Mass Change", " Sex ")
```

```{r echo=FALSE}
eq1 = "Flew in T1 only rather than T2 only = 16.5 + 98.29 Mass Change + 15.49 Sex"
eq2 = "Flew in both rather than T1 only = 1.25 - 50.49 Mass Change - 0.1 Sex"
eq3 = "Flew in both rather than T2 only = 17.67 + 47.8 Mass Change + 15.39 Sex"

significance = c("not mass | sex**", "mass** | not sex", " not mass | sex** ")
t = cbind(n_trials, c(eq1, eq2, eq3), significance)
colnames(t) = c("N","Model", "P")

kable(t) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F) 
```

**Second: flight_case, mass_per, and sex**

```{r}
df <- df[with(df, order(mass_per)),]
```

```{r}
data <- data.frame(R = df$flight_case, 
         A = df$mass_per,
         B = df$sex_c)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 2 FF.R")
```
```{r}
anova(m3, m4, test="Chisq") # Adding A*B does not improve fit
```

```{r}
delta_mass_model <- multinom(flight_case ~ mass_per + sex_c, data = df)
model_table = calculate_P2(delta_mass_model, "mass_per", "sex_c")
```

```{r}
prediction_equations2(model_table, " Mass Percent Change", " Sex ")
```
**Significant models**

```{r}
run_multinom_model = function(d) {
  m <- multinom(flight_case ~ mass_per + sex_c, trace=FALSE, data = d) 
  model_table = calculate_P2(m, "mass_per", "sex_c", print_table=FALSE)
  return(model_table)
}
MASS_ML = get_significant_models(11) # mass per
MASS_ML
SEX_ML = get_significant_models(12) # sex
SEX_ML
```

```{r echo=FALSE}
# 2 vs. -1
odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=flew\\, in\\, T1\\, only)}$", " ", " ")
effect = c("Intercept", "$\\delta$ Mass %", "Sex")
pars = c("$\\alpha$", "$\\beta_1$", "$\\beta_2=F$")
estimate = round(c(1.139438, -0.02314856, -0.2096559),2)
SE = c(" ", round(c(0.008374107, 0.1965823),2))
exp.b = c(" ",round(c(exp(-0.02314856), exp(-0.2096559)),2))
wald = c(" ",round(c(7.641369,1.137432),2))
pvals = c(" ",round(c(5.704460e-03, 0.2861957009),2))
key1 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

# 2 vs. 1
odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=flew\\, in\\, T2\\, only)}$", " ", " ")
estimate = round(c(6.996531, 0.028594653, 4.776587),2)
SE = c(" ", round(c(0.02573154, 0.1901576),2))
exp.b = c(" ",round(c(exp(0.028594653),exp(4.776587)),2))
wald = c(" ",round(c(1.2349177, 630.9692),2))
pvals = c(" ",round(c(0.2664528,0),2))
key2 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

# 2 vs. 0
odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=did\\, not\\, fly)}$", " ", " ")
estimate = round(c(0.1236475, 0.019385661, -0.9015721),2)
SE = c(" ", round(c(0.008305979, 0.1586103),2))
exp.b =  c(" ",round(c(exp(0.019385661),exp(-0.9015721)),2))
wald = c(" ",round(c(5.4472786, 32.31009),2))
pvals = c(" ",round(c(1.959883e-02,0),2))
key3 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

# -1 vs. 1
odds = c("$\\frac{P(Yi=flew\\, in\\, T1\\, only)}{P(Yi=flew\\, in\\, T2\\, only)}$", " ", " ")
estimate = round(c(5.857132, 0.051742281, 4.986267),2)
SE = c(" ", round(c(0.02639275, 0.2103403),2))
exp.b =  c(" ",round(c(exp(3.8434553),exp(4.986267)),2))
wald = c(" ",round(c(4.621580358, 561.9610),2))
pvals = c(" ",round(c(0.0499405, 0),2))
key4 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

# -1 vs. 0
odds = c("$\\frac{P(Yi=flew\\, in\\, T1\\, only)}{P(Yi=did\\, not\\, fly)}$", " ", " ")
estimate = round(c(-1.0154279, 0.042521764, -0.6917921),2)
SE = c(" ", round(c(0.009686178, 0.2029708),2))
exp.b = c(" ",round(c(exp(0.042521764), exp(-0.6917921)),2))
wald = c(" ",round(c(19.2715935,11.61673),2))
pvals = c(" ",round(c(1.133807e-05, 0),2))
key5 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

# 1 vs. 0
odds = c("$\\frac{P(Yi=flew\\, in\\, T1\\, only)}{P(Yi=did\\, not\\, fly)}$", " ", " ")
estimate = round(c(-6.8204622, -0.009162539, -5.6256871),2)
SE = c(" ", round(c(0.026356158, 0.1831234),2))
exp.b = c(" ",round(c(exp(-0.009162539), exp(-5.6256871)),2))
wald = c(" ",round(c(0.1208558,943.76396),2))
pvals = c(" ",round(c(7.281082e-01,0),2))
key6 = cbind(odds, effect, pars, estimate, SE, exp.b, wald, pvals)

key = rbind(key1, key2, key3, key4, key5, key6)
colnames(key) = c("Odds","Effect", "Parameter", "Estimate", "SE", "exp($\\beta$)", "Wald", "p")
```

```{r echo=FALSE}
kable(key) %>%
  kable_styling(bootstrap_options = "hover", full_width = F)  %>%
  add_header_above(c("Estimated Parameters, Standard Errors, and Wald Test Statistics for All Main Effects Model" = 8 )) %>%
  column_spec(1, width="6cm")
# save_kable("model_table.pdf)
```

```{r echo=FALSE}
eq1 = "Flew in T1 only rather than T2 only = 5.81 + 0.05 Mass % + 4.93 Sex"
eq2 = "Flew in both rather than T1 only = 1.14 - 0.02 Mass % - 0.21 Sex"
eq3 = "Flew in both rather than T2 only = 6.94 + 0.03 Mass % + 4.72 Sex"

significance = c("mass** | sex**", "mass** | not sex", "not mass | sex**")
t = cbind(n_trials, c(eq1, eq2, eq3), significance)
colnames(t) = c("N","Model", "P")

kable(t) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F) 
```

**Estimated Odds**

**For males:**

For bugs of mass_perc x + 20%*(0.05), the estimated odds that bug flew in T1 rather than T2 equals

```{r}
exp(0.05*20)
```

times the estimated odds at mass_perc x (%). So for every 20% increase in a bug's original mass, the bug was 2.72 times more likely to fly only in T1. That makes sense because the odds of flying in T2 only are very low to begin with.

For bugs of mass_perc x + 20*(-0.02%), the estimated odds that the bug flew twice instead of only in T1 equals

```{r}
exp(20*-0.02) # 20 times less likely to fly twice if gain mass
exp(-20*-0.02) # 20 times more likely to fly twice if loose mass
```

times the estimated odds at mass_perc x (%). Similar message - for every 20% increase in a bug's original mass, the bug was 1.5 times more likely to fly only in T1. So, when a bug starts loosing mass it becomes more likely to fly twice then only once. 

**For females:**

For bugs of mass_perc x + 20%*(0.05), the estimated odds that bug flew in T1 rather than T2 equals

```{r}
exp(0.05*20 + 4.93)
```

times the estimated odds at mass_perc x (%). So for every 20% increase in a bug's original mass, the bug was **376** times more likely to fly only in T1. Crazy! It doesn't take much for a female to only fly once.


For bugs of mass_perc x + 20%*(0.05), the estimated odds that bug flew in both trials rather than T1 equals

```{r}
exp(-0.02*20 - 0.21)
exp(-0.02*-40 - 0.21)
```

times the estimated odds at mass_perc x (%). So half as likely to fly in both trials if gain mass. Would need to loose a lot of mass (40) to be almost twice as likely (1.8) to fly in both trials.

```{r}
exp(coef(delta_mass_model)*20) # this compares to no fly, the baseline # gain large % mass
exp(coef(delta_mass_model)*5) # gain small % mass
exp(coef(delta_mass_model)*-5) # loose small % mass
exp(coef(delta_mass_model)*-20) # loose large % mass
# 1/0 mass not sig but sex**
```

- If F and gain a lot of mass then most likely to fly only in T1 rather than none.
- If F and loose mass then most likely to not fly in either trial. 

**Predicted Probabilities**

```{r}
head(pp <- fitted(delta_mass_model))
```

```{r}
df$index = 1:nrow(df)
females = df %>%
  filter(sex=="F")
males = df %>%
  filter(sex=="M")
Frows = females$index
Mrows = males$index
```

```{r echo=FALSE}
plot3 = function(df, pp) {
  plot(df$mass_per[Frows], pp[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",
     type="l",
     #type="b", cex=0.45, pch=16, 
     ylab="Flight Case Probability", 
     xlab="Percent Mass Change From T1 to T2 (%)", lty=1, cex.axis=1.2, cex.lab=1.3)  
  points(df$mass_per[Mrows], pp[Mrows,1], col="red", type="l", cex=0.45, lty=2) 
  # pch=c(2,3)[as.factor(df$no_response_b[Frows])]
  points(df$mass_per[Frows], pp[Frows,2], col="blue", type="l", #type="b", cex=0.45, pch=16
         ) 
  points(df$mass_per[Mrows], pp[Mrows,2], col="blue", type="l", cex=0.45, lty=2)
  points(df$mass_per[Frows], pp[Frows,3], col="darkgreen", cex=0.45, type="l", pch=16) 
  points(df$mass_per[Mrows], pp[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=2) 
  points(df$mass_per[Frows], pp[Frows,4], col="darkred", 
         type="l", #type="b", cex=0.45, pch=16
         ) 
  points(df$mass_per[Mrows], pp[Mrows,4], col="darkred", type="l", cex=0.45, lty=2) 
  mtext("A", side=3, adj=0.01, line=0.5, cex=1.5, font=2)
  text(68,0.7, labels="Flew in T1 only", col="blue")
  text(-27,0.9, labels="Did Not Fly", col="red")
  text(13,0.37, labels="Flew Twice", col="darkred")
  #text(75,0.05, labels="Flew in T2 only", col="darkgreen")
  # female line is always higher
  # text(0.0,0.96, labels="F", col="red")
  # text(0.0,0.7, labels="M", col="red")
  # text(0.02,0.2, labels="F", col="blue")
  # text(0.0,0.25, labels="M", col="blue")
  # text(0.025,0.05, labels="F", col="darkgreen")
  # text(0.01,0.10, labels="M", col="darkgreen")
  # abline(v=40.5, lty=1, col="black")
  # abline(v=7.5, lty=3, col="black")
  # abline(v=-17, lty=3, col="black")
  # rect(56,-4,-24,2,col = rgb(0.5,0.5,0.5,1/4))
  # abline(v=-0.008, lty=2, col="slategrey")
  legend(83, 1.0,
         legend = c("female","male"),
         lty=1:2,
         col="black",
         cex=1.1)  
}
pp3 <- fitted(delta_mass_model)
df3 <- df # for summary purposes
plot3(df3,pp3)
```

No females flew in T2 only.

<a id="host_plant"></a>

#### Adding Host Plant

```{r}
df <- df[with(df, order(mass_diff)),]
```

```{r}
data <- data.frame(R = df$flight_case, 
         A = df$mass_diff,
         B = df$sex_c,
         C = df$host_c)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 3 FF.R")
```

```{r}
anova(m4, m7, test="Chisq") # Adding C (host plant) does not improve fit
```

Host plant is not significant.

<a id="wing2body"></a>

#### Wing2Body

```{r}
df <- df[with(df, order(mass_per)),]
df$wing2body_c = df$wing2body - mean(df$wing2body)
```

```{r}
data <- data.frame(R = df$flight_case, 
         A = df$mass_per,
         B = df$sex_c,
         C = df$wing2body_c)
model_script = paste0(source_path,"generic multinomial models- multinom 1RF + 3 FF.R")
model_comparisonsAIC(model_script)
```

```{r}
anova(m7, m12, test="Chisq") # adding A*C does not improve fit
anova(m7, m13, test="Chisq") # Adding B*C does not improve fit
```

```{r}
calculate_P3 = function(m, print_table=TRUE) {
  
  # compute p-values using Wald tests (i.e. z-tests)
  s <- summary(m) 
  z <- s$coefficients/s$standard.errors 
  wald <- z^2
  p <- (1 - pnorm(abs(z), 0, 1)) * 2
    
  # summary table (similar to lm, glm, or lmer function)
  model_table <- cbind(s$coefficients, c(s$edf, s$edf, s$edf), s$standard.errors[,2:4], z[,2:4], wald[,2:4], p[,2:4])
  colnames(model_table) <- c("(Intercept)", "mass %", "sex","wing2body","DF", 
                              "SE1", "SE2", "SE3", "z1", "z2", "z3",
                              "wald1","wald2", "wald3", "P1>|z|", "P2>|z|", "P3>|z|")
  if (print_table){
    cat("\n", "AIC: ", s$AIC, "\n") 
    print(round(model_table,3))    
  }
  return(model_table)
}
```

```{r}
#model <- multinom(flight_case ~ mass_per + sex_c + wing2body, data = df)
#model_table = calculate_P3(model)
model <- multinom(flight_case ~ mass_per + sex_c + wing2body_c, data = df)
model_table = calculate_P3(model)
```

Signal of flying in only T2 is weak, which is probably why the equation in the model was not significant. It does not differ much from not flying at all.

**Significant equations**

```{r}
run_multinom_model = function(d) {
  m <- multinom(flight_case ~ mass_per + sex_c + wing2body_c, trace=FALSE, data = d)
  model_table = calculate_P3(m, print_table=FALSE)
  return(model_table)
}
MASS_PER_ML = get_significant_models(15) # mass%
SEX_ML = get_significant_models(16) # sex
WING2BODY_ML = get_significant_models(17) # wing2body
```

```{r}
getting_odds = function(Odds, effect, pars, odds, r) {
  # Odds:     Equation of the odds written out as vector of strings.
  # effect:   Main effects written out as a vector of strings.
  # pars:     Parameters written out as a vector of strings
  # odds:     Model table ML equations for the given outcome and baseline.
  # r:        Row in which the outcome is indexed. 
  estimate = round(unlist(odds[r,1:4]),2)
  SE = c(" ", round(unlist(odds[r,6:8]),2))
  for (i in 2:4) {
    if (i == 2) {
      estimate[i] = estimate[i]*20
    }
    if (i == 4) {
      estimate[i] = round(estimate[i]/100,2)
    }
  }
  exp.b = c(" ",round(exp(estimate[2:4]),2))
  wald = c(" ",round(unlist(odds[r,12:14]),2))
  pvals = c(" ",round(unlist(odds[r,15:17]),2))
  key = cbind(Odds, effect, pars, estimate, SE, exp.b, wald, pvals) 
  
  return(key)
}
```

```{r}
# 2 vs. -1
Odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=flew\\, in\\, T1\\, only)}$", " ", " ", " ")
effect = c("Intercept", "$\\delta$ Mass %", "Sex", "Wing-to-Body")
pars = c("$\\alpha$", "$\\beta_1$", "$\\beta_2\\, (F=1 | M=-1)$", "$\\beta_3\\,(\\mu=0)$ ")
key1 = getting_odds(Odds, effect, pars, MASS_PER_ML[[1]], 3) 

# 2 vs. 1
Odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=flew\\, in\\, T2\\, only)}$", " ", " ", " ")
key2 = getting_odds(Odds, effect, pars, MASS_PER_ML[[3]], 3) 

# 2 vs. 0
Odds = c("$\\frac{P(Yi=flew\\,twice)}{P(Yi=did\\, not\\, fly)}$", " ", " ", " ")
key3 = getting_odds(Odds, effect, pars, MASS_PER_ML[[2]], 3) 

# -1 vs. 0
Odds = c("$\\frac{P(Yi=flew\\, in\\, T1\\, only)}{P(Yi=did\\, not\\, fly)}$", " ", " ", " ")
key4 = getting_odds(Odds, effect, pars, MASS_PER_ML[[2]], 1) 

# 1 vs. 0
Odds = c("$\\frac{P(Yi=flew\\, in\\, T2\\, only)}{P(Yi=did\\, not\\, fly)}$", " ", " ", " ")
key5 = getting_odds(Odds, effect, pars, MASS_PER_ML[[2]], 2) 

# -1 vs. 1
Odds = c("$\\frac{P(Yi=flew\\, in\\, T1\\, only)}{P(Yi=flew\\, in\\, T2\\, only}$", " ", " ", " ")
key6 = getting_odds(Odds, effect, pars, MASS_PER_ML[[3]], 2)

key = rbind(key1, key2, key3, key4, key5, key6)
rownames(key)<-NULL
colnames(key) = c("Odds","Effect", "Parameter", "Estimate*", "SE", "exp($\\beta$)*", "Wald", "p")
```

```{r}
kable(key, caption="Table 1. Estimated Parameters, Standard Errors, and Wald Test Statistics for All Main Effects Model") %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  column_spec(1, width="6cm") %>%
  kable_classic(html_font = "Cambria") %>%
  row_spec(c(4,8,12,16,20), extra_css = "border-bottom: 1px solid")
```

```{r echo=FALSE}
kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Estimated Parameters, Standard Errors, and Wald Test Statistics for All Main Effects Model" = 8)) %>%
  column_spec(1, width="6cm") 
#%>% row_spec(0, italic=T)
# save_kable("model_table.pdf)
```

Need to get the intercept SE and values 

**Odds**

```{r}
exp(0.02*20 - 0.76 + 28.09/100) # 20% increase in mass, female, and 1/20 increase in the wing2body ratio length

exp(0.02*20 + 0.76 + 28.09/100)

# confidence interval for wing2body ratio
exp((28.09 + 1.96*9.72)/100) 
exp((28.09 - 1.96*9.72)/100)
```


**Predicted Probabilities**

```{r}
head(pp <- fitted(model))
```

```{r echo=FALSE}
df$index = 1:nrow(df)
females = df %>%
  filter(sex=="F")
males = df %>%
  filter(sex=="M")
Frows = females$index
Mrows = males$index
```

```{r echo=FALSE}
plot4 = function(df, pp, gradient=TRUE, circles=TRUE) {
  c = 0.65
  plot(df$mass_per[Frows], pp[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",type="l", 
       ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3) 
  points(df$mass_per[Frows], pp[Frows,2], col="blue", type="l")
  points(df$mass_per[Frows], pp[Frows,4], col="darkred", type="l") 
  mtext(expression(italic("Females")), side=3, adj=0.05, line=-2, cex=1.5, font=2)
  mtext("B", side=3, adj=0.01, line=0.5, cex=1.5, font=2)
  text(68,0.7, labels="Flew in T1 only", col="blue")
  text(20,0.85, labels="Did Not Fly", col="red")
  text(-31,0.37, labels="Flew Twice", col="darkred")
  #text(53, 0.99, labels = expression(italic("flight_case ~ mass% + sex + wing2body")), cex=1.2)
  # legend(49, 1.1, 
  #        lty=1, 
  #        col=c("darkred", "blue", "darkgreen", "red"), 
  #        legend=c("Flew Twice", "Flew T1 Only", "Flew T2 Only", "Did Not Fly"), 
  #        text.col=c("darkred", "blue", "darkgreen", "red"),
  #        cex=1.1)
  
  if (gradient) {
    rbPal <- colorRampPalette(c('black','red'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Frows], pp[Frows, 1], pch=20, col=df$w2b_col[Frows])
    
    rbPal <- colorRampPalette(c('black','blue'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Frows], pp[Frows, 2], pch=20, col=df$w2b_col[Frows])
    
    rbPal <- colorRampPalette(c('black','violetred1'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Frows], pp[Frows, 4], pch=20, col=df$w2b_col[Frows])
  }

 if (circles) {
  # Mark points in the graph with high wing2body ratio vs. points with low wing2body ratio.
  test <- df[with(df, order(wing2body)),] # ascending order

  small = test %>%
    filter(sex =="F", wing2body < 0.7184934)
  large = test %>%
    filter(sex == "F", wing2body > 0.7184934)
  srows = small$index
  lrows = large$index

  points(df$mass_per[lrows], pp[lrows,1], col="red", type="p", cex=c, pch=16)
  points(df$mass_per[srows], pp[srows,1], col="red", type="p", cex=c)
  # those with smaller wing2body ratio were more likely to NOT fly
  points(df$mass_per[lrows], pp[lrows,2], col="blue", type="p", cex=c, pch=16)
  points(df$mass_per[srows], pp[srows,2], col="blue", type="p", cex=c)
  points(df$mass_per[lrows], pp[lrows,4], col="darkred", type="p", cex=c, pch=16)
  points(df$mass_per[srows], pp[srows,4], col="darkred", type="p", cex=c)
 }
  
}
pp6 = pp
df6 = df
```

```{r echo=FALSE}
plot5 = function(df, pp, gradient=TRUE, circles=TRUE) {
  c = 0.65
  plot(df$mass_per[Mrows], pp[Mrows,1], ylim=c(-0.00,0.8), xlim=c(-25,58), col="red",type="l", 
       ylab=" ", xlab="Percent Mass Change from T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3)
  points(df$mass_per[Mrows], pp[Mrows,2], col="blue", type="l", cex=0.45, lty=1)
  points(df$mass_per[Mrows], pp[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=1) 
  points(df$mass_per[Mrows], pp[Mrows,4], col="darkred", type="l", cex=0.45, lty=1) 
  mtext(expression(italic("Males")), side=3, adj=0.05, line=-2, cex=1.5, font=2)
  mtext("C", side=3, adj=0.01, line=0.5, cex=1.5, font=2)
  text(22,0.35, labels="Flew in T1 only", col="blue")
  text(52,0.17, labels="Did Not Fly", col="red")
  text(-16,0, labels="Flew in T2 only", col="darkgreen")
  text(13,0.77, labels="Flew Twice", col="maroon") # 13,0.77
  if (circles) {
    legend(38.5, .81, 
           pch=c(16,1), 
           title="Wing-to-body", 
           legend=c("> mean", "< mean"), 
           cex=1.1)
  }
  if (gradient) {
    legend(38.5, .81, 
           pch=c(16), 
           title="Wing-to-body", 
           col=c("grey", "black"),
           legend=c("high", "low"), 
           cex=1.1)
  }
  
  if (gradient) {
    rbPal <- colorRampPalette(c('black','red'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 1], pch=20, col=df$w2b_col[Mrows])
    
    rbPal <- colorRampPalette(c('black','blue'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 2], pch=20, col=df$w2b_col[Mrows])
    
    rbPal <- colorRampPalette(c('black','palegreen2'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 3], pch=20, col=df$w2b_col[Mrows])
    
    rbPal <- colorRampPalette(c('black','violetred1'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 4], pch=20, col=df$w2b_col[Mrows])
  }

 if (circles) {
  # Mark points in the graph with high wing2body ratio vs. points with low wing2body ratio. 
  test <- df[with(df, order(wing2body)),] # ascending order
  #test$index
  
  small = test %>%
    filter(sex =="M", wing2body < 0.7184934)
  large = test %>%
    filter(sex == "M", wing2body > 0.7184934)
  srows = small$index
  lrows = large$index
  
  points(df$mass_per[lrows], pp[lrows,1], col="red", type="p", cex=c, pch=16)
  points(df$mass_per[srows], pp[srows,1], col="red", type="p", cex=c)
  # those with smaller wing2body ratio were more likely to NOT fly
  points(df$mass_per[lrows], pp[lrows,2], col="blue", type="p", cex=c, pch=16)
  points(df$mass_per[srows], pp[srows,2], col="blue", type="p", cex=c)
  points(df$mass_per[lrows], pp[lrows,3], col="darkgreen", type="p", cex=c, pch=16)
  points(df$mass_per[srows], pp[srows,3], col="darkgreen", type="p", cex=c)
  points(df$mass_per[lrows], pp[lrows,4], col="darkred", type="p", cex=c, pch=16)
  points(df$mass_per[srows], pp[srows,4], col="darkred", type="p", cex=c)
 }
}
```

```{r echo=FALSE, fig.width=3.2*1.7, fig.height=2.8}
par(mfrow=c(1,2), tcl=-0.5) # length of tick marks set at default

par(mai=c(1,0.85,0.4,0)) # bottom, right, top, left
plot4(df6,pp6, gradient=TRUE, circles=FALSE)

par(mai=c(1,0.6,0.4,0.05))
plot5(df6,pp6, gradient=TRUE, circles=FALSE)
```

```{r echo=FALSE, fig.width=3.2*1.7, fig.height=2.8}
par(mfrow=c(1,1), tcl=-0.5)
#plot(0, xaxt = 'n', yaxt = 'n', bty = 'n', pch = '', ylab = '', xlab = '')
#par(mai=c(1,0,0.4,0.05)) 
plot3(df3,pp3)
```


Amazing to see what a clear impact wing2body ratio has for whether bugs are more likely to fly twice or not fly at all. Those with wing2body ratios above the mean wing2body ratio appear to be more likely to fly twice and less likely to not fly. This is true across females and males.

<a id="fem_only"></a>

#### Females only 

**Baseline**

```{r}
df <- d %>%
  filter(!is.na(egg_diff), !is.na(mass_diff), !is.na(flew_diff), sex_c == 1)

df <- df[with(df, order(mass_diff)),]

n_tfemales = nrow(df)

df$flight_case <- relevel(as.factor(df$flight_case), ref = "0")
```

**Barplot**

```{r echo=FALSE}
data_fem = data_tested %>%
    filter(sex=="F")
bar2 = function() {
  # fig.height=2.4, fig.width=2.7
  counts <- table(data_fem$eggs_b, data_fem$trial_type) # data_tested$flew_b
  counts <- counts[1:2,2:3]
  barplot(counts, #main="Flight Distribution by Trial",
    xlab="Trial", col=c("lightblue","darkgoldenrod2"),
    legend = c("no eggs", "yes eggs"), ylim=c(0,110), beside=TRUE)
} 
bar2()
```

**Egg Case**

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("laid eggs in both trials", "laid eggs in T2 only", "laid eggs in neither trials", "laid eggs in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Egg Response Key" = 2 )) 
```

**Baseline**

```{r}
df <- d %>%
  filter(!is.na(egg_case), !is.na(mass_diff), !is.na(flew_diff), sex_c == 1)

df <- df[with(df, order(mass_diff)),]

n_tfemales = nrow(df)

df$flight_case <- relevel(as.factor(df$flight_case), ref = "0")
```

**Null model**

```{r}
df$flight_case = droplevels(df$flight_case) # no female bug only flew in T2
null <- multinom(flight_case ~ 1, data = df) 
```

**Multinom model: flew_diff ~ egg_case**

```{r}
model <- multinom(flight_case ~ egg_case, data = df) 
model_table = calculate_P(model)
```
```{r}
anova(null, model, test="Chisq") # adding egg_case improves fit
```

**Significant models**

```{r echo=FALSE}
run_multinom_model = function(d) {
  m <- multinom(flight_case ~ egg_case, trace=FALSE, data = d) 
  model_table = calculate_P(m, print_table=FALSE)
  return(model_table)
}
get_significant_modelsf = function(num_val){
  baselines = c(-1, 0, 2)
  pvalues = matrix(NA, nrow = 4, ncol = 4)
  r = 0
  for (b in baselines) {
    r = r + 1
    df$flight_case <- relevel(as.factor(df$flight_case), ref = as.character(b))
    model_table = run_multinom_model(df)

    eqs = rownames(model_table)
    c = 0
    for (e in eqs){
      if (r == 3) {
        r =4
      }
      c = c + 1
      e = as.integer(e) + 2 
      pvalues[r,e] = model_table[c,num_val]
    } 
  }
  colnames(pvalues) = c(-1, 0, NA, 2)
  rownames(pvalues) = c(-1, 0, NA, 2) 

  #plot
  par(mar=c(5.1, 4.1, 3.1, 4.1))
  plot(pvalues, ylab="Baselines", xlab="Equation", main="p-values", 
     na.col="white", col=rev(grey.colors(7)), digits=4, 
     breaks=c(0.05,0.10, 0.5, 0.8, 1),
     text.cell=list(col="white", cex=1), max.col=170, border=NA, fmt.cell='%.2f', fmt.key='%.2f')
}
```

```{r}
get_significant_modelsf(7) #-1/0 egg case not sig | 0/-1 or 2/-1 egg case not sig | -1/2 egg case not sig | but 0/2 and 2/0 egg case**
```

**Comparing models: adding host**

Adding host with egg_diff and mass_diff

```{r echo=FALSE}
# key 
Host = c("Golden Rain Tree (GRT)", "Balloon Vine (BV)")
Encoding = c(1,-1)
key = cbind(Host, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Host Plant Key" = 2 )) 
```

```{r}
data <- data.frame(R = df$flight_case, 
         A = df$egg_case,
         B = df$mass_diff,
         C = df$host_c)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 3 FF.R")
```
```{r}
anova(m4, m7, test="Chisq") # Adding C does not improve fit
anova(m7, m13, test="Chisq") # Adding  mass_diff*host does not improve fit
```
```{r}
model <- multinom(flight_case ~ mass_diff + egg_case, data = df) 
model_table = calculate_P2(model, "mass_diff", "egg_case")
```

**Significant eqs**

```{r}
run_multinom_model = function(d) {
  m <- multinom(flight_case ~ mass_diff + egg_case, trace=FALSE, data = d) 
  model_table = calculate_P2(m, "mass_diff", "egg_case", print_table=FALSE)
  return(model_table)
}
get_significant_modelsf(11) # mass diff
get_significant_modelsf(12) # egg_case
```


```{r}
tb = model_table
# -1 / 2 | Flew in T1, not T2
I = (tb[1,1] - tb[2,1])
M = (tb[1,2] - tb[2,2])
E = (tb[1,3] - tb[2,3])
EQ1 = paste0("log(pi_-1 / pi_2) = ", round(I, 2), " + ", round(M,2), " Mass Diff", " + ", round(E, 2), " Egg Case", "     Flew in T1, rather than both" )
EQ1  # mass_dff** | sex not
```

**Predicted Probabilities**

```{r}
head(pp <- fitted(model))
```
```{r echo=FALSE}
df$index = 1:nrow(df)

eggT1 = df %>%
  filter(egg_case==-1)
egg0 = df %>%
  filter(egg_case==0)
egg2 = df %>%
  filter(egg_case==2)
eggT2 = df %>%
  filter(egg_case==1)

eggT1_rows = eggT1$index
egg_0rows = egg0$index
egg_2rows = egg2$index
eggT2_rows = eggT2$index
```

```{r echo=FALSE}
df <- df[with(df, order(mass_diff)),]
plot6 = function(df, pp) {
  # only laid eggs in T1
  plot(df$mass_diff[eggT1_rows], pp[eggT1_rows,1], ylim=c(0,1.05), xlim=c(-0.045,0.07), col="red", type="l", lty=1,main="Females Only", ylab="Flight Case Probability", xlab="Change in Mass From T1 to T2 (g)") 
  points(df$mass_diff[eggT1_rows], pp[eggT1_rows,2], col="blue", type="l", lty=1, cex=0.45) 
  points(df$mass_diff[eggT1_rows], pp[eggT1_rows,3], col="black", type="l", lty=1, cex=0.45) 
  # no egg change
  points(df$mass_diff[egg_0rows], pp[egg_0rows,1], col="red", type="l", lty=2) # did not fly in either
  points(df$mass_diff[egg_0rows], pp[egg_0rows,2], col="blue", type="l", lty=2) # flew in T1 only
  points(df$mass_diff[egg_0rows], pp[egg_0rows,3], col="black", type="l", lty=2) # flew in both
  # eggs twice
  points(df$mass_diff[egg_2rows], pp[egg_2rows,1], col="red", type="l", lty=4) # did not fly in either
  points(df$mass_diff[egg_2rows], pp[egg_2rows,2], col="blue", type="l", lty=4) # flew in T1 only
  points(df$mass_diff[egg_2rows], pp[egg_2rows,3], col="black", type="l", lty=4) # flew in both
  # only laid eggs in T2
  points(df$mass_diff[eggT2_rows], pp[eggT2_rows,1], col="red", type="l", lty=3) # flew in neither
  points(df$mass_diff[eggT2_rows], pp[eggT2_rows,2], col="blue", type="l", lty=3) # flew in T1 only
  points(df$mass_diff[eggT2_rows], pp[eggT2_rows,3], col="black", type="l", lty=3) # flew in both
  
  
  rect(-0.038,-1,0.064,2, NA, col = rgb(0.5,0,0.5,1/15), border="pink") # most likely to not fly unless gain more than about 0.025 g mass and then fly only in T1 (eggs were laid twice).
  rect(-0.045,-1,0.038,2, NA, col = rgb(0.5,0.2,0.5,1/15), border="pink") # most likely to not fly (2nd widest mass change, and laid eggs in T2)
  rect(-0.039,-1,0.008,2, NA, col = rgb(0.1,0.5,0.5,1/10), border="lightblue") # most likely to fly twice (lost mass and laid eggs only in T1)
  rect(-0.005,-1,0.029,2, NA, col = rgb(0.4,0.5,0.5,1/4), border="lightblue") # most likely to fly twice always (smallest mass change and did not lay eggs)
  
  text(0.059,0.54, labels="Flew in T1 only", col="blue")
  text(-0.036,0.95, labels="Did Not Fly", col="red")
  text(-0.02,0.35, labels="Flew Twice", col="black")
  legend(0.033, 1.07,
         legend = c("laid eggs in T1","no eggs laid", "eggs laid twice", "laid eggs in T2"),
         lty=1:4,
         col="black",
         cex=0.8)
}
pp5 = fitted(model)
df5 = df
plot6(df5,pp5)
```


```{r}
matrix = rbind(cbind(df$mass_diff[eggT1_rows], 
            pp[eggT1_rows,1],pp[eggT1_rows,2], pp[eggT1_rows,3]),
      cbind(df$mass_diff[egg_0rows], pp[egg_0rows,1], pp[egg_0rows,2],
            pp[egg_0rows,3]), 
      cbind(df$mass_diff[egg_2rows], pp[egg_2rows,1], pp[egg_2rows,2],
            pp[egg_2rows,3]),
      cbind(df$mass_diff[eggT2_rows], pp[eggT2_rows,1], pp[eggT2_rows,2], 
            pp[eggT2_rows,3]))
colnames(matrix) = c("mass_diff", "No", "T1", "Twice")
#write.csv(matrix, "data/animate_eggs.csv") # for interactive graphs
```

- Eggs laid twice: most likely to not fly unless gain more than about 0.025 g mass and then fly only in T1 (largest mass change)
- Eggs laid in T2:  most likely to not fly (2nd widest mass change)
- Eggs laid only in T1: most likely to fly twice (mostly only lost mass)
- Eggs not laid: most likely to fly twice always (smallest mass change and mostly only gained about 0.030 g)

<a id="fem_wings"></a>

**wing2body**

**Baseline**

```{r}
df <- d %>%
  filter(!is.na(egg_case), !is.na(mass_diff), !is.na(flew_diff), !is.na(wing2body), sex_c == 1)

df <- df[with(df, order(mass_diff)),]

n_tfemales = nrow(df)

df$flight_case <- relevel(as.factor(df$flight_case), ref = "0")
```

```{r warning=FALSE}
data <- data.frame(R = df$flight_case, 
         A = df$egg_case,
         B = df$mass_diff,
         C = df$wing2body)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 3 FF.R") # strange error...
```
```{r}
anova(m4, m7, test="Chisq") # adding wing2body does not include fit
anova(m7, m12, test="Chisq") # Adding A*C does not improve fit
anova(m7, m11, test="Chisq") 
anova(m7, m13, test="Chisq") 
anova(m4, m8, test="Chisq") # Adding A*B does not improve fit
```

wing2body is not in the top model for females

### Encodings

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("flew in both trials", "flew in T2 only", " flew in neither trials", "flew in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

```{r echo=FALSE}
# key = change in mass
Event = c("gained mass from T1 to T2", "no mass change between trails", "lost mass from T1 to T2")
Sign = c("pos","0","neg")
key = cbind(Event, Sign)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Mass Key" = 2 )) 
```

```{r echo=FALSE}
# key 
Host = c("Golden Rain Tree (GRT)", "Balloon Vine (BV)")
Encoding = c(1,-1)
key = cbind(Host, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Host Plant Key" = 2 )) 
```


**Females Only**

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("flew in both trials", "flew in neither trial", "flew in T1 only")
Encoding = c(2,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("laid eggs in both trials", "laid eggs in T2 only", "laid eggs in neither trials", "laid eggs in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Egg Response Key" = 2 )) 
```

### Summary

**flight case ~ mass diff**

```{r echo=FALSE}
plot1(df1,pp1)
```

**flight case ~ mass per**

```{r echo=FALSE}
plot2(df2,pp2)
```

**flight case ~ mass per and sex**

```{r echo=FALSE}
plot3(df3,pp3)
```

**wing2body**

```{r echo=FALSE}
plot4(df6,pp6, gradient=TRUE, circles=FALSE)
```

```{r echo=FALSE}
plot5(df6,pp6, gradient=TRUE, circles=FALSE)
```


**females only**

**flight case ~ mass diff and egg case**

```{r echo=FALSE}
plot6(df5,pp5)
```

### Questions

- Egg case and egg diff not factors. Not sure how to work around this problem.
- Animate plots?
- For Fall season some bugs were tested more than 2 times (up to four times), but which to pull from and from which experiments?

