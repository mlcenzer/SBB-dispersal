---
title: "Delta Flight Response"
author: "Anastasia Bernat"
date: "12/16/2020"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat_working_on/Dispersal/Winter_2020/stats/"
setwd(dir) 

# modeling and data manipulation
library(lme4)
library(dplyr)
library(nnet) # multinom package

# tables
library(knitr)
library(kableExtra)

# plotting
library(rethinking) 
library(ggformula)

knitr::opts_chunk$set(echo = TRUE)
```

## Multinomial Flight Modeling {.tabset}

Flight Trials Winter 2020 were conducted from 2/17/2020 - 3/10/2020. Soapberry bugs were flight tested twice (T1 vs. T2) for multiple hours in the flight mill and observed from 8 AM to (5-8 PM) each day. I used  multicategorical, nominal modeling (multinom) to analyze how sex and host plant as well as changes in mass and egg-laying changed a soapberry bug's flight response between trials. 

### Delta Flight Response (T1 vs. T2)

[Introduction](#intro)

[Clean the Data](#clean_data)

[Flight Case ~ Mass Diff ](#mass_difference)

[Flight Case ~ Mass Per ](#mass_percentage)

[Flight Case ~ Mass Diff or Mass Perc + Sex ](#adding_sex)

[Flight Case ~ Mass Diff or Mass Perc + Sex + Host Plant ](#host_plant)

Females Only

- [Flew Diff ~ Egg Diff ](#fem_only)
- [Flew Diff ~ Egg Case ](#fem_only_case)

<a id="intro"></a>

#### Introduction

Graphs I generated below illustrate how changes in mass (more specifically % mass) or egg-laying led to changes in flight response. To generate these graphs, I ran multicategorical regressions to model the probability of different flight delta cases due to sex, host plant, and changes in mass or egg-laying. Changes in speed and distance as a result of changes in mass or egg-laying were not analyzed here but rather in a separate script.

To perform these analyses, a new variable will be created called "flight_case" which calculates the flight response differences between T1 and T2. Here is a formula and key describing each flight case event and encoding: 

**Formula** ***: flight case = response in*** $T_2$ ***- response in*** $T_1$

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("flew in both trials", "flew in T2 only", " flew in neither trials", "flew in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

Since the outcomes (or response variables) were no longer binomial, I used multicategorical logit models (refer to Chapter 6 of *An Introduction to Categorical Data Analysis, Second Edition* by Alan Agresti). Below I've written out notes on performing these analyses.

**What we are interested in is a multicategorical, nominal response variable.** When the response variable is nominal, there is no natural order among the response variable categories (unordered categories). When the response variable is multicategorical, its multicategory models assume that the counts in the categories of $Y$ have a *multinomial distribution*.

Let J = number of categories for $Y$.

$\pi_1,...\pi_J$ = the response probabilities where $\sum_j \pi_j = 1$.

With $n$ independent observations, the probability distribution for the number of outcomes of the J types is the multinomial. It specifies the probability for each possible way the $n$ observations can fall in the J categories. Multicategory logit models simultaneously use all pairs of categories by specifying the odds of outcome in one category instead of another. 

Logit models for nominal response variables pair each category with a baseline category. The choice of the baseline category is arbitrary. When the last category (J) is the baseline, the **baseline-category logits** are

<div align="center">$\log (\frac{\pi_j}{\pi_J}), j = 1, ..., J - 1$.</div> <br/>

Given that the response falls in category j or category J, this is the log odds that the response is j. **For J = 3**, for instance, the model uses $\log(\pi_1/\pi_3)$ and $\log(\pi_2/\pi_3)$. The baseline-category logit model with a predictor x is

<div align="center">$\log \frac{\pi_j}{\pi_J} = \alpha_J + \beta_j x, j = 1, ..., J - 1$</div> <br/>

The model has J - 1 equations, with separate parameters for each. **The effects vary according to the category paired with the baseline**. When J = 2, this model simplifies to a single equation for $\log(\pi_1/\pi_2) = logit(\pi_1)$, resulting in ordinary logistic regression for binary responses. 

So how do these pair of categories determine equations for all other pairs of categories? Here is an arbitrary pair of categories a and b that follows the general equation above,

<div align="center">$\log (\frac{\pi_a}{\pi_b}) = \log ( \frac{\pi_a/pi_J}{\pi_b/pi_J}) = \log (\frac{\pi_a}{\pi_J}) -  \log (\frac{\pi_b}{\pi_J})$

$= (\alpha_a + \beta_a x) - (\alpha_b + \beta_b x)$

$= (\alpha_a - \alpha_b) + (\beta_a - \beta_b) x$ </div> <br/>
So, the equation for categories a and b has the form $\alpha + \beta x$ with intercept parameter $\alpha = (\alpha_a - \alpha_b)$ and with slope parameter $\beta = (\beta_a - \beta_b)$.

Let's apply it to our data now:

<a id="clean_data"></a>

#### Cleaning the Data

```{r message=FALSE, warning=FALSE}
output_col = FALSE # Change to TRUE if working in Base R or RStudio; FALSE if generating an HTML
source("src/clean_flight_data.R") # Loads and cleans data
source("src/regression_output.R") # Cleans regression outputs; prints in color or black & white
source("src/center_flight_data.R") # Re-centers data
source("src/get_warnings.R")

data <- read_flight_data("data/all_flight_data-Winter2020.csv")
data_all <- data[[1]]
data_tested <- data[[2]]
source("src/unique_flight_data.R")
d <- create_delta_data(data_tested)
```

```{r}
colnames(d)
```
#### Age Effect 

Age also plays a role in this dataset, but age was unknown because the soapberry bugs were field collected.

```{r, echo=FALSE}
# fig.height=2.4, fig.width=2.7
```

```{r echo=FALSE}
counts <- table(data_tested$flew_b, data_tested$trial_type)
counts <- counts[1:2,2:3]
barplot(counts, #main="Flight Distribution by Trial",
  xlab="Trial", col=c("lightblue","darkgoldenrod2"),
  legend = c("no flew", "yes flew"), ylim=c(0,250), beside=TRUE)
```

#### Modeling

Below I used the **multinom function** from the **nnet package** to estimate a *multinomial logistic regression* model. There are other functions in other R packages capable of multinomial regression. I chose the multinom function because it does not require the data to be reshaped (as the mlogit package does) and to mirror the example code found in Hilbeâ€™s *Logistic Regression Models*.

First, I chose the baseline by specifying the level using relevel function. Then, I ran our model using multinom. The multinom package does not include p-value calculations for the regression coefficients, so I calculated *P* using **Wald tests (i.e. z-tests)**.

<a id="mass_difference"></a>

Finally, I considered **mass difference** as my predictor variable where a (+) sign means the bug gained mass between trials and a (-) sign means the bug lost mass between trials.

```{r echo=FALSE}
# key = change in mass
Event = c("gained mass from T1 to T2", "no mass change between trails", "lost mass from T1 to T2")
Sign = c("pos","0","neg")
key = cbind(Event, Sign)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Mass Key" = 2 )) 
```

**Baseline**

```{r}
df <- d %>%
  filter(!is.na(mass_diff), !is.na(flight_case)) 
  
df <- df[with(df, order(mass_diff)),]
n_trials = nrow(df)

df$flight_case <- relevel(as.factor(df$flight_case), ref = "0")
```

**Null model**

```{r}
null <- multinom(flight_case ~ 1, data = df) 
```

**Multinom model: flight_case ~ mass_diff**

```{r echo=FALSE}
calculate_P = function(model) {
  # compute p-values using Wald tests (i.e. z-tests)
  s <- summary(model) 
  z <- s$coefficients/s$standard.errors 
  wald <- z^2
  p <- (1 - pnorm(abs(z), 0, 1)) * 2
  
  # summary table (similar to lm, glm, or lmer function)
  model_table <- cbind(s$coefficients, c(s$edf, s$edf), s$standard.errors[,2], z[,2], wald[,2], p[,2])
  colnames(model_table) <- c("(Intercept)"," Estimate","DF", "Std. Err.", "z", "wald", "P > |z|")
  cat("\n", "AIC: ", s$AIC, "\n")
  print(model_table)
  return(model_table)
}
```

```{r}
model <- multinom(flight_case ~ mass_diff, data = df) 
model_table = calculate_P(model)
```
```{r}
anova(null, model, test="Chisq") # adding mass_diff improves fit 
```

**The multinomial (ML) prediction equations are:**

```{r echo=FALSE}
prediction_equations = function(tb) {
  # -1 / 1 | Flew in T1, not T2
  I = (tb[1,1] - tb[2,1])
  M = (tb[1,2] - tb[2,2])
  EQ1 = paste0("log(pi_-1 / pi_1) = ", round(I, 2), " + ", round(M,2), " Mass Change     Flew in T1, rather than T2" )
  
  # 2 / -1 | Flew in both, not T1
  I = (tb[3,1] - tb[1,1])
  M = (tb[3,2] - tb[1,2])
  EQ2 = paste0("log(pi_2 / pi_-1) = ", round(I, 2), " + ", round(M,2), " Mass Change     Flew in both, rather than T1" )
  
  # 2 / 1 | Flew in both, not T2
  I = (tb[3,1] - tb[2,1])
  M = (tb[3,2] - tb[2,2])
  EQ3 = paste0("log(pi_2 / pi_1) = ", round(I, 2), " + ", round(M,2),  " Mass Change     Flew in both, rather than T2")
  
  eqs = c(EQ1, EQ2, EQ3)
  return(eqs)
}
```

```{r}
prediction_equations(model_table)
```

```{r echo=FALSE}
eq1 = "Flew in T1 only rather than T2 only = 1.36 + 62.51 Mass Change"
eq2 = "Flew in both rather than T1 only = 1.19 - 43.88 Mass Change"
eq3 = "Flew in both rather than T2 only = 2.55 + 18.63 Mass Change"

t = cbind(n_trials, c(eq1, eq2, eq3))
colnames(t) = c("N","Model")

kable(t) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F) 
```

**Estimated Odds**

For bugs of mass_diff x + 1 * (1/50 g or 0.02 g), the estimated odds that the bug flew in T1 rather than T2 equals

```{r}
exp(62.51/50)
```

times the estimated odds at mass_diff x (g). As gain mass, then less likely to fly again.

For bugs of mass_diff x + 1/50 (0.02) g, the estimated odds that the bug flew twice rather than only in T1 equals

```{r}
exp(-43.88/50)
```

times the estimated odds at mass_diff x (g). Same idea - as gain mass, then less likely to fly again. 

For bugs of mass_diff x + 1/50 (0.02) g, the estimated odds that the bug flew twice rather than only in T2 equals

```{r}
exp(18.63/50)
```

times the estimated odds at mass_diff x (g). As gain mass, then more likely to fly twice rather than fly only in T2. So the case of flying twice is more likely than only flying in T2 more so because only flying in T2 is a very rare case if you gain mass. So flying twice is more likely when a bug gains mass but not necessarily *most likely*. What is most likely is flying only in T1 if a bug gains mass

```{r}
exp(coef(model)/50) # this compares to not flying, the baseline 
```

**Predicted probabilities** 

You can also use predicted probabilities to help you understand the model. **The multicategory logit model has an alternative expression in terms of the response probabilities**. This is

<div align="center">$\pi_j = \frac{e^{\alpha_j + \beta_j x}}{\sum_he^{\alpha_h + \beta_h x}}, j=1,...,J$</div> <br/>

The denominator is the same for each probability, and the numerators for various j sum to the denominator where $\sum_j \pi_j = 1$. The parameters ($\alpha$ and$\beta$) equal zero for whichever category is the baseline in the logit expressions. So these would be the equations for the model above:

<div align="center">$\hat{\pi_{-1}} = \frac{e^{-1.77 + 69.21 x}}{1 + e^{-1.77 + 69.21 x} + e^{-2.13 - 6.70 x} + e^{0.42 + 25.33 x}}, j=1,...,J$

$\hat{\pi_1} = \frac{e^{-2.13 - 6.70 x}}{1 + e^{-1.77 + 69.21 x} + e^{-2.13 - 6.70 x} + e^{0.42 + 25.33 x}}, j=1,...,J$

$\hat{\pi_2} = \frac{e^{0.42 + 25.33 x}}{1 + e^{-1.77 + 69.21 x} + e^{-2.13 - 6.70 x} + e^{0.42 + 25.33 x}}, j=1,...,J$

$\hat{\pi_0} = \frac{e^{0 + 0 x} = 1}{1 + e^{-1.77 + 69.21 x} + e^{-2.13 - 6.70 x} + e^{0.42 + 25.33 x}}, j=1,...,J$

x = mass_diff, which can give you the estimated probabilities.</div><br/>

You can calculate these predicted probabilities for each of our outcome levels using the fitted function. You can start by generating the predicted probabilities for the observations in our dataset and viewing the first few rows. Then, you can plot them.

```{r}
head(pp <- fitted(model))
```
```{r echo=FALSE}
plot(df$mass_diff, pp[,1], ylim=c(0,1), col="red", type="l", ylab="Flight Case Probability", xlab="Changes in Mass From T1 to T2 (g)", pch=2, cex=0.45) # no flight_diff | 0 is triangle
points(df$mass_diff, pp[,4], col="darkred", type="l", pch=3, cex=0.45)
points(df$mass_diff, pp[,2], col="blue", type="l", cex=0.45) # flew in T1 but not T2
points(df$mass_diff, pp[,3], col="darkgreen", type="l", cex=0.45) # flew in T2 but not T1
text(-0.035,0.7, labels="Did Not Fly", col="red")
text(0.007,0.6, labels="Flew Twice", col="darkred")
text(0.05,0.85, labels="Flew in T1 only", col="blue")
text(0.014,0.1, labels="Flew in T2 only", col="darkgreen")
#abline(v=0.011, lty=2, col="black")
abline(v=0.027, lty=2, col="black")
abline(v=-0.0165, lty=2, col="black")
abline(v=-0.022, lty=2, col="black")
# legend(-0.015, 0.99,
#        legend = c("0","1", "2"),
#        pch = c(2,1, 3),
#        title="Flight Count",
#        col=c("red","black","darkred"))
```
```{r echo=FALSE}
pp1 <- fitted(model)
df1 <- df # for summary purposes
```

<a id="mass_percentage"></a>

**Multinom model: flight case ~ mass_per**

**Re-order**

```{r}
df <- df[with(df, order(mass_per)),]
```

```{r}
model <- multinom(flight_case ~ mass_per, data = df) 
model_table = calculate_P(model)
```
Model comparing flying only in T2 to the baseline (not flying at all) **is not significant (P = 0.97)**. That is probably because so few bugs (only male) flew in T2 only.

**The multinomial (ML) prediction equations are:**

```{r}
gsub("Mass Change",  "Mass Percent Change", prediction_equations(model_table))
```

```{r echo=FALSE}
eq1 = "Flew in T1 only rather than T2 only = 1.22 + 0.04 Mass %"
eq2 = "Flew in both rather than T1 only = 1.25 - 0.02 Mass %"
eq3 = "Flew in both rather than T2 only = 2.48 + 0.02 Mass %"

t = cbind(n_trials, c(eq1, eq2, eq3))
colnames(t) = c("N","Model")

kable(t) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F) 
```

**Estimated Odds**

For bugs of mass_perc x + 20%*(0.04) the estimated odds that bug flew in T1 rather than T2 equals

```{r}
exp(0.04*20)
```

times the estimated odds at mass_perc x (%). So for every 20% increase in a bug's original mass, the bug is 2.23 times more likely to fly only in T1. That makes sense because the odds of flying in T2 only are very low to begin with.

For bugs of mass_perc x + 40%*(-0.02), the estimated odds that the bug flew twice instead of only in T1 equals

```{r}
exp(40*-0.02) # 2.5 times less likely to fly twice if gain mass
exp(-40*-0.02) # 2.5 times more likely to fly twice if loose mass
```

times the estimated odds at mass_perc x (%). Similar message - for every 40% increase in a bug's original mass, the bug was 2.23 times more likely to fly only in T1 rather than fly twice. Although, when a bug looses 40% of original mass then becomes more likely to fly twice then only once. 

```{r}
exp(coef(model)*20) # this compares to no fly, the baseline # gain large % mass
exp(coef(model)*5) # gain small % mass
exp(coef(model)*-5) # loose small % mass
exp(coef(model)*-20) # loose large % mass
```
1 vs. 0 is not significant as already stated. However, -1 vs. 0 shows that as gain more mass then become increasingly more likely to only fly once. If loose mass then most likely to not fly at all, and more likely to fly twice then fly only once.

```{r}
head(pp <- fitted(model))
```

```{r echo=FALSE}
plot(df$mass_per, pp[,1], xlim=c(-40, 103), ylim=c(0,1), col="red", type="l", ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", pch=2, cex=0.45) # no flight_diff | 0 is triangle
points(df$mass_per, pp[,4], col="darkred", type="l", pch=3, cex=0.45)
points(df$mass_per, pp[,2], col="blue", type="l", cex=0.45) # flew in T1 but not T2
points(df$mass_per, pp[,3], col="darkgreen", type="l", cex=0.45) # flew in T2 but not T1
text(-36,0.65, labels="Did Not \nFly", col="red")
text(20,0.6, labels="Flew Twice", col="darkred")
text(85,0.85, labels="Flew in T1 only", col="blue")
text(20,0.1, labels="Flew in T2 only", col="darkgreen")
#abline(v=0.011, lty=2, col="black")
abline(v=53, lty=2, col="black")
abline(v=-16.5, lty=2, col="black")
abline(v=-28, lty=2, col="black")
# legend(-0.015, 0.99,
#        legend = c("0","1", "2"),
#        pch = c(2,1, 3),
#        title="Flight Count",
#        col=c("red","black","darkred"))
```

For more on multinomial plotting for when have more than 1 predictor variables see the following: https://stats.idre.ucla.edu/r/dae/multinomial-logistic-regression/

```{r echo=FALSE}
pp2 = fitted(model)
df2 <- df # for summary purposes
```

<a id="adding_sex"></a>

#### Now let's compare some models

**First: flight_case, mass_diff, and sex**

```{r}
df <- df[with(df, order(mass_diff)),]
```

```{r, warnings = FALSE}
data <- data.frame(R = df$flight_case, 
         A = df$mass_diff,
         B = df$sex_c)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 2 FF.R")
```

```{r}
anova(m3, m4, test="Chisq") # Adding A*B does not improve fit
```

```{r echo=FALSE}
calculate_P2 = function(model, var1, var2) {
  # compute p-values using Wald tests (i.e. z-tests)
  s <- summary(model) 
  z <- s$coefficients/s$standard.errors 
  wald <- z^2
  p <- (1 - pnorm(abs(z), 0, 1)) * 2
  
  # summary table (similar to lm, glm, or lmer function)
  model_table <- cbind(s$coefficients, c(s$edf, s$edf), s$standard.errors[,2:3], z[,2:3], wald[,2:3], p[,2:3])
  colnames(model_table) <- c("(Intercept)", var1, var2,"DF", 
                            "SE1", "SE2", "z1", "z2", 
                            "ML wald","sex wald","P1 > |z|", "P2 > |z|")
  cat("\n", "AIC: ", s$AIC, "\n") 
  print(round(model_table,3))
  return(model_table)
}
```

```{r}
delta_mass_model <- multinom(flight_case ~ mass_diff + sex_c, data = df)
model_table = calculate_P2(delta_mass_model, "mass_diff", "sex_c")
```

```{r echo=FALSE}
prediction_equations2 = function(tb, var1, var2, third_eq = TRUE) {
  # -1 / 1 | Flew in T1, not T2
  I = (tb[1,1] - tb[2,1])
  M = (tb[1,2] - tb[2,2])
  S = (tb[1,3] - tb[2,3])
  EQ1 = paste0("log(pi_-1 / pi_1) = ", round(I, 2), " + ", round(M,2), var1, " + ", round(S, 2), var2, "     Flew in T1, rather than T2" )
  
  if (third_eq) {
    # 2 / -1 | Flew in both, not T1
    I = (tb[3,1] - tb[1,1])
    M = (tb[3,2] - tb[1,2])
    S = (tb[3,3] - tb[1,3])
    EQ2 = paste0("log(pi_2 / pi_-1) = ", round(I, 2), " + ", round(M,2), var1, " + ", round(S, 2), var2, "     Flew in both, rather than T1" )
  }

  if (third_eq) {
    # 2 / 1 | Flew in both, not T2
    I = (tb[3,1] - tb[2,1])
    M = (tb[3,2] - tb[2,2])
    S = (tb[3,3] - tb[2,3])
    EQ3 = paste0("log(pi_2 / pi_1) = ", round(I, 2), " + ", round(M,2),  var1, " + ", round(S, 2), var2, "     Flew in both, rather than T2")
  }
  
  eqs = EQ1
  
  if (third_eq) {
    eqs = c(EQ1, EQ2, EQ3)
  }
  
  print("Where F = 1")
  return(eqs)
}
```

```{r}
prediction_equations2(model_table, " Mass Change", " Sex ")
```

```{r echo=FALSE}
eq1 = "Flew in T1 only rather than T2 only = 16.5 + 98.29 Mass Change + 15.49 Sex"
eq2 = "Flew in both rather than T1 only = 1.25 - 50.49 Mass Change - 0.1 Sex"
eq3 = "Flew in both rather than T2 only = 17.67 + 47.8 Mass Change + 15.39 Sex"

t = cbind(n_trials, c(eq1, eq2, eq3))
colnames(t) = c("N","Model")

kable(t) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F) 
```

**Second: flight_case, mass_per, and sex**

```{r}
df <- df[with(df, order(mass_per)),]
```

```{r}
data <- data.frame(R = df$flight_case, 
         A = df$mass_per,
         B = df$sex_c)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 2 FF.R")
```
```{r}
anova(m3, m4, test="Chisq") # Adding A*B does not improve fit
```

```{r}
delta_mass_model <- multinom(flight_case ~ mass_per + sex_c, data = df)
model_table = calculate_P2(delta_mass_model, "mass_per", "sex_c")
```

```{r}
prediction_equations2(model_table, " Mass Percent Change", " Sex ")
```

```{r echo=FALSE}
eq1 = "Flew in T1 only rather than T2 only = 5.81 + 0.05 Mass % + 4.93 Sex"
eq2 = "Flew in both rather than T1 only = 1.14 - 0.02 Mass % - 0.21 Sex"
eq3 = "Flew in both rather than T2 only = 6.94 + 0.03 Mass % + 4.72 Sex"

t = cbind(n_trials, c(eq1, eq2, eq3))
colnames(t) = c("N","Model")

kable(t) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F) 
```

**Estimated Odds**

**For males:**

For bugs of mass_perc x + 20%*(0.05), the estimated odds that bug flew in T1 rather than T2 equals

```{r}
exp(0.05*20)
```

times the estimated odds at mass_perc x (%). So for every 20% increase in a bug's original mass, the bug was 2.72 times more likely to fly only in T1. That makes sense because the odds of flying in T2 only are very low to begin with.

For bugs of mass_perc x + 20*(-0.02%), the estimated odds that the bug flew twice instead of only in T1 equals

```{r}
exp(20*-0.02) # 20 times less likely to fly twice if gain mass
exp(-20*-0.02) # 20 times more likely to fly twice if loose mass
```

times the estimated odds at mass_perc x (%). Similar message - for every 20% increase in a bug's original mass, the bug was 1.5 times more likely to fly only in T1. So, when a bug starts loosing mass it becomes more likely to fly twice then only once. 

**For females:**

For bugs of mass_perc x + 20%*(0.05), the estimated odds that bug flew in T1 rather than T2 equals

```{r}
exp(0.05*20 + 4.93)
```

times the estimated odds at mass_perc x (%). So for every 20% increase in a bug's original mass, the bug was **376** times more likely to fly only in T1. Crazy! It doesn't take much for a female to only fly once.


For bugs of mass_perc x + 20%*(0.05), the estimated odds that bug flew in both trials rather than T1 equals

```{r}
exp(-0.02*20 - 0.21)
exp(-0.02*-40 - 0.21)
```

times the estimated odds at mass_perc x (%). So half as likely to fly in both trials if gain mass. Would need to loose a lot of mass (40) to be almost twice as likely (1.8) to fly in both trials.

```{r}
exp(coef(delta_mass_model)*20) # this compares to no fly, the baseline # gain large % mass
exp(coef(delta_mass_model)*5) # gain small % mass
exp(coef(delta_mass_model)*-5) # loose small % mass
exp(coef(delta_mass_model)*-20) # loose large % mass
```

- If F and gain a lot of mass then most likely to fly only in T1 rather than none.
- If F and loose mass then most likely to not fly in either trial. 

**Predicted Probabilities**

```{r}
head(pp <- fitted(delta_mass_model))
```

```{r}
df$index = 1:nrow(df)
females = df %>%
  filter(sex=="F")
males = df %>%
  filter(sex=="M")
Frows = females$index
Mrows = males$index
```

```{r echo=FALSE}
plot(df$mass_per[Frows], pp[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",
     type="l",
     #type="b", cex=0.45, pch=16, 
     ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", lty=1) # flew in T1 but not T2
points(df$mass_per[Mrows], pp[Mrows,1], col="red", type="l", cex=0.45, lty=2) 
# pch=c(2,3)[as.factor(df$no_response_b[Frows])]
points(df$mass_per[Frows], pp[Frows,2], col="blue", 
       type="l",
       #type="b", cex=0.45, pch=16
       ) # did not fly in either
points(df$mass_per[Mrows], pp[Mrows,2], col="blue", type="l", cex=0.45, lty=2)
points(df$mass_per[Frows], pp[Frows,3], col="darkgreen", cex=0.45, type="l", pch=16) # flew in T2 but not T1
points(df$mass_per[Mrows], pp[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=2) 
points(df$mass_per[Frows], pp[Frows,4], col="darkred", 
       type="l",
       #type="b", cex=0.45, pch=16
       ) # flew in both
points(df$mass_per[Mrows], pp[Mrows,4], col="darkred", type="l", cex=0.45, lty=2) 
text(68,0.7, labels="Flew in T1 only", col="blue")
text(-27,0.9, labels="Did Not Fly", col="red")
text(13,0.37, labels="Flew Twice", col="darkred")
#text(75,0.05, labels="Flew in T2 only", col="darkgreen")
# female line is always higher
# text(0.0,0.96, labels="F", col="red")
# text(0.0,0.7, labels="M", col="red")
# text(0.02,0.2, labels="F", col="blue")
# text(0.0,0.25, labels="M", col="blue")
# text(0.025,0.05, labels="F", col="darkgreen")
# text(0.01,0.10, labels="M", col="darkgreen")
# abline(v=40.5, lty=1, col="black")
# abline(v=7.5, lty=3, col="black")
# abline(v=-17, lty=3, col="black")
# rect(56,-4,-24,2,col = rgb(0.5,0.5,0.5,1/4))
# abline(v=-0.008, lty=2, col="slategrey")
legend(83, 1.0,
       legend = c("female","male"),
       lty=1:2,
       col="black",
       cex=0.8)
```

```{r echo=FALSE}
pp3 <- fitted(delta_mass_model)
df3 <- df # for summary purposes
```

No females flew in T2 only.

<a id="host_plant"></a>

#### Adding Host Plant

```{r}
df <- df[with(df, order(mass_diff)),]
```

```{r}
data <- data.frame(R = df$flight_case, 
         A = df$mass_diff,
         B = df$sex_c,
         C = df$host_c)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 3 FF.R")
```

```{r}
anova(m4, m7, test="Chisq") # Adding C (host plant) does not improve fit
```

Host plant is not significant.

<a id="fem_only"></a>

#### Females only 

**Baseline**

```{r}
df <- d %>%
  filter(!is.na(egg_diff), !is.na(mass_diff), !is.na(flew_diff), sex_c == 1)

df <- df[with(df, order(mass_diff)),]

n_tfemales = nrow(df)

df$flight_case <- relevel(as.factor(df$flight_case), ref = "0")
```

**Barplot**

```{r echo=FALSE}
# fig.height=2.4, fig.width=2.7
data_fem = data_tested %>%
  filter(sex=="F")
counts <- table(data_fem$eggs_b, data_fem$trial_type) # data_tested$flew_b
counts <- counts[1:2,2:3]
barplot(counts, #main="Flight Distribution by Trial",
  xlab="Trial", col=c("lightblue","darkgoldenrod2"),
  legend = c("no eggs", "yes eggs"), ylim=c(0,110), beside=TRUE)
```

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("laid eggs in T2 but not T1", "laid eggs T1 and T2 or neither trials", "laid eggs in T1 but not T2")
Encoding = c(1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Egg Response Key" = 2 )) 
```
```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("flew in both trials", "flew in neither trial", "flew in T1 only")
Encoding = c(2,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

**Null model**

```{r}
df$flight_case = droplevels(df$flight_case) # no female bug only flew in T2
null <- multinom(flight_case ~ 1, data = df) 
```

**Multinom model: flew_diff ~ egg_diff**

```{r}
model <- multinom(flight_case ~ egg_diff, data = df) 
model_table = calculate_P(model)
```

```{r}
anova(null, model, test="Chisq") # adding egg_diff improves fit
```

**The ML prediction equations are:**

$\log(\hat{\pi_{-1}}/\hat{\pi_0}) = -1.88 + 2.42 x$ 

$\log(\hat{\pi_{2}}/\hat{\pi_0}) = -0.94 + 1.43 x$ 


**Comparing models: adding host**

Adding host with egg_diff and mass_diff

```{r echo=FALSE}
# key 
Host = c("Golden Rain Tree (GRT)", "Balloon Vine (BV)")
Encoding = c(1,-1)
key = cbind(Host, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Host Plant Key" = 2 )) 
```

```{r}
data <- data.frame(R = df$flight_case, 
         A = df$egg_diff,
         B = df$mass_diff,
         C = df$host_c)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 3 FF.R")
```

```{r}
anova(m7, m13, test="Chisq") # Adding B*C does not improve fit
anova(m4, m7, test="Chisq") # Adding C does not improve fit
anova(m2, m4, test="Chisq") # Adding A does improve fit
anova(m1, m4, test="Chisq") # Adding B does improve fit
```

Host is not in the best fit model.

```{r}
model <- multinom(flight_case ~ egg_diff + mass_diff, data = df) 
model_table = calculate_P2(model, "egg_diff", "mass_diff")
```

**The multinomial (ML) prediction equations are:**

```{r echo=FALSE}
tb = model_table
I = (tb[1,1] - tb[2,1])
E = (tb[1,2] - tb[2,2])
M = (tb[1,3] - tb[2,3])
EQ1 = paste0("log(pi_-1 / pi_1) = ", round(I, 2), " + ", round(E,2), " Egg Change", " + ", round(M,2),      " Mass Change       Flew in T1, rather than both trials" )
EQ1
```

```{r echo=FALSE}
eq = "Females flew in T1 only rather than both trials = -1.15 + 0.66 Egg Diff + 31.91 Mass Diff"

t = cbind(n_tfemales, eq)
colnames(t) = c("N","Model")

kable(t) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F) 
```

**Estimated Odds**

For bugs that laid eggs *and* had a mass diff of mass diff x + 1/50 or 0.02 g, the estimated odds that the bug flew in T1 rather than both trials equals

```{r}
exp((0.66+31.91/50))
```

times the estimated odds at mass_diff x (g). As gain mass, then less likely to fly again.

```{r}
exp(coef(model)/50) # this compares to not flying, the baseline  #gained mass
exp(-coef(model)/50) # lost mass
```

* If female bug laid eggs in T2, then the more likely flew in T1 only.
* The higher the mass gain, then the more likely flew in T1 only. 

**Predicted Probabilities**

```{r}
head(pp <- fitted(model))
```

```{r}
df$index = 1:nrow(df)

egg_T1 = df %>%
  filter(egg_diff==-1)
egg_no_change = df %>%
  filter(egg_diff==0)
egg_T2 = df %>%
  filter(egg_diff==1)

egg_T1rows = egg_T1$index
egg_nochange_rows = egg_no_change$index
egg_T2rows = egg_T2$index
```

```{r echo=FALSE}
df <- df[with(df, order(mass_diff)),]
# only laid eggs in T1
plot(df$mass_diff[egg_T1rows], pp[egg_T1rows,1], ylim=c(0,1), xlim=c(-0.045,0.07), col="red", type="l", lty=1,
     main="Females Only",
     #type="b", cex=0.45, pch=16, 
     ylab="Flight Case Probability", xlab="Change in Mass From T1 to T2 (g)") # flew in neither
points(df$mass_diff[egg_T1rows], pp[egg_T1rows,2], col="blue", type="l", lty=1, cex=0.45)  # flew in T1 only
points(df$mass_diff[egg_T1rows], pp[egg_T1rows,3], col="black", type="l", lty=1, cex=0.45) # flew in both
# no egg change
points(df$mass_diff[egg_nochange_rows], pp[egg_nochange_rows,1], col="red", type="l", lty=2) # did not fly in either
points(df$mass_diff[egg_nochange_rows], pp[egg_nochange_rows,2], col="blue", type="l", lty=2) # flew in T1 only
points(df$mass_diff[egg_nochange_rows], pp[egg_nochange_rows,3], col="black", type="l", lty=2) # flew in both
# only laid eggs in T2
points(df$mass_diff[egg_T2rows], pp[egg_T2rows,1], col="red", type="l", lty=3) # flew in neither
points(df$mass_diff[egg_T2rows], pp[egg_T2rows,2], col="blue", type="l", lty=3) # flew in T1 only
points(df$mass_diff[egg_T2rows], pp[egg_T2rows,3], col="black", type="l", lty=3) # flew in both

text(0.034,0.7, labels="Flew in T1 only", col="blue")
text(-0.035,0.85, labels="Did Not Fly", col="red")
text(-0.02,0.3, labels="Flew Twice", col="black")
legend(0.02, 1.02,
       legend = c("laid eggs in T1","no egg laying change", "laid eggs in T2"),
       lty=1:3,
       col="black",
       cex=0.8)
rect(-0.038,-1,0.064,2, NA, col = rgb(0.5,0.5,0.5,1/15))
rect(-0.045,-1,0.038,2, NA, col = rgb(0.5,0.5,0.5,1/15))
rect(-0.039,-1,0.008,2, NA, col = rgb(0.5,0.5,0.5,1/15))
# turn this into an animated graph
```

- Eggs laid only in T1: most likely to not fly
- No egg laying change: most likely to not fly 
- Eggs laid in T2:  most likely to fly twice if lost mass but most likely to only fly in T1 if gained more than about 0.015 g. (largest mass change interval)

```{r echo=FALSE}
pp4 = fitted(model)
df4 = df
```

<a id="fem_only_case"></a>

**Egg Case**

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("laid eggs in both trials", "laid eggs in T2 only", "laid eggs in neither trials", "laid eggs in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Egg Response Key" = 2 )) 
```

**Baseline**

```{r}
df <- d %>%
  filter(!is.na(egg_case), !is.na(mass_diff), !is.na(flew_diff), sex_c == 1)

df <- df[with(df, order(mass_diff)),]

n_tfemales = nrow(df)

df$flight_case <- relevel(as.factor(df$flight_case), ref = "0")
```

**Null model**

```{r}
df$flight_case = droplevels(df$flight_case) # no female bug only flew in T2
null <- multinom(flight_case ~ 1, data = df) 
```

**Multinom model: flew_diff ~ egg_case**

```{r}
model <- multinom(flight_case ~ egg_case, data = df) 
model_table = calculate_P(model)
```
```{r}
anova(null, model, test="Chisq") # adding egg_case improves fit
```


```{r}
data <- data.frame(R = df$flight_case, 
         A = df$egg_case,
         B = df$mass_diff,
         C = df$host_c)
source("src/compare_models.R")
model_comparisonsAIC("src/generic multinomial models- multinom 1RF + 3 FF.R")
```
```{r}
anova(m4, m7, test="Chisq") # Adding C does not improve fit
anova(m7, m13, test="Chisq") # Adding  mass_diff*host does not improve fit
```
```{r}
model <- multinom(flight_case ~ mass_diff + egg_case, data = df) 
model_table = calculate_P2(model, "mass_diff", "egg_case")
```

```{r}
prediction_equations2(model_table, " Mass Diff", " Egg Case ", third_eq = FALSE)
```

**Predicted Probabilities**

```{r}
head(pp <- fitted(model))
```
```{r echo=FALSE}
df$index = 1:nrow(df)

eggT1 = df %>%
  filter(egg_case==-1)
egg0 = df %>%
  filter(egg_case==0)
egg2 = df %>%
  filter(egg_case==2)
eggT2 = df %>%
  filter(egg_case==1)

eggT1_rows = eggT1$index
egg_0rows = egg0$index
egg_2rows = egg2$index
eggT2_rows = eggT2$index
```

```{r echo=FALSE}
df <- df[with(df, order(mass_diff)),]
# only laid eggs in T1
plot(df$mass_diff[eggT1_rows], pp[eggT1_rows,1], ylim=c(0,1.05), xlim=c(-0.045,0.07), col="red", type="l", lty=1,main="Females Only", ylab="Flight Case Probability", xlab="Change in Mass From T1 to T2 (g)") 
points(df$mass_diff[eggT1_rows], pp[eggT1_rows,2], col="blue", type="l", lty=1, cex=0.45) 
points(df$mass_diff[eggT1_rows], pp[eggT1_rows,3], col="black", type="l", lty=1, cex=0.45) 
# no egg change
points(df$mass_diff[egg_0rows], pp[egg_0rows,1], col="red", type="l", lty=2) # did not fly in either
points(df$mass_diff[egg_0rows], pp[egg_0rows,2], col="blue", type="l", lty=2) # flew in T1 only
points(df$mass_diff[egg_0rows], pp[egg_0rows,3], col="black", type="l", lty=2) # flew in both
# eggs twice
points(df$mass_diff[egg_2rows], pp[egg_2rows,1], col="red", type="l", lty=4) # did not fly in either
points(df$mass_diff[egg_2rows], pp[egg_2rows,2], col="blue", type="l", lty=4) # flew in T1 only
points(df$mass_diff[egg_2rows], pp[egg_2rows,3], col="black", type="l", lty=4) # flew in both
# only laid eggs in T2
points(df$mass_diff[eggT2_rows], pp[eggT2_rows,1], col="red", type="l", lty=3) # flew in neither
points(df$mass_diff[eggT2_rows], pp[eggT2_rows,2], col="blue", type="l", lty=3) # flew in T1 only
points(df$mass_diff[eggT2_rows], pp[eggT2_rows,3], col="black", type="l", lty=3) # flew in both


rect(-0.038,-1,0.064,2, NA, col = rgb(0.5,0,0.5,1/15), border="pink") # most likely to not fly unless gain more than about 0.025 g mass and then fly only in T1 (eggs were laid twice).
rect(-0.045,-1,0.038,2, NA, col = rgb(0.5,0.2,0.5,1/15), border="pink") # most likely to not fly (2nd widest mass change, and laid eggs in T2)
rect(-0.039,-1,0.008,2, NA, col = rgb(0.1,0.5,0.5,1/10), border="lightblue") # most likely to fly twice (lost mass and laid eggs only in T1)
rect(-0.005,-1,0.029,2, NA, col = rgb(0.4,0.5,0.5,1/4), border="lightblue") # most likely to fly twice always (smallest mass change and did not lay eggs)
# turn this into an animated graph...!

text(0.059,0.54, labels="Flew in T1 only", col="blue")
text(-0.036,0.95, labels="Did Not Fly", col="red")
text(-0.02,0.35, labels="Flew Twice", col="black")
legend(0.033, 1.07,
       legend = c("laid eggs in T1","no eggs laid", "eggs laid twice", "laid eggs in T2"),
       lty=1:4,
       col="black",
       cex=0.8)
```

```{r echo=FALSE}
pp5 = fitted(model)
df5 = df
```

- Eggs laid twice: most likely to not fly unless gain more than about 0.025 g mass and then fly only in T1 (largest mass change)
- Eggs laid in T2:  most likely to not fly (2nd widest mass change)
- Eggs laid only in T1: most likely to fly twice (mostly only lost mass)
- Eggs not laid: most likely to fly twice always (smallest mass change and mostly only gained about 0.030 g)



### Encodings

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("flew in both trials", "flew in T2 only", " flew in neither trials", "flew in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

```{r echo=FALSE}
# key = change in mass
Event = c("gained mass from T1 to T2", "no mass change between trails", "lost mass from T1 to T2")
Sign = c("pos","0","neg")
key = cbind(Event, Sign)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Mass Key" = 2 )) 
```

```{r echo=FALSE}
# key 
Host = c("Golden Rain Tree (GRT)", "Balloon Vine (BV)")
Encoding = c(1,-1)
key = cbind(Host, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Host Plant Key" = 2 )) 
```


**Females Only**

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("flew in both trials", "flew in neither trial", "flew in T1 only")
Encoding = c(2,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("laid eggs in T2 but not T1", "laid eggs T1 and T2 or neither trials", "laid eggs in T1 but not T2")
Encoding = c(1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Egg Response Key" = 2 )) 
```

```{r echo=FALSE}
# key = response in T2 - response in T1
Event = c("laid eggs in both trials", "laid eggs in T2 only", "laid eggs in neither trials", "laid eggs in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = "striped", "hover", full_width = F)  %>%
  add_header_above(c("Delta Egg Response Key" = 2 )) 
```

### Summary

**flight case ~ mass diff**

```{r echo=FALSE}
df1 <- df1[with(df1, order(mass_diff)),]
plot(df1$mass_diff, pp1[,1], ylim=c(0,1), col="red", type="l", ylab="Flight Case Probability", xlab="Changes in Mass From T1 to T2 (g)", pch=2, cex=0.45) # no flight_diff | 0 is triangle
points(df1$mass_diff, pp1[,4], col="darkred", type="l", pch=3, cex=0.45)
points(df1$mass_diff, pp1[,2], col="blue", type="l", cex=0.45) # flew in T1 but not T2
points(df1$mass_diff, pp1[,3], col="darkgreen", type="l", cex=0.45) # flew in T2 but not T1
text(-0.035,0.7, labels="Did Not Fly", col="red")
text(0.007,0.6, labels="Flew Twice", col="darkred")
text(0.05,0.85, labels="Flew in T1 only", col="blue")
text(0.014,0.1, labels="Flew in T2 only", col="darkgreen")
#abline(v=0.011, lty=2, col="black")
abline(v=0.027, lty=2, col="black")
abline(v=-0.0165, lty=2, col="black")
abline(v=-0.022, lty=2, col="black")
# legend(-0.015, 0.99,
#        legend = c("0","1", "2"),
#        pch = c(2,1, 3),
#        title="Flight Count",
#        col=c("red","black","darkred"))
```

**flight case ~ mass per**

```{r echo=FALSE}
plot(df2$mass_per, pp2[,1], xlim=c(-40, 103), ylim=c(0,1), col="red", type="l", ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", pch=2, cex=0.45) # no flight_diff | 0 is triangle
points(df2$mass_per, pp2[,4], col="darkred", type="l", pch=3, cex=0.45)
points(df2$mass_per, pp2[,2], col="blue", type="l", cex=0.45) # flew in T1 but not T2
points(df2$mass_per, pp2[,3], col="darkgreen", type="l", cex=0.45) # flew in T2 but not T1
text(-36,0.65, labels="Did Not \nFly", col="red")
text(20,0.6, labels="Flew Twice", col="darkred")
text(85,0.85, labels="Flew in T1 only", col="blue")
text(20,0.1, labels="Flew in T2 only", col="darkgreen")
#abline(v=0.011, lty=2, col="black")
abline(v=53, lty=2, col="black")
abline(v=-16.5, lty=2, col="black")
abline(v=-28, lty=2, col="black")
# legend(-0.015, 0.99,
#        legend = c("0","1", "2"),
#        pch = c(2,1, 3),
#        title="Flight Count",
#        col=c("red","black","darkred"))
```

**flight case ~ mass per and sex**

```{r echo=FALSE}
df3 <- df3[with(df3, order(mass_per)),]
plot(df3$mass_per[Frows], pp3[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",
     type="l",
     #type="b", cex=0.45, pch=16, 
     ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", lty=1) # flew in T1 but not T2
points(df3$mass_per[Mrows], pp3[Mrows,1], col="red", type="l", cex=0.45, lty=2) 
# pch=c(2,3)[as.factor(df3$no_response_b[Frows])]
points(df3$mass_per[Frows], pp3[Frows,2], col="blue", 
       type="l",
       #type="b", cex=0.45, pch=16
       ) # did not fly in either
points(df3$mass_per[Mrows], pp3[Mrows,2], col="blue", type="l", cex=0.45, lty=2)
points(df3$mass_per[Frows], pp3[Frows,3], col="darkgreen", cex=0.45, type="l", pch=16) # flew in T2 but not T1
points(df3$mass_per[Mrows], pp3[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=2) 
points(df3$mass_per[Frows], pp3[Frows,4], col="darkred", 
       type="l",
       #type="b", cex=0.45, pch=16
       ) # flew in both
points(df3$mass_per[Mrows], pp3[Mrows,4], col="darkred", type="l", cex=0.45, lty=2) 
text(68,0.7, labels="Flew in T1 only", col="blue")
text(-27,0.9, labels="Did Not Fly", col="red")
text(13,0.37, labels="Flew Twice", col="darkred")
#text(75,0.05, labels="Flew in T2 only", col="darkgreen")
# female line is always higher
# text(0.0,0.96, labels="F", col="red")
# text(0.0,0.7, labels="M", col="red")
# text(0.02,0.2, labels="F", col="blue")
# text(0.0,0.25, labels="M", col="blue")
# text(0.025,0.05, labels="F", col="darkgreen")
# text(0.01,0.10, labels="M", col="darkgreen")
# abline(v=40.5, lty=1, col="black")
# abline(v=7.5, lty=3, col="black")
# abline(v=-17, lty=3, col="black")
# rect(56,-4,-24,2,col = rgb(0.5,0.5,0.5,1/4))
# abline(v=-0.008, lty=2, col="slategrey")
legend(84, 1.02,
       legend = c("female","male"),
       lty=1:2,
       col="black",
       cex=0.8)
```

**females only**

**flight case ~ mass diff and egg diff**


```{r echo=FALSE}
df4 <- df4[with(df4, order(mass_diff)),]
# only laid eggs in T1
plot(df4$mass_diff[egg_T1rows], pp4[egg_T1rows,1], ylim=c(0,1), xlim=c(-0.045,0.07), col="red", type="l", lty=1,
     main="Females Only",
     #type="b", cex=0.45, pch=16, 
     ylab="Flight Case Probability", xlab="Change in Mass From T1 to T2 (g)") # flew in neither
points(df4$mass_diff[egg_T1rows], pp4[egg_T1rows,2], col="blue", type="l", lty=1, cex=0.45)  # flew in T1 only
points(df4$mass_diff[egg_T1rows], pp4[egg_T1rows,3], col="black", type="l", lty=1, cex=0.45) # flew in both
# no egg change
points(df4$mass_diff[egg_nochange_rows], pp4[egg_nochange_rows,1], col="red", type="l", lty=2) # did not fly in either
points(df4$mass_diff[egg_nochange_rows], pp4[egg_nochange_rows,2], col="blue", type="l", lty=2) # flew in T1 only
points(df4$mass_diff[egg_nochange_rows], pp4[egg_nochange_rows,3], col="black", type="l", lty=2) # flew in both
# only laid eggs in T2
points(df4$mass_diff[egg_T2rows], pp4[egg_T2rows,1], col="red", type="l", lty=3) # flew in neither
points(df4$mass_diff[egg_T2rows], pp4[egg_T2rows,2], col="blue", type="l", lty=3) # flew in T1 only
points(df4$mass_diff[egg_T2rows], pp4[egg_T2rows,3], col="black", type="l", lty=3) # flew in both

text(0.034,0.7, labels="Flew in T1 only", col="blue")
text(-0.035,0.85, labels="Did Not Fly", col="red")
text(-0.02,0.3, labels="Flew Twice", col="black")
legend(0.02, 1.02,
       legend = c("laid eggs in T1","no egg laying change", "laid eggs in T2"),
       lty=1:3,
       col="black",
       cex=0.8)
rect(-0.038,-1,0.064,2, NA, col = rgb(0.5,0.5,0.5,1/15))
rect(-0.045,-1,0.038,2, NA, col = rgb(0.5,0.5,0.5,1/15))
rect(-0.039,-1,0.008,2, NA, col = rgb(0.5,0.5,0.5,1/15))
```

**flight case ~ mass diff and egg case**

```{r echo=FALSE}
df5 <- df5[with(df5, order(mass_diff)),]
# only laid eggs in T1
plot(df5$mass_diff[eggT1_rows], pp5[eggT1_rows,1], ylim=c(0,1.05), xlim=c(-0.045,0.07), col="red", type="l", lty=1,
     main="Females Only",
     #type="b", cex=0.45, pch=16, 
     ylab="Flight Case Probability", xlab="Change in Mass From T1 to T2 (g)") # flew in neither
points(df5$mass_diff[eggT1_rows], pp5[eggT1_rows,2], col="blue", type="l", lty=1, cex=0.45)  # flew in T1 only
points(df5$mass_diff[eggT1_rows], pp5[eggT1_rows,3], col="black", type="l", lty=1, cex=0.45) # flew in both
# no egg change
points(df5$mass_diff[egg_0rows], pp5[egg_0rows,1], col="red", type="l", lty=2) # did not fly in either
points(df5$mass_diff[egg_0rows], pp5[egg_0rows,2], col="blue", type="l", lty=2) # flew in T1 only
points(df5$mass_diff[egg_0rows], pp5[egg_0rows,3], col="black", type="l", lty=2) # flew in both
# eggs twice
points(df5$mass_diff[egg_2rows], pp5[egg_2rows,1], col="red", type="l", lty=4) # did not fly in either
points(df5$mass_diff[egg_2rows], pp5[egg_2rows,2], col="blue", type="l", lty=4) # flew in T1 only
points(df5$mass_diff[egg_2rows], pp5[egg_2rows,3], col="black", type="l", lty=4) # flew in both
# only laid eggs in T2
points(df5$mass_diff[eggT2_rows], pp5[eggT2_rows,1], col="red", type="l", lty=3) # flew in neither
points(df5$mass_diff[eggT2_rows], pp5[eggT2_rows,2], col="blue", type="l", lty=3) # flew in T1 only
points(df5$mass_diff[eggT2_rows], pp5[eggT2_rows,3], col="black", type="l", lty=3) # flew in both


rect(-0.038,-1,0.064,2, NA, col = rgb(0.5,0,0.5,1/15), border="pink") # most likely to not fly unless gain more than about 0.025 g mass and then fly only in T1 (eggs were laid twice).
rect(-0.045,-1,0.038,2, NA, col = rgb(0.5,0.2,0.5,1/15), border="pink") # most likely to not fly (2nd widest mass change, and laid eggs in T2)
rect(-0.039,-1,0.008,2, NA, col = rgb(0.1,0.5,0.5,1/10), border="lightblue") # most likely to fly twice (lost mass and laid eggs only in T1)
rect(-0.005,-1,0.029,2, NA, col = rgb(0.4,0.5,0.5,1/4), border="lightblue") # most likely to fly twice always (smallest mass change and did not lay eggs)
# turn this into an animated graph...!

text(0.059,0.54, labels="Flew in T1 only", col="blue")
text(-0.036,0.95, labels="Did Not Fly", col="red")
text(-0.02,0.35, labels="Flew Twice", col="black")
legend(0.033, 1.07,
       legend = c("laid eggs in T1","no eggs laid", "eggs laid twice", "laid eggs in T2"),
       lty=1:4,
       col="black",
       cex=0.8)
```

### Questions

- Egg case and egg diff not factors. Not sure how to work around this problem.
- Subtracting equations when p values are not significant...is that possible? What are the implications if it is?
- Animate plots?
- For Fall season some bugs were tested more than 2 times (up to four times), but which to pull from and from which experiments?

