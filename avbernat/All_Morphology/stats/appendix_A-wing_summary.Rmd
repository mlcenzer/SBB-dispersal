---
title: 'Appendix A: Modeling Wing Morphology'
author: "for  \n'Dispersal-behavioral plasticity within an insect-host system  \nundergoing human-induced rapid evolutionary change (HIREC)';   \nBernat, AV, Cenzer, ML"
geometry: margin=2cm
output:
  pdf_document:
    includes: null
    toc: yes
    toc_depth: 3
    number_sections: true
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
line-height: 1.5
fontsize: 11pt
classoption: a4paper
language: en
---

```{r setup, include=FALSE}
rm(list = ls())

# set working directory
dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat/"
setwd(dir)

knitr::opts_knit$set(root.dir = dir)
knitr::opts_chunk$set(echo = TRUE)
```

\newpage

# Details of the Analyses

This document was generated by R Markdown on `r format(Sys.time(), '%Y-%m-%d')` using `r version[['version.string']]`. The document provides the step-by-step analytical methods used in the manuscript by Anastasia Bernat (AVB) and Meredith Cenzer (MLC). Multiple draft scripts were written by AVB between 2021-03-01 and 2021-07-26 until being distilled and complied by AVB and code reviewed by MLC at the University of Chicago into this comprehensive script. All draft scripts can be viewed in the GitHub repository, SBB-dispersal (https://github.com/mlcenzer/SBB-dispersal), within the directory **avbernat > All_Morphology > stats**. 

All code and output from the statistical analyses are shown. Code for data cleaning and the generation of plots is not displayed but can be viewed in the **appendix_A-wing_summary.Rmd** file and its accompanying sourced scripts. To repeat analyses and the generation of plots, all data files and sourced scripts should follow the directory structure presented in the SBB-dispersal repository.

## Description of the Data

This document analyzes two main datasets, `raw_data` and `data_long`. The raw_data set provides morphology measurements for each soapberry bug, *Jadera haematoloma*, collected and measured between the April 2013 and February 2020. There are four morphology measurements: beak length, thorax width, wing length, and body length. The sex, wing morph (long-winged, shot-winged, or ambiguously-winged), and host plant the bug was collected from as well as the month and year each bug was collected in was recorded. The data_long set provides the same recordings as the raw_data set, but it has been filtered for only long-winged soapberry bugs.

## Abbreviations Used in the Data and Code

* **SBB** - soapberry bug, *Jadera haematoloma*
* **S** - short-winged morph
* **L** - long-winged morph
* **LS** or **SL** - ambiguous wing morph
* **pophost** - the host plant soapberry bugs were collected from, which was either *Koelreuteria elegans* or *Cardiospermum corindum*, occasionally called (and abbreviated) as goldenrain tree (GRT) or balloon vine (BV), respectively
* **months_since_start** - proxy for year where the first collection occurred on April 2013
* **month_of_year** - proxy for season where collections occurred only in months February, April, May, August, September, and October
* **wing2body** - a computed and unitless value calculated from the wing length divided by the body length of a soapberry bug
* **wing2thorax** - a computed and unitless value calculated from the wing length divided by the thorax width of a soapberry bug
* **sd** - standard deviation
* **se** - standard error
* `w_` - a column name that starts with `w_` is shortened from "wing" (e.g. w_morph is "wing morph")
* `_c` - a column name that ends in `_c` is a column that has been centered. Example columns: wing2body_c, month_of_year_c, and months_since_start_c
* `_b` - a column name that ends in `_b` is a column that has been recodified into binary data (0's and 1's). Example columns: sex_b, pophost_b, and wing_morph_b

# Data Cleaning And Exploration

## Read Libraries

The occurrence of long-wing morphology and the wing-to-body ratio of *J. haematoloma* were analyzed using multivariate, generalized linear modeling (GLM) as implemented in the R packages `lme4` and `binom`. The `dplyr` package helped pipeline data manipulation processes by grouping data quickly. All plots, except the histograms, were generated using `ggplot` libraries and helper functions found in R packages `ggformula` and `cowplot`.

Additional R packages not shown below, but embedded in the sourced scripts are `zoo` and `lubridate`, which aid in data manipulation and datetime manipulation, respectively. 

```{r reading-libraries, message=FALSE}
library(lme4)      # fit regressions 
library(dplyr)     # data manipulation 
library(ggformula) # ggplot plotting
library(cowplot)   # ggplot helper functions to arrange multi-panel figures
library(binom)     # binomial confidence intervals
```

## Read Source Files

Each sourced script below aides in either data cleaning (`read_morph_data()`, `remove_torn_wings()`) or multivariate GLM (`model_comparisonsAIC()`, `get_model_probs()`). Additionally, the function `model_comparisonsAIC()` takes in the path of a generic multi-factor script with a specified, hard-coded GLM family and link function needed to build the predictive models. All aforementioned sourced scripts are located in the **Rscr** folder.

```{r sourcing-scripts, message=FALSE}
source_path = paste0(dir,"/Rsrc/")

script_names = c("clean_morph_data.R",   # 1 function: read_morph_data() 
                 "remove_torn_wings.R",  # 1 function: remove_torn_wings()
                 "compare_models.R",     # 1 function: model_comparisonsAIC()
                 "get_Akaike_weights.R") # 1 function: get_model_probs()

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}
```

## Read the Data

The morphology data were started in 2013-04-28 and last updated on 2021-05-18. The `read_morph_data()` function standardizes population names, host plant names, and month and year inputs. Month and year inputs are also converted into datetimes. Variables of interest like wing-to-body ratio and wing-to-thorax ratio are also calculated and centered. The full dataset, `raw_data` (n=3532), and a long-winged bug dataset, `data_long` (n=2096), are returned. 

```{r reading-data}
datapath = paste0(dir,"All_Morphology/stats/data/allmorphology05.18.21.csv")
data_list = read_morph_data(datapath)

raw_data = data_list[[1]]
data_long = data_list[[2]] # long-wing bugs with wing-to-body value only

data_long = remove_torn_wings(data_long)
```

Bugs marked as having torn wings during measurements were only filtered out of the `data_long` dataset (n=1903). That was because `data_long` is used only to analyze the wing-to-body ratio, which was computed for long-winged bugs since no short-winged bugs can fly. `raw_data` is only used to analyze long-wing morph frequency.

## Histograms of Wing Morph Data 

Soapberry bugs have two noticeable wing morphs: a long-wing (left) and short-wing morph (right).

![](images/wing_morphs.png)

To better visualize how wing morph relates to a SBB allometric measurement, wing-to-thorax ratio, the following histograms were plotted:

&nbsp;

```{r wing-morph-histograms, fig.height=5.5, fig.width=6.6, echo=FALSE}
raw_data_missing = raw_data %>% 
  filter(w_morph=="" | is.na(w_morph)) 

par(mfrow=c(3,1))
hist(raw_data$wing[raw_data$w_morph=="L"]/raw_data$thorax[raw_data$w_morph=="L"],
     main="wing-to-thorax for long-winged SBB",
     xlab="wing length/thorax length",
     breaks=seq(0.5, 3.8, by=0.05))
hist(raw_data_missing$wing/raw_data_missing$thorax, 
     main="wing-to-thorax for SBB without recorded wing morph", # with missing
     xlab="wing length/thorax length",
     breaks=seq(0.5, 3.8, by=0.05),
     ylim=c(0,12))
hist(raw_data$wing[raw_data$w_morph=="S"]/raw_data$thorax[raw_data$w_morph=="S"],
     main="wing-to-thorax for short-winged SBB",
     xlab="wing length/thorax length",
     breaks=seq(0.5,3.8,by=0.05))
```

From the histograms, the relationship between wing morph and wing-to-thorax ratio is bimodal. Long-winged bugs have larger wing-to-thorax ratios with a frequency peak around 2.75, whereas short-winged bugs have much smaller wing-to-thorax ratios with a frequency peak around 1.75. It is then noticeable that there are 22 bugs who had not been identified as either S or L during measurements, but cannot be categorized into S or L because their wing-to-thorax values reside in-between the two modes.


## Field Collection Numbers

Bugs were collected from the field during different years and months. The barplots below display the bugs collected per **population**, **host plant**, and **sex** across the years and months:

&nbsp;

```{r echo=FALSE}
# repeating plot features
customPlot = list(geom_bar(position='stack', color="black", width=0.7),
                  theme_classic(),
                  theme(axis.text.y = element_text(size=9),
                        axis.text.x = element_text(size=9, angle = 45, hjust = 1.1),
                        axis.title = element_text(size=17,face="bold")),
                  theme(axis.title.x = element_text(size=10,vjust = -3)),
                  theme(axis.title.y = element_text(size=10, vjust = 4)),
                  theme(plot.margin=unit(c(1,1,1.1,1.2),"cm")),
                  theme(legend.title = element_text(face="italic"),
                         legend.text = element_text(face="italic"))
                  )
```

```{r pop-barplot, message=FALSE, fig.height=4.5, fig.width=7.2, fig.align="center", echo=FALSE}
pop_colors = c("#2e5922","#417532", "#459c28", "#84c96d", "#8edb79", "#cae6c3",
               "#22abf0", "#66c3f2", "#b1dbf0")

pop_colors = c("#2e5922","#417532", "#459c28", "#89cf76", "#c1ffab", "#d9f2d3",
               "#22abf0", "#8dd4f7", "#c7ebfc") 

p1 = ggplot(data=subset(raw_data, !is.na(datetime)), aes(x=datetime, fill=population)) + 
  labs(title="Collection numbers grouped by Population and Datetime", 
       fill="Population",x="Field Collection Date", y="Number of Bugs Collected") +
  scale_fill_manual(values=pop_colors) + 
  customPlot + 
  theme(plot.title = element_text(hjust = 0.5)) +   
  theme(plot.margin=unit(c(1,1.5,1,1.5), "cm"))

groups = raw_data %>% 
  group_by(sex, datetime) %>% 
  summarize(count = n())

numF = paste0("F(", as.character(unlist(groups[1:10,3])), ")")
numM = paste0("M(", as.character(unlist(groups[11:20,3])), ")")
text = paste0(numF, "\n", numM)
p1 = p1 + annotate(geom="text", x=1, y=400, label=text[1],
              color="black", size=3) +
  annotate(geom="text", x=2, y=470, label=text[2],
           color="black", size=3) +
  annotate(geom="text", x=3, y=270, label=text[3],
           color="black", size=3) +
  annotate(geom="text", x=4, y=220, label=text[4],
           color="black", size=3) +
  annotate(geom="text", x=5, y=320, label=text[5],
           color="black", size=3) +
  annotate(geom="text", x=6, y=500, label=text[6],
           color="black", size=3) +
  annotate(geom="text", x=7, y=240, label=text[7],
           color="black", size=3) +
  annotate(geom="text", x=8, y=730, label=paste0("\n", text[8]),
           color="black", size=3) +
  annotate(geom="text", x=9, y=440, label=text[9],
           color="black", size=3) +
  annotate(geom="text", x=10, y=650, label=text[10],
           color="black", size=3)
p1 
```

Stacked barplots are grouped and colored by population. Populations labeled in the legend are ordered by latitude from highest to lowest across Florida. Populations in shades of green indicate populations from the mainland of Florida while those in shades of blue indicate populations from the islands. Numbers above each bar represent the count between male (M) and female (F) soapberry bugs in each collection season. Population collections across datetimes are noticeably heterogeneous. However, collection numbers by sex and host plant were relatively homogeneous, as seen below.

```{r hostplant-barplot, fig.height=4.5, fig.width=7.2, echo=FALSE}
raw_data$pophost = as.factor(raw_data$pophost)
raw_data$pophost = relevel(raw_data$pophost, "K. elegans")
p2 = ggplot(data=subset(raw_data, !is.na(datetime)), aes(x=datetime, fill=pophost)) + 
  labs(title="Collection numbers grouped by \n Host Plant and Datetime", 
       fill="Host Plant", x="Field Collection Date", y="Number of Bugs Collected") +
  scale_fill_manual(values=c("#68b054", "#56B4E9")) + 
  customPlot + 
  theme(plot.title = element_text(hjust = 0.5)) +   
  theme(plot.margin=unit(c(1,0.15,1,0.85), "cm"))
```

```{r sexes-barplot, fig.height=4.5, fig.width=7.2, echo=FALSE}
p3 = ggplot(data=subset(raw_data, !is.na(datetime)), aes(x=datetime, fill=sex)) + 
  labs(title="Collection numbers grouped by \n Sex and Datetime", 
       fill="Sex", x="Field Collection Date", y="Number of Bugs Collected") +
  scale_fill_manual(values=c("#db5c5c", "#80635b"),
                    labels = c("Female     ", "Male       ")) + 
  customPlot + 
  theme(plot.title = element_text(hjust = 0.5)) +   
  theme(plot.margin=unit(c(1,0.85,1,0.15), "cm"))
```

```{r message=FALSE, fig.height=3.4, fig.width=8, fig.align="center", echo=FALSE}
plot_grid(p2, p3, ncol=2)
```

For more details on the Fall 2019 and Winter 2020 soapberry bugs collected, see the table below. These bugs were also tested for flight trials (see Appendix B). Flight tested bugs are grouped by collection site and ordered by descending latitude. Collection numbers across each collection site ($n_{site}$) and each population ($n_{pop}$) are also recorded under Sample Sizes.

```{r echo=FALSE, message=FALSE, eval=FALSE}
library(kableExtra)
Fall_table = read.csv(paste0(dir,"All_Morphology/stats/tables/table2.csv"))

colnames(Fall_table) = c("host plant", "population", "site", 
                         "latitude", "longitude", "$\ n_{site}$", "$\ n_{pop}$")
kable(Fall_table, caption=" ") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  add_header_above(c(" ", " ", " ", "Coordinates" = 2, "Sample Sizes" = 2 )) %>% 
  add_header_above(c("Fall 2019" = 7 )) %>%
  column_spec(1, width="3cm", background="white") %>%
  kable_classic(html_font = "Cambria") 
```

```{r echo=FALSE, message=FALSE, eval=FALSE}
Winter_table = read.csv(paste0(dir,"All_Morphology/stats/tables/table1.csv"))

colnames(Winter_table) = c("host plant", "population", "site", 
                           "latitude", "longitude", "$\ n_{site}$", "$\ n_{pop}$")
kable(Winter_table, caption=" ") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  add_header_above(c(" ", " ", " ", "Coordinates" = 2, "Sample Sizes" = 2 )) %>% 
  add_header_above(c("Winter 2020" = 7 )) %>%
  column_spec(1, width="3cm", background="white") %>%
  kable_classic(html_font = "Cambria") 
```


\hfil ![](tables/tables.png){width=80%} \hfil

Fall 2019 field and test collections were a mix of short wing and long wing soapberry bugs. Winter 2020 field collections were a mix of short wing and long wing bugs, but only long wing soapberry bugs were tested.

# Regression Modeling

Multivariate, GLM was performed using the `glm()` function in the `lme4` package. Models were compared using Akaike Information Criterion (AIC) and model selection was determined using Akaike weights. Model fit was further evaluated between two models using the `anova()` function. 

## Long-Wing Morph Frequency

We tested how sex, host plant, month, and/or year effected whether a soapberry bug is long-winged (`wing_morph_b=1`) or short-winged (`wing_morph_b=0`). 

```{r}
data = data.frame(R=raw_data$wing_morph_b, 
                  A=raw_data$sex_b, 
                  B=raw_data$pophost_b, 
                  C=(raw_data$month_of_year),
                  D=raw_data$months_since_start)

model_script = paste0(source_path,"generic models-binomial glm 4-FF.R")
model_comparisonsAIC(model_script)
```

The R output above can be read as follows: Models exhibiting an Akaike weight greater than 0.05 are selected and displayed on the top table. The table is ordered by decreasing Akaike weight (or increasing AIC) where, for example, model `m98` had the highest Akaike weigh and lowest AIC. These Akaike weighs would demonstrate the relative likelihood of each model and they can be interpreted as the probabilities that a given model is the best approximating model.

Following the table, the formula of each model is pasted in order to make the models easy to refer to during the upcoming model comparisons using `anova()`. 

```{r results = "hold"}
anova(m98, m110, test="Chisq") # adding B*D does not improve fit
anova(m84, m98, test="Chisq")  # adding A*B improves fit
anova(m63, m84, test="Chisq")  # Adding C*D improves fit
anova(m51, m63, test="Chisq")  # Adding B improves fit
```

The best fit model is m98. That is confirmed by its minimum AIC value, maximum Akaike weight, and the addition of `A*B` (`sex_b*pophost_b`) leading to a significant improvement in model fit as detected by the ANOVA test.

### Best Fit

```{r}
M1 = glm(wing_morph_b ~ sex_b * pophost_b + sex_b * months_since_start +
           pophost_b * month_of_year + month_of_year * months_since_start, 
         data=raw_data, family="binomial") 
summary(M1)
```

```{r echo=FALSE}
sex.hp_int = M1$coefficients["sex_b:pophost_b"]
sex.year_int = M1$coefficients["sex_b:months_since_start"]
hp.month_int = M1$coefficients["pophost_b:month_of_year"]
month.year_int = M1$coefficients["months_since_start:month_of_year"]

interaction_terms = as.numeric(c(sex.hp_int, sex.year_int, hp.month_int, month.year_int))

define_interactions = function(interactions){
  each_int = split(interactions, sort(interactions%%length(interactions)),
                   f = LETTERS[1:length(interactions)])
    i1 = each_int$A
    i2 = each_int$B
    i3 = each_int$C
    i4 = each_int$D
    
    return(c(i1,i2,i3,i4))
}
```

```{r echo=FALSE}
d = raw_data
sex = c(1,-1)
hp = c(1,-1)
yr = seq(min(d$months_since_start), max(d$months_since_start), by=3)
mo = seq(1, 12, by=1)
combos = expand.grid(sex,hp,yr,mo)

define_total_effect_eq = function(i, sex, hp, yr, mo){
  total_effect = (i[1] * sex * hp) + (i[2] * sex * yr) #+ (i[3] * hp *mo) + (i[4] * mo * yr)
  return(total_effect)
}

get_percent_changes = function(cmatrix, define_interactions, define_total_effect_eq) {
  effects_col = c()
  for (i in 1:nrow(cmatrix)) {
    sex=cmatrix[i,1]
    hp=cmatrix[i,2]
    yr=cmatrix[i,3]
    mo=cmatrix[i,4]
    i = define_interactions(interaction_terms)
    total_effect = define_total_effect_eq(i,sex,hp,yr,mo)
    pred_prob = exp(total_effect)
    perchange =  (pred_prob - 1) * 100 
    effects_col = c(effects_col, perchange)
  }
  return(effects_col)
}

MODEL = get_percent_changes(combos, define_interactions, define_total_effect_eq)
combos$model  = MODEL

define_total_effect_eq = function(i, sex, hp, yr, mo){
  total_effect = (i[1] * sex * hp) + (i[3] * hp *mo)
  return(total_effect)
}

MODEL2 = get_percent_changes(combos, define_interactions, define_total_effect_eq)
combos$model2  = MODEL2
colnames(combos) = c("sex", "hp", "yr", "mo", "model", "model2")
cd = as.data.frame(combos)
```


```{r echo=FALSE, message=FALSE, fig.width=10, fig.height=4.8, fig.align="center"}
library(plotrix)
cols = c("#80635b", "#db5c5c")
colorfunc = colorRamp(cols)
x <- sort(runif(length(sex), min = 0, max = 1))
mycolors = rgb(colorfunc(x), maxColorValue=255)

# Plotting interaction between sex and host plant with interaction between sex and months since start
par(mfrow=c(1,2))
plot(cd$yr, cd$model, frame.plot=F,
     main="% change = \n sex * host plant + sex * months since start",
     ylab="% change (long-winged)", xlab="month since start",
     ylim=c(-50,75),
     col=cols[as.factor(cd$sex)], pch=c(19,17)[as.factor(cd$hp)])  
abline(h=0)
legend(0, 70,
       legend=c("M", "F"), 
       col=cols, pch=c(20, 20))
legend(15, 70,
       legend=c("C. corindum", "K. elegans"), 
       pch=c(1,2))

# Plotting interaction between sex and host plant  with interaction between host plant and month
plot(cd$mo, cd$model2, frame.plot=F,
     main="% change = \n sex * host plant + host plant * month",
     ylab="% change (long-winged)", xlab="month",
     ylim=c(-50,75), xlim=c(0,12),
     col=cols[as.factor(cd$sex)], pch=c(19,17)[as.factor(cd$hp)]) 
abline(h=0)
```

```{r echo=FALSE}
define_total_effect_eq = function(i, sex, hp, yr, mo){
  total_effect = 0.0107239 * yr + (i[1] * sex * hp) + (i[2] * sex * yr)
  return(total_effect)
}

MODEL3 = get_percent_changes(combos, define_interactions, define_total_effect_eq)
combos$model3  = MODEL3

define_total_effect_eq = function(i, sex, hp, yr, mo){
  total_effect = 0.0995560 * mo + (i[1] * sex * hp) + (i[3] * hp *mo) 
  return(total_effect)
}

MODEL4 = get_percent_changes(combos, define_interactions, define_total_effect_eq)
combos$model4  = MODEL4
cd = as.data.frame(combos)
```

```{r echo=FALSE, message=FALSE, fig.width=10, fig.height=4.8, fig.align="center"}
par(mfrow=c(1,2))
plot(cd$yr, cd$model3, frame.plot=F,
     main="% change = months since start + \n sex * host plant + sex * months since start",
     ylab="% change (long-winged)", xlab="month since start",
     ylim=c(-10,500),
     col=cols[as.factor(cd$sex)], pch=c(19,17)[as.factor(cd$hp)])  
abline(h=0)

plot(cd$mo, cd$model4, frame.plot=F,
     main="% change = month + \n sex * host plant + host plant * month",
     ylab="% change (long-winged)", xlab="month",
     ylim=c(-10,500), xlim=c(0,12),
     col=cols[as.factor(cd$sex)], pch=c(19,17)[as.factor(cd$hp)]) 
abline(h=0)
```


```{r echo=FALSE, message=FALSE, fig.width=10, fig.height=4.8, fig.align="center"}
par(mfrow=c(1,2))
define_total_effect_eq = function(i, sex, hp, yr, mo){
  total_effect = 0.0995560 * mo + (-0.0014557 * mo * yr) 
  return(total_effect)
}

MODEL5 = get_percent_changes(combos, define_interactions, define_total_effect_eq)
combos$model5  = MODEL5
cd = as.data.frame(combos)

colorfunc = colorRamp(c("black","#5c5c5c", "lightgrey"))
x <- sort(runif(length(mo), min = 0, max = 1))
mycolors_mo = rgb(colorfunc(x), maxColorValue=255)

plot(cd$mo, cd$model5, frame.plot=F,
     main="% change = month + months since start * month",
     ylab="% change (long-winged)", xlab="month",
     pch=18,
     col=mycolors_mo[as.factor(combos$yr)])
abline(h=0)
legend(1.5, 200, 
       title="year", 
       legend=c("2013", "2017", "2020"), 
       col=c("black","#5c5c5c", "lightgrey"), 
       pch=18)


plot(cd$yr, cd$model5, frame.plot=F,
     main="% change = month + months since start * month",
     ylab="% change (long-winged)", xlab="months since start",
     pch=18,
     col=mycolors_mo[as.factor(combos$mo)])
text(55, 78, "year = 2019")
abline(v=69, col="black")
abline(h=0)
legend(50, 200, 
       title="month", 
       legend=c("1  ", "6  ", "12  "), 
       col=c("black","#5c5c5c", "lightgrey"), 
       pch=18)
```

All single effects and their interactions are significant in the best fit model for predicting wing morph. It may be because of the size of the dataset that the model is more sensitive at detecting weak interactions as significant.

Also, notice how the interaction terms are weaker than the single variate effects in the best fit model. The first row of plots is showing only the interaction terms when considered independently whereas the second row of plots includes a single effect related to time (month or months since start). The strongest single variate effects, sex and host plant, are not plotted, but it is implied that they would drastically influence the possible outcome of whether a soapberry bug is long-winged or short-winged. This becomes more evident in the LOESS plots section of this appendix.

## Long-Wing Morph Variance

We then tested how sex, host plant, month, and/or year effected long-wing morph frequency variance.

First, the long-wing morph mean frequency was computed using `aggregate()` to group the long-wing morph recordings in `raw_data` according to sex, host plant, month, and year. The subsequent subset data created was `wmorph_table` (n=40) Then, summary statistics were applied to the data subset and variance (`sd`) was modeled.

```{r}
wmorph_table = aggregate(wing_morph_b ~ 
                           sex_b*pophost_b*month_of_year*months_since_start, 
                           data=raw_data, FUN=mean)

SE = function(x){sd(x)/sqrt(length(x))}

wmorph_table$sd = aggregate(wing_morph_b ~ 
                              sex_b*pophost_b*month_of_year*months_since_start, 
                              data=raw_data,FUN=sd)$wing_morph_b
wmorph_table$se = aggregate(wing_morph_b ~ 
                              sex_b*pophost_b*month_of_year*months_since_start, 
                              data=raw_data,FUN=SE)$wing_morph_b
wmorph_table$n = aggregate(wing_morph_b ~ 
                             sex_b*pophost_b*month_of_year*months_since_start, 
                              data=raw_data,FUN=length)$wing_morph_b
```

```{r}
data = wmorph_table
data = data.frame(R=data$sd, 
                  A=data$sex_b, 
                  B=data$pophost_b, 
                  C=(data$month_of_year),
                  D=data$months_since_start)

model_script = paste0(source_path,"generic models-gaussian glm 4-FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r results = "hold"}
anova(m2, m5, test="Chisq") # Adding A does not improve fit
anova(m2, m8, test="Chisq") # Adding C does not improve fit
anova(m2, m9, test="Chisq") # Adding D does not improve fit
anova(m0, m2, test="Chisq") # Adding B improves fit
```

The best fit model is m2. That is confirmed by its minimum AIC value, maximum Akaike weight, and the addition of `B` (`pophost_b`) to the null model leading to a significant improvement in model fit as detected by the ANOVA test.

### Best Fit

```{r}
M2 = glm(sd ~ pophost_b, data=wmorph_table, family="gaussian")
summary(M2) 
```

Host plant (`K. elegans = 1`, `C. corindum = -1`) is significant in predicting long-wing morph frequency variance. Soapberry bugs collected from *C. corindum*, balloon vine, experience more variance in long-wing morph frequency than those collected from *K. elegans*, goldenrain tree.

&nbsp;

## Wing-to-Body Ratio 

We tested how sex, host plant, month, and/or year effected whether the wing-to-body ratio of long-winged soapberry bugs.

```{r}
data = data.frame(R=data_long$wing2body_c,
                  A=data_long$sex_b,
                  B=data_long$pophost_b,
                  C=data_long$month_of_year_c, 
                  D=data_long$months_since_start_c)

model_script = paste0(source_path,"generic models-gaussian glm 4-FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r results = "hold"}
anova(m88, m99, test="Chisq") # adding C*D does not improve fit
anova(m58, m88, test="Chisq") # Adding A*D marginally improves fit
anova(m58, m76, test="Chisq") # Adding C*D does not improve fit
anova(m34, m58, test="Chisq") # Adding B*D improves fit
```

The best fit model is m58. It did not have the minimum AIC value or maximum Akaike weight, but the addition of `A*D (sex_b*months_since_start_c)` was not detected as a significant improvement in model fit, according to the ANOVA test.

### Best Fit

```{r}
M3 = glm(wing2body_c ~ sex_b*pophost_b + pophost_b*months_since_start_c 
         + month_of_year_c, data=data_long, family=gaussian) 
summary(M3) 
```

```{r echo=FALSE}
sex.hp_int = M3$coefficients["sex_b:pophost_b"]
hp.year_int = M3$coefficients["pophost_b:months_since_start_c"]

interaction_terms = as.numeric(c(sex.hp_int, hp.year_int))

define_interactions = function(interactions){
  each_int = split(interactions, sort(interactions%%length(interactions)),
                   f = LETTERS[1:length(interactions)])
    i1 = each_int$A
    i2 = each_int$B
    
    return(c(i1,i2))
}
```

```{r echo=FALSE}
d = data_long
sex = c(1,-1)
hp = c(1,-1)
yr = seq(min(d$months_since_start), max(d$months_since_start), by=3)
combos = expand.grid(sex,hp,yr)

define_total_effect_eq = function(i, sex, hp, yr){
  total_effect = (i[1] * sex * hp) + (i[2] * hp * yr)
  return(total_effect)
}

get_percent_changes = function(cmatrix, define_interactions, define_total_effect_eq) {
  effects_col = c()
  for (i in 1:nrow(cmatrix)) {
    sex=cmatrix[i,1]
    hp=cmatrix[i,2]
    yr=cmatrix[i,3]
    i = define_interactions(interaction_terms)
    total_effect = define_total_effect_eq(i,sex,hp,yr)
    pred_prob = exp(total_effect)
    perchange =  (pred_prob - 1) * 100 
    effects_col = c(effects_col, perchange)
  }
  return(effects_col)
}

MODEL = get_percent_changes(combos, define_interactions, define_total_effect_eq)
combos$model  = MODEL

define_total_effect_eq = function(i, sex, hp, yr){
  total_effect = 0.001787 * sex + 0.004289 * hp + (i[1] * sex * hp) + (i[2] * hp * yr)
  return(total_effect)
}

MODEL2 = get_percent_changes(combos, define_interactions, define_total_effect_eq)
combos$model2  = MODEL2
colnames(combos) = c("sex", "hp", "yr", "model", "model2")
cd = as.data.frame(combos)

```


```{r echo=FALSE, message=FALSE, fig.width=10, fig.height=4.8}
cols = c("#80635b", "#db5c5c")
colorfunc = colorRamp(cols)
x <- sort(runif(length(sex), min = 0, max = 1))
mycolors = rgb(colorfunc(x), maxColorValue=255)

# Plotting interaction between sex and host plant \n with interaction between host plant and year"
par(mfrow=c(1,2))
plot(cd$yr, cd$model, frame.plot=F,
     main="% change = \n sex * host plant + host plant * months since start",
     ylab="% change (wing-to-body ratio)", xlab="months since start",
     ylim=c(-1,1.5),
     col=cols[as.factor(cd$sex)], pch=c(19,17)[as.factor(cd$hp)])  
abline(h=0)
legend(0, 1.3,
       legend=c("M", "F"), 
       col=cols, pch=c(20, 20))
legend(15, 1.3,
       legend=c("C. corindum", "K. elegans"), 
       pch=c(1,2))
plot(cd$yr, cd$model2, frame.plot=F,
     main="% change = sex + host plant + \n sex * host plant + host plant * months since start",
     ylab="% change (wing-to-body ratio)", xlab="months since start",
     ylim=c(-1,1.5),
     col=cols[as.factor(cd$sex)], pch=c(19,17)[as.factor(cd$hp)])  
abline(h=0)
```


All single effects except `months_since_start` and all interactions are significant in the best fit model for predicting wing-to-body ratio. It is noticeable that month and year effect sizes are relatively small.

In general, it is noticeable that the variables in the model have weak effect sizes, especially when compared to how long-wing morph frequency changes over time. Considering single effects, does not lead to more pronounced percent changes in wing-to-body ratio across the years, but it does highlight which host plants exhibit sex differences and how host plant differences seems to be most influencing changes in wing-to-body ratio over time. 

&nbsp;

## Wing-to-Body Ratio Variance 

We then tested how sex, host plant, month, or year effects the wing-to-body ratio variance of long-winged soapberry bugs.

First, the mean wing-to-body ratio was computed using `aggregate()` to group the wing-to-body ratio recordings in `data_long` according to sex, host plant, month, and year. The subsequent subset data created was `w2b_table` (n=36). Then, summary statistics were applied to the data subset and variance (`sd`) was modeled.

```{r}
w2b_table = aggregate(wing2body ~ 
                        sex_b*pophost_b*month_of_year*months_since_start, 
                        data=data_long, FUN=mean)
w2b_table$sd = aggregate(wing2body ~ 
                           sex_b*pophost_b*month_of_year*months_since_start, 
                           data=data_long, FUN=sd)$wing2body
w2b_table$se = aggregate(wing2body ~ 
                           sex_b*pophost_b*month_of_year*months_since_start, 
                           data=data_long, FUN=SE)$wing2body
```

```{r}
data = w2b_table
data = data.frame(R=data$sd, 
                 A=data$sex_b, 
                 B=data$pophost_b, 
                 C=(data$month_of_year),
                 D=data$months_since_start)

model_script = paste0(source_path,"generic models-gaussian glm 4-FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r results = "hold"}
anova(m8, m19, test="Chisq") # Adding B*C does not improve fit
anova(m2, m8, test="Chisq") # Adding C does not improve fit
anova(m0, m2, test="Chisq") # Adding B improves fit
```

The best fit model is m2. It did not have the minimum AIC value or maximum Akaike weight, but the addition of `B` (`pophost_b`) to the null model lead to a significant improvement in model fit detected by the ANOVA test.

### Best Fit

```{r}
M4 = glm(sd ~ pophost_b, data=w2b_table, family=gaussian) 
summary(M4)
```

Host plant (`K. elegans = 1,C. corindum = -1`) is significant in predicting wing-to-body ratio variance. Soapberry bugs collected from *K. elegans*, goldenrain tree, experience more variance in wing-to-body ratio than those collected from *C. corindum*, balloon vine.

&nbsp;

# LOESS & Linear Regression Plots

Locally-weighted scatterplot smoothing (LOESS) helped display and explore the non-linear fluctuations in long-wing morph frequency and wing-to-body ratio across time. Each data set was fit with a local polynomial regression using `lowess()` to determine LOESS parameters ($\alpha$ and $\lambda$) and `geom_smooth()` for plotting more aesthetic visuals.  

```{r echo=FALSE}
# repeating plotting features
customPlot = list( theme_classic(),
                   theme(axis.text=element_text(size=13),
                         axis.title=element_text(size=16), 
                         plot.title=element_text(size=20),),
                   theme(legend.position = c(0.2, 0.9)),
                   theme(legend.title = element_text(size=14, face="italic"),
                         legend.text = element_text(size = 13, face="italic"))
)

xlab_years = na.omit(sort(unique(data_long$dates))[-2])
xlab_yrs = sort(unique(raw_data$dates))

xlab_allmonths = na.omit(sort(unique(data_long$month_of_year)))
xlab_months = xlab_allmonths[c(-2,-5)]
month_labs = c("Feb", "May", "Aug", "Oct", "Dec")

hp_col_pts = c("turquoise3", "springgreen4")
hp_col_shade = c("turquoise3", "green")
hp_col_lines = c("skyblue2", "darkgreen")
sex_col_pts = c("brown3", "black")
sex_col_shade = c("brown1", "sienna4")
sex_col_lines = c("brown3", "black")

font_size = 4.5
```

## Wing Morph Frequency

### Group significant elements 

Data are aggregated according to predictors present in their respective aforementioned best fit GLM model. For predicting long-wing morph frequency (`raw_data`), the best fit model had the following predictors: sex, host plant, month, and year. We used `dates`, a datetime object, instead of `months_since_start` for cleaner plotting, but the two are interchangeable.

```{r}
# function to calculate 95% confidence interval (CI). 
CI_95 = function(x){qnorm(0.975)*sd(x)/sqrt(length(x))}
CI_95_binom_upper = function(y) {
                        binom.confint(x=sum(y, na.rm=TRUE), 
                                      n=length(y[!is.na(y)]), 
                                      conf.level=0.95, 
                                      methods='exact')$upper}
CI_95_binom_lower = function(y) {
                        binom.confint(x=sum(y, na.rm=TRUE), 
                                      n=length(y[!is.na(y)]), 
                                      conf.level=0.95, 
                                      methods='exact')$lower}
```

```{r}
# aggregate the full data
w_morph_summary = aggregate(wing_morph_b ~
                            sex*pophost*month_of_year*dates, 
                            data=raw_data, FUN=mean)

# compute standard error (SE), upper and lower CI, & sample size (n)
w_morph_summary$se = aggregate(wing_morph_b ~ 
                               sex*pophost*month_of_year*dates,
                               data=raw_data, 
                               FUN=SE)$wing_morph_b
w_morph_summary$upper = aggregate(wing_morph_b ~ 
                                  sex*pophost*month_of_year*dates,
                                  data=raw_data, 
                                  FUN=CI_95_binom_upper)$wing_morph_b
w_morph_summary$lower = aggregate(wing_morph_b ~ 
                                  sex*pophost*month_of_year*dates,
                                  data=raw_data, 
                                  FUN=CI_95_binom_lower)$wing_morph_b
w_morph_summary$n = aggregate(wing_morph_b ~ 
                              sex*pophost*month_of_year*dates,
                              data=raw_data, 
                              FUN=length)$wing_morph_b

dd = w_morph_summary
```

### Check for LOESS Residuals 

To determine the span ($\alpha$, the smoothing parameter) and the degree of zero ($\lambda$) of the LOESS, smoothers were applied with increasing weights until the residuals appeared to have constant variance. Only the best LOESS parameters are shown below:
 
```{r}
plot_lowess_residuals = function(lfit, x, y, color) {
  lfun = approxfun(lfit)
  fitted = lfun(x)
  resid = y-fitted
  plot(fitted,resid,col=color, pch=19)
  abline(h=0,col=8)
}
```

```{r plot-loess-fit, warning=FALSE, fig.height=3*2, fig.show = 'hold'}
# loess models (month and year)
lM = lowess(dd$month_of_year, dd$wing_morph_b, f=0.4) # f = alpha, the smoother span
lY = lowess(dd$dates, dd$wing_morph_b, f=0.4)

# plot loess fit and residuals 
par(mfrow=c(2,2), mai=c(0.80,0.80,0.3,0.3), mgp=c(2.3,1,0)) 

color=alpha("black", alpha = 0.75)
plot(dd$month_of_year, dd$wing_morph_b,
     xlab="month of year", ylab="long-wing morph freq", col=color)
lines(lM, type = "l")
plot_lowess_residuals(lM, dd$month_of_year, dd$wing_morph_b, color)

plot(dd$dates, dd$wing_morph_b,
     xlab="year", ylab="long-wing morph freq", col=color)
lines(lY, type = "l", color="#BEBEBE")
plot_lowess_residuals(lY, dd$dates, dd$wing_morph_b, color)
```

From these residual plots (right-side), we selected a $\lambda$=0 and $\alpha$=0.4. With a zero degree polynomial, LOESS acts as a weighted moving average and a span of 0.4 demonstrates independence between the residuals. 

### Figure: Panels A, B, C, D (long-wing morph freq with month) & E (long-wing morph freq with year)

```{r echo=FALSE}
# relevel factors for cleaner plotting
dd$pophost = factor(dd$pophost, levels = c("K. elegans", "C. corindum") )
dd$`Host Plant` = dd$pophost

# rename columns 
dd$sex[dd$sex=="F"] = "Females"
dd$sex[dd$sex=="M"] = "Males"
dd$sex = factor(dd$sex, levels = c("Males", "Females") )
dd$`Sex` = dd$sex 

raw_data$'Host Plant'=raw_data$pophost
raw_data$Sex=NA
raw_data$Sex[raw_data$sex=="F"] = "Females"
raw_data$Sex[raw_data$sex=="M"] = "Males"
```

In addition to plotting local polynomial regression lines, the effects (slopes) of the best fit GLM models were also plotted. However, due to multiple interaction terms, we substituted the complex GLM models with single-variate or simpler models. This led to cleaner GLM line plotting, and the plots still reasonably reflected the aforementioned GLM models. Finally, all p-values displayed were extracted from the aforementioned best fit GLM model.

&nbsp;

\begin{center}
 \textbf{Panels A and B Regression Computations:}
\end{center}

```{r}
# single-variate model of month predicting wing morph
fit1 = glm(wing_morph_b ~ month_of_year, family="binomial", data=raw_data)
xmonth = seq(2,12, 0.01)
wing_probs = predict(fit1, list(month_of_year=xmonth), type="response")

# extract p-value from best fit regression model
fit_pvalue = round(summary(M1)$coeff[,"Pr(>|z|)"][5],5)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
### Panels A and B

### host plant
p4 = ggplot() + 
  ggtitle("A\n") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_line(aes(x=xmonth, y=wing_probs), linetype = "dashed") +
  geom_smooth(data=raw_data[!is.na(raw_data$wing_morph_b),], method="loess",
              mapping = aes(x = month_of_year, y = wing_morph_b, colour=`Host Plant`, fill=`Host Plant`)) +
  geom_point(data=dd, 
             mapping = aes(x = month_of_year, y = wing_morph_b, colour=`Host Plant`, size=n), show.legend=F) +
  customPlot + 
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) + 
  ylim(0,1.2) 

### sex
p5 = ggplot() + 
  ggtitle("B\n") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_line(aes(x=xmonth, y=wing_probs), linetype = "dashed") +
  geom_smooth(data=raw_data[!is.na(raw_data$wing_morph_b),], method="loess",
              mapping = aes(x = month_of_year, y = wing_morph_b, colour=`Sex`, fill=`Sex`)) + 
  geom_point(data=dd, 
             mapping = aes(x = month_of_year, y = wing_morph_b, colour=Sex, size=n), show.legend=F) +
  customPlot +
  scale_color_manual(values=c("Females" = sex_col_pts[1], "Males" = sex_col_pts[2])) +
  scale_fill_manual(values = c("Females" = sex_col_shade[1], "Males" = sex_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) + 
  ylim(0,1.2) + 
  theme(axis.title.y = element_blank()) 

# extract alpha, smoothing parameter, from LOESS regression(s)
alpha = paste("alpha[loess]==", ggplot_build(p5)$data[[3]]$alpha[1])
degree="lambda[loess]==0"

p4 = p4 + 
  annotate(geom="text", x=7.2, y=0.92, label=alpha, parse=TRUE, size=font_size) +
  annotate(geom="text", x=7.2, y=0.99, label=degree, parse=TRUE, size=font_size) +
  annotate(geom="text", x=5.5, y=0.718, label=pvalue, parse=TRUE, size=font_size) + 
  theme(legend.position = c(0.18, 1.02)) + 
  labs(x = " ", y = " ") +
  coord_cartesian(ylim=c(0.30,1.1))

p5 = p5 + 
  annotate(geom="text", x=7.2, y=0.98, label=alpha, parse=TRUE, size=font_size) +
  annotate(geom="text", x=7.2, y=1.05, label=degree, parse=TRUE, size=font_size) +
  annotate(geom="text", x=6.5, y=0.85, label=pvalue, parse=TRUE, size=font_size) + 
  theme(legend.position = c(0.15, 1.02)) + 
  labs(x = " ", y = " ") +
  coord_cartesian(ylim=c(0.30,1.1))
```

```{r echo=FALSE}
# group data by sex 
dfF = dd[dd$sex=="Females",]
dfM = dd[dd$sex=="Males",]
```

\begin{center}
  \textbf{Panels C and D Regression Computations:}
\end{center}

```{r message=FALSE}
# multi-variate model with month, sex, and host plant predicting wing morph
fit2 = glm(wing_morph_b ~ sex_b * pophost_b + 
          pophost_b * month_of_year, family = "binomial", data = raw_data)

set.seed(194842)
xmon = seq(2,12, 0.01)
bsex = sample(c(-1,1), replace=TRUE, size=length(xmon))
bhost = sample(c(-1,1), replace=TRUE, size=length(xmon))
wprobs = predict(fit2, list(sex_b = bsex,
                                pophost_b = bhost,
                                month_of_year = xmon), type="response")

pred = cbind(xmon, bsex, bhost, wprobs)
pred = as.data.frame(pred)

predFK = pred[pred$bhost==1 & pred$bsex==1,]
predFC = pred[pred$bhost==-1 & pred$bsex==1,]

predMK = pred[pred$bhost==1 & pred$bsex==-1,]
predMC = pred[pred$bhost==-1 & pred$bsex==-1,]

# extract p-value from best fit regression model
fit_pvalue = round(summary(M1)$coeff[,"Pr(>|z|)"][6],4)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)
```

```{r echo=FALSE, message=FALSE}
### Panels C and D

### females & host plant
p6 = ggplot() + 
  ggtitle("C") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_line(aes(x=predFK$xmon, y=predFK$wprobs), linetype = "dashed", color=hp_col_lines[2]) +
  geom_line(aes(x=predFC$xmon, y=predFC$wprobs), linetype = "dashed", color=hp_col_lines[1]) +
  geom_smooth(data=raw_data[raw_data$sex=="F" & !is.na(raw_data$wing_morph_b),], method="loess", span=0.8,
              mapping = aes(x = month_of_year, y = wing_morph_b, colour=`Host Plant`, fill=`Host Plant`)) +
  geom_point(data=dfF, mapping = aes(x = month_of_year, y = wing_morph_b, colour=`Host Plant`, size=n),
             show.legend=F) +
  customPlot + 
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) +
  ylim(0,1.3)

### males & host plant
p7 = ggplot() + 
  ggtitle("D") + xlab("Month") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_line(aes(x=predMK$xmon, y=predMK$wprobs), linetype = "dashed", color=hp_col_lines[2]) +
  geom_line(aes(x=predMC$xmon, y=predMC$wprobs), linetype = "dashed", color=hp_col_lines[1]) +
  geom_smooth(data=raw_data[raw_data$sex=="M" & !is.na(raw_data$wing_morph_b),], method="loess", span=0.8,
              mapping = aes(x = month_of_year, y = wing_morph_b, colour=`pophost`, fill=`pophost`),
              show.legend=F) + 
  geom_point(data=dfM, mapping = aes(x = month_of_year, y = wing_morph_b, colour=`Host Plant`, size=n)) +
  guides(color=F) +
  customPlot + 
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) +
  ylim(0,1.3)

# extract alpha, smoothing parameter from LOESS regression(s)
alpha = paste("alpha[loess]==", ggplot_build(p7)$data[[4]]$alpha[1])
degree="lambda[loess]==0"

p6 = p6 + 
  annotate(geom="text", x=3, y=1.07, label="Females", size=6, fontface = 'italic') + 
  annotate(geom="text", x=6.5, y=0.99, label=alpha, parse=TRUE, size=font_size) +
  annotate(geom="text", x=6.5, y=1.06, label=degree, parse=TRUE, size=font_size) +
  annotate(geom="text", x=7.5, y=0.40, label=pvalue, parse=TRUE, size=font_size) + 
  theme(legend.position = "none") + 
  labs(x = " ", y = " ") +
  coord_cartesian(ylim=c(0.30,1.1))

p7 = p7 + 
  annotate(geom="text", x=3, y=1.07, label="Males", size=6, fontface = 'italic') + 
  annotate(geom="text", x=6.5, y=0.99, label=alpha, parse=TRUE, size=font_size) +
  annotate(geom="text", x=6.5, y=1.06, label=degree,parse=TRUE, size=font_size) +
  annotate(geom="text", x=7.5, y=0.40, label=pvalue, parse=TRUE, size=font_size) +
  #theme(legend.position = "none") + 
  theme(legend.position = c(0.87, 0.25)) + 
  theme(axis.title.y = element_blank()) + 
  labs(x = " ", y = " ") +
  coord_cartesian(ylim=c(0.30,1.1))
```

\begin{center}
  \textbf{Panel F Regression Computations:}
\end{center}

```{r}
# multi-variate model with year, sex, and host plant predicting wing morph
fit3 = glm(wing_morph_b ~ sex_b * dates, family = "binomial", data = raw_data)

set.seed(194842)
xyr = seq(sort(unique(dd$dates))[1],sort(unique(dd$dates))[10], 1)
bsex = sample(c(-1,1), replace=TRUE, size=length(xyr))
bhost = sample(c(-1,1), replace=TRUE, size=length(xyr))
wprobs = predict(fit3, list(sex_b = bsex,
                                pophost_b = bhost,
                                dates = xyr), type="response")

pred = cbind(xyr, bsex, bhost, wprobs)
pred = as.data.frame(pred)
pred$xyr = as.Date.numeric(pred$xyr)

predF = pred[pred$bsex==1,]
predM = pred[pred$bsex==-1,]

# extract p-value from best fit regression model
fit_pvalue = round(summary(M1)$coeff[,"Pr(>|z|)"][7],3)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
### Panel F

p9 = ggplot() + 
  ggtitle("F") + xlab("Year") + ylab("Long-Wing Morph Frequency") +
  geom_vline(xintercept = xlab_yrs, color="gainsboro") + 
  geom_line(aes(x=predF$xyr, y=predF$wprobs), linetype = "dashed", color=sex_col_lines[1], lwd=0.5) +
  geom_line(aes(x=predM$xyr, y=predM$wprobs), linetype = "dashed", color=sex_col_lines[2], lwd=0.5) +
  geom_smooth(data=raw_data[!is.na(raw_data$wing_morph_b),], method="loess", span=0.8,
              mapping = aes(x = dates, y = wing_morph_b, colour=`Sex`, fill=`Sex`)) + 
  geom_point(data=dd, mapping = aes(x = dates, y = wing_morph_b, colour=`Sex`, size=n),
             show.legend=F) +
  customPlot + 
  scale_color_manual(values=c("Females" = sex_col_pts[1], "Males" = sex_col_pts[2])) +
  scale_fill_manual(values = c("Females" = sex_col_shade[1], "Males" = sex_col_shade[2])) +
  ylim(0,1.3) + # ylim bounds must include must all data points or points be marked as 'non-finite'
  coord_cartesian(ylim=c(0.30,1.1)) +
  theme(legend.position = "none") 

p9 = p9 +
  annotate(geom="text", x=xlab_yrs[5], y=0.99, label=alpha, parse=TRUE, size=font_size) +
  annotate(geom="text", x=xlab_yrs[5], y=1.04, label=degree, parse=TRUE, size=font_size) +
  annotate(geom="text", x=xlab_yrs[4], y=0.59, label=pvalue, parse=TRUE, size=font_size)
```

```{r figure-4-extension, echo=FALSE, message=FALSE, warning=FALSE, fig.height=13.5, fig.width=11}
customGRID1 = list(draw_plot(p4, 0, .66, .5, .33),
                   draw_plot(p5, 0.5, .66, .5, .33),
                   draw_plot(p6, 0, .33, .5, .33),
                   draw_plot(p7, 0.5, .33, .5, .33),
                   draw_plot(p9, 0, 0, 1, .33),
                   draw_plot_label("Month", 0.47, 0.338, fontface="plain"),
                   draw_plot_label("Long-Wing Morph Frequency", 0, 0.46, fontface="plain", angle=90)
                  )

paper_figure1 = ggdraw() +
  customGRID1
paper_figure1
```

**Extension of Figure 4. Evaluation of the frequency of long-winged morph soapberry bugs averaged across month and year from April 2013 to February 2020 using exploratory plots.** For each point, the mean frequency of long-winged morphs of each month and year is plotted with LOESS smooth lines (solid lines) and 95% confidence intervals (shading) and linear regression line(s) (dashed line(s)).

\newpage

## Wing-to-Body Ratio

### Group significant elements 

Data are aggregated according to predictors present in their respective aforementioned best fit GLM model. For predicting wing-to-body ratio (`data_long`), the best fit model had the following predictors: sex, host plant, month, and year. We used `dates`, a datetime object, instead of `months_since_start` for cleaner plotting, but the two are interchangeable.

```{r}
w2b_summary = aggregate(wing2body~sex*pophost*dates*month_of_year, 
                        data=data_long, FUN=mean)
w2b_summary$se = aggregate(wing2body~sex*pophost*dates, 
                           data=data_long,
                           FUN=SE)$wing2body
w2b_summary$n = aggregate(wing2body~sex*pophost*dates, 
                          data=data_long,
                          FUN=length)$wing2body
d = w2b_summary
```

### Check for LOESS Residuals 

To determine the span ($\alpha$, the smoothing parameter) and the degree of zero ($\lambda$) of the LOESS, smoothers were applied with increasing weights until the residuals appeared to have constant variance. Only the best LOESS parameters are shown below:

```{r plot-loess-fit-2, warning=FALSE, fig.height=2.7, fig.show = 'hold'}
# loess models (month and year)
lM = lowess(d$month_of_year, d$wing2body, f=0.4) # f = alpha, the smoother span
lY = lowess(d$dates, d$wing2body, f=0.4)

# plot loess fit and residuals 
par(mfrow=c(1,2), mai=c(0.80,0.80,0.3,0.3), mgp=c(2.5,1,0)) 

color="#00000080"
plot(d$month_of_year, d$wing2body, 
     xlab="month of year", ylab="wing-to-body ratio", col=color)
lines(lM, type = "l")
plot_lowess_residuals(lM, d$month_of_year, d$wing2body, color)

plot(d$dates, d$wing2body, 
     xlab="year", ylab="wing-to-body ratio", col=color)
lines(lY, type = "l")
plot_lowess_residuals(lY, d$dates, d$wing2body, color)
```

Similarly, from these residual plots (right-side), we selected a $\lambda$=0 and $\alpha$=0.4. 

### Figure: Panels A, B, (wing-to-body ratio with month) & C (wing-to-body ratio with year)

In similar fashion, the local polynomial regression lines and the effects (slopes) of the best fit GLM models were plotted together. Due to multiple interaction terms, we substituted the complex GLM models with single-variate or simpler models. This led to cleaner GLM line plotting, and the plots still reasonably reflected the aforementioned GLM models. Finally, all p-values displayed were extracted from the aforementioned best fit GLM model.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# relevel and rename factors for cleaner plotting
d$pophost = factor(d$pophost, levels = c("K. elegans", "C. corindum") )
d$`Host Plant` = d$pophost

d$sex[d$sex=="F"] = "Females"
d$sex[d$sex=="M"] = "Males"
d$sex = factor(d$sex, levels = c("Males", "Females") )
d$`Sex` = d$sex 

data_long$'Host Plant' = factor(data_long$pophost, levels = c("K. elegans", "C. corindum") )
data_long$Sex[data_long$sex=="F"] = "Females"
data_long$Sex[data_long$sex=="M"] = "Males"
data_long$Sex = factor(data_long$Sex, levels = c("Males", "Females") )
```

\begin{center}
 \textbf{Panels A and B Regression Computations:}
\end{center}

Wing-to-body ratio is continuous data, unlike the wing morph data which is binary data. As a result, rather than using the `predict()` function to calculate the best fit line between wing-to-body and month, we used a single line of `ggplot` code, `geom_smooth(data=data_long, method="glm", mapping = aes(x = month_of_year, y = wing2body)...)`. This line of code can be see in the wing_summary.Rmd script.

```{r echo=FALSE, message=FALSE, warning=FALSE}
### Panels A and B

### host plant
p10 = ggplot() + 
  ggtitle("A") + xlab("Month") + ylab(" ") +
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_smooth(data=data_long, method="glm", se=FALSE, linetype = "dashed", 
              mapping = aes(x = month_of_year, y = wing2body), colour="black", lwd=0.5) + 
  geom_smooth(data=data_long, method="loess", 
              mapping = aes(x = month_of_year, y = wing2body, colour=`Host Plant`, fill=`Host Plant`)) + 
  geom_point(data=d, mapping = aes(x = month_of_year, y = wing2body, colour=`Host Plant`, size=n), show.legend=F) + 
  ylim(0.65, 0.85) + # data outside this range will be dropped
  coord_cartesian(ylim=c(0.705,0.75)) + 
  customPlot +
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels=month_labs) + 
  theme(axis.title.x = element_blank())

### sex
p11 = ggplot() + 
  ggtitle("B") + xlab("Month") + ylab(" ") + 
  geom_vline(xintercept = xlab_allmonths, color="gainsboro") + 
  geom_smooth(data=data_long, method="glm", se=FALSE, linetype = "dashed",  
              mapping = aes(x = month_of_year, y = wing2body), colour="black", lwd=0.5) + 
  geom_smooth(data=data_long, method="loess",
              mapping = aes(x = month_of_year, y = wing2body, colour=Sex, fill=Sex)) + 
  geom_point(data=d, mapping = aes(x = month_of_year, y = wing2body, colour=Sex, size=n), show.legend=F) +
  ylim(0.65, 0.85) +
  coord_cartesian(ylim=c(0.705,0.75)) + 
  customPlot +
  scale_color_manual(values=c("Females" = sex_col_pts[1], "Males" = sex_col_pts[2])) +
  scale_fill_manual(values = c("Females" = sex_col_shade[1], "Males" = sex_col_shade[2])) +
  scale_x_continuous(breaks=xlab_months, labels= month_labs) + 
  theme(axis.title.x = element_blank())

# extract alpha, smoothing parameter from LOESS regression(s) and p-value from linear model
alpha = paste("alpha[loess]==", ggplot_build(p10)$data[[3]]$alpha[1])
degree="lambda[loess]==0"
fit_pvalue = round(summary(M3)$coeff[,"Pr(>|t|)"][5],7)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)

p10 = p10 +
  annotate(geom="text", x=10, y=0.745, label=alpha, parse=TRUE, size=font_size) +
  annotate(geom="text", x=10, y=0.749, label=degree, parse=TRUE, size=font_size) +
  annotate(geom="text", x=5, y=0.715, label=pvalue, parse=TRUE, size=font_size)

p11 = p11 +
  annotate(geom="text", x=10, y=0.745, label=alpha, parse=TRUE, size=font_size) +
  annotate(geom="text", x=10, y=0.749, label=degree, parse=TRUE, size=font_size) +
  annotate(geom="text", x=5, y=0.715, label=pvalue, parse=TRUE, size=font_size)
```

\begin{center}
 \textbf{Panel C Regression Computations:}
\end{center}

```{r}
# multi-variate model with year and host plant predicting wing2body ratio
fit4 = glm(wing2body ~ pophost_b * dates, data = data_long)

set.seed(194842)
xyr = seq(sort(unique(dd$dates))[1],sort(unique(dd$dates))[10], 1)
bhost = sample(c(-1,1), replace=TRUE, size=length(xyr))
wprobs = predict(fit4, list(pophost_b = bhost,
                                dates = xyr), type="response")

pred = cbind(xyr, bhost, wprobs)
pred = as.data.frame(pred)
pred$xyr = as.Date.numeric(pred$xyr)

predK = pred[pred$bhost==1,]
predC = pred[pred$bhost==-1,]

# extract p-value from best fit regression model
fit_pvalue = round(summary(M3)$coeff[,"Pr(>|t|)"][7],3)
pvalue = paste0("italic(p)[glm]==", fit_pvalue)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
### Panel C

p12 = ggplot() + 
  ggtitle("C") + xlab("Year") + ylab(" ") +
  geom_vline(xintercept = xlab_years, color="gainsboro") + 
  geom_line(aes(x=predK$xyr, y=predK$wprobs), linetype = "dashed", color=hp_col_lines[2], lwd=0.5) +
  geom_line(aes(x=predC$xyr, y=predC$wprobs), linetype = "dashed", color=hp_col_lines[1], lwd=0.5) +
  geom_smooth(data=data_long, method="loess", span=0.8,
              mapping = aes(x = dates, y = wing2body, colour=`Host Plant`, fill=`Host Plant`),
              show.legend=F) + 
  geom_point(data=d, mapping = aes(x = dates, y = wing2body, colour=`Host Plant`, size=n)) +
  guides(color=F) + 
  customPlot +
  scale_color_manual(values=c("C. corindum" = hp_col_pts[1], "K. elegans" = hp_col_pts[2])) +
  scale_fill_manual(values = c("C. corindum" = hp_col_shade[1], "K. elegans" = hp_col_shade[2])) +
  ylim(0.65, 0.85) +
  theme(legend.position = c(0.1, 0.9)) +
  #theme(legend.position = "none") +
  coord_cartesian(ylim=c(0.705,0.75))

#### loess and linear regressions
alpha = paste("alpha[loess]==", ggplot_build(p12)$data[[4]]$alpha[1])
degree="lambda[loess]==0"

p12 = p12 +
  annotate(geom="text", x=unique(d$dates)[17]-330, y=0.743, label=alpha, parse=TRUE, size=font_size) +
  annotate(geom="text", x=unique(d$dates)[17]-330, y=0.747, label=degree, parse=TRUE, size=font_size) +
  annotate(geom="text", x=unique(d$dates)[15], y=0.716, label=pvalue, parse=TRUE, size=font_size)
```



```{r figure-5, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10}
#```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=4.2, fig.width=5}
paper_figure2 = ggdraw() +
  draw_plot(p10, 0, .5, .5, .5) +
  draw_plot(p11, .5, .5, .5, .5) +
  draw_plot(p12, 0, 0, 1, .5) +  
  draw_plot_label("Month", 0.47, 0.51, fontface="plain") +
  draw_plot_label("Wing-to-Body Ratio", 0, 0.35, fontface="plain", angle=90)
paper_figure2
```

**Figure 5. Evaluation of the wing-to-body ratio of soapberry bugs averaged across month and year from April 2013 to February 2020 using exploratory plots.** For each point, the mean wing-to-body ratio of soapberry bugs collected in each month and year is plotted with LOESS smooth lines (solid lines) and 95% confidence intervals (shading) and linear regression line(s) (dashed line(s)). 
