---
title: 'Appendix B: Modeling Flight Response'
author: "for 'paper_title'; Bernat, AV, Cenzer, ML"
geometry: margin=2cm
output:
  pdf_document:
    includes: null
    toc: yes
    toc_depth: 3
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
line-height: 1.5
fontsize: 11pt
classoption: a4paper
language: en
---

```{r setup, include=FALSE}
rm(list=ls())

# set working directory
dir = "~/Desktop/git_repositories/SBB-dispersal/avbernat/"
setwd(dir)

knitr::opts_chunk$set(echo = TRUE)
```

\newpage

# Details of the Analyses

This document was generated by R Markdown on `r format(Sys.time(), '%Y-%m-%d')` using `r version[['version.string']]`. The document provides the step-by-step analytical methods used in the manuscript by Anastasia Bernat (AVB) and Meredith Cenzer (MLC). Multiple draft scripts were written by AVB and MLC between 2020-03-01 and 2021-07-26 until being distilled and complied by AVB and code reviewed by MLC at the University of Chicago into this comprehensive script. All draft scripts can be viewed in the GitHub repository, SBB-dispersal (https://github.com/mlcenzer/SBB-dispersal), within the directory **avbernat > Dispersal > Winter_2020 > stats **. 

All code and output from the statistical analyses are shown. Code for data cleaning and the generation of plots is not displayed, but can be viewed in the **appendix_B-flight_summary.Rmd** file and its accompanying sourced scripts. To repeat analyses and the generation of plots, all data files and sourced scripts should follow the directory structure presented in the SBB-dispersal repository.

## Description of the Data

Soapberry bugs, *Jadera haematoloma*, were flight tested in the Fall 2019 (2019-10-15 to 2019-11-08) and Winter 2020 (2020-02-17 to 2020-03-10) seasons using a flight mill machine. Soapberry bugs were flight tested twice for either set time increments or multiple hours in the flight mill and observed from 8 AM to (5-8 PM) each day. For each trial, the mass, flight response, egg-laying response, distance, duration, average speed, and max speed of each soapberry bug was recorded and then processed. All Python scripts used to process the flight records are located in the GitHub repository within the directory **avbernat_working_on > Dispersal > Winter_2020 > windaq_processing **. After trials, morphology measurements were taken for each bug. There are four morphology measurements: beak length, thorax width, wing length, and body length. The sex, wing morph (long-winged, shot-winged, or ambiguously-winged), host plant, and population of each bug were also recorded.

As a result of the experimental design, this document analyzes two main types of datasets: a full dataset and a unique dataset. A **full dataset** is a dataset where each row has a unique ID and trial type. A **unique dataset** is a dataset where each row has a unique ID because each trial has been grouped by ID. Examples are provided below. The advantage of generating a unique dataset is that changes between trials can be observed and analyzed.

## Abbreviations Used in the Data and Code

* **SBB** - soapberry bug, *Jadera haematoloma*
* **S** - short-winged morph
* **L** - long-winged morph
* **LS** or **SL** - ambiguous wing morph
* **T1** - trial 1 of flight testing
* **T2** - trial 2 of flight testing
* **EWM** - eggs when massed, binary response (yes or no)
* **host_** - the host plant soapberry bugs were collected from, which was either *Koelreuteria elegans* or *Cardiospermum corindum*, occasionally called (and abbreviated) as goldenrain tree (GRT) or balloon vine (BV), respectively
* **sym_dist** - distance from the local sympatric zone, which is demarked as Homestead
* **wing2body** - a computed and unitless column that calculates the wing length divided by the body length of a soapberry bug
* **sd** - standard deviation
* **se** - standard error
* **w_** - a column name that starts with `w_` is abbreviated from "wing". Example column: w_morph is "wing morph"

## Data Transformations

* `_b` - a column name that ends in `_b` is a column that has been recodified into binary data (0's and 1's). Example columns: flew_b, eggs_b 
* `_c` - a column name that ends in `_c` is a column that has been centered. Example columns: sex_c, host_c, avg_days_c
* `_s` - a column name that ends in `_s` is a column that has been standardized. Example columns: wing2body_s, sym_dist_s, thorax_s
* `avg_` - a column name that starts in `avg_` is a column that has been averaged across trial 1 (T1) and trial 2 (T2). Example columns: avg_mass, avg_days, avg_time_start, avg_rec_dur (exception: average_speed)
* `_diff` - a column name that ends in `_diff` is a column that is the difference between T1 and T2 data values. Formula: data values
* `_per` - a column name that ends in `_per` is a column that is the percent change between T1 and T2 (T2-T1) data values. Formula: (T2-T1)/T1 * 100. 
* `_logsqrt` - a column name that ends in `_logsqrt` is a column that has been normalized using a log-square-root transformation. Formula: `log(sqrt(<data_column>))-mean(log(sqrt(<data_column>))`. Example columns: avg_mass_logsqrt

* `_logsqrt_i` - a column name that ends in `_logsqrt_i` is a column that has been normalized using a log-square-root transformation but its sign is the inverse of the column. Formula: `log(sqrt(0.85-column))-mean(log(sqrt(0.85-column))`. Example columns: wing2body_logsqrt_i (AB FLAG: max value is this 0.7633366)

# Winter 2020 Data Cleaning

## Read Libraries

The flight response of *J. haematoloma* was analyzed using multivariate, generalized linear modeling (GLM) as implemented in the R packages `lme4` and `binom`. All plots, except the histogram, were generated using base R and supplemented with the `popbio` package to display logistic regressions and the `rethinking` package to display 95% confidence intervals of linear regressions. The histogram below was generated using `ggplot` libraries and helper functions found in `ggformula` package.

Additional R packages not show below, but embedded in the sourced scripts are `lubridate`, `chron`, and `dplyr`. `lubridate` and `chron` both aid in datetime manipulation while `dplry` pipelines data grouping processes.

```{r message=FALSE, warning=FALSE}
library(lme4)       # fit regressions 
library(rethinking) # Bayesian data analysis and plotting
library(popbio)     # logistic regression plotting
library(binom)      # binomial confidence intervals
library(ggformula)  # ggplot plotting
```

## Read Source Files

Each sourced script below aides in either data cleaning (`read_flight_data()`, `center_data()`) or multivariate GLM (`model_comparisonsAIC()`, `get_model_probs()`, `catch_warnings()`). Additionally, the function `model_comparisonsAIC()` takes in the path of a generic multi-factor script specific to the GLM family and link function needed to build the predictive models. All aforementioned, sourced scripts are located in the **Rscr** folder.

```{r message=FALSE, warning=FALSE}
source_path = paste0(dir,"/Rsrc/")

script_names = c("center_flight_data.R",  # 1 function: center_data()
                 "clean_flight_data.R",   # 1 function: clean_flight_data()
                 "unique_flight_data.R",  # 1 function: create_delta_data()
                 "compare_models.R",      # 1 function: model_comparisonsAIC()
                 "get_Akaike_weights.R",  # 1 function: get_model_probs()
                 "get_warnings.R")        # 1 function: catch_warnings() 

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}
```

## Read the Data

The flight performance data read directly below is only from Winter 2020 flight trials. The `read_flight_data()` function standardizes data types and names of the ID, trial type, host plant, flight response, egg-laying response, sex, population, and wing morph inputs. The date, start time, and end time of trails are also converted into datetimes. Variables of interest like wing-to-body ratio are also calculated and centered. Using the `clean_flight_data` function, all morphology, mass, and flight performance measurements are centered and/or standardized within the `read_flight_data()` function. Then, full dataset (n=758) that includes all bugs collected during Winter 2020 and a subset of the full dataset (n=614) that includes only bugs tested from that collection are returned.

The `create_delta_data()` function generates the unique dataset by grouping by ID. The function also computes trial differences, percent differences, and averages for variables of interest such as mass, flight response, egg-laying response, distance, and speed. Then, the unique data variables are centered and/or standardized.

```{r message=FALSE, warning=FALSE}
data_path = paste0(dir,"/Dispersal/Winter_2020/stats/data/all_flight_data-Winter2020.csv")

data = read_flight_data(data_path) # centers each subset of data
data_all = data[[1]]               # full dataset
data_tested = data[[2]]            # subset of data_all, contains only bugs flight tested

# create the unique dataset
d <- create_delta_data(data_tested, remove_bugs_tested_once = FALSE) 

# keep all bugs (even bugs only tested once), then re-center
dc <- center_data(d, is_not_unique_data = FALSE)
```

Example of a  **full dataset** (each row has unique ID and trial type):

```{r}
data_tested[c(1:2,400:401), c("ID", "trial_type")]
```

Example of a **unique dataset** (each row has unique ID):

```{r results='hold'}
dc[c(1:2,295:296), c("ID", "trial_type")]
```

The datatype of the `trial_type` column is a list because when expanded out, it would show `list(T1, T2)`.

# Across-Trial Flight Response (T1 & T2)

Flight response (yes flew or did not fly) was recorded and modeled. Multivariate, GLM was performed using the `glm()` function in the `lme4` package. Models were compared using Akaike Information Criterion (AIC) and model selection was determined using Akaike weights. Model fit was further evaluated between two models using the `anova()` function.

```{r echo=FALSE}
# repeating plotting features & functions

## scale/magnifications
c1 = 1.3*2  # size of points
c2 = 1.2*2  # size of large text
c3 = 2      # size of smaller text
c4 = 2*2    # size of title 

## colors
pink = "#b57783"
darkred = "#820331"
red = "#cd5c5c"
grey = "#999999"
grey = "grey78"
#yellow = "#E69F00"
blue = "#4255d4"
orange = "#e34a33"
lightorange = "#fdbb84"
red = "#de2d26"
#red = "#2ca25f"
#red = orange
#grey = "#99d8c9" # "grey48"
black = "black"


## compute 95% confidence interval for regression line
get_CI = function(x,y,m) {
  x.seq = seq(min(x) - sd(x), max(x) + sd(x), length.out=100)
  prd = data.frame(x=x.seq)
  err = predict(m, newdata = prd, se.fit = TRUE)
  prd$lci = err$fit - 1.96 * err$se.fit
  prd$fit = err$fit
  prd$uci = err$fit + 1.96 * err$se.fit
  mu_ci = t(matrix(c(prd$lci,prd$uci), ncol=2))
  return(list(mu_ci, prd))
}
```

## Experimental Effects

To determine how the design of the experiment affected flight response and/or performance, three design factors were modeled: trial type (T1 vs. T2), days from start, and trial start time.

### Trial Type, Days from Start & Trial Start Time 

```{r}
# compute how many times flew yes or no per trial
binary_counts = table(data_tested$flew_b, data_tested$trial_type)[,2:3]

# aggregate by days since the trials began and flight response to determine flight prob 
dd = aggregate(flew_b ~ days_from_start, data=data_tested, FUN=mean)
```

```{r echo=FALSE, fig.height=2.7*3, fig.width=6*3}
# day tested: flight prob vs. days from start

par(mfrow=c(1,2), mar = c(4.3, 7, 3.5, 0.1), cex.axis=c3, cex.lab=c2) 

# plot A (barplot)
barplot(binary_counts,
        ylim=c(0,250), beside=TRUE,
        xlab="Trial", col=c(lightorange, orange),
        ylab="Frequency")
legend(4, 245,
       legend = c("no flew", "yes flew"),
       col=c(lightorange, orange),
       pch=15,
       cex = c2)
mtext("A", side=3, adj=0, line=0.5, cex=c4, font=1)
  
# plot B (linear regression)
x=dd$days_from_start
y=dd$flew_b
m = glm(y ~ x, data=dd, family="gaussian")
shading = get_CI(x,y,m)
mu_ci=shading[[1]]
prd=shading[[2]]

plot(dd$flew_b~dd$days_from_start, frame.plot=F,
     ylab="Flight Probability", xlab="Days From Start", 
     pch=19, col=1, 
     cex=c1,
     ylim=c(0.4,1))
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval = paste0("p = ", round(summary(m)$coefficients[8],3), "*")
text(11, 0.45, pval, cex=c2)
mtext("B", side=3, adj=0, line=0.5, cex=c4, font=1)

# inner plot (logistic regression)
par(fig=c(.70,0.97,0.5,0.99), new=TRUE, mar=c(1,1,1,1), cex.axis=c3, cex.lab=c3)

m = glm(flew_b ~ days_from_start, data=data_tested, family = "binomial" )
pvalue = paste0("p = ", round(summary(m)$coefficients[8],3), "*")

logi.hist.plot(data_tested$days_from_start, 
               data_tested$flew_b,boxp=FALSE,
               type="hist",col=grey, ylabel="", ylabel2 = "", xlabel="")
text(7, 0.38, pvalue, cex=c3)
mtext("Frequency", side=4, cex=c3, line=1)
```

```{r echo=FALSE, fig.height=2.7*3, fig.width=6*3}
# time tested: recording duration (HR) vs. trial start time (HR)

par(mfrow=c(1,2), mar = c(4.3, 7, 3.5, 0.1), cex.axis=c3, cex.lab=c2) 

# plot C (all bugs)
dt = data_tested[,c("hr_start", "recording_duration")]
x=dt$hr_start
y=dt$recording_duration/60/60
m = glm(y ~ x, data=dt, family="gaussian")
shading = get_CI(x,y,m)
mu_ci=shading[[1]]
prd=shading[[2]]

plot(dt$hr_start, dt$recording_duration/60/60, frame.plot=F,
     xlab="Trial Start Time (HR)", 
     ylab="Recording Duration (HR)",
     cex=c1, 
     pch=19,
     ylim=c(0,16))
abline(m, lty=2)
shade(mu_ci, lim = prd$x)
pval = paste0("p = ", round(summary(m)$coefficients[8],3)) # marginal effect
text(15, 11, pval, cex=c2) 
context = expression(italic("all tested bugs"))
text(9.5, 15.5, context, cex=c2)
mtext("C", side=3, adj=0, line=0.5, cex=c4, font=1)

# plot D (filter out bugs that did not fly then categorize by flight type)
flight_type_col = c(CB = red, 
                    B = black, 
                    BC = red,
                    C = red)

dt=data_tested[data_tested$flew_b !=0,]
x=dt$hr_start
y=dt$recording_duration/60/60
m = glm(y ~ x, data=dt, family="gaussian") 
shading = get_CI(x,y,m)
mu_ci=shading[[1]]
prd=shading[[2]]

dtt=data_tested[data_tested$flew_b !=0 & data_tested$flight_type == "C",]
x=dtt$hr_start
y=dtt$recording_duration/60/60
m2 = glm(y ~ x, data=dtt, family="gaussian") 
shading2 = get_CI(x,y,m2)
mu_ci2=shading2[[1]]
prd2=shading2[[2]]

plot(dt$hr_start, dt$recording_duration/60/60, frame.plot=F,
     xlab="Trial Start Time (HR)", 
     ylab="Recording Duration (HR)",
     col=flight_type_col[as.factor(dt$flight_type)],
     cex=c1,
     pch=19,
     ylim=c(0,16))
legend(13.7, 15, 
       title="Flight Type",
       legend=c("continous", "burster"), 
       col=c(red, black),
       pch=19, y.intersp=1.3, 
       pt.cex=c1, cex = c3)
abline(m2, lty=2)
shade(mu_ci2, lim = prd2$x, col=col.alpha(red, alpha=0.4))
pval2 = paste0("p = ", round(summary(m2)$coefficients[8],3), "*")
text(13.2, 6.6, pval2, cex=c2, col=red)
context = expression(italic("only tested bugs that flew"))
text(10.7, 15.5, context, cex=c2)
mtext("D", side=3, adj=0, line=0.5, cex=c4, font=1)
```

**A & B.** There was a negative effect of day a bug was tested (since the start of trials) on flight probability, but there was a significant effect only when the full dataset is considered. It is not significant for the unique dataset because days from start had to be averaged between trials. This is explored in the next section of the report. **C & D.** There was a negative effect of the trial start time on flight duration but only after removing bugs that did not fly (*p* = 0.031). Continuous flyers are driving this significant relationship (**D**).

## Binomial Modeling

To understand SBB flight response, flight response across trials was modeled against sex, host plant, distance from the sympatric zone, wing-to-body ratio, and mass. This was done using the unique dataset.

Because the unique dataset was used, there exist multiple recorded counts of the number of times a SBB flew and did not fly between trials, T1 and T2. For that reason, we used `cbind(num_flew, num_notflew)` when modeling in order to account for all flight successes and failures for each individual.

Finally, we tested whether the data was over-dispersed, which could be resolved using a Quasibinomial:

```{r message=FALSE, warning=FALSE}
# calculate the confidence interval for the mean of the data (Binomial vs. Quasibinomial)
fit <- glm(cbind(num_flew, num_notflew) ~ 1, family = binomial, data = dc)
plogis(confint(fit))

fit_q <- glm(cbind(num_flew, num_notflew) ~ 1, family = quasibinomial, data = dc)
plogis(confint(fit_q))

# estimate the dispersion parameter
summary(fit_q)$dispersion
```

If the dispersion parameter is close to 1, the data is not over-dispersed, so there is not much of a necessity to apply a Quasibinomial model. Therefore, we selected the family as "binomial".

### Average Days Since Start

For the unique dataset, average days since start (log-square-root transformed) was computed in order to determine how an experimental factor affected flight response. It proved to not be significant: 

```{r}
avg_days_model<-glm(cbind(num_flew,num_notflew)~avg_days_c, data=dc, family=binomial)
summary(avg_days_model)
```

```{r echo=FALSE, fig.width=3.5, fig.height=2.5}
dc$num_trials <- as.factor(rowSums(dc[,c("num_flew", "num_notflew")]))

h <- ggplot(dc, aes(x=avg_days, color=num_trials)) +
  labs(title=" ", color="Number of Trials", 
       x="Average Days Since Start", y = "Frequency") +
  geom_histogram(binwidth=1, fill="white") + 
  theme(legend.position="top") +
  theme_classic() +
  scale_color_manual(values=c(grey, "black")) 
h
```

Average days since start accounts for bugs who died before they could be tested twice, which would most likely lead to an early average day value. The rest of the bugs that were tested twice would most likely have a later average day value. This testing regime shapes the bimodal distribution seen in the histogram. Additionally, the advantage of this computed variable is that it controls for the fact that some bugs were tested once late, and some by chance had been tested twice early. In turn, because we randomized test day, when repeated measures for each individual are combined across days, they balance each other out. Thus, average days since start allows the multi-variate models, which control for repeated tests per ID number, to converge, and we can be confident that non-random mortality is not impacting flight response.[[AB FLAG: "can be confident..." not so founded...]]

### Single-Variate Effects

We used aggregated datasets for single-variate modeling.

```{r}
# tailoring variables for plotting
d$mass_block=round(d$avg_mass/0.005)*0.005      # 0.005 g blocks 
d$wing2body_block=round(d$wing2body, digits=2)  # 0.01 blocks
d$days_block=round(d$avg_days, digits=0)        # integer blocks
```

```{r}
# aggregate data for plotting
dt=aggregate(flew_prob~sex, data=d, FUN=mean)
dt$trials=c(sum(d$num_flew[d$sex=="F"]+d$num_notflew[d$sex=="F"]),
            sum(d$num_flew[d$sex=="M"]+d$num_notflew[d$sex=="M"]))

ds=aggregate(flew_prob~sex*wing2body_block, data=d, FUN=mean)
ds$n=aggregate(flew_prob~sex*wing2body_block, data=d, FUN=length)$flew_prob

dm=aggregate(flew_prob~sex*mass_block, data=d, FUN=mean)
dm$n=aggregate(flew_prob~sex*mass_block, data=d, FUN=length)$flew_prob

# calculate binomial confidence interval
dt$successes = c(sum(d$num_flew[d$sex=="F"]), sum(d$num_flew[d$sex=="M"]))
dt$CI = binom.confint(dt$successes, dt$trials, methods="exact")
```

```{r echo=FALSE, fig.height=2.7*2.7, fig.width=6*2.7}

par(mfrow=c(1,3), mar = c(4.3, 7, 4.6, 0.1), cex.axis=c3, cex.lab=c2) 
sex_colors = c("red", "blue")

# plot A (flight probability grouped by sex)
nfem = nrow(d[d$sex=="F",])
nfem = paste0("N=", nfem)
nmale = nrow(d[d$sex=="M",])
nmale = paste0("N=", nmale)

plot(dt$CI$mean~c(1,2), xaxt='n', 
     ylab="Flight probability", 
     xlab="Sex", ylim=c(0,1), 
     xlim=c(0.5,2.5), 
     cex=c1, pch=19, col=sex_colors)
lines(x=xy.coords(x=c(1,1), y=c(dt$CI$lower[1], dt$CI$upper[1])), lwd=3, col=sex_colors[1])
lines(x=xy.coords(x=c(2,2), y=c(dt$CI$lower[2], dt$CI$upper[2])), lwd=3, col=sex_colors[2])
axis(side=1, at=c(1,2), labels=c("female", "male"))
mtext(text=c(nfem,nmale), at=c(1,2), side=1, line=-3, cex=c2)
mtext("A", side=3, adj=0, line=0.5, cex=c4, font=1)

# plot B (wing2body ratio vs. flew_prob grouped by sex)

d1 = ds[ds$sex=="F",]
d2 = ds[ds$sex=="M",]

# females
x=d1[,"wing2body_block"]
y=d1[,"flew_prob"] 
m1 = lm(y ~ x, data=d1)
shading=get_CI(x,y,m1)
mu_ci1=shading[[1]]
prd1=shading[[2]]

# males
x=d2[,"wing2body_block"]
y=d2[,"flew_prob"] 
m2 = lm(y ~ x, data=d2)
shading=get_CI(x,y,m2)
mu_ci2=shading[[1]]
prd2=shading[[2]]

plot(ds$flew_prob~ds$wing2body_block, 
     ylab="Flight probability", xlab="Wing-to-body ratio", 
     pch=19, col=sex_colors[as.factor(ds$sex)], 
     cex=c1, ylim=c(0,1))
abline(m1, lty=2, col=sex_colors[1])
abline(m2, lty=2, col="darkblue")
shade(mu_ci1, lim = prd1$x, col=col.alpha("indianred1"))
shade(mu_ci2, lim = prd2$x) 
pval1 = paste0("p = ", round(summary(m1)$coefficients[8],2))
pval2 = paste0("p = ", round(summary(m2)$coefficients[8],5), "*")
text(0.72, 0.05, pval1, cex=c2, col="darkred")
text(0.67, 0.6, pval2, cex=c2) 
legend(0.64, 1, 
       legend=c("male", "female"), 
       col=rev(sex_colors),
       pch=19, y.intersp=1.3, 
       pt.cex=c1, cex = c2)
mtext("B", side=3, adj=0, line=0.5, cex=c4, font=1)

# plot C (mass vs. flew_prob grouped by sex)
dm=aggregate(flew_prob~sex*mass_block, data=d, FUN=mean)
dm$n=aggregate(flew_prob~sex*mass_block, data=d, FUN=length)$flew_prob

d1 = dm[dm$sex=="F",]
d2 = dm[dm$sex=="M",]

# females
x=d1[,"mass_block"]
y=d1[,"flew_prob"] 
m1 = lm(y ~ x, data=d1)
shading=get_CI(x,y,m1)
mu_ci1=shading[[1]]
prd1=shading[[2]]

# males
x=d2[,"mass_block"]
y=d2[,"flew_prob"] 
m2 = lm(y ~ x, data=d2)
shading=get_CI(x,y,m2)
mu_ci2=shading[[1]]
prd2=shading[[2]]

plot(dm$flew_prob~dm$mass_block, 
     ylab="Flight probability", 
     xlab="Mass (g)", 
     pch=19, 
     col=sex_colors[as.factor(dm$sex)], 
     cex=c1,
     ylim=c(0,1), xlim=c(0.02, 0.18))
legend(0.125, 1, 
       legend=c("male", "female"), 
       col=rev(sex_colors),
       pch=19, 
       y.intersp=1.3, pt.cex=c1, cex = c2)
abline(m1, lty=2)
abline(m2, lty=2, col="darkblue")
shade(mu_ci1, lim = prd1$x)
shade(mu_ci2, lim = prd2$x, col=col.alpha("darkblue"))
pval1 = paste0("p = ", round(summary(m1)$coefficients[8],3), "*")
pval2 = paste0("p = ", round(summary(m2)$coefficients[8],2))
text(0.11, 0.5, pval1, cex=c2)
text(0.1, 0.9, pval2, cex=c2, col="darkblue")
mtext("C", side=3, adj=0, line=0.5, cex=c4, font=1)
```

### Multi-Variate Models

We used the unique dataset for multi-variate modeling. 

```{r results='hold', message=FALSE}
data<-data.frame(R1 = dc$num_flew, 
                 R2 = dc$num_notflew, 
                 A = dc$host_c,
                 B = dc$sex_c,
                 C = dc$sym_dist,
                 D = dc$avg_mass_logsqrt,
                 E = dc$avg_days_c)

model_script = paste0(source_path,"generic models-binomial glm 2R ~ 4-FF + E.R")
errors = catch_warnings(model_comparisonsAIC(model_script))
cat("Number of models that failed to converge: ", length(errors$warnings))
```

&nbsp;

```{r results='hold'}
anova(m63, m85, test="Chisq") # Adding B*D does not improve fit
anova(m63, m36, test="Chisq") # Adding C*D does improve fit 
```

#### Best Fit 

```{r}
M1 <- glm(cbind(num_flew, num_notflew) ~ host_c * avg_mass_logsqrt 
          + sym_dist_s * avg_mass_logsqrt + sex_c + avg_days_c, data=d, family=binomial)
summary(M1)
```

&nbsp;

### Multi-Variate Models Split By Sex

#### Females

```{r}
data_fem <- dc[dc$sex=="F",]
data_fem <- center_data(data_fem, is_not_unique_data = FALSE)
```

```{r results='hold'}
data<-data.frame(R1 = data_fem$num_flew,
                 R2 = data_fem$num_notflew,
                 A = data_fem$host_c,
                 B = data_fem$sym_dist, 
                 C = data_fem$avg_mass_logsqrt, 
                 D = data_fem$wing2body_logsqrt_i, 
                 E = data_fem$avg_days_c)

model_script = paste0(source_path,"generic models-binomial glm 2R ~ 4-FF + E.R")
errors = catch_warnings(model_comparisonsAIC(model_script))
cat("Number of models that failed to converge: ", length(errors$warnings))
```

&nbsp;

```{r results='hold'}
anova(m25, m45, test='Chisq') #adding A*D does not improve fit 
anova(m25, m13, test='Chisq') #adding A*C improves fit
anova(m25, m17, test="Chisq") #adding D improves fit
anova(m25, m45, test="Chisq") #adding D improves fit
```

##### Best Fit 

```{r}
M2 <- glm(cbind(num_flew, num_notflew) ~ host_c * avg_mass_logsqrt +  wing2body_logsqrt_i + 
            avg_days_c, data=data_fem, family=binomial) 
summary(M2)
```

&nbsp;

#### Males

```{r}
data_male <- dc[dc$sex=="M",]
data_male <- center_data(data_male, is_not_unique_data = FALSE)
```

```{r results='hold'}
data<-data.frame(R1 = data_male$num_flew,
                 R2 = data_male$num_notflew,
                 A = data_male$host_c,
                 B = data_male$sym_dist, 
                 C = data_male$avg_mass_logsqrt, 
                 D = data_male$wing2body_logsqrt_i, 
                 E = data_male$avg_days_c)

model_script = paste0(source_path,"generic models-binomial glm 2R ~ 4-FF + E.R")
errors = catch_warnings(model_comparisonsAIC(model_script))
cat("Number of models that failed to converge: ", length(errors$warnings))
```

&nbsp;

```{r results='hold'}
anova(m83, m105, test="Chisq") # adding C*D marginally improves fit
anova(m83, m62, test="Chisq") # adding B*C marginally improves fit
anova(m50, m62, test="Chisq") # adding C does not improve fit 
```

##### Best Fit 

```{r}
M3<-glm(cbind(num_flew, num_notflew)~host_c*wing2body_logsqrt_i + sym_dist*wing2body_logsqrt_i 
        + avg_days_c, family=binomial, data=data_male) 
summary(M3)
```

&nbsp;

# Between-Trial Flight Response (T1 vs. T2)

## Read Libraries

```{r warning=FALSE, message=FALSE}
library(dplyr) # data manipulation 
library(zoo) # data manipulation
library(nnet) # multinomial modeling 
library(kableExtra) # table formatting
library(plot.matrix) # enables matrix/heatmap plotting
```

## Read Source Files

```{r}
script_names = c("multinom_functions.R") # 4 relevant functions:
                                          # calculate_P2(), calculate_P3(),
                                          # get_significant_models(),
                                          # get_significant_modelsf(),

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}
```

## Read the Data

```{r}
# only keep bugs tested twice
d = create_delta_data(data_tested, remove_bugs_tested_once=TRUE) 
```

## Encodings & Signs

We aimed to model the probability of different delta flight response cases with sex, host plant, percent changes in mass, and percent changes in egg-laying response as predictors. Since the outcomes (or response variables) were no longer binomial, we used multi-categorical logit models. Below are the categorical encodings and/or signs used. See the Appendix for additional explanations and examples of computing multi-categorical logit models.

```{r echo=FALSE}
Event = c("flew in both trials", "flew in T2 only", " flew in neither trials", "flew in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  kable_classic(html_font = "Cambria") %>%
  add_header_above(c("Delta Flight Response Key" = 2 )) 
```

```{r echo=FALSE}
Event = c("gained % mass from T1 to T2", "no % mass change between trails", "lost % mass from T1 to T2")
Sign = c("+","0","-")
key = cbind(Event, Sign)

kable(key) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  kable_classic(html_font = "Cambria") %>%
  add_header_above(c("Delta Percent Mass Key (%)" = 2 )) 
```

```{r echo=FALSE, warning=FALSE}
Host = c("Golden Rain Tree (GRT)", "Balloon Vine (BV)")
Encoding = c(1,-1)
key = cbind(Host, Encoding)

kable(key)  %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  kable_classic(html_font = "Cambria") %>%
  add_header_above(c("Host Plant Key" = 2 )) 
```
```{r echo=FALSE, warning=FALSE}
Sex = c("Female", "Male")
Encoding = c(1,-1)
key = cbind(Sex, Encoding)

kable(key)  %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  kable_classic(html_font = "Cambria") %>%
  add_header_above(c("Sex Key" = 2 )) 
```

## Multinomial Modeling

### Baseline

```{r}
# remove any missing values for flight case or mass percent change between trials
df = d[with(d,!is.na(flight_case) & !is.na(mass_per)),]

# order the dataset by ascending mass percent change values
df = df[with(df, order(mass_per)),]

# relevel the flight case factors so as to set 0 as the first level.
df$flight_case = relevel(as.factor(df$flight_case), ref = "0")
```

### Null Model

```{r}
null = multinom(flight_case ~ 1, data = df) 
```

### Compare Models - predictors: % mass, sex, host

```{r warning=FALSE}
data = data.frame(R = df$flight_case, 
         A = df$mass_per,
         B = df$sex_c,
         C = df$host_c)
model_script = paste0(source_path,"generic multinomial models- multinom 1RF + 3 FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r warning=FALSE, results = "hold"}
anova(m4, m7, test="Chisq") # Adding C (host plant) does not improve fit
anova(m4, m8, test="Chisq") # Adding A*B does not improve fit
```

### Best Fit

```{r warning=FALSE, results = "hold"}
M4 = multinom(flight_case ~ mass_per + sex_c, data = df)
model_table4 = calculate_P2(M4, "mass_per", "sex_c")
```

&nbsp;

Host plant was not a significant predictor, so we tested the wing-to-body ratio as a predictor next.

&nbsp;
&nbsp;

### Compare Models - predictors: % mass, sex, wing2body (w2b)

```{r warning=FALSE}
df$wing2body_c = df$wing2body - mean(df$wing2body) # re-center the w2b predictor
```

```{r warning=FALSE}
data = data.frame(R = df$flight_case, 
                  A = df$mass_per,
                  B = df$sex_c,
                  C = df$wing2body_c)
model_script = paste0(source_path,"generic multinomial models- multinom 1RF + 3 FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r warning=FALSE, results = "hold"}
anova(m7, m12, test="Chisq") # adding A*C does not improve fit
anova(m7, m13, test="Chisq") # Adding B*C does not improve fit
```

### Best Fit

```{r warning=FALSE, results = "hold"}
M5 = multinom(flight_case ~ mass_per + sex_c + wing2body_c, data = df)
model_table5 = calculate_P3(M5)
```

### Prediction Equations 

```{r}
get_prediction_eq = function(tb, table_rowA, table_rowB, var_lab1, var_lab2, var_lab3, 
                             log_lab, title_lab) { 
  I = (tb[table_rowA,1] - tb[table_rowB,1])
  M = (tb[table_rowA,2] - tb[table_rowB,2])
  S = (tb[table_rowA,3] - tb[table_rowB,3])
  W = (tb[table_rowA,4] - tb[table_rowB,4])
  EQ = paste0(log_lab, round(I, 2), " + ", round(M,2), var_lab1, " + ", round(S, 2), 
               var_lab2, " + ", round(W, 2), var_lab3, title_lab)
  print(EQ)
  
  return(EQ)
}
```

```{r results='hold'}
EQ1 = get_prediction_eq(model_table5, 1, 2, " Mass %", " Sex", " Wing-to-Body", 
                        "log(pi_-1 / pi_1) = ","   Flew in T1, not T2")
EQ2 = get_prediction_eq(model_table5, 3, 1, " Mass %", " Sex", " Wing-to-Body", 
                        "log(pi_2 / pi_-1) = ", "   Flew in both, not T1" )
EQ3 = get_prediction_eq(model_table5, 3, 2, " Mass %", " Sex", " Wing-to-Body", 
                        "log(pi_2 / pi_1) = ", "   Flew in both, not T2" )
```

### Visualize Significant Multinomial Functions

```{r warning=FALSE, results = "hold", fig.width=10, fig.height=9}
# define a run_multinom_model function based on the best fit model
run_multinom_model = function(d) {
  m = multinom(flight_case ~ mass_per + sex_c + wing2body_c, trace=FALSE, data = d)
  model_table = calculate_P3(m, print_table=FALSE)
  return(model_table)
}

# determine which multinomial model equations are significant with a plot
par(mfrow=c(2,2))
mass_per_ML = get_significant_models(19) # % mass
  mtext("A. Mass", side=3, adj=0, line=0.5, cex=1.3, font=1)
sex_ML = get_significant_models(20) # sex
  mtext("B. Sex", side=3, adj=0, line=0.5, cex=1.3, font=1)
w2b_ML = get_significant_models(21) # wing2body
  mtext("C. Wing2Body", side=3, adj=0, line=0.5, cex=1.3, font=1)
```

&nbsp;

### Plot Predicted Probabilities 

```{r warning=FALSE}
head(pp <- fitted(M4),3) # compute fitted values of the best fit model without wing-to-body ratio
```

```{r warning=FALSE, echo=FALSE}
df$index = 1:nrow(df)
females = df[df$sex=="F",]
males = df[df$sex=="M",]
Frows = females$index
Mrows = males$index
```

```{r warning=FALSE, echo=FALSE, fig.width=3.2*1.7*2, fig.height=2.8*2}
#```{r warning=FALSE, echo=FALSE, fig.width=3.2*1.5, fig.height=2.8}
plot1 = function(df, pp) {
  plot(df$mass_per[Frows], pp[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",
     type="l",
     ylab="Flight Case Probability", 
     xlab="Percent Mass Change From T1 to T2 (%)", lty=1, cex.axis=1.2, cex.lab=1.3)  
  points(df$mass_per[Mrows], pp[Mrows,1], col="red", type="l", cex=0.45, lty=2) 
  points(df$mass_per[Frows], pp[Frows,2], col="blue", type="l") 
  points(df$mass_per[Mrows], pp[Mrows,2], col="blue", type="l", cex=0.45, lty=2)
  points(df$mass_per[Frows], pp[Frows,3], col="darkgreen", cex=0.45, type="l", pch=16) 
  points(df$mass_per[Mrows], pp[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=2) 
  points(df$mass_per[Frows], pp[Frows,4], col="orange3", type="l") 
  points(df$mass_per[Mrows], pp[Mrows,4], col="orange3", type="l", cex=0.45, lty=2) 
  #mtext("A", side=3, adj=0.01, line=0.5, cex=1.5, font=2)
  text(68,0.7, labels="Flew in T1 only", col="blue")
  text(-27,0.9, labels="Did Not Fly", col="red")
  text(13,0.37, labels="Flew Twice", col="orange3")
  legend(83, 1.0,
         legend = c("female","male"),
         lty=1:2,
         col="black",
         cex=1.1)  
}
pp4 <- fitted(M4)
df4 <- df 
plot1(df4,pp4)
```

```{r warning=FALSE}
head(pp <- fitted(M5), 3) # compute fitted values of the best fit model with wing-to-body ratio
```

```{r warning=FALSE, echo=FALSE}
df$index = 1:nrow(df)
females = df[df$sex=="F",]
males = df[df$sex=="M",]
Frows = females$index
Mrows = males$index
```

```{r echo=FALSE, warning=FALSE}
plot2 = function(df, pp, PP, gradient=TRUE, circles=TRUE, stochasticity=TRUE, points=TRUE) {
  
  c1 = 0.65
  c2 = 1.2
  df$w2b_col = 0
  
  if (stochasticity) {
    plot(df$mass_per[Frows], pp[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",type="l", 
       ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3) 
    points(df$mass_per[Frows], pp[Frows,2], col="blue", type="l")
    points(df$mass_per[Frows], pp[Frows,4], col="darkorange1", type="l") #darkred
  }
  if (points){
    plot(df$mass_per[Frows], PP[Frows,1], ylim=c(0,1), xlim=c(-40,104), col="red",type="l", 
       ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3) 
    points(df$mass_per[Frows], PP[Frows,2], col="blue", type="l")
    points(df$mass_per[Frows], PP[Frows,4], col="darkorange1", type="l") #darkred   
  }
  mtext(expression(italic("Females")), side=3, adj=0.05, line=-2, cex=1.5, font=2)
  mtext("B", side=3, adj=0.01, line=0.5, cex=1.5, font=2)
  text(64,0.7, labels="Flew in T1 only", col="blue", cex=c2)
  text(22,0.85, labels="Did Not Fly", col="red", cex=c2) 
  text(82,0.37, labels="Flew Twice", col="darkorange3", cex=c2) #maroon

  if (gradient) {
    rbPal <- colorRampPalette(c('black','red'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Frows], pp[Frows, 1], pch=20, col=df$w2b_col[Frows])
    
    rbPal <- colorRampPalette(c('black','royalblue1'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Frows], pp[Frows, 2], pch=20, col=df$w2b_col[Frows])
    
    rbPal <- colorRampPalette(c('black','orange')) # violetred1
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Frows], pp[Frows, 4], pch=20, col=df$w2b_col[Frows])
  }

 if (circles) {
  # Mark points in the graph with high wing2body ratio vs. points with low wing2body ratio.
  test <- df[with(df, order(wing2body)),] # ascending order

  small = test %>%
    filter(sex =="F", wing2body < 0.7184934)
  large = test %>%
    filter(sex == "F", wing2body > 0.7184934)
  srows = small$index
  lrows = large$index

  points(df$mass_per[lrows], pp[lrows,1], col="red", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,1], col="red", type="p", cex=c1)
  # those with smaller wing2body ratio were more likely to NOT fly
  points(df$mass_per[lrows], pp[lrows,2], col="blue", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,2], col="blue", type="p", cex=c1)
  points(df$mass_per[lrows], pp[lrows,4], col="darkred", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,4], col="darkred", type="p", cex=c1)
 }
  
}
pp5 = pp
df5 = df
```

```{r echo=FALSE, warning=FALSE}
plot3 = function(df, pp, PP, gradient=TRUE, circles=TRUE, stochasticity=TRUE, points=TRUE) {
  
  c1 = 0.65
  c2 = 1.2
  df$w2b_col = 0

  if (stochasticity) {
    plot(df$mass_per[Mrows], pp[Mrows,1], ylim=c(-0.00,0.8+0.05), xlim=c(-25,58), col="red",type="l", 
       ylab=" ", xlab="Percent Mass Change from T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3)
    points(df$mass_per[Mrows], pp[Mrows,2], col="blue", type="l", cex=0.45, lty=1)
    points(df$mass_per[Mrows], pp[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=1) 
    points(df$mass_per[Mrows], pp[Mrows,4], col="darkorange1", type="l", cex=0.45, lty=1) # darkred
  }
  if (points) {
    plot(df$mass_per[Mrows], PP[Mrows,1], ylim=c(-0.00,0.8), xlim=c(-25,58), col="red",type="l", 
       ylab=" ", xlab="Percent Mass Change from T1 to T2 (%)", 
       lty=1, cex.axis=1.2, cex.lab=1.3)
    points(df$mass_per[Mrows], PP[Mrows,2], col="blue", type="l", cex=0.45, lty=1)
    points(df$mass_per[Mrows], PP[Mrows,3], col="darkgreen", type="l", cex=0.45, lty=1) 
    points(df$mass_per[Mrows], PP[Mrows,4], col="darkorange1", type="l", cex=0.45, lty=1) # darkred
  }
  mtext(expression(italic("Males")), side=3, adj=0.05, line=-2, cex=1.5, font=2)
  mtext("C", side=3, adj=0.01, line=0.5, cex=1.5, font=2)
  text(22,0.35, labels="Flew in T1 only", col="blue", cex=c2)
  text(52,0.17, labels="Did Not Fly", col="red", cex=c2)
  text(-16, 0, labels="Flew in T2 only", col="darkgreen", cex=c2)
  text(-17,0.69, labels="Flew Twice", col="darkorange3", cex=c2) # 13,0.77, maroon, 13,0.77

  if (circles) {
    legend(39, .81+0.05, 
           pch=c(16,1), 
           title="Wing-to-body", 
           legend=c("> mean", "< mean"), 
           cex=1.1)
  }
  if (gradient) {
    text(50,0.84, labels="Wing-to-body", cex=c2)
  }
  
  if (gradient) {
    rbPal <- colorRampPalette(c('black','red'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 1], pch=20, col=df$w2b_col[Mrows])
    
    rbPal <- colorRampPalette(c('black','royalblue1'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 2], pch=20, col=df$w2b_col[Mrows])
    
    rbPal <- colorRampPalette(c('black','palegreen2'))
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 3], pch=20, col=df$w2b_col[Mrows])
    
    rbPal <- colorRampPalette(c('black','orange')) #violetred1
    df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
    points(df$mass_per[Mrows], pp[Mrows, 4], pch=20, col=df$w2b_col[Mrows])
  }

 if (circles) {
  # Mark points in the graph with high wing2body ratio vs. points with low wing2body ratio. 
  test <- df[with(df, order(wing2body)),] # ascending order
  
  small = test %>%
    filter(sex =="M", wing2body < 0.7184934)
  large = test %>%
    filter(sex == "M", wing2body > 0.7184934)
  srows = small$index
  lrows = large$index
  
  points(df$mass_per[lrows], pp[lrows,1], col="red", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,1], col="red", type="p", cex=c1)
  # those with smaller wing2body ratio were more likely to NOT fly
  points(df$mass_per[lrows], pp[lrows,2], col="blue", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,2], col="blue", type="p", cex=c1)
  points(df$mass_per[lrows], pp[lrows,3], col="darkgreen", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,3], col="darkgreen", type="p", cex=c1)
  points(df$mass_per[lrows], pp[lrows,4], col="darkred", type="p", cex=c1, pch=16)
  points(df$mass_per[srows], pp[srows,4], col="darkred", type="p", cex=c1)
 }
}
```

```{r echo=FALSE, fig.width=0.7, fig.height=1, warning=FALSE}
# Function to plot color bar
color.bar <- function(lut, min, max=77, nticks=3, ticks=seq(min, max, len=nticks), title='') {
    scale = (length(lut)-1)/(max-min)
    
    final_ticks=seq(min/100, max/100, len=nticks)
    #final_ticks = c("0.63", "0.66", "0.70", "0.74", "0.77")
    final_ticks = c("0.63", "0.70", "0.77")
    
    #dev.new(width=1.75, height=5)
    plot(c(0,10), c(min,max), type='n', bty='n', xaxt='n', xlab='', yaxt='n', ylab='', main=title)
    axis(2, ticks, las=1, labels=final_ticks)
    for (i in 1:(length(lut)-1)) {
     y = (i-1)/scale + min
     rect(0,y,10,y+1/scale, col=lut[i], border=NA)
    }
}
```

```{r warning=FALSE, echo=FALSE}
# generate small subset plots and scales in the top right hand corner
plot_histograms = function() {
  x = 0.48
  v <- c(x-0.13,x, 0.85, 0.90)
  par( fig=v, new=TRUE, mar=c(0,0,0,0) )
  hist(df$wing2body[Frows], col="white", main="", cex.axis=0.9) 
  text(0.64,45, labels="w2b", cex=0.9)

  x = 0.88
  v <- c(x-0.13, x, 0.85, 0.90)
  par( fig=v, new=TRUE, mar=c(0,0,0,0) )
  hist(df$wing2body[Mrows], col="white", main="", cex.axis=0.9, xlim=c(0.64,0.78)) 
  text(0.66,40, labels="w2b", cex=0.9)
}
plot_color_scale = function() {
  x = 0.98
  v <- c(x-0.025, x, 0.75, 0.86)
  par( fig=v, new=TRUE, mar=c(0,0,0,0) )
  color.bar(colorRampPalette(c("black", "grey"))(1000), 63)
}
```

```{r echo=FALSE, warning=FALSE, fig.width=3.2*1.7*2, fig.height=2.8*2}
#```{r echo=FALSE, warning=FALSE, fig.width=3.2*1.7*1.5, fig.height=2.8*1.5}
par(mfrow=c(1,2), tcl=-0.5) # length of tick marks set at default

par(mai=c(1,0.85,0.4,0)) # bottom, right, top, left
plot2(df5,pp5, pp4, gradient=TRUE, circles=FALSE, stochasticity=TRUE, points=FALSE)

par(mai=c(1,0.6,0.4,0.05))
plot3(df5,pp5, pp4, gradient=TRUE, circles=FALSE, stochasticity=TRUE, points=FALSE)

plot_histograms()
plot_color_scale()
```

## Multinomial Modeling (Females Only)

### Egg Case

```{r echo=FALSE, warning=FALSE}
# key = response in T2 - response in T1
Event = c("laid eggs in both trials", "laid eggs in T2 only", "laid eggs in neither trials", "laid eggs in T1 only")
Encoding = c(2, 1,0,-1)
key = cbind(Event, Encoding)

kable(key) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  kable_classic(html_font = "Cambria") %>%
  add_header_above(c("Delta Egg Response Key" = 2 )) 
```

### Baseline

```{r warning=FALSE, results='hold'}
# filter for females &
# remove any missing values for flight case, mass percent change, and egg case between trials
df = d[with(d,!is.na(flight_case) & !is.na(mass_per) & !is.na(egg_case) & sex=="F"),]

# order the dataset by ascending mass percent change values
df = df[with(df, order(mass_per)),]

# relevel the flight case factors so as to set 0 as the first level.
df$flight_case = relevel(as.factor(df$flight_case), ref = "0")

unique(df$flight_case) # no female bug only flew in T2, so can drop factor "1"
df$flight_case = droplevels(df$flight_case)
```

### Null model

```{r warning=FALSE}
null <- multinom(flight_case ~ 1, data = df) 
```

### Comparing Models - predictors: % mass, egg diff, host

```{r warning=FALSE}
data <- data.frame(R = df$flight_case, 
         A = df$egg_case,
         B = df$mass_per,
         C = df$host_c)
model_script = paste0(source_path,"generic multinomial models- multinom 1RF + 3 FF.R")
model_comparisonsAIC(model_script)
```
&nbsp;

```{r warning=FALSE, results='hold'}
anova(m4, m7, test="Chisq") # Adding C does not improve fit
anova(m7, m13, test="Chisq") # Adding mass_per*host does not improve fit
```

&nbsp;

Host plant was not a significant predictor for females as well, so we tested the wing-to-body ratio as a predictor next.

&nbsp;
&nbsp;

### Comparing Models - predictors: % mass, egg diff, wing2body

```{r warning=FALSE, echo=FALSE}
data <- data.frame(R = df$flight_case, 
         A = df$egg_case,
         B = df$mass_per,
         C = df$wing2body)
model_script = paste0(source_path,"generic multinomial models- multinom 1RF + 3 FF.R")
model_comparisonsAIC(model_script)
```

&nbsp;

```{r results='hold', warning=FALSE}
anova(m4, m7, test="Chisq") # adding wing2body does not improve fit
anova(m7, m13, test="Chisq") # Adding A*C does not improve fit
anova(m7, m12, test="Chisq") # Adding B*C does not improve fit
```

### Best Fit

```{r results="hold", warning=FALSE, message=FALSE}
M6 = multinom(flight_case ~ mass_per + egg_case, data = df) # same top model 
model_table6 = calculate_P2(M6, "mass_per", "egg_case")
```

### Prediction Equations 

```{r}
get_prediction_eq = function(tb, table_rowA, table_rowB, var_lab1, var_lab2, 
                             log_lab, title_lab) { 
  I = (tb[table_rowA,1] - tb[table_rowB,1])
  M = (tb[table_rowA,2] - tb[table_rowB,2])
  E = (tb[table_rowA,3] - tb[table_rowB,3])
  EQ = paste0(log_lab, round(I, 2), " + ", round(M,2), var_lab1, " + ", round(E, 2), 
               var_lab2, title_lab)
  print(EQ)
  
  return(EQ)
}
```

```{r results='hold'}
EQ = get_prediction_eq(model_table6, 1, 2, " Mass %", " Egg Case",
                        "log(pi_-1 / pi_1) = ","   Flew in T1, not T2")
```

### Visualize Significant Multinomial Functions

```{r warning=FALSE, results = "hold", fig.width=11, fig.height=4.7}
# define a run_multinom_model function based on the best fit model
run_multinom_model = function(d) {
  m <- multinom(flight_case ~ mass_per + egg_case, trace=FALSE, data = d) 
  model_table = calculate_P2(m, "mass_per", "egg_case", print_table=FALSE)
  return(model_table)
}

# determine which multinomial model equations are significant with a plot
par(mfrow=c(1,2)) 
mass_per_ML = get_significant_modelsf(15) # mass_per 
  mtext("A. Mass", side=3, adj=0, line=0.5, cex=1.6, font=1)
egg_case_ML = get_significant_modelsf(16) # egg_case
  mtext("B. Egg \nResponse", side=3, adj=0, line=0.3, cex=1.6, font=1)
```

### Barplot

```{r}
data_fem = data_tested[data_tested$sex=="F",]
binary_counts <- table(data_fem$eggs_b, data_fem$trial_type)[,2:3]
```

```{r echo=FALSE, warning=FALSE, fig.height=4.3}
par(mfrow=c(1,2))

barplot(binary_counts, ylab="Frequency",
        xlab="Trial", col=c("#b57783","#820331"),
        legend = c("no eggs", "yes eggs"), ylim=c(0,110), beside=TRUE)
```

&nbsp;
Notice that female bugs were laying more during the second trial (T2) than the first trial (T1).
&nbsp;

### Plot Predicted Probabilities 

```{r warning=FALSE}
head(pp <- fitted(M6),3)
```

```{r echo=FALSE, warning=FALSE}
df$index = 1:nrow(df)

eggT1 = df[df$egg_case == -1,]
egg0 = df[df$egg_case == 0,]
egg2 = df[df$egg_case == 2,]
eggT2 = df[df$egg_case == 1,]

eggT1_rows = eggT1$index
egg_0rows = egg0$index
egg_2rows = egg2$index
eggT2_rows = eggT2$index
```


```{r echo=FALSE, fig.width=3.2*1.7*2, fig.height=2.8*2}
plot4 = function(df, pp) {
  # only laid eggs in T1
  plot(df$mass_per[eggT1_rows], pp[eggT1_rows,1], ylim=c(0,1.05), xlim=c(-36,108), col="red", type="l", lty=1,main="Females Only", ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)")
  
  points(df$mass_per[eggT1_rows], pp[eggT1_rows,2], col="blue", type="l", lty=1, cex=0.45) 
  points(df$mass_per[eggT1_rows], pp[eggT1_rows,3], col="black", type="l", lty=1, cex=0.45) 
  # no egg change
  points(df$mass_per[egg_0rows], pp[egg_0rows,1], col="red", type="l", lty=2) # did not fly in either
  points(df$mass_per[egg_0rows], pp[egg_0rows,2], col="blue", type="l", lty=2) # flew in T1 only
  points(df$mass_per[egg_0rows], pp[egg_0rows,3], col="black", type="l", lty=2) # flew in both
  # eggs twice
  points(df$mass_per[egg_2rows], pp[egg_2rows,1], col="red", type="l", lty=4) # did not fly in either
  points(df$mass_per[egg_2rows], pp[egg_2rows,2], col="blue", type="l", lty=4) # flew in T1 only
  points(df$mass_per[egg_2rows], pp[egg_2rows,3], col="black", type="l", lty=4) # flew in both
  # only laid eggs in T2
  points(df$mass_per[eggT2_rows], pp[eggT2_rows,1], col="red", type="l", lty=3) # flew in neither
  points(df$mass_per[eggT2_rows], pp[eggT2_rows,2], col="blue", type="l", lty=3) # flew in T1 only
  points(df$mass_per[eggT2_rows], pp[eggT2_rows,3], col="black", type="l", lty=3) # flew in both
  
  text(70,0.68, labels="Flew in T1 only", col="blue") # 0.059,0.54
  text(-20,0.95, labels="Did Not Fly", col="red") # -0.036,0.95
  text(-20,0.55, labels="Flew Twice", col="black") # -0.02,0.35
  legend(76, 1.07,
         legend = c("laid eggs in T1","no eggs laid", "eggs laid twice", "laid eggs in T2"),
         lty=1:4,
         col="black",
         cex=0.8)
}
pp6 = fitted(M6)
df6 = df
plot4(df6,pp6) 
```

&nbsp;

# Fall 2019 Data Cleaning

## Read Libraries 

```{r}
library(cvms) # cross-validating regressions
```

## Read Source Files 

```{r warning=FALSE, message=FALSE}
script_names = c("clean_flight_data-Fall.R", # 1 function: clean_flight_data.Fall()
                 "unique_flight_data-Fall.R", # 1 function: create_delta_data.Fall()
                 "prediction_accuracy.R",     # 1 function: calculate_accuracy()
                 "confusion_matrix.R")        # 1 function: get_confusion_matrix()

for (script in script_names) { 
  path = paste0(source_path, script)
  source(path) 
}
```

## Read the Data

```{r warning=FALSE}
data_path = paste0(dir,"/Dispersal/Winter_2020/stats/data/full_data-Fall2019.csv")
dataFall = clean_flight_data.Fall(data_path)

# extract sets with an experimental design similar to the Winter tests
ongoing_data = dataFall[with(dataFall,!is.na(mass) & set_number > 71),]

# create delta data
d = create_delta_data.Fall(ongoing_data) 
```

# Flight Response Predictions

## Compute predicted probabilities

```{r}
d <- d[with(d, order(mass_per)),]
```

```{r}
neither = c()
T1_rather_than_none = c()
T2_rather_than_none = c()
both_rather_than_none = c()

for (i in 1:nrow(d)) {
  m = d$mass_per[[i]]
  s = d$sex_c[[i]]
  w = d$wing2body_c[i]
  # extract effects from the best fit model
  top0 = exp(0) # equals 1
  top1 = exp(model_table5[1,1] + model_table5[1,2]*m + model_table5[1,3]*s + model_table5[1,4]*w)
  top2 = exp(model_table5[2,1] + model_table5[2,2]*m + model_table5[2,3]*s + model_table5[2,4]*w)
  top3 = exp(model_table5[3,1] + model_table5[3,2]*m + model_table5[3,3]*s + model_table5[3,4]*w)
  bottom = top0 + top1 + top2 + top3
  # calculate predicted probabilities
  neither = c(neither, top0/bottom)
  T1_rather_than_none = c(T1_rather_than_none, top1/bottom)
  T2_rather_than_none = c(T2_rather_than_none, top2/bottom)
  both_rather_than_none = c(both_rather_than_none, top3/bottom)
}
```

## Plot predicted probabilities

```{r echo=FALSE}
d$index = 1:nrow(d)
females = d[d$sex=="F",]
males = d[d$sex=="M",]
Frows = females$index
Mrows = males$index
```

```{r echo=FALSE}
plot5 = function(d, T1_rather_than_none, T2_rather_than_none, both_rather_than_none, neither) {
  d$w2b_col = 0
  plot(d$mass_per[Frows], T1_rather_than_none[Frows], ylim=c(0,1), xlim=c(-40,104), col="blue", type="l",
       ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", lty=1) #T1 only
  points(d$mass_per[Frows], T2_rather_than_none[Frows], col="darkgreen", type="l", lty=1)
  points(d$mass_per[Frows], both_rather_than_none[Frows], col="darkorange1", type="l", lty=1)
  points(d$mass_per[Frows], neither[Frows], col="red", type="l", lty=1)

  rbPal <- colorRampPalette(c('black','royalblue1'))
  d$w2b_col <- rbPal(10)[as.numeric(cut(d$wing2body,breaks = 10))]
  points(d$mass_per[Frows], T1_rather_than_none[Frows], pch=20, col=d$w2b_col[Frows])
      
  rbPal <- colorRampPalette(c('black','palegreen2'))
  d$w2b_col <- rbPal(10)[as.numeric(cut(d$wing2body,breaks = 10))]
  points(d$mass_per[Frows], T2_rather_than_none[Frows], pch=20, col=d$w2b_col[Frows])  
  
  rbPal <- colorRampPalette(c('black','orange')) #violetred1
  df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
  points(d$mass_per[Frows], both_rather_than_none[Frows], pch=20, col=df$w2b_col[Frows])
      
  rbPal <- colorRampPalette(c('black','red'))
  d$w2b_col <- rbPal(10)[as.numeric(cut(d$wing2body,breaks = 10))]
  points(d$mass_per[Frows], neither[Frows], pch=20, col=d$w2b_col[Frows])
  
  text(-20,0.85, labels="Did Not Fly", col="red")
  text(25,0.35, labels="Flew Twice", col="darkorange1")
  text(55,0.25, labels="Flew in T1 only", col="blue")
  text(40,0.1, labels="Flew in T2 only", col="darkgreen")
  
  legend(70, 1.02,
         legend = c("female","male"),
         lty=1:2,
         col="black",
         cex=0.8)
}

plot6 = function(d, T1_rather_than_none, T2_rather_than_none, both_rather_than_none, neither) {
  d$w2b_col = 0
  plot(d$mass_per[Mrows], T1_rather_than_none[Mrows], ylim=c(0,0.8), xlim=c(-20,60), col="blue", type="l",
       ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", lty=1) #T1 only
  points(d$mass_per[Mrows], T2_rather_than_none[Mrows], col="darkgreen", type="l", lty=2)
  points(d$mass_per[Mrows], both_rather_than_none[Mrows], col="darkorange1", type="l", lty=2)
  points(d$mass_per[Mrows], neither[Mrows], col="red", type="l", lty=2)
  
  rbPal <- colorRampPalette(c('black','royalblue1'))
  d$w2b_col <- rbPal(10)[as.numeric(cut(d$wing2body,breaks = 10))]
  points(d$mass_per[Mrows], T1_rather_than_none[Mrows], pch=20, col=d$w2b_col[Mrows])

  rbPal <- colorRampPalette(c('black','palegreen2'))
  d$w2b_col <- rbPal(10)[as.numeric(cut(d$wing2body,breaks = 10))]
  points(d$mass_per[Mrows], T2_rather_than_none[Mrows], pch=20, col=d$w2b_col[Mrows])

  rbPal <- colorRampPalette(c('black','orange')) #violetred1
  df$w2b_col <- rbPal(10)[as.numeric(cut(df$wing2body,breaks = 10))]
  points(d$mass_per[Mrows], both_rather_than_none[Mrows], pch=20, col=df$w2b_col[Mrows])

  rbPal <- colorRampPalette(c('black','red'))
  d$w2b_col <- rbPal(10)[as.numeric(cut(d$wing2body,breaks = 10))]
  points(d$mass_per[Mrows], neither[Mrows], pch=20, col=d$w2b_col[Mrows])

  text(-12,0.38, labels="Did Not Fly", col="red")
  text(25,0.55, labels="Flew Twice", col="darkorange1")
  text(30,0.25, labels="Flew in T1 only", col="blue")
  text(30,0.1, labels="Flew in T2 only", col="darkgreen")
}
```

```{r warning=FALSE, echo=FALSE}
# generate small subset plots and scales in the top right hand corner
plot_histograms = function() {
  x = 0.34
  v <- c(x-0.13,x, 0.85, 0.90)
  par( fig=v, new=TRUE, mar=c(0,0,0,0) )
  hist(d$wing2body[Frows], col="white", main="", cex.axis=0.9, xlim=c(0.68,0.78)) 
  text(0.64,45, labels="w2b", cex=0.9)

  x = 0.88
  v <- c(x-0.13, x, 0.85, 0.90)
  par( fig=v, new=TRUE, mar=c(0,0,0,0) )
  hist(d$wing2body[Mrows], col="white", main="", cex.axis=0.9, xlim=c(0.68,0.78)) 
  text(0.66,40, labels="w2b", cex=0.9)
}
```

```{r echo=FALSE, warning=FALSE, fig.width=3.2*1.7*2, fig.height=2.8*2}
par(mfrow=c(1,2), tcl=-0.5) # length of tick marks set at default

par(mai=c(1,0.85,0.4,0)) # bottom, right, top, left
plot5(d, T1_rather_than_none, T2_rather_than_none, both_rather_than_none, neither)
text(45, 0.99, labels="w2b", cex=0.9)

par(mai=c(1,0.6,0.4,0.05))
plot6(d, T1_rather_than_none, T2_rather_than_none, both_rather_than_none, neither)
text(50,0.79, labels="Wing-to-body", cex=0.9)
text(23, 0.79, labels="w2b", cex=0.9)

plot_histograms()
plot_color_scale()
```


## Overall and Grouped Accuracies

```{r results='hold'}
probs = round(cbind(neither, T1_rather_than_none, T2_rather_than_none, both_rather_than_none),2)
summary_probs = cbind(as.character(d$flight_case), as.character(d$sex), probs)
colnames(summary_probs) = c("event", "sex", "none", "T1", "T2", "both")
dataframe = as.data.frame(summary_probs)
nrow(dataframe)
```

```{r results='hold'}
# overall
acc = calculate_accuracy(dataframe,3,6)
paste("Overall prediction accuracy, ", round(acc,2))

# by sex
femdata = dataframe[dataframe$sex=="F",]
maledata = dataframe[dataframe$sex=="M",]

accF = calculate_accuracy(femdata,3,6)
paste("Female prediction accuracy, ", round(accF,2))
accM = calculate_accuracy(maledata,3,6)
paste("Male prediction accuracy, ", round(accM,2))
```

## Confusion Matrix

```{r}
acc_table = get_confusion_matrix(dataframe,3,6)
acc_table[,1:5]
confusion_matrix <- acc_table$'Confusion Matrix'[[1]]
confusion_matrix
plot_confusion_matrix(confusion_matrix, add_sums=FALSE)
```

## Females

```{r}
dfem = d[d$sex=="F",]
```

```{r}
dfem <- dfem[with(dfem, order(mass_per)),]
```

```{r}
neither = c()
T1_rather_than_none = c()
both_rather_than_none = c()
for (i in 1:nrow(dfem)) {
  M = dfem$mass_per[[i]]
  EC = dfem$egg_diff[[i]]
  top0 = exp(0) #  equals 1
  top1 = exp(model_table6[1,1] + model_table6[1,2]*M + model_table6[1,3]*EC)
  top2 = exp(model_table6[2,1] + model_table6[2,2]*M + model_table6[2,3]*EC)
  bottom = top0 + top1 + top2
  neither = c(neither, top0/bottom)
  T1_rather_than_none = c(T1_rather_than_none, top1/bottom)
  both_rather_than_none = c(both_rather_than_none, top2/bottom)
}
```

### Compute predicted probabilities

```{r}
probs = round(cbind(neither, T1_rather_than_none, both_rather_than_none),2)
summary_probs = cbind(as.character(dfem$flight_case), as.character(dfem$egg_diff), probs)
colnames(summary_probs) = c("event", "egg_diff", "none", "T1", "both")

egg2 = c(1,2,3,5,6,7,9,10,11,13)
noegg = c(4,8,12)

dataframe = as.data.frame(summary_probs)
dataframe$egg_cat = c(2,2,2,0,2,2,2,0,2,2,2,0,2)
```

### Plot predicted probabilities

```{r echo=FALSE, fig.width=3.2*1.7*2, fig.height=2.8*2}
plot(dfem$mass_per[egg2], T1_rather_than_none[egg2], ylim=c(0,1), col="blue", type="l",
     ylab="Flight Case Probability", xlab="Percent Change in Mass From T1 to T2 (%)", main="Females Only", lty=2) #T1 only
points(dfem$mass_per[noegg], T1_rather_than_none[noegg], col="blue", type="l", lty=1)
points(dfem$mass_per[egg2], both_rather_than_none[egg2], col="black", type="l", lty=2)
points(dfem$mass_per[noegg], both_rather_than_none[noegg], col="black", type="l", lty=1)
points(dfem$mass_per[egg2], neither[egg2], col="red", type="l", lty=2)
points(dfem$mass_per[noegg], neither[noegg], col="red", type="l", lty=1)

text(0,0.42, labels="Did Not Fly", col="red")
text(0,0.60, labels="Flew Twice", col="black")
text(0,0.20, labels="Flew in T1 only", col="blue")
legend(20, 0.98,
       legend = c("no eggs","2 eggs"),
       lty=1:2,
       col="black",
       cex=0.8)
```

### Overall and Grouped Accuracies

```{r}
accF_eggs = calculate_accuracy(dataframe,3,5)
paste("Female prediction accuracy for mass diff and egg model, ", round(accF_eggs,2))
```

### Confusion Matrix

```{r}
acc_table = get_confusion_matrix(dataframe,3,5)
acc_table[,1:5]
confusion_matrix <- acc_table$'Confusion Matrix'[[1]]
confusion_matrix
plot_confusion_matrix(confusion_matrix, add_sums=FALSE)
```
